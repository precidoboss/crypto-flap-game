<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit | Mission Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-orange: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --glow: rgba(255, 77, 0, 0.3);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(255, 77, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 77, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .mars-border-glow {
            border: 1px solid var(--mars-orange);
            box-shadow: 0 0 10px var(--glow);
        }

        .btn-mars {
            background: var(--mars-orange);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .btn-mars:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow);
            transform: scale(1.02);
        }

        .move-select {
            border: 1px solid #333;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .move-select.selected {
            border-color: var(--mars-orange);
            filter: grayscale(0);
            background: rgba(255, 77, 0, 0.1);
            box-shadow: inset 0 0 10px var(--glow);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(255, 77, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 100;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--habitat-bg); }
        ::-webkit-scrollbar-thumb { background: var(--mars-orange); }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="scanline"></div>

    <!-- HUD Top Bar -->
    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-4 border-b border-orange-900/30">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 mars-border-glow flex items-center justify-center bg-black">
                <span class="text-orange-500 text-2xl font-bold">M</span>
            </div>
            <div>
                <h1 class="orbitron text-2xl font-bold text-orange-500 tracking-widest">MARTIAN GAMBIT</h1>
                <p class="text-[10px] text-orange-800 uppercase tracking-[0.2em]">Sector 2027 // EROL Protocol</p>
            </div>
        </div>

        <div id="connection-interface" class="mt-4 md:mt-0">
            <button id="connect-btn" class="btn-mars px-8 py-2">Initialize Uplink</button>
            <div id="account-info" class="hidden flex items-center gap-4">
                <div class="text-right">
                    <div id="user-address" class="text-[10px] text-orange-400 opacity-70"></div>
                    <div id="user-balance" class="orbitron text-orange-500 font-bold">0.00 $EROL</div>
                </div>
                <div class="h-10 w-1 bg-orange-500"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Tactical Selection -->
        <aside class="lg:col-span-4 space-y-6">
            <div class="mars-glass p-6">
                <h2 class="orbitron text-sm text-orange-500 mb-6 flex items-center gap-2">
                    <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                    COMMENCE SIGNAL DEPLOYMENT
                </h2>

                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="selectMove(1)" id="move-1" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                        <span class="text-[9px] uppercase">Solar</span>
                    </button>
                    <button onclick="selectMove(2)" id="move-2" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå¨Ô∏è</span>
                        <span class="text-[9px] uppercase">Oxygen</span>
                    </button>
                    <button onclick="selectMove(3)" id="move-3" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå™Ô∏è</span>
                        <span class="text-[9px] uppercase">Dust</span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-orange-800 uppercase mb-2 block">Energy Stake ($EROL)</label>
                        <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron">
                    </div>
                    
                    <button id="create-btn" onclick="handleCreateGame()" class="btn-mars w-full py-4 text-lg">Deploy Signal</button>
                </div>
            </div>

            <div class="mars-glass p-4 border-l-4 border-orange-500">
                <h3 class="text-orange-500 text-xs font-bold mb-3 uppercase tracking-tighter">Strategic Matrix</h3>
                <div class="space-y-2 text-[11px] text-gray-500">
                    <div class="flex justify-between border-b border-white/5 pb-1">
                        <span>Solar Flare</span>
                        <span class="text-orange-300">>> Oxygen Siphon</span>
                    </div>
                    <div class="flex justify-between border-b border-white/5 pb-1">
                        <span>Oxygen Siphon</span>
                        <span class="text-orange-300">>> Dust Storm</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Dust Storm</span>
                        <span class="text-orange-300">>> Solar Flare</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Combat Lobby -->
        <section class="lg:col-span-8">
            <div class="mars-glass p-6 min-h-[500px] relative overflow-hidden">
                <div class="flex justify-between items-center mb-8 border-b border-orange-900/20 pb-4">
                    <h2 class="orbitron text-lg text-white tracking-widest flex items-center gap-3">
                        LOBBY_FREQUENCIES
                        <span class="text-[10px] bg-orange-900/30 px-2 py-1 text-orange-500">LIVE SCAN</span>
                    </h2>
                    <button onclick="refreshLobby()" class="text-[10px] text-orange-500 hover:text-white border border-orange-500/30 px-3 py-1 uppercase transition">Sync Data</button>
                </div>
                
                <div id="lobby-list" class="space-y-4">
                    <!-- Dynamic Content -->
                </div>

                <!-- Background Decoration -->
                <div class="absolute bottom-0 right-0 opacity-5 pointer-events-none">
                    <span class="orbitron text-9xl font-bold text-orange-500">MARS</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 mars-glass border-orange-500 px-8 py-4 text-orange-500 orbitron text-sm transform translate-y-32 transition-all duration-300 z-[200]">
        SYSTEM MESSAGE
    </div>

    <script>
        const CHAIN_ID = "0x7EB"; 
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const CONTRACT_ADDR = "0x0b912a321801B2f6062b4BdC3d9763e643584074";

        const ABI = [
            "function createGame(bytes32 _hash) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function forceForfeit(uint256 _gameId) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timestamp, uint8 status)",
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;

        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                refreshLobby();
            } else {
                showToast("CRITICAL: NO INJECTED PROVIDER FOUND");
            }
        }

        async function connectWallet() {
            try {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID }] });
                } catch (err) {
                    if (err.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CHAIN_ID,
                                chainName: 'Martian Chain',
                                nativeCurrency: { name: 'EROL', symbol: 'EROL', decimals: 18 },
                                rpcUrls: [RPC_URL],
                                blockExplorerUrls: ['https://explorer.martianchain.com/']
                            }],
                        });
                    }
                }

                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                document.getElementById('user-address').innerText = userAddress.toLowerCase();
                
                updateBalance();
                refreshLobby();
                showToast("UPLINK ESTABLISHED");
            } catch (err) {
                showToast("UPLINK FAILED");
            }
        }

        async function updateBalance() {
            const balance = await provider.getBalance(userAddress);
            document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $EROL`;
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        async function handleCreateGame() {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (selectedMoveIdx === 0) return showToast("SELECT TACTICAL MOVE");
            
            const wager = document.getElementById('wager-amount').value;
            const salt = ethers.hexlify(ethers.randomBytes(16));
            
            const hash = ethers.solidityPackedKeccak256(
                ["uint8", "string", "address"],
                [selectedMoveIdx, salt, userAddress]
            );

            try {
                showToast("ENCRYPTING SIGNAL...");
                const tx = await contract.createGame(hash, { value: ethers.parseEther(wager) });
                
                const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
                secrets[tx.hash] = { move: selectedMoveIdx, salt: salt };
                localStorage.setItem('martian_gambits', JSON.stringify(secrets));

                await tx.wait();
                showToast("SIGNAL DEPLOYED TO L1");
                updateBalance();
                refreshLobby();
            } catch (err) {
                showToast("DEPLOYMENT ABORTED");
            }
        }

        async function refreshLobby() {
            if (!contract) return;
            const lobby = document.getElementById('lobby-list');
            lobby.innerHTML = '<div class="text-center py-20 animate-pulse text-orange-900 uppercase tracking-widest">Re-Scanning Sector Frequencies...</div>';

            try {
                const counterBig = await contract.gameCounter();
                const counter = Number(counterBig);
                const gamePromises = [];
                const maxItems = 12;
                const start = counter > maxItems ? counter - (maxItems - 1) : 1;

                for (let i = counter; i >= start; i--) {
                    // Added catch to prevent one failed fetch from breaking the whole lobby
                    gamePromises.push(contract.games(i).then(g => ({ ...g, id: i })).catch(e => null));
                }

                const results = await Promise.all(gamePromises);
                const games = results.filter(g => g !== null);

                if (games.length === 0) {
                    lobby.innerHTML = '<div class="text-center py-20 text-orange-900/50 uppercase italic tracking-tighter">No signals detected in this sector.</div>';
                    return;
                }

                lobby.innerHTML = "";
                games.forEach(game => {
                    const isHost = userAddress && game.host.toLowerCase() === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger.toLowerCase() === userAddress.toLowerCase();
                    
                    // Filter out resolved games that don't involve the user to keep the lobby clean
                    if (Number(game.status) > 1 && !isHost && !isChallenger) return;

                    const div = document.createElement('div');
                    div.className = "p-4 bg-black/40 border-l-2 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:bg-black/60 " + (Number(game.status) == 0 ? "border-orange-500" : "border-gray-800");
                    
                    div.innerHTML = `
                        <div class="flex-1 w-full md:w-auto">
                            <div class="flex items-center gap-3 mb-1">
                                <span class="text-[9px] px-2 py-0.5 border ${Number(game.status) == 0 ? 'border-orange-500 text-orange-500' : 'border-gray-700 text-gray-600'} uppercase tracking-widest">${getStatusText(Number(game.status))}</span>
                                <span class="text-[9px] text-orange-900/40">SIG_ID: ${game.id}</span>
                            </div>
                            <div class="orbitron text-white text-sm flex items-center gap-2">
                                <span class="text-orange-500">${ethers.formatEther(game.wager)} $EROL</span> 
                                <span class="text-orange-900 text-[10px]">//</span> 
                                <span class="text-xs text-gray-500 truncate max-w-[120px]">${game.host}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            ${getActionButtons(game, isHost, isChallenger)}
                        </div>
                    `;
                    lobby.appendChild(div);
                });
            } catch (err) {
                lobby.innerHTML = '<div class="text-center py-20 text-red-900 uppercase">Signal Interruption: Data Sync Failure</div>';
                console.error(err);
            }
        }

        function getActionButtons(game, isHost, isChallenger) {
            const status = Number(game.status);
            if (status === 0) {
                if (isHost) return `<button onclick="handleRefund(${game.id})" class="text-[9px] border border-gray-700 px-4 py-2 hover:bg-white/5 uppercase transition">Retract Signal</button>`;
                return `<button onclick="handleChallenge(${game.id})" class="btn-mars text-[10px] px-6 py-2">Intercept</button>`;
            }
            if (status === 1) {
                if (isHost) return `<button onclick="handleResolve(${game.id})" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Broadcast Resolve</button>`;
                return `<span class="text-[9px] text-orange-900 uppercase italic tracking-widest">In Combat...</span>`;
            }
            return `<span class="text-[9px] text-gray-700 uppercase">Deactivated</span>`;
        }

        async function handleChallenge(id) {
            if (!signer) return showToast("INITIALIZE UPLINK FIRST");
            const move = prompt("SELECT COMBAT MANEUVER: 1 (Solar), 2 (Oxygen), 3 (Dust)");
            if (![1, 2, 3].includes(Number(move))) return showToast("INVALID TACTIC");

            try {
                const g = await contract.games(id);
                showToast("TRANSMITTING INTERCEPT...");
                const tx = await contract.challengeGame(id, move, { value: g.wager });
                await tx.wait();
                showToast("INTERCEPT CONFIRMED");
                refreshLobby();
            } catch (err) {
                showToast("INTERCEPT FAILED");
            }
        }

        async function handleResolve(id) {
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            let mySecret = null;
            
            // Search through stored transactions for the move/salt
            for (let txHash in secrets) {
                // If we want to be more precise we could map id to hash, but this works for single user
                mySecret = secrets[txHash];
                break;
            }
            
            if (!mySecret) {
                const move = prompt("MANUAL RECOVERY: Move (1-3)");
                const salt = prompt("MANUAL RECOVERY: Salt Hex");
                mySecret = { move, salt };
            }

            try {
                showToast("BROADCASTING RESOLUTION...");
                const tx = await contract.resolveGame(id, mySecret.move, mySecret.salt);
                await tx.wait();
                showToast("SIGNAL RESOLVED");
                refreshLobby();
            } catch (err) {
                showToast("PROTOCOL ERROR: HASH MISMATCH");
            }
        }

        async function handleRefund(id) {
            try {
                showToast("RETRACTING SIGNAL...");
                const tx = await contract.refundUnchallenged(id);
                await tx.wait();
                showToast("ENERGY RECLAIMED");
                refreshLobby();
            } catch (err) {
                showToast("RETRACTION FAILED");
            }
        }

        function getStatusText(s) { return ["Freq Open", "Challenged", "Resolved", "Refunded", "Forfeited"][s]; }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        }

        window.onload = init;
    </script>
</body>
</html>
