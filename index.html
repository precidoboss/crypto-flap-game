<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit | Mission Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-orange: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --glow: rgba(255, 77, 0, 0.3);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(255, 77, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 77, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .mars-border-glow {
            border: 1px solid var(--mars-orange);
            box-shadow: 0 0 10px var(--glow);
        }

        .btn-mars {
            background: var(--mars-orange);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .btn-mars:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow);
            transform: scale(1.02);
        }

        .move-select {
            border: 1px solid #333;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .move-select.selected {
            border-color: var(--mars-orange);
            filter: grayscale(0);
            background: rgba(255, 77, 0, 0.1);
            box-shadow: inset 0 0 10px var(--glow);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(255, 77, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 100;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--habitat-bg); }
        ::-webkit-scrollbar-thumb { background: var(--mars-orange); }

        .tab-btn {
            color: #666;
            background: transparent;
        }

        .tab-btn:hover {
            color: var(--mars-orange);
        }

        .tab-btn.active {
            color: var(--mars-orange);
            background: rgba(255, 77, 0, 0.1);
            border-bottom: 2px solid var(--mars-orange);
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="scanline"></div>

    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-4 border-b border-orange-900/30">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 mars-border-glow flex items-center justify-center bg-black">
                <span class="text-orange-500 text-2xl font-bold">M</span>
            </div>
            <div>
                <h1 class="orbitron text-2xl font-bold text-orange-500 tracking-widest">MARTIAN GAMBIT</h1>
                <p class="text-[10px] text-orange-800 uppercase tracking-[0.2em]">Sector 2027 // EROL Protocol</p>
            </div>
        </div>

        <div class="flex items-center gap-6 mt-4 md:mt-0">
            <!-- Navigation Tabs -->
            <div class="flex gap-1 bg-black/40 p-1 border border-orange-900/30">
                <button onclick="switchTab('lobby')" id="tab-lobby" class="tab-btn active px-4 py-2 text-[10px] uppercase transition">Lobby</button>
                <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Profile</button>
                <button onclick="switchTab('howto')" id="tab-howto" class="tab-btn px-4 py-2 text-[10px] uppercase transition">How to Play</button>
            </div>

            <div id="connection-interface">
                <button id="connect-btn" class="btn-mars px-8 py-2">Initialize Uplink</button>
                <div id="account-info" class="hidden flex items-center gap-4">
                    <div class="text-right">
                        <div id="user-address" class="text-[10px] text-orange-400 opacity-70"></div>
                        <div id="user-balance" class="orbitron text-orange-500 font-bold">0.00 $EROL</div>
                    </div>
                    <div class="h-10 w-1 bg-orange-500"></div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto">
        <!-- LOBBY PAGE -->
        <div id="page-lobby" class="page-section active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <aside class="lg:col-span-4 space-y-6">
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm text-orange-500 mb-6 flex items-center gap-2">
                            <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                            COMMENCE SIGNAL DEPLOYMENT
                        </h2>

                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <button onclick="selectMove(1)" id="move-1" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                                <span class="text-[9px] uppercase">Solar</span>
                            </button>
                            <button onclick="selectMove(2)" id="move-2" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå¨Ô∏è</span>
                                <span class="text-[9px] uppercase">Oxygen</span>
                            </button>
                            <button onclick="selectMove(3)" id="move-3" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå™Ô∏è</span>
                                <span class="text-[9px] uppercase">Dust</span>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-orange-800 uppercase mb-2 block">Energy Stake ($EROL)</label>
                                <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron">
                            </div>
                            <button id="create-btn" onclick="handleCreateGame()" class="btn-mars w-full py-4 text-lg">Deploy Signal</button>
                            <button onclick="debugInfo()" class="w-full py-2 text-[9px] border border-orange-900/30 text-orange-700 hover:text-orange-500 uppercase">Debug Info</button>
                        </div>
                    </div>
                </aside>

                <section class="lg:col-span-8">
                    <div class="mars-glass p-6 min-h-[500px] relative overflow-hidden">
                        <div class="flex justify-between items-center mb-8 border-b border-orange-900/20 pb-4">
                            <h2 class="orbitron text-lg text-white tracking-widest flex items-center gap-3">
                                LOBBY_FREQUENCIES
                                <span class="text-[10px] bg-orange-900/30 px-2 py-1 text-orange-500">FAST INDEX</span>
                            </h2>
                            <button onclick="refreshLobby()" class="text-[10px] text-orange-500 hover:text-white border border-orange-500/30 px-3 py-1 uppercase transition">Sync Data</button>
                        </div>
                        <div id="lobby-list" class="space-y-4"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="page-profile" class="page-section">
            <div class="mars-glass p-8 max-w-5xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-8 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    PILOT STATISTICS
                </h2>
                <div id="profile-content" class="space-y-6"></div>
            </div>
        </div>

        <!-- HOW TO PLAY PAGE -->
        <div id="page-howto" class="page-section">
            <div class="mars-glass p-8 max-w-4xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-8">MISSION BRIEFING</h2>
                
                <div class="space-y-8 text-gray-300">
                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">üéØ OBJECTIVE</h3>
                        <p class="leading-relaxed">Martian Gambit is a high-stakes Rock-Paper-Scissors style game on the Martian Chain. Players bet $EROL tokens and compete using three strategic moves. The winner takes the pot (minus a small fee).</p>
                    </section>

                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">‚öîÔ∏è THE THREE MOVES</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-black/40 p-4 border border-orange-900/30">
                                <div class="text-4xl mb-2">‚òÄÔ∏è</div>
                                <div class="orbitron text-orange-500 mb-1">SOLAR FLARE</div>
                                <div class="text-[11px] text-gray-400">Beats Oxygen Siphon</div>
                            </div>
                            <div class="bg-black/40 p-4 border border-orange-900/30">
                                <div class="text-4xl mb-2">üå¨Ô∏è</div>
                                <div class="orbitron text-orange-500 mb-1">OXYGEN SIPHON</div>
                                <div class="text-[11px] text-gray-400">Beats Dust Storm</div>
                            </div>
                            <div class="bg-black/40 p-4 border border-orange-900/30">
                                <div class="text-4xl mb-2">üå™Ô∏è</div>
                                <div class="orbitron text-orange-500 mb-1">DUST STORM</div>
                                <div class="text-[11px] text-gray-400">Beats Solar Flare</div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">üìã HOW TO PLAY</h3>
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">1.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Deploy Signal (Host)</div>
                                    <p class="text-sm text-gray-400">Select your move and wager amount. Your move is encrypted and stored locally. Click "Deploy Signal" to create the game.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">2.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Intercept (Challenger)</div>
                                    <p class="text-sm text-gray-400">Find an open game in the lobby and click "Intercept". Choose your move and match the wager amount.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">3.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Broadcast Reveal (Host)</div>
                                    <p class="text-sm text-gray-400">Once intercepted, click "Broadcast Reveal" to reveal your move. The smart contract determines the winner automatically.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">4.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Victory or Defeat</div>
                                    <p class="text-sm text-gray-400">Winner takes 97% of the pot. 1.5% goes to treasury, 1.5% is burned. In case of a draw, both players get their wager back minus 1.5% fee each.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">‚ö†Ô∏è IMPORTANT NOTES</h3>
                        <ul class="space-y-2 text-sm text-gray-400">
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> You must use the same browser/device to reveal your move (secret is stored locally)</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> If host doesn't reveal within 15 minutes, challenger can claim victory</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> If no one intercepts within 15 minutes, host can retract their wager</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> All games are on-chain and provably fair via cryptographic commitments</li>
                        </ul>
                    </section>

                    <section class="bg-orange-900/10 border border-orange-500/30 p-6">
                        <h3 class="orbitron text-orange-500 text-lg mb-3">üí∞ FEES & PAYOUTS</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Winner Payout:</span><span class="text-orange-500">97% of pot</span></div>
                            <div class="flex justify-between"><span>Treasury Fee:</span><span class="text-orange-500">1.5%</span></div>
                            <div class="flex justify-between"><span>Burn Amount:</span><span class="text-orange-500">1.5%</span></div>
                            <div class="flex justify-between"><span>Draw (each player):</span><span class="text-orange-500">Wager - 1.5%</span></div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 mars-glass border-orange-500 px-8 py-4 text-orange-500 orbitron text-sm transform translate-y-32 transition-all duration-300 z-[200]">
        SYSTEM MESSAGE
    </div>

    <script>
        const CHAIN_ID = "0x7EB"; 
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const CONTRACT_ADDR = "0x0b912a321801B2f6062b4BdC3d9763e643584074";
        
        // Supabase Configuration
        const SB_URL = "https://tvckbtgggsuwxtlgilcl.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2Y2tidGdnZ3N1d3h0bGdpbGNsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDY2NDY0NSwiZXhwIjoyMDg2MjQwNjQ1fQ.DhvGNo3seKoRtDmeRod0gAP48yFZw_0-kAvY3eT_554"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const ABI = [
            "function createGame(bytes32 _hash) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timestamp, uint8 status)",
            "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager, bytes32 commitHash)"
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;

        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                refreshLobby();
                
                _supabase.channel('game_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, () => refreshLobby())
                    .subscribe();

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if ("0x" + network.chainId.toString(16).toUpperCase() !== CHAIN_ID.toUpperCase()) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID }],
                    });
                } catch (switchError) {
                    showToast("SWITCH TO MARTIAN NETWORK");
                    return false;
                }
            }
            return true;
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                
                if (!(await checkNetwork())) return;

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                document.getElementById('user-address').innerText = userAddress.toLowerCase();
                updateBalance();
                refreshLobby();
            } catch (err) { 
                console.error(err);
                showToast("UPLINK FAILED"); 
            }
        }

        async function updateBalance() {
            if (!userAddress || !provider) return;
            try {
                const balance = await provider.getBalance(userAddress);
                document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $EROL`;
            } catch (e) { console.error("Balance fetch error", e); }
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        async function handleCreateGame() {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (selectedMoveIdx === 0) return showToast("SELECT TACTICAL MOVE");
            if (!(await checkNetwork())) return;
            
            const wagerInput = document.getElementById('wager-amount').value;
            const wagerValue = ethers.parseEther(wagerInput);
            const salt = ethers.hexlify(ethers.randomBytes(32)); // Use 32 bytes for better entropy
            
            // CRITICAL: Must match Solidity's keccak256(abi.encodePacked(move, salt, host))
            // We need to encode exactly as Solidity does
            const abiCoder = ethers.AbiCoder.defaultAbiCoder();
            
            // Solidity abi.encodePacked with uint8, string, address
            const encoded = ethers.solidityPacked(
                ["uint8", "string", "address"],
                [selectedMoveIdx, salt, userAddress]
            );
            const hash = ethers.keccak256(encoded);
            
            console.log("=== GAME CREATION DEBUG ===");
            console.log("Move:", selectedMoveIdx);
            console.log("Salt:", salt);
            console.log("Address:", userAddress);
            console.log("Generated Hash:", hash);

            try {
                showToast("ENCRYPTING SIGNAL...");
                const tx = await contract.createGame(hash, { value: wagerValue });
                
                showToast("WAITING FOR CONFIRMATION...");
                const receipt = await tx.wait();
                
                // Save secret locally
                const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
                secrets[hash] = { move: selectedMoveIdx, salt: salt };
                localStorage.setItem('martian_gambits', JSON.stringify(secrets));
                
                console.log("Secret saved:", { hash, move: selectedMoveIdx, salt });

                let gameId;
                // Method 1: Try parsing logs with proper error handling
                try {
                    for (const log of receipt.logs) {
                        try {
                            // Check if log is from our contract
                            if (log.address.toLowerCase() !== CONTRACT_ADDR.toLowerCase()) continue;
                            
                            const parsed = contract.interface.parseLog({
                                topics: log.topics,
                                data: log.data
                            });
                            
                            if (parsed && parsed.name === 'GameCreated') {
                                gameId = Number(parsed.args.gameId);
                                console.log("Game ID from event:", gameId);
                                break;
                            }
                        } catch(e) { 
                            // Skip logs that aren't GameCreated events
                            continue; 
                        }
                    }
                } catch (e) { 
                    console.warn("Log parsing failed:", e); 
                }

                // Method 2: Fallback to gameCounter
                if (gameId === undefined) {
                    try {
                        const counter = await contract.gameCounter();
                        gameId = Number(counter);
                        console.log("Game ID from counter:", gameId);
                    } catch (e) {
                        console.error("Counter fetch failed:", e);
                        throw new Error("Unable to determine game ID");
                    }
                }

                // INDEX TO SUPABASE
                const { error: sbError } = await _supabase.from('games').insert([{
                    game_id: gameId,
                    host: userAddress.toLowerCase(),
                    wager: wagerInput,
                    status: 0,
                    commit_hash: hash
                }]);

                if (sbError) console.error("Supabase insert error:", sbError);

                showToast("SIGNAL DEPLOYED");
                setTimeout(refreshLobby, 1000);
            } catch (err) { 
                console.error("Game Creation Error:", err);
                showToast("DEPLOYMENT ABORTED"); 
            }
        }

        async function refreshLobby() {
            const lobby = document.getElementById('lobby-list');
            try {
                const { data: games, error } = await _supabase.from('games')
                    .select('*').order('game_id', { ascending: false }).limit(30);

                if (error) {
                    console.error("Supabase Fetch Error:", error);
                    lobby.innerHTML = `<div class="text-center py-20 text-red-500 uppercase">Indexing Error</div>`;
                    return;
                }

                lobby.innerHTML = games.length ? "" : '<div class="text-center py-20 opacity-30 uppercase italic">No signals detected...</div>';

                games.forEach(game => {
                    const status = Number(game.status);
                    const isHost = userAddress && game.host === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                    
                    // Only show resolved games if you participated
                    if (status > 1 && !isHost && !isChallenger) return;

                    const div = document.createElement('div');
                    div.className = "p-4 bg-black/40 border-l-2 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:bg-black/60 " + (status == 0 ? "border-orange-500" : status == 1 ? "border-yellow-500" : status == 2 ? "border-green-700" : "border-gray-800");
                    
                    let gameInfo = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] px-2 py-0.5 border ${status == 0 ? 'border-orange-500 text-orange-500' : status == 1 ? 'border-yellow-500 text-yellow-500' : status == 2 ? 'border-green-500 text-green-500' : 'border-gray-700 text-gray-500'} uppercase">${getStatusText(status)}</span>
                                <span class="text-[9px] text-orange-900/40">ID: ${game.game_id}</span>
                            </div>
                            <div class="orbitron text-white text-sm">
                                <span class="text-orange-500">${game.wager} $EROL</span> 
                                <span class="text-gray-600 text-[10px] ml-2">FROM ${game.host.slice(0,6)}...</span>`;
                    
                    // Show moves and winner for resolved games
                    if (status == 2 && game.host_move && game.challenger_move) {
                        const moves = ['', '‚òÄÔ∏è Solar', 'üå¨Ô∏è Oxygen', 'üå™Ô∏è Dust'];
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        
                        let winner = '';
                        if (hostMove === challengerMove) {
                            winner = '‚öñÔ∏è DRAW';
                        } else if (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        ) {
                            winner = `üèÜ ${game.host.slice(0,6)}... WINS`;
                        } else {
                            winner = `üèÜ ${game.challenger.slice(0,6)}... WINS`;
                        }
                        
                        gameInfo += `
                            <div class="text-[10px] mt-1 text-gray-400">
                                Host: ${moves[hostMove]} vs Challenger: ${moves[challengerMove]}
                            </div>
                            <div class="text-[11px] mt-1 font-bold ${hostMove === challengerMove ? 'text-yellow-500' : 'text-green-500'}">
                                ${winner}
                            </div>`;
                    }
                    
                    gameInfo += `
                            </div>
                        </div>
                        <div class="flex gap-2">${getActionButtons(game, isHost, isChallenger)}</div>`;
                    
                    div.innerHTML = gameInfo;
                    lobby.appendChild(div);
                });
            } catch (err) { 
                console.error("Lobby Refresh Catch:", err);
            }
        }

        function getActionButtons(game, isHost, isChallenger) {
            if (game.status == 0) {
                // Only show retract button if you're actually the host
                if (isHost) {
                    return `<button onclick="handleRefund(${game.game_id})" class="text-[9px] border border-gray-700 px-4 py-2 hover:bg-white/5 uppercase">Retract</button>`;
                }
                // Don't allow challenging your own game
                if (userAddress && game.host === userAddress.toLowerCase()) {
                    return `<span class="text-[9px] text-gray-500 uppercase italic">Your Signal</span>`;
                }
                return `<button onclick="handleChallenge(${game.game_id}, '${game.wager}')" class="btn-mars text-[10px] px-6 py-2">Intercept</button>`;
            }
            if (game.status == 1) {
                if (isHost) {
                    return `<button onclick="handleResolve(${game.game_id}, '${game.commit_hash}')" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Broadcast Reveal</button>`;
                }
                if (isChallenger) {
                    return `<span class="text-[9px] text-orange-500 uppercase italic">‚öîÔ∏è Awaiting Host Reveal...</span>`;
                }
                return `<span class="text-[9px] text-orange-900 uppercase italic">Combat Active</span>`;
            }
            if (game.status == 2) {
                return `<span class="text-[9px] text-green-500 uppercase">‚úì Resolved</span>`;
            }
            if (game.status == 3) {
                return `<span class="text-[9px] text-gray-600 uppercase">Refunded</span>`;
            }
            return `<span class="text-[9px] text-gray-700 uppercase">Inactive</span>`;
        }

        async function handleChallenge(id, wager) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const move = prompt("1-Solar, 2-Oxygen, 3-Dust");
            if (!move || move < 1 || move > 3) return showToast("INVALID MOVE");
            
            try {
                showToast("INTERCEPTING...");
                
                // Fetch actual wager from contract to ensure exact match
                const gameData = await contract.games(id);
                const actualWager = gameData.wager;
                
                console.log("Challenging game", id, "with move", move, "and wager", ethers.formatEther(actualWager));
                
                const tx = await contract.challengeGame(id, move, { value: actualWager });
                showToast("CONFIRMING TRANSACTION...");
                const receipt = await tx.wait();
                
                console.log("Challenge successful, receipt:", receipt);
                
                // Update Supabase with challenger info
                const { data: updateData, error: updateError } = await _supabase
                    .from('games')
                    .update({ 
                        status: 1, 
                        challenger: userAddress.toLowerCase(),
                        challenger_move: parseInt(move)
                    })
                    .eq('game_id', id)
                    .select();
                
                if (updateError) {
                    console.error("Supabase update error:", updateError);
                    showToast("‚ö†Ô∏è INTERCEPTED BUT DB UPDATE FAILED");
                } else {
                    console.log("Supabase updated:", updateData);
                    showToast("‚úì SIGNAL INTERCEPTED");
                }
                
                // Force refresh after delay
                setTimeout(refreshLobby, 1500);
            } catch (err) { 
                console.error("Challenge error:", err);
                showToast("INTERCEPTION FAILED"); 
            }
        }

        async function handleResolve(id, hash) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            console.log("=== RESOLVE DEBUG ===");
            console.log("Game ID:", id);
            console.log("Commit Hash:", hash);
            
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            console.log("All stored secrets:", Object.keys(secrets));
            
            let secret = secrets[hash];
            
            // If secret not found, offer manual input
            if (!secret) {
                console.error("Secret not found for hash:", hash);
                const manualReveal = confirm("Secret not found in localStorage. Do you want to manually enter your move and salt?");
                
                if (manualReveal) {
                    const move = prompt("Enter your original move (1-Solar, 2-Oxygen, 3-Dust):");
                    const salt = prompt("Enter your salt (hex string starting with 0x):");
                    
                    if (!move || !salt) {
                        showToast("CANCELLED");
                        return;
                    }
                    
                    // Verify the hash matches using same method as contract
                    const encoded = ethers.solidityPacked(
                        ["uint8", "string", "address"],
                        [parseInt(move), salt, userAddress]
                    );
                    const testHash = ethers.keccak256(encoded);
                    
                    console.log("Manual hash:", testHash);
                    console.log("Expected hash:", hash);
                    
                    if (testHash.toLowerCase() !== hash.toLowerCase()) {
                        showToast("‚ö†Ô∏è HASH MISMATCH - WRONG MOVE/SALT");
                        console.error("Hash verification failed!");
                        return;
                    }
                    
                    secret = { move: parseInt(move), salt: salt };
                    console.log("Using manual secret:", secret);
                } else {
                    showToast("‚ö†Ô∏è SECRET NOT FOUND - USE SAME BROWSER");
                    return;
                }
            }
            
            console.log("Using secret - Move:", secret.move, "Salt:", secret.salt);
            
            // Verify hash locally before sending transaction
            const encoded = ethers.solidityPacked(
                ["uint8", "string", "address"],
                [secret.move, secret.salt, userAddress]
            );
            const verifyHash = ethers.keccak256(encoded);
            
            console.log("Verification hash:", verifyHash);
            console.log("Expected hash:", hash);
            console.log("Hashes match:", verifyHash.toLowerCase() === hash.toLowerCase());
            
            if (verifyHash.toLowerCase() !== hash.toLowerCase()) {
                showToast("‚ö†Ô∏è LOCAL HASH VERIFICATION FAILED");
                console.error("Hash mismatch - secret may be corrupted");
                console.error("Move:", secret.move, "Salt:", secret.salt, "Address:", userAddress);
                return;
            }
            
            try {
                showToast("BROADCASTING REVEAL...");
                console.log("Calling resolveGame with:", {
                    gameId: id,
                    move: secret.move,
                    salt: secret.salt
                });
                
                const tx = await contract.resolveGame(id, secret.move, secret.salt);
                showToast("CONFIRMING TRANSACTION...");
                const receipt = await tx.wait();
                
                console.log("Resolve transaction confirmed:", receipt);
                
                // Fetch game data to determine winner
                const gameData = await contract.games(id);
                const hostMove = Number(gameData.hostMove);
                const challengerMove = Number(gameData.challengerMove);
                
                console.log("Game resolved - Host:", hostMove, "Challenger:", challengerMove);
                
                let resultMsg = "COMBAT RESOLVED";
                // Rock-Paper-Scissors logic matching contract:
                // 1 (SolarFlare) beats 2 (OxygenSiphon)
                // 2 (OxygenSiphon) beats 3 (DustStorm) 
                // 3 (DustStorm) beats 1 (SolarFlare)
                if (hostMove === challengerMove) {
                    resultMsg = "‚öñÔ∏è DRAW - FUNDS SPLIT";
                } else if (
                    (hostMove === 1 && challengerMove === 2) ||
                    (hostMove === 2 && challengerMove === 3) ||
                    (hostMove === 3 && challengerMove === 1)
                ) {
                    resultMsg = "üèÜ VICTORY - YOU WIN!";
                } else {
                    resultMsg = "üí• DEFEAT - CHALLENGER WINS";
                }
                
                const { data: updateData, error: updateError } = await _supabase
                    .from('games')
                    .update({ 
                        status: 2,
                        host_move: hostMove,
                        challenger_move: challengerMove
                    })
                    .eq('game_id', id)
                    .select();
                
                if (updateError) {
                    console.error("Supabase update error:", updateError);
                } else {
                    console.log("Supabase updated:", updateData);
                }
                
                setTimeout(refreshLobby, 1000);
                updateBalance();
                showToast(resultMsg);
            } catch (err) { 
                console.error("Resolve error:", err);
                console.error("Full error object:", JSON.stringify(err, null, 2));
                
                if (err.message && err.message.includes("Already resolved")) {
                    showToast("ALREADY RESOLVED");
                } else if (err.reason) {
                    showToast("ERROR: " + err.reason.toUpperCase());
                } else if (err.message) {
                    showToast("ERROR: " + err.message.slice(0, 50));
                } else {
                    showToast("RESOLVE FAILED - CHECK CONSOLE"); 
                }
            }
        }

        async function handleRefund(id) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            try {
                showToast("RETRACTING SIGNAL...");
                const tx = await contract.refundUnchallenged(id);
                showToast("WAITING FOR CONFIRMATION...");
                await tx.wait();
                
                await _supabase.from('games').update({ status: 3 }).eq('game_id', id);
                refreshLobby();
                updateBalance();
                showToast("FUNDS RETRACTED");
            } catch (err) { 
                console.error(err);
                showToast("REFUND FAILED"); 
            }
        }

        function getStatusText(s) { return ["Open", "Intercepted", "Resolved", "Refunded", "Forfeited"][s]; }
        
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Update page sections
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`page-${tab}`).classList.add('active');
            
            // Load profile data if switching to profile
            if (tab === 'profile') {
                loadProfile();
            }
        }
        
        async function loadProfile() {
            const profileContent = document.getElementById('profile-content');
            
            if (!userAddress) {
                profileContent.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-orange-900 text-6xl mb-4">üîí</div>
                        <div class="text-orange-500 orbitron text-lg mb-2">UPLINK REQUIRED</div>
                        <div class="text-gray-500 text-sm">Connect your wallet to view pilot statistics</div>
                    </div>`;
                return;
            }
            
            profileContent.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-orange-500 animate-pulse">Loading pilot data...</div>
                </div>`;
            
            try {
                // Fetch all games for this user
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .or(`host.eq.${userAddress.toLowerCase()},challenger.eq.${userAddress.toLowerCase()}`)
                    .order('game_id', { ascending: false });
                
                if (error) {
                    console.error("Profile fetch error:", error);
                    profileContent.innerHTML = `<div class="text-red-500">Error loading profile data</div>`;
                    return;
                }
                
                // Calculate stats
                let totalGames = 0;
                let wins = 0;
                let losses = 0;
                let draws = 0;
                let totalWagered = 0;
                let totalWon = 0;
                let totalLost = 0;
                
                const recentGames = [];
                
                games.forEach(game => {
                    const isHost = game.host === userAddress.toLowerCase();
                    const wager = parseFloat(game.wager);
                    
                    if (game.status === 2 && game.host_move && game.challenger_move) {
                        totalGames++;
                        totalWagered += wager;
                        
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        
                        let result = '';
                        if (hostMove === challengerMove) {
                            draws++;
                            result = 'DRAW';
                            totalWon += wager * 0.985; // Get back wager minus 1.5% fee
                            totalLost += wager * 0.015;
                        } else {
                            const hostWins = (
                                (hostMove === 1 && challengerMove === 2) ||
                                (hostMove === 2 && challengerMove === 3) ||
                                (hostMove === 3 && challengerMove === 1)
                            );
                            
                            if ((isHost && hostWins) || (!isHost && !hostWins)) {
                                wins++;
                                result = 'WIN';
                                totalWon += wager * 2 * 0.97; // Winner gets 97% of pot
                            } else {
                                losses++;
                                result = 'LOSS';
                                totalLost += wager;
                            }
                        }
                        
                        recentGames.push({ ...game, result, isHost });
                    }
                });
                
                const netPnL = totalWon - totalWagered;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                
                // Render profile
                profileContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-black/40 border border-orange-900/30 p-6 text-center">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Total Games</div>
                            <div class="orbitron text-3xl text-orange-500">${totalGames}</div>
                        </div>
                        <div class="bg-black/40 border border-green-900/30 p-6 text-center">
                            <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                            <div class="orbitron text-3xl text-green-500">${wins}</div>
                        </div>
                        <div class="bg-black/40 border border-red-900/30 p-6 text-center">
                            <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                            <div class="orbitron text-3xl text-red-500">${losses}</div>
                        </div>
                        <div class="bg-black/40 border border-yellow-900/30 p-6 text-center">
                            <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                            <div class="orbitron text-3xl text-yellow-500">${draws}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-black/40 border border-orange-900/30 p-6">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Win Rate</div>
                            <div class="orbitron text-2xl text-orange-500">${winRate}%</div>
                        </div>
                        <div class="bg-black/40 border border-orange-900/30 p-6">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Total Wagered</div>
                            <div class="orbitron text-2xl text-orange-500">${totalWagered.toFixed(2)} $EROL</div>
                        </div>
                        <div class="bg-black/40 border border-${netPnL >= 0 ? 'green' : 'red'}-900/30 p-6">
                            <div class="text-[10px] text-${netPnL >= 0 ? 'green' : 'red'}-800 uppercase mb-2">Net P&L</div>
                            <div class="orbitron text-2xl text-${netPnL >= 0 ? 'green' : 'red'}-500">${netPnL >= 0 ? '+' : ''}${netPnL.toFixed(2)} $EROL</div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <h3 class="orbitron text-orange-500 text-lg mb-4">RECENT BATTLES</h3>
                        <div class="space-y-3">
                            ${recentGames.slice(0, 10).map(game => {
                                const moves = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                                const opponent = game.isHost ? game.challenger : game.host;
                                return `
                                    <div class="bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-4 flex justify-between items-center">
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 uppercase">${game.result}</span>
                                                <span class="text-[9px] text-gray-600">Game #${game.game_id}</span>
                                            </div>
                                            <div class="text-sm">
                                                <span class="text-orange-500">${game.wager} $EROL</span>
                                                <span class="text-gray-600 text-[10px] ml-2">vs ${opponent ? opponent.slice(0,8) + '...' : 'Unknown'}</span>
                                            </div>
                                        </div>
                                        <div class="text-2xl">${game.isHost ? moves[game.host_move] : moves[game.challenger_move]}</div>
                                    </div>
                                `;
                            }).join('') || '<div class="text-center text-gray-600 py-8">No battles yet</div>'}
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error("Profile error:", err);
                profileContent.innerHTML = `<div class="text-red-500">Error: ${err.message}</div>`;
            }
        }
        
        function debugInfo() {
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            console.log("=== DEBUG INFO ===");
            console.log("Connected Address:", userAddress);
            console.log("Contract Address:", CONTRACT_ADDR);
            console.log("Supabase URL:", SB_URL);
            console.log("Stored Secrets Count:", Object.keys(secrets).length);
            console.log("");
            console.log("=== STORED SECRETS ===");
            
            if (Object.keys(secrets).length === 0) {
                console.log("No secrets stored! You need to create a game first.");
            } else {
                Object.entries(secrets).forEach(([hash, data]) => {
                    console.log(`Hash: ${hash}`);
                    console.log(`  Move: ${data.move} (${['', 'SolarFlare', 'OxygenSiphon', 'DustStorm'][data.move]})`);
                    console.log(`  Salt: ${data.salt}`);
                    
                    // Verify the hash using correct encoding
                    const encoded = ethers.solidityPacked(
                        ["uint8", "string", "address"],
                        [data.move, data.salt, userAddress]
                    );
                    const verifyHash = ethers.keccak256(encoded);
                    console.log(`  Verify: ${verifyHash.toLowerCase() === hash.toLowerCase() ? '‚úì Valid' : '‚úó INVALID'}`);
                    if (verifyHash.toLowerCase() !== hash.toLowerCase()) {
                        console.log(`  Expected: ${hash}`);
                        console.log(`  Got:      ${verifyHash}`);
                    }
                    console.log("");
                });
            }
            
            console.log("=== COPY THIS FOR MANUAL REVEAL ===");
            console.log("If you need to manually reveal on a different device:");
            console.log("Secrets JSON:", JSON.stringify(secrets, null, 2));
            
            alert("Debug info printed to console (F12)!\n\nSecrets stored: " + Object.keys(secrets).length);
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 4000);
        }
        
        window.onload = init;
    </script>
</body>
</html>
