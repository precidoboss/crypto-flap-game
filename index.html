<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit | Mission Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-orange: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --glow: rgba(255, 77, 0, 0.3);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(255, 77, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 77, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .mars-border-glow {
            border: 1px solid var(--mars-orange);
            box-shadow: 0 0 10px var(--glow);
        }

        .btn-mars {
            background: var(--mars-orange);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .btn-mars:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow);
            transform: scale(1.02);
        }

        .btn-mars:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-select {
            border: 1px solid #333;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .move-select.selected {
            border-color: var(--mars-orange);
            filter: grayscale(0);
            background: rgba(255, 77, 0, 0.1);
            box-shadow: inset 0 0 10px var(--glow);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(255, 77, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 100;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--habitat-bg); }
        ::-webkit-scrollbar-thumb { background: var(--mars-orange); }

        .tab-btn {
            color: #666;
            background: transparent;
        }

        .tab-btn:hover {
            color: var(--mars-orange);
        }

        .tab-btn.active {
            color: var(--mars-orange);
            background: rgba(255, 77, 0, 0.1);
            border-bottom: 2px solid var(--mars-orange);
        }

        .lobby-filter {
            color: #666;
            background: transparent;
        }

        .lobby-filter:hover {
            color: var(--mars-orange);
        }

        .lobby-filter.active {
            color: var(--mars-orange);
            background: rgba(255, 77, 0, 0.1);
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .copy-btn {
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            color: var(--mars-orange);
            transform: scale(1.1);
        }

        .header-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 2px solid var(--mars-orange);
        }

        .game-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .activity-feed {
            height: 500px;
            overflow-y: auto;
        }

        .lobby-row {
            cursor: pointer;
            transition: all 0.2s;
        }
        .lobby-row:hover {
            background: rgba(255, 77, 0, 0.05) !important;
            border-left-color: #ff6622 !important;
        }

        /* Match Detail Subpage */
        #page-match {
            display: none;
        }
        #page-match.active {
            display: block;
        }

        .stat-card {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,77,0,0.2);
            padding: 1.5rem;
            text-align: center;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 8px;
            bottom: 0;
            width: 1px;
            background: rgba(255,77,0,0.2);
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 0;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--mars-orange);
            border: 2px solid var(--habitat-bg);
        }
        .timeline-item:last-child::before {
            display: none;
        }

        /* Bridge iframe */
        .bridge-iframe {
            width: 100%;
            height: 750px;
            border: none;
            border-radius: 0 0 4px 4px;
        }

        /* Live countdown ticker */
        .countdown-tick {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
            transition: color 0.3s;
        }
        @keyframes blink-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .countdown-critical {
            animation: blink-red 0.8s ease-in-out infinite;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .header-banner {
                height: 120px;
            }
            .game-logo {
                width: 45px;
                height: 45px;
            }
            .chat-messages {
                height: 300px;
            }
            .bridge-iframe {
                height: 600px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="scanline"></div>

    <!-- Header Banner -->
    <div class="max-w-7xl mx-auto mb-4">
        <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-01_14-21-55.jpg" 
             alt="Martian Gambit Header" 
             class="header-banner"
             onerror="this.style.display='none'">
    </div>

    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-4 border-b border-orange-900/30">
        <div class="flex items-center gap-4">
            <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-01_14-13-33.jpg" 
                 alt="Martian Gambit Logo" 
                 class="game-logo"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-12 h-12 mars-border-glow hidden items-center justify-center bg-black">
                <span class="text-orange-500 text-2xl font-bold">M</span>
            </div>
            <div>
                <h1 class="orbitron text-2xl font-bold text-orange-500 tracking-widest">MARTIAN GAMBIT</h1>
                <p class="text-[10px] text-orange-800 uppercase tracking-[0.2em]">Sector 2027 // EROL Protocol</p>
            </div>
        </div>

        <div class="flex items-center gap-6 mt-4 md:mt-0">
            <div class="flex gap-1 bg-black/40 p-1 border border-orange-900/30 flex-wrap">
                <button onclick="switchTab('lobby')" id="tab-lobby" class="tab-btn active px-4 py-2 text-[10px] uppercase transition">Lobby</button>
                <button onclick="switchTab('leaderboard')" id="tab-leaderboard" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Leaderboard</button>
                <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Profile</button>
                <button onclick="switchTab('bridge')" id="tab-bridge" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Bridge</button>
                <button onclick="switchTab('howto')" id="tab-howto" class="tab-btn px-4 py-2 text-[10px] uppercase transition">How to Play</button>
            </div>

            <div id="connection-interface">
                <button id="connect-btn" class="btn-mars px-8 py-2">Initialize Uplink</button>
                <div id="account-info" class="hidden flex items-center gap-3">
                    <div class="text-right">
                        <div class="flex items-center gap-2">
                            <span id="user-address" class="text-[10px] text-orange-400 opacity-70"></span>
                            <button id="copy-address" class="copy-btn text-orange-400 text-xs" onclick="copyAddress()" title="Copy Address">üìã</button>
                        </div>
                        <div id="user-balance" class="orbitron text-orange-500 font-bold text-sm">0.00 $EROL</div>
                    </div>
                    <div class="h-10 w-1 bg-orange-500"></div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto">

        <!-- LOBBY PAGE -->
        <div id="page-lobby" class="page-section active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <aside class="lg:col-span-4 space-y-6">
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm text-orange-500 mb-6 flex items-center gap-2">
                            <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                            COMMENCE SIGNAL DEPLOYMENT
                        </h2>

                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <button onclick="selectMove(1)" id="move-1" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                                <span class="text-[9px] uppercase">Solar</span>
                            </button>
                            <button onclick="selectMove(2)" id="move-2" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå¨Ô∏è</span>
                                <span class="text-[9px] uppercase">Oxygen</span>
                            </button>
                            <button onclick="selectMove(3)" id="move-3" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå™Ô∏è</span>
                                <span class="text-[9px] uppercase">Dust</span>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-orange-800 uppercase mb-2 block">Energy Stake ($EROL)</label>
                                <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron">
                            </div>
                            <div>
                                <label class="text-[10px] text-orange-800 uppercase mb-2 block">Interception Timeout</label>
                                <select id="timeout-select" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron text-sm">
                                    <option value="300">5 Minutes</option>
                                    <option value="600">10 Minutes</option>
                                    <option value="900" selected>15 Minutes</option>
                                </select>
                            </div>
                            <button id="create-btn" onclick="handleCreateGame()" class="btn-mars w-full py-4 text-lg">Deploy Signal</button>
                            <button onclick="debugInfo()" class="w-full py-2 text-[9px] border border-orange-900/30 text-orange-700 hover:text-orange-500 uppercase">Debug Info</button>
                        </div>
                    </div>

                    <!-- Global Chat -->
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm text-orange-500 mb-4 flex items-center gap-2">
                            <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                            GLOBAL COMMS
                        </h2>
                        <div id="chat-messages" class="chat-messages mb-4 bg-black/40 border border-orange-900/30 p-3 space-y-2"></div>
                        <div class="flex gap-2">
                            <input id="chat-input" type="text" placeholder="Type message..." maxlength="200" class="flex-1 bg-black border border-orange-900/50 p-2 text-sm text-orange-500 focus:outline-none focus:border-orange-500" onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="btn-mars px-4 py-2 text-xs">Send</button>
                        </div>
                    </div>
                </aside>

                <section class="lg:col-span-8 space-y-6">
                    <div class="mars-glass p-6 min-h-[500px] relative overflow-hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-orange-900/20 pb-4 gap-4">
                            <h2 class="orbitron text-lg text-white tracking-widest flex items-center gap-3">
                                LOBBY_FREQUENCIES
                                <span class="text-[10px] bg-orange-900/30 px-2 py-1 text-orange-500">FAST INDEX</span>
                            </h2>
                            
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="flex gap-1 bg-black/40 p-1 border border-orange-900/30">
                                    <button onclick="setLobbyFilter('all')" id="filter-all" class="lobby-filter active px-3 py-1 text-[9px] uppercase transition">All</button>
                                    <button onclick="setLobbyFilter('open')" id="filter-open" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Open</button>
                                    <button onclick="setLobbyFilter('intercepted')" id="filter-intercepted" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Intercepted</button>
                                    <button onclick="setLobbyFilter('resolved')" id="filter-resolved" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Resolved</button>
                                </div>
                                <button onclick="refreshLobby()" class="text-[10px] text-orange-500 hover:text-white border border-orange-500/30 px-3 py-1 uppercase transition">Sync Data</button>
                            </div>
                        </div>
                        <div id="lobby-list" class="space-y-4"></div>
                    </div>

                    <!-- Live Activity Feed -->
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-lg text-white tracking-widest mb-6 flex items-center gap-3">
                            LIVE ACTIVITY FEED
                            <span class="w-2 h-2 bg-green-500 animate-pulse"></span>
                        </h2>
                        <div id="activity-feed" class="activity-feed space-y-2"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- MATCH DETAIL PAGE -->
        <div id="page-match" class="page-section">
            <div class="mb-4">
                <button onclick="goBackToLobby()" class="flex items-center gap-2 text-orange-500 hover:text-white text-sm uppercase transition border border-orange-900/30 px-4 py-2 hover:border-orange-500/50">
                    ‚Üê Back to Lobby
                </button>
            </div>
            <div id="match-detail-content"></div>
        </div>

        <!-- LEADERBOARD PAGE -->
        <div id="page-leaderboard" class="page-section">
            <div class="mars-glass p-8">
                <h2 class="orbitron text-2xl text-orange-500 mb-8 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    PILOT RANKINGS
                </h2>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-2">Total Wagered</div>
                        <div id="global-wagered" class="orbitron text-2xl text-orange-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-red-900/30 p-4 text-center">
                        <div class="text-[10px] text-red-800 uppercase mb-2">Burnt ($EROL)</div>
                        <div id="global-burnt" class="orbitron text-2xl text-red-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-blue-900/30 p-4 text-center">
                        <div class="text-[10px] text-blue-800 uppercase mb-2">Treasury</div>
                        <div id="global-treasury" class="orbitron text-2xl text-blue-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-green-900/30 p-4 text-center">
                        <div class="text-[10px] text-green-800 uppercase mb-2">Games Played</div>
                        <div id="global-games" class="orbitron text-2xl text-green-500">--</div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-orange-900/30">
                                <th class="text-left p-3 text-[10px] text-orange-800 uppercase">Rank</th>
                                <th class="text-left p-3 text-[10px] text-orange-800 uppercase">Pilot</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Wagered</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Win Rate</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Biggest Pot</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Win Streak</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="page-profile" class="page-section">
            <div class="mars-glass p-8 max-w-5xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-8 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    PILOT STATISTICS
                </h2>
                <div id="profile-content" class="space-y-6"></div>
            </div>
        </div>

        <!-- HOW TO PLAY PAGE -->
        <div id="page-howto" class="page-section">
            <div class="mars-glass p-8 max-w-4xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-8">MISSION BRIEFING</h2>
                
                <div class="space-y-8 text-gray-300">
                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">üéØ OBJECTIVE</h3>
                        <p class="leading-relaxed">Martian Gambit is a high-stakes Rock-Paper-Scissors style game on the Martian Chain. Players bet $EROL tokens and compete using three strategic moves. The winner takes the pot (minus a small fee).</p>
                    </section>

                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">‚öîÔ∏è THE THREE MOVES</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-black/40 p-4 border border-orange-900/30">
                                <div class="text-4xl mb-2">‚òÄÔ∏è</div>
                                <div class="orbitron text-orange-500 mb-1">SOLAR FLARE</div>
                                <div class="text-[11px] text-gray-400">Beats Oxygen Siphon</div>
                            </div>
                            <div class="bg-black/40 p-4 border border-orange-900/30">
                                <div class="text-4xl mb-2">üå¨Ô∏è</div>
                                <div class="orbitron text-orange-500 mb-1">OXYGEN SIPHON</div>
                                <div class="text-[11px] text-gray-400">Beats Dust Storm</div>
                            </div>
                            <div class="bg-black/40 p-4 border border-orange-900/30">
                                <div class="text-4xl mb-2">üå™Ô∏è</div>
                                <div class="orbitron text-orange-500 mb-1">DUST STORM</div>
                                <div class="text-[11px] text-gray-400">Beats Solar Flare</div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">üìã HOW TO PLAY</h3>
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">1.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Deploy Signal (Host)</div>
                                    <p class="text-sm text-gray-400">Select your move, wager amount, and timeout. Your move is encrypted and stored locally. Click "Deploy Signal" to create the game.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">2.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Intercept (Challenger)</div>
                                    <p class="text-sm text-gray-400">Find an open game in the lobby and click "Intercept". Choose your move and match the wager amount.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">3.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Broadcast Reveal (Host)</div>
                                    <p class="text-sm text-gray-400">Once intercepted, click "Broadcast Reveal" to reveal your move. The smart contract determines the winner automatically.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="orbitron text-orange-500 text-xl">4.</div>
                                <div>
                                    <div class="font-bold text-white mb-1">Victory or Defeat</div>
                                    <p class="text-sm text-gray-400">Winner takes 97% of the pot. 1.5% goes to treasury, 1.5% is burned. In case of a draw, both players get their wager back minus fees.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="orbitron text-orange-500 text-lg mb-3">‚ö†Ô∏è IMPORTANT NOTES</h3>
                        <ul class="space-y-2 text-sm text-gray-400">
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> You must use the same browser/device to reveal your move (secret is stored locally)</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> If host doesn't reveal within the timeout, challenger can force forfeit to claim victory</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> If no one intercepts within the timeout, host can retract their wager</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> Matches cannot be joined in the last 60 seconds before timeout</li>
                            <li class="flex gap-2"><span class="text-orange-500">‚Üí</span> All games are on-chain and provably fair via cryptographic commitments</li>
                        </ul>
                    </section>

                    <section class="bg-orange-900/10 border border-orange-500/30 p-6">
                        <h3 class="orbitron text-orange-500 text-lg mb-3">üí∞ FEES & PAYOUTS</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Winner Payout:</span><span class="text-orange-500">97% of pot</span></div>
                            <div class="flex justify-between"><span>Treasury Fee:</span><span class="text-orange-500">1.5%</span></div>
                            <div class="flex justify-between"><span>Burn Amount:</span><span class="text-orange-500">1.5%</span></div>
                            <div class="flex justify-between"><span>Draw (each player):</span><span class="text-orange-500">Wager - 3%</span></div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- BRIDGE PAGE -->
        <div id="page-bridge" class="page-section">
            <div class="mars-glass p-8 max-w-5xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-2 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    CROSS-CHAIN BRIDGE
                </h2>
                <p class="text-gray-500 text-sm mb-6">Transfer $EROL from Avalanche C-Chain to Martian Chain (1:1 ratio)</p>

                <!-- Info cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-1">Exchange Rate</div>
                        <div class="orbitron text-orange-500">1:1 $EROL</div>
                    </div>
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-1">Bridge Fee</div>
                        <div class="orbitron text-orange-500">Gas Only</div>
                    </div>
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-1">Min Amount</div>
                        <div class="orbitron text-orange-500">1 $EROL</div>
                    </div>
                </div>

                <!-- Contract addresses -->
                <div class="bg-black/40 border border-orange-900/20 p-4 mb-6 text-[11px] text-gray-600 flex flex-wrap gap-6">
                    <div>Bridge Contract: <span class="text-orange-600">0xF95B...1928</span></div>
                    <div>Token Address (AVAX): <span class="text-orange-600">0xCaC4...D037</span></div>
                    <div>Chain ID (Martian): <span class="text-orange-600">2027</span></div>
                </div>

                <!-- Bridge launch -->
                <div class="space-y-4">
                    <button onclick="openBridgeOverlay()" class="btn-mars w-full py-5 text-lg" style="clip-path:none;border-radius:2px;">
                        üåâ &nbsp; Launch Bridge Interface
                    </button>
                    <a href="https://bridge.martianchain.com/swap/" target="_blank" rel="noopener noreferrer"
                       class="block w-full py-3 text-center text-[11px] border border-orange-900/40 text-orange-700 hover:text-orange-500 hover:border-orange-500/50 uppercase transition tracking-widest">
                        Open Bridge in New Tab ‚Üó
                    </a>
                </div>

                <div class="mt-6 bg-orange-900/10 border border-orange-900/30 p-4 text-[11px] text-gray-500 space-y-1">
                    <div class="text-orange-600 font-bold uppercase mb-2">‚ö†Ô∏è Wallet Connection Note</div>
                    <div>‚Ä¢ Click "Launch Bridge Interface" to open the bridge in a full-screen floating window</div>
                    <div>‚Ä¢ Connect your wallet directly inside that window ‚Äî MetaMask will pop up normally</div>
                    <div>‚Ä¢ You can drag the window to reposition it</div>
                    <div>‚Ä¢ If MetaMask still doesn't appear, use "Open in New Tab" for full compatibility</div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bridge Full-Screen Overlay ‚Äî draggable floating window -->
    <div id="bridge-overlay" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px);">
        <div id="bridge-window" style="
            position:absolute;top:2%;left:50%;transform:translateX(-50%);
            width:min(960px,96vw);height:94vh;
            background:#0a0a0c;
            border:1px solid rgba(255,77,0,0.5);
            box-shadow:0 0 60px rgba(255,77,0,0.12),0 0 120px rgba(0,0,0,0.8);
            display:flex;flex-direction:column;border-radius:4px;overflow:hidden;
        ">
            <!-- Title bar / drag handle -->
            <div id="bridge-drag-handle" style="
                background:rgba(15,15,18,0.98);
                border-bottom:1px solid rgba(255,77,0,0.3);
                padding:10px 16px;
                display:flex;align-items:center;gap:10px;
                cursor:grab;user-select:none;flex-shrink:0;
            ">
                <span style="width:8px;height:8px;background:#ff4d00;border-radius:50%;display:inline-block;box-shadow:0 0 6px #ff4d00;"></span>
                <span style="font-family:'Orbitron',sans-serif;font-size:11px;color:#ff4d00;text-transform:uppercase;letter-spacing:0.15em;flex:1;">üåâ Martian Chain Bridge</span>
                <span style="font-size:9px;color:#444;text-transform:uppercase;letter-spacing:0.1em;">‚†ø Drag to move</span>
                <a href="https://bridge.martianchain.com/swap/" target="_blank" rel="noopener noreferrer"
                   style="font-size:9px;color:#664400;border:1px solid rgba(255,77,0,0.2);padding:3px 10px;text-transform:uppercase;text-decoration:none;letter-spacing:0.05em;transition:color 0.2s;"
                   onmouseover="this.style.color='#ff4d00';this.style.borderColor='rgba(255,77,0,0.5)'"
                   onmouseout="this.style.color='#664400';this.style.borderColor='rgba(255,77,0,0.2)'">
                    New Tab ‚Üó
                </a>
                <button onclick="closeBridgeOverlay()" style="
                    background:none;border:1px solid rgba(255,77,0,0.2);color:#555;
                    font-size:18px;cursor:pointer;padding:0 8px;line-height:1.4;
                    margin-left:4px;transition:color 0.2s,border-color 0.2s;
                " onmouseover="this.style.color='#ff4d00';this.style.borderColor='rgba(255,77,0,0.5)'"
                   onmouseout="this.style.color='#555';this.style.borderColor='rgba(255,77,0,0.2)'">√ó</button>
            </div>
            <!-- The bridge iframe ‚Äî loads lazily on open -->
            <iframe
                id="bridge-iframe"
                src="about:blank"
                style="flex:1;width:100%;border:none;"
                title="Martian Chain Bridge"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals allow-top-navigation allow-top-navigation-by-user-activation allow-downloads allow-storage-access-by-user-activation allow-pointer-lock"
                allow="ethereum; web3; clipboard-read; clipboard-write; payment"
            ></iframe>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content mars-glass p-8 w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="orbitron text-xl text-orange-500">PILOT PROFILE</h2>
                <button onclick="closePlayerModal()" class="text-2xl text-gray-500 hover:text-orange-500">&times;</button>
            </div>
            <div id="player-modal-content"></div>
        </div>
    </div>

    <!-- Challenge Move Modal -->
    <div id="challenge-modal" class="modal">
        <div class="modal-content mars-glass p-8 w-full" style="max-width:400px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="orbitron text-xl text-orange-500">SELECT YOUR MOVE</h2>
                <button onclick="closeChallengeModal()" class="text-2xl text-gray-500 hover:text-orange-500">&times;</button>
            </div>
            <div id="challenge-modal-content">
                <p class="text-gray-400 text-sm mb-6">Choose your interception move carefully, Commander.</p>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="selectChallengeMove(1)" id="cmove-1" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                        <span class="text-[9px] uppercase">Solar</span>
                    </button>
                    <button onclick="selectChallengeMove(2)" id="cmove-2" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå¨Ô∏è</span>
                        <span class="text-[9px] uppercase">Oxygen</span>
                    </button>
                    <button onclick="selectChallengeMove(3)" id="cmove-3" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå™Ô∏è</span>
                        <span class="text-[9px] uppercase">Dust</span>
                    </button>
                </div>
                <div id="challenge-wager-info" class="bg-black/40 border border-orange-900/30 p-3 mb-4 text-sm text-center">
                    <span class="text-gray-400">Wager required:</span>
                    <span id="challenge-wager-display" class="orbitron text-orange-500 ml-2">--</span>
                </div>
                <button onclick="confirmChallenge()" id="confirm-challenge-btn" class="btn-mars w-full py-3 text-sm" disabled>Confirm Interception</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 mars-glass border-orange-500 px-8 py-4 text-orange-500 orbitron text-sm transform translate-y-32 transition-all duration-300 z-[200]">
        SYSTEM MESSAGE
    </div>

    <script>
        const CHAIN_ID = "0x7EB"; 
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const CONTRACT_ADDR = "0x395E368045315062b26AC950690f384c98fDEEe2";
        
        const SB_URL = "https://tvckbtgggsuwxtlgilcl.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2Y2tidGdnZ3N1d3h0bGdpbGNsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDY2NDY0NSwiZXhwIjoyMDg2MjQwNjQ1fQ.DhvGNo3seKoRtDmeRod0gAP48yFZw_0-kAvY3eT_554"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const ABI = [
            "function createGame(bytes32 _hash, uint256 _timeout) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function forceForfeit(uint256 _gameId) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timeout, uint256 timestamp, uint8 status)",
            "function getTimeRemaining(uint256 _gameId) external view returns (uint256)",
            "function canForfeit(uint256 _gameId) external view returns (bool)",
            "function canRefund(uint256 _gameId) external view returns (bool)",
            "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager, uint256 timeout, bytes32 commitHash)",
            "event GameChallenged(uint256 indexed gameId, address indexed challenger)",
            "event GameResolved(uint256 indexed gameId, address winner, uint256 payout)"
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;
        let lobbyRefreshInterval, activityRefreshInterval, chatRefreshInterval;
        let currentLobbyFilter = 'all';

        // Challenge modal state
        let pendingChallengeId = null;
        let pendingChallengeWager = null;
        let selectedChallengeMove = 0;

        // ===========================
        // UTILITY: Time helpers
        // ===========================
        function getTimeRemaining(game) {
            const createdAt = new Date(game.created_at).getTime() / 1000;
            const timeout = game.timeout || 900;
            const deadline = createdAt + timeout;
            const now = Math.floor(Date.now() / 1000);
            return deadline - now;
        }

        function isExpired(game) {
            return getTimeRemaining(game) <= 0;
        }

        function isNearExpiry(game) {
            // Less than 60 seconds remaining ‚Äî too late to join
            return getTimeRemaining(game) < 60;
        }

        function formatCountdown(seconds) {
            if (seconds <= 0) return '00:00';
            const m = Math.floor(Math.max(0, seconds) / 60);
            const s = Math.max(0, seconds) % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // ===========================
        // INIT
        // ===========================
        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                
                await refreshLobby();
                await refreshActivityFeed();
                await refreshChat();
                
                lobbyRefreshInterval = setInterval(refreshLobby, 10000);
                activityRefreshInterval = setInterval(refreshActivityFeed, 5000);
                chatRefreshInterval = setInterval(refreshChat, 3000);
                
                _supabase.channel('game_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, () => {
                        refreshLobby();
                        refreshActivityFeed();
                    })
                    .subscribe();

                _supabase.channel('chat_updates')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, () => {
                        refreshChat();
                    })
                    .subscribe();

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if ("0x" + network.chainId.toString(16).toUpperCase() !== CHAIN_ID.toUpperCase()) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: CHAIN_ID,
                                    chainName: 'Martian Chain',
                                    nativeCurrency: { name: 'EROL', symbol: 'EROL', decimals: 18 },
                                    rpcUrls: [RPC_URL],
                                    blockExplorerUrls: ['https://explorer.martian.com']
                                }]
                            });
                        } catch (addError) {
                            showToast("FAILED TO ADD MARTIAN NETWORK");
                            return false;
                        }
                    } else {
                        showToast("SWITCH TO MARTIAN NETWORK");
                        return false;
                    }
                }
            }
            return true;
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                
                if (!(await checkNetwork())) return;

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                
                const shortened = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('user-address').innerText = shortened;
                
                updateBalance();
                refreshLobby();
            } catch (err) { 
                console.error(err);
                showToast("UPLINK FAILED"); 
            }
        }

        function copyAddress() {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress).then(() => {
                    showToast("ADDRESS COPIED");
                }).catch(() => showToast("COPY FAILED"));
            }
        }

        async function updateBalance() {
            if (!userAddress || !provider) return;
            try {
                const balance = await provider.getBalance(userAddress);
                document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $EROL`;
            } catch (e) { console.error("Balance fetch error", e); }
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        // ===========================
        // CREATE GAME
        // ===========================
        async function handleCreateGame() {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (selectedMoveIdx === 0) return showToast("SELECT TACTICAL MOVE");
            if (!(await checkNetwork())) return;
            
            const createBtn = document.getElementById('create-btn');
            createBtn.disabled = true;
            
            const wagerInput = document.getElementById('wager-amount').value;
            const wagerValue = ethers.parseEther(wagerInput);
            const timeoutValue = document.getElementById('timeout-select').value;
            const salt = ethers.hexlify(ethers.randomBytes(32));
            
            try {
                const nextGameId = (await contract.gameCounter()) + BigInt(1);
                
                const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                    ["uint8", "string", "address", "uint256"],
                    [selectedMoveIdx, salt, userAddress, nextGameId]
                );
                const hash = ethers.keccak256(encoded);

                showToast("ENCRYPTING SIGNAL...");
                const tx = await contract.createGame(hash, timeoutValue, { value: wagerValue });
                
                showToast("WAITING FOR CONFIRMATION...");
                const receipt = await tx.wait();
                
                const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
                secrets[hash] = { 
                    move: selectedMoveIdx, 
                    salt: salt,
                    gameId: nextGameId.toString(),
                    address: userAddress.toLowerCase()
                };
                localStorage.setItem('martian_gambits', JSON.stringify(secrets));

                let gameId = Number(nextGameId);

                try {
                    for (const log of receipt.logs) {
                        try {
                            if (log.address.toLowerCase() !== CONTRACT_ADDR.toLowerCase()) continue;
                            const parsed = contract.interface.parseLog({ topics: log.topics, data: log.data });
                            if (parsed && parsed.name === 'GameCreated') {
                                gameId = Number(parsed.args.gameId);
                                break;
                            }
                        } catch(e) { continue; }
                    }
                } catch (e) { console.warn("Log parsing failed:", e); }

                const { error: sbError } = await _supabase.from('games')
                    .upsert([{
                        game_id: gameId,
                        host: userAddress.toLowerCase(),
                        wager: wagerInput,
                        timeout: parseInt(timeoutValue),
                        status: 0,
                        commit_hash: hash
                    }], { onConflict: 'game_id' })
                    .select();

                if (sbError) {
                    console.error("Supabase upsert error:", sbError);
                    showToast("‚ö†Ô∏è GAME CREATED BUT INDEX FAILED");
                } else {
                    showToast("‚úì SIGNAL DEPLOYED");
                }

                setTimeout(async () => {
                    await refreshLobby();
                    createBtn.disabled = false;
                }, 2000);
                
            } catch (err) { 
                console.error("Game Creation Error:", err);
                showToast("DEPLOYMENT ABORTED");
                createBtn.disabled = false;
            }
        }

        // ===========================
        // LOBBY
        // ===========================
        async function refreshLobby() {
            const lobby = document.getElementById('lobby-list');
            try {
                const { data: games, error } = await _supabase.from('games')
                    .select('*')
                    .order('game_id', { ascending: false })
                    .limit(100);

                if (error) {
                    lobby.innerHTML = `<div class="text-center py-20 text-red-500 uppercase">Indexing Error: ${error.message}</div>`;
                    return;
                }

                lobby.innerHTML = '';
                let displayedCount = 0;

                games.forEach(game => {
                    const status = Number(game.status);
                    const isHost = userAddress && game.host === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                    
                    if (currentLobbyFilter === 'open' && status !== 0) return;
                    if (currentLobbyFilter === 'intercepted' && status !== 1) return;
                    if (currentLobbyFilter === 'resolved' && status !== 2) return;
                    
                    // In "all" filter, hide resolved/refunded/forfeited games unless you participated
                    if (status > 1 && !isHost && !isChallenger && currentLobbyFilter === 'all') return;

                    displayedCount++;

                    const remaining = getTimeRemaining(game);
                    const expired = remaining <= 0;
                    const nearExpiry = remaining > 0 && remaining < 60;

                    let countdownHTML = '';
                    if (status === 0 || status === 1) {
                        const createdAt = new Date(game.created_at).getTime() / 1000;
                        const timeout = game.timeout || 900;
                        const deadline = Math.floor(createdAt + timeout);

                        if (!expired) {
                            const initColor = nearExpiry ? 'countdown-critical' : (remaining < 300 ? 'text-yellow-500' : 'text-orange-500');
                            const initText = `‚è± ${formatCountdown(remaining)}`;
                            countdownHTML = `<span class="text-[10px] countdown-tick ${initColor} ml-2" data-deadline="${deadline}">${initText}</span>`;
                        } else {
                            countdownHTML = `<span class="text-[10px] countdown-critical ml-2" data-deadline="${deadline}">‚è± TIMEOUT</span>`;
                        }
                    }

                    if (status === 0 && nearExpiry && !isHost) {
                        countdownHTML += `<span class="text-[10px] text-red-500 ml-2">üîí CLOSING SOON</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = "lobby-row p-4 bg-black/40 border-l-2 flex flex-col md:flex-row justify-between items-center gap-4 " + 
                        (status == 0 ? "border-orange-500" : 
                         status == 1 ? "border-yellow-500" : 
                         status == 2 ? "border-green-700" : 
                         "border-gray-800");
                    
                    // Click handler to open detail page
                    div.setAttribute('data-game-id', game.game_id);
                    div.onclick = (e) => {
                        // Don't navigate if clicking a button
                        if (e.target.closest('button')) return;
                        openMatchDetail(game.game_id);
                    };
                    
                    let gameInfo = `
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-[9px] px-2 py-0.5 border ${
                                    status == 0 ? 'border-orange-500 text-orange-500' : 
                                    status == 1 ? 'border-yellow-500 text-yellow-500' : 
                                    status == 2 ? 'border-green-500 text-green-500' : 
                                    'border-gray-700 text-gray-500'
                                } uppercase">${getStatusText(status)}</span>
                                <span class="text-[9px] text-orange-900/40">ID: ${game.game_id}</span>
                                ${countdownHTML}
                            </div>
                            <div class="orbitron text-white text-sm">
                                <span class="text-orange-500">${game.wager} $EROL</span> 
                                <span class="text-gray-600 text-[10px] ml-2">FROM ${game.host.slice(0,6)}...</span>`;
                    
                    if (status == 2 && game.host_move && game.challenger_move) {
                        const moves = ['', '‚òÄÔ∏è Solar', 'üå¨Ô∏è Oxygen', 'üå™Ô∏è Dust'];
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        let winner = '';
                        if (hostMove === challengerMove) {
                            winner = '‚öñÔ∏è DRAW';
                        } else if (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        ) {
                            winner = `üèÜ ${game.host.slice(0,6)}... WINS`;
                        } else {
                            winner = `üèÜ ${(game.challenger || 'Unknown').slice(0,6)}... WINS`;
                        }
                        gameInfo += `
                            <div class="text-[10px] mt-1 text-gray-400">
                                Host: ${moves[hostMove]} vs Challenger: ${moves[challengerMove]}
                            </div>
                            <div class="text-[11px] mt-1 font-bold ${hostMove === challengerMove ? 'text-yellow-500' : 'text-green-500'}">
                                ${winner}
                            </div>`;
                    }
                    
                    gameInfo += `
                            </div>
                            <div class="text-[9px] text-gray-700 mt-1">Click row for details</div>
                        </div>
                        <div class="flex gap-2 shrink-0" onclick="event.stopPropagation()">${getActionButtons(game, isHost, isChallenger)}</div>`;
                    
                    div.innerHTML = gameInfo;
                    lobby.appendChild(div);
                });
                
                if (displayedCount === 0) {
                    lobby.innerHTML = '<div class="text-center py-20 opacity-30 uppercase italic">No signals detected...</div>';
                }
            } catch (err) { 
                console.error("Lobby Refresh Error:", err);
                lobby.innerHTML = `<div class="text-center py-20 text-red-500">Error loading lobby: ${err.message}</div>`;
            }
        }

        function setLobbyFilter(filter) {
            currentLobbyFilter = filter;
            document.querySelectorAll('.lobby-filter').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            refreshLobby();
        }

        function getActionButtons(game, isHost, isChallenger) {
            const status = Number(game.status);
            const expired = isExpired(game);
            const nearExpiry = isNearExpiry(game);

            if (status === 0) {
                if (isHost) {
                    // HOST: only show Retract button
                    return `<button onclick="handleRefund(${game.game_id})" class="text-[9px] border border-gray-700 px-4 py-2 hover:bg-white/5 uppercase transition">Retract</button>`;
                }
                // Non-host: show Intercept only if not expired and not near expiry
                if (expired) {
                    return `<span class="text-[9px] text-red-700 uppercase italic">Timed Out</span>`;
                }
                if (nearExpiry) {
                    return `<span class="text-[9px] text-red-500 uppercase italic">üîí Closing...</span>`;
                }
                return `<button data-intercept-btn onclick="openChallengeModal(${game.game_id}, '${game.wager}')" class="btn-mars text-[10px] px-6 py-2">Intercept</button>`;
            }

            if (status === 1) {
                if (isHost) {
                    return `<button onclick="handleResolve(${game.game_id}, '${game.commit_hash}')" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Broadcast Reveal</button>`;
                }
                if (isChallenger) {
                    if (expired) {
                        return `<button onclick="handleForceForfeit(${game.game_id})" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Claim Victory</button>`;
                    }
                    return `<span class="text-[9px] text-orange-500 uppercase italic">‚öîÔ∏è Awaiting Reveal...</span>`;
                }
                return `<span class="text-[9px] text-orange-900 uppercase italic">Combat Active</span>`;
            }

            if (status === 2) return `<span class="text-[9px] text-green-500 uppercase">‚úì Resolved</span>`;
            if (status === 3) return `<span class="text-[9px] text-gray-600 uppercase">Refunded</span>`;
            if (status === 4) return `<span class="text-[9px] text-red-600 uppercase">‚ö° Forfeited</span>`;
            return `<span class="text-[9px] text-gray-700 uppercase">Inactive</span>`;
        }

        // ===========================
        // MATCH DETAIL PAGE
        // ===========================
        async function openMatchDetail(gameId) {
            if (!gameId || gameId === 'null' || gameId === 'undefined') {
                showToast("‚ö†Ô∏è INVALID MATCH ID");
                return;
            }
            gameId = parseInt(gameId);
            if (isNaN(gameId)) { showToast("‚ö†Ô∏è INVALID MATCH ID"); return; }
            // Switch to match detail tab
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-match').classList.add('active');

            const content = document.getElementById('match-detail-content');
            content.innerHTML = `<div class="text-center py-20 text-orange-500 animate-pulse orbitron">Loading match data...</div>`;

            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('game_id', gameId)
                    .single();

                if (error || !games) throw new Error("Game not found");

                const game = games;
                const status = Number(game.status);
                const isHost = userAddress && game.host === userAddress.toLowerCase();
                const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                const moves = ['', '‚òÄÔ∏è Solar Flare', 'üå¨Ô∏è Oxygen Siphon', 'üå™Ô∏è Dust Storm'];
                const moveIcons = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                const remaining = getTimeRemaining(game);
                const expired = remaining <= 0;
                const nearExpiry = remaining > 0 && remaining < 60;

                const pot = parseFloat(game.wager) * 2;
                const winnerPayout = (pot * 0.97).toFixed(4);
                const treasury = (pot * 0.015).toFixed(4);
                const burnt = (pot * 0.015).toFixed(4);

                // Determine result
                let resultSection = '';
                let hostMove = Number(game.host_move);
                let challengerMove = Number(game.challenger_move);

                if (status === 2 && game.host_move && game.challenger_move) {
                    let winnerAddr = '';
                    let resultLabel = '';
                    let resultColor = '';

                    if (hostMove === challengerMove) {
                        resultLabel = '‚öñÔ∏è DRAW ‚Äî Both pilots return to base';
                        resultColor = 'text-yellow-500';
                        winnerAddr = 'Draw';
                    } else if (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    ) {
                        resultLabel = `üèÜ HOST WINS`;
                        winnerAddr = game.host;
                        resultColor = 'text-green-500';
                    } else {
                        resultLabel = `üèÜ CHALLENGER WINS`;
                        winnerAddr = game.challenger;
                        resultColor = 'text-green-500';
                    }

                    resultSection = `
                        <div class="mars-glass p-6 mb-6 border border-orange-500/30">
                            <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">‚öîÔ∏è Battle Outcome</h3>
                            <div class="${resultColor} orbitron text-2xl font-bold text-center mb-6">${resultLabel}</div>
                            <div class="grid grid-cols-2 gap-6 text-center">
                                <div class="bg-black/40 p-4 ${isHost && resultLabel.includes('HOST') ? 'border border-green-500/30' : ''}">
                                    <div class="text-[10px] text-gray-500 uppercase mb-2">HOST</div>
                                    <div class="text-4xl mb-2">${moveIcons[hostMove]}</div>
                                    <div class="orbitron text-orange-500 text-sm">${moves[hostMove]}</div>
                                    <div class="text-[10px] text-gray-600 mt-1">${game.host.slice(0,10)}...</div>
                                </div>
                                <div class="bg-black/40 p-4 ${isChallenger && resultLabel.includes('CHALLENGER') ? 'border border-green-500/30' : ''}">
                                    <div class="text-[10px] text-gray-500 uppercase mb-2">CHALLENGER</div>
                                    <div class="text-4xl mb-2">${moveIcons[challengerMove]}</div>
                                    <div class="orbitron text-orange-500 text-sm">${moves[challengerMove]}</div>
                                    <div class="text-[10px] text-gray-600 mt-1">${(game.challenger || 'Unknown').slice(0,10)}...</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Timer section
                let timerSection = '';
                if (status === 0 || status === 1) {
                    const createdAt = new Date(game.created_at).getTime() / 1000;
                    const timeout = game.timeout || 900;
                    const deadline = Math.floor(createdAt + timeout);
                    const timeColor = expired ? 'countdown-critical' : (nearExpiry ? 'countdown-critical' : 'text-orange-500');
                    const timeDisplay = expired ? '‚è± TIMEOUT' : `‚è± ${formatCountdown(remaining)}`;
                    timerSection = `
                        <div class="stat-card mb-4">
                            <div class="text-[10px] text-gray-500 uppercase mb-2">Time Remaining</div>
                            <div class="orbitron text-3xl countdown-tick ${timeColor}" data-deadline="${deadline}">${timeDisplay}</div>
                            ${nearExpiry && !expired ? `<div class="text-[10px] text-red-500 mt-2 animate-pulse">üîí Cannot be joined in final 60 seconds</div>` : ''}
                        </div>
                    `;
                }

                // Action buttons for this player
                const actionButtons = getActionButtons(game, isHost, isChallenger);

                // Timeline / History
                const createdTime = new Date(game.created_at);
                let timelineHTML = `
                    <div class="timeline-item">
                        <div class="text-sm text-white font-bold">Game Created</div>
                        <div class="text-[10px] text-gray-500">${createdTime.toLocaleString()}</div>
                        <div class="text-[10px] text-gray-600 mt-1">Host: ${game.host.slice(0,10)}...${game.host.slice(-6)}</div>
                    </div>
                `;

                if (status >= 1 && game.challenger) {
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="text-sm text-yellow-400 font-bold">Signal Intercepted</div>
                            <div class="text-[10px] text-gray-600 mt-1">Challenger: ${game.challenger.slice(0,10)}...${game.challenger.slice(-6)}</div>
                        </div>
                    `;
                }

                if (status === 2) {
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="text-sm text-green-400 font-bold">Battle Resolved</div>
                            <div class="text-[10px] text-gray-500">${game.updated_at ? new Date(game.updated_at).toLocaleString() : 'Unknown time'}</div>
                        </div>
                    `;
                }

                if (status === 3) {
                    timelineHTML += `<div class="timeline-item"><div class="text-sm text-gray-400 font-bold">Wager Refunded</div></div>`;
                }

                if (status === 4) {
                    timelineHTML += `<div class="timeline-item"><div class="text-sm text-red-400 font-bold">Game Forfeited</div></div>`;
                }

                content.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Info -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Header -->
                            <div class="mars-glass p-6">
                                <div class="flex items-start justify-between flex-wrap gap-4 mb-6">
                                    <div>
                                        <div class="text-[10px] text-gray-600 mb-1">MATCH ID</div>
                                        <div class="orbitron text-3xl text-orange-500">#${game.game_id}</div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-[9px] px-3 py-1 border ${
                                            status == 0 ? 'border-orange-500 text-orange-500' : 
                                            status == 1 ? 'border-yellow-500 text-yellow-500' : 
                                            status == 2 ? 'border-green-500 text-green-500' : 
                                            'border-gray-700 text-gray-500'
                                        } uppercase">${getStatusText(status)}</span>
                                    </div>
                                </div>

                                <!-- Stats row -->
                                <div class="grid grid-cols-3 gap-3 mb-6">
                                    <div class="stat-card">
                                        <div class="text-[10px] text-gray-500 uppercase mb-1">Wager</div>
                                        <div class="orbitron text-orange-500 text-lg">${game.wager}</div>
                                        <div class="text-[9px] text-gray-600">$EROL each</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-[10px] text-gray-500 uppercase mb-1">Total Pot</div>
                                        <div class="orbitron text-orange-500 text-lg">${pot.toFixed(4)}</div>
                                        <div class="text-[9px] text-gray-600">$EROL</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-[10px] text-gray-500 uppercase mb-1">Timeout</div>
                                        <div class="orbitron text-orange-500 text-lg">${Math.floor(game.timeout / 60)}m</div>
                                        <div class="text-[9px] text-gray-600">window</div>
                                    </div>
                                </div>

                                ${timerSection}
                            </div>

                            ${resultSection}

                            <!-- Players -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Combatants</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between bg-black/40 p-4 border border-orange-900/20">
                                        <div>
                                            <div class="text-[9px] text-orange-700 uppercase mb-1">Host ${isHost ? '(You)' : ''}</div>
                                            <div class="text-sm text-white font-mono">${game.host}</div>
                                        </div>
                                        <div class="text-right">
                                            ${status === 2 && game.host_move ? `<div class="text-2xl">${moveIcons[Number(game.host_move)]}</div>` : `<div class="text-[10px] text-gray-600">Move Hidden</div>`}
                                        </div>
                                    </div>
                                    ${game.challenger ? `
                                    <div class="flex items-center justify-between bg-black/40 p-4 border border-yellow-900/20">
                                        <div>
                                            <div class="text-[9px] text-yellow-700 uppercase mb-1">Challenger ${isChallenger ? '(You)' : ''}</div>
                                            <div class="text-sm text-white font-mono">${game.challenger}</div>
                                        </div>
                                        <div class="text-right">
                                            ${status === 2 && game.challenger_move ? `<div class="text-2xl">${moveIcons[Number(game.challenger_move)]}</div>` : `<div class="text-[10px] text-gray-600">${status === 1 ? 'Move Locked In' : 'No Challenger Yet'}</div>`}
                                        </div>
                                    </div>` : `
                                    <div class="bg-black/40 p-4 border border-gray-900/20 text-center text-gray-600 text-sm italic">
                                        Awaiting challenger...
                                    </div>`}
                                </div>
                            </div>

                            <!-- Payout Breakdown -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Payout Structure</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center py-2 border-b border-orange-900/10">
                                        <span class="text-gray-400">Total Pot</span>
                                        <span class="orbitron text-white">${pot.toFixed(4)} $EROL</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-orange-900/10">
                                        <span class="text-gray-400">Winner Receives (97%)</span>
                                        <span class="orbitron text-green-500">${winnerPayout} $EROL</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-orange-900/10">
                                        <span class="text-gray-400">Treasury (1.5%)</span>
                                        <span class="orbitron text-blue-500">${treasury} $EROL</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-gray-400">Burned (1.5%)</span>
                                        <span class="orbitron text-red-500">${burnt} $EROL</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="space-y-6">
                            <!-- Action Panel -->
                            ${(isHost || isChallenger) || (status === 0 && !expired && !nearExpiry) ? `
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Your Actions</h3>
                                <div class="space-y-2">
                                    ${getActionButtons(game, isHost, isChallenger)}
                                </div>
                            </div>` : ''}

                            <!-- Match Timeline -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Mission Log</h3>
                                <div class="text-sm">
                                    ${timelineHTML}
                                </div>
                            </div>

                            <!-- Commit Hash -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">On-Chain Proof</h3>
                                <div class="space-y-3 text-[10px]">
                                    <div>
                                        <div class="text-gray-600 mb-1">Commit Hash</div>
                                        <div class="text-orange-800 break-all font-mono text-[9px]">${game.commit_hash || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600 mb-1">Contract</div>
                                        <div class="text-orange-800 break-all font-mono text-[9px]">${CONTRACT_ADDR}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- How to win reminder -->
                            <div class="mars-glass p-6 bg-orange-900/5">
                                <h3 class="orbitron text-sm text-orange-500 mb-3 uppercase">Move Rules</h3>
                                <div class="space-y-2 text-[10px] text-gray-500">
                                    <div>‚òÄÔ∏è Solar <span class="text-orange-800">beats</span> üå¨Ô∏è Oxygen</div>
                                    <div>üå¨Ô∏è Oxygen <span class="text-orange-800">beats</span> üå™Ô∏è Dust</div>
                                    <div>üå™Ô∏è Dust <span class="text-orange-800">beats</span> ‚òÄÔ∏è Solar</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (err) {
                console.error("Match detail error:", err);
                content.innerHTML = `<div class="text-center py-20 text-red-500">Error loading match: ${err.message}</div>`;
            }
        }

        function goBackToLobby() {
            switchTab('lobby');
        }

        // ===========================
        // CHALLENGE MODAL
        // ===========================
        function openChallengeModal(gameId, wager) {
            if (!userAddress) {
                showToast("CONNECT UPLINK FIRST");
                return;
            }
            pendingChallengeId = gameId;
            pendingChallengeWager = wager;
            selectedChallengeMove = 0;

            document.querySelectorAll('[id^="cmove-"]').forEach(b => b.classList.remove('selected'));
            document.getElementById('confirm-challenge-btn').disabled = true;
            document.getElementById('challenge-wager-display').textContent = `${wager} $EROL`;
            document.getElementById('challenge-modal').classList.add('active');
        }

        function closeChallengeModal() {
            document.getElementById('challenge-modal').classList.remove('active');
            pendingChallengeId = null;
            pendingChallengeWager = null;
            selectedChallengeMove = 0;
        }

        function selectChallengeMove(idx) {
            selectedChallengeMove = idx;
            document.querySelectorAll('[id^="cmove-"]').forEach(b => b.classList.remove('selected'));
            document.getElementById(`cmove-${idx}`).classList.add('selected');
            document.getElementById('confirm-challenge-btn').disabled = false;
        }

        async function confirmChallenge() {
            if (!pendingChallengeId || selectedChallengeMove === 0) return;
            closeChallengeModal();
            await handleChallenge(pendingChallengeId, pendingChallengeWager, selectedChallengeMove);
        }

        // ===========================
        // CHALLENGE GAME
        // ===========================
        async function handleChallenge(id, wager, move) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            try {
                // Re-check timer on-chain before submitting
                const { data: gameRow } = await _supabase.from('games').select('*').eq('game_id', id).single();
                if (gameRow) {
                    if (isExpired(gameRow)) return showToast("‚õî MATCH HAS TIMED OUT");
                    if (isNearExpiry(gameRow)) return showToast("‚õî TOO CLOSE TO TIMEOUT ‚Äî CANNOT JOIN");
                }

                showToast("INTERCEPTING...");
                
                // Use wager amount passed from DB ‚Äî avoids a contract.games() call that can fail
                const actualWager = ethers.parseEther(String(wager));
                
                const tx = await contract.challengeGame(id, move, { value: actualWager });
                showToast("CONFIRMING TRANSACTION...");
                const receipt = await tx.wait();
                
                const { error: updateError } = await _supabase
                    .from('games')
                    .update({ 
                        status: 1, 
                        challenger: userAddress.toLowerCase(),
                        challenger_move: parseInt(move)
                    })
                    .eq('game_id', id);
                
                if (updateError) {
                    showToast("‚ö†Ô∏è INTERCEPTED BUT DB UPDATE FAILED");
                } else {
                    showToast("‚úì SIGNAL INTERCEPTED");
                }
                
                setTimeout(refreshLobby, 1500);
            } catch (err) { 
                console.error("Challenge error:", err);
                showToast("INTERCEPTION FAILED"); 
            }
        }

        // ===========================
        // RESOLVE GAME
        // ===========================
        async function handleResolve(id, hash) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            let secret = secrets[hash];
            
            if (!secret) {
                const manualReveal = confirm("Secret not found in this browser. Enter manually?");
                if (manualReveal) {
                    const move = prompt("Enter your move (1-3):");
                    const salt = prompt("Enter your salt (hex string):");
                    if (!move || !salt) return showToast("CANCELLED");
                    
                    const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                        ["uint8", "string", "address", "uint256"],
                        [parseInt(move), salt, userAddress, BigInt(id)]
                    );
                    const testHash = ethers.keccak256(encoded);
                    if (testHash.toLowerCase() !== hash.toLowerCase()) return showToast("‚ö†Ô∏è HASH MISMATCH");
                    
                    secret = { move: parseInt(move), salt: salt, gameId: id.toString() };
                } else {
                    return showToast("‚ö†Ô∏è SECRET NOT FOUND");
                }
            }
            
            const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                ["uint8", "string", "address", "uint256"],
                [secret.move, secret.salt, userAddress, BigInt(secret.gameId || id)]
            );
            const verifyHash = ethers.keccak256(encoded);
            
            if (verifyHash.toLowerCase() !== hash.toLowerCase()) return showToast("‚ö†Ô∏è HASH VERIFICATION FAILED");
            
            try {
                showToast("BROADCASTING REVEAL...");
                const tx = await contract.resolveGame(id, secret.move, secret.salt);
                showToast("CONFIRMING...");
                await tx.wait();
                
                // Fetch resolved move data from supabase instead of contract call
                let hostMove = secret.move;
                let challengerMove = 0;
                try {
                    const { data: resolvedGame } = await _supabase.from('games').select('*').eq('game_id', id).single();
                    if (resolvedGame && resolvedGame.challenger_move) {
                        challengerMove = Number(resolvedGame.challenger_move);
                    }
                } catch(e) { console.warn('Could not fetch resolved moves from DB'); }
                
                let resultMsg = "COMBAT RESOLVED";
                if (hostMove === challengerMove) {
                    resultMsg = "‚öñÔ∏è DRAW";
                } else if (
                    (hostMove === 1 && challengerMove === 2) ||
                    (hostMove === 2 && challengerMove === 3) ||
                    (hostMove === 3 && challengerMove === 1)
                ) {
                    resultMsg = "üèÜ VICTORY!";
                } else {
                    resultMsg = "üí• DEFEAT";
                }
                
                await _supabase.from('games').update({ 
                    status: 2,
                    host_move: hostMove,
                    challenger_move: challengerMove
                }).eq('game_id', id);
                
                setTimeout(refreshLobby, 1000);
                updateBalance();
                showToast(resultMsg);
            } catch (err) { 
                console.error("Resolve error:", err);
                showToast("RESOLVE FAILED"); 
            }
        }

        async function handleRefund(id) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            try {
                showToast("RETRACTING...");
                const tx = await contract.refundUnchallenged(id);
                await tx.wait();
                await _supabase.from('games').update({ status: 3 }).eq('game_id', id);
                refreshLobby();
                updateBalance();
                showToast("FUNDS RETRACTED");
            } catch (err) { 
                console.error(err);
                showToast("REFUND FAILED"); 
            }
        }

        async function handleForceForfeit(gameId) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            try {
                showToast("CLAIMING VICTORY...");
                const tx = await contract.forceForfeit(gameId);
                await tx.wait();
                await _supabase.from('games').update({ status: 4 }).eq('game_id', gameId);
                refreshLobby();
                updateBalance();
                showToast("üèÜ VICTORY BY FORFEIT!");
            } catch (err) {
                console.error("Forfeit error:", err);
                showToast("FORFEIT FAILED");
            }
        }

        // ===========================
        // ACTIVITY FEED
        // ===========================
        async function refreshActivityFeed() {
            const feed = document.getElementById('activity-feed');
            // Add event delegation once
            if (!feed._delegated) {
                feed._delegated = true;
                feed.addEventListener('click', (e) => {
                    const row = e.target.closest('[data-gameid]');
                    if (row) {
                        const gid = row.getAttribute('data-gameid');
                        if (gid && gid !== 'null' && gid !== '') openMatchDetail(gid);
                    }
                });
            }
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .order('updated_at', { ascending: false })
                    .limit(50);

                if (error) return;

                feed.innerHTML = games.map(game => {
                    const moves = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    
                    let result = '', resultColor = '';
                    if (hostMove === challengerMove) {
                        result = 'DRAW'; resultColor = 'text-yellow-500';
                    } else if (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    ) {
                        result = `${game.host.slice(0,6)}... WINS`; resultColor = 'text-green-500';
                    } else {
                        result = `${(game.challenger || 'Unknown').slice(0,6)}... WINS`; resultColor = 'text-green-500';
                    }
                    
                    const timeAgo = getTimeAgo(new Date(game.updated_at || game.created_at));
                    
                    return `
                        <div class="lobby-row bg-black/40 border-l-2 border-green-700 p-3 flex justify-between items-center transition" data-gameid="${game.game_id || ''}" style="cursor:pointer">
                            <div class="flex-1">
                                <div class="text-sm ${resultColor} font-bold">${result}</div>
                                <div class="text-[10px] text-gray-500 mt-1">
                                    ${moves[hostMove]} vs ${moves[challengerMove]} ‚Ä¢ ${game.wager} $EROL ‚Ä¢ ${timeAgo}
                                </div>
                            </div>
                            <div class="text-2xl">${result.includes('DRAW') ? '‚öñÔ∏è' : 'üèÜ'}</div>
                        </div>`;
                }).join('') || '<div class="text-center text-gray-600 py-8">No recent activity</div>';
            } catch (err) {
                console.error("Activity feed error:", err);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        // ===========================
        // CHAT
        // ===========================
        async function refreshChat() {
            const chatMessages = document.getElementById('chat-messages');
            try {
                const { data: messages, error } = await _supabase
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) return;

                const shouldScroll = chatMessages.scrollHeight - chatMessages.scrollTop === chatMessages.clientHeight;

                chatMessages.innerHTML = messages.reverse().map(msg => {
                    const isOwn = userAddress && msg.sender.toLowerCase() === userAddress.toLowerCase();
                    return `
                        <div class="${isOwn ? 'text-right' : 'text-left'}">
                            <div class="inline-block max-w-[80%] ${isOwn ? 'bg-orange-900/30' : 'bg-gray-900/50'} px-3 py-2 rounded">
                                <div class="text-[9px] text-orange-700 mb-1">${msg.sender.slice(0,6)}...${msg.sender.slice(-4)}</div>
                                <div class="text-sm text-gray-200">${escapeHtml(msg.message)}</div>
                            </div>
                        </div>`;
                }).join('');

                if (shouldScroll) chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (err) {
                console.error("Chat refresh error:", err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !userAddress) return;
            try {
                const { error } = await _supabase
                    .from('chat_messages')
                    .insert([{ sender: userAddress.toLowerCase(), message: message }]);
                if (!error) { input.value = ''; refreshChat(); }
            } catch (err) { showToast("MESSAGE FAILED"); }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===========================
        // LEADERBOARD
        // ===========================
        async function loadLeaderboard() {
            try {
                const { data: games, error } = await _supabase.from('games').select('*').eq('status', 2);
                if (error) return;

                const playerStats = {};
                let totalWagered = 0, totalBurnt = 0, totalTreasury = 0;

                games.forEach(game => {
                    const wager = parseFloat(game.wager);
                    totalWagered += wager * 2;
                    const pot = wager * 2;
                    totalBurnt += pot * 0.015;
                    totalTreasury += pot * 0.015;

                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    
                    [game.host, game.challenger].filter(Boolean).forEach((addr, idx) => {
                        if (!playerStats[addr]) {
                            playerStats[addr] = { address: addr, totalWagered: 0, wins: 0, losses: 0, draws: 0, games: 0, biggestPot: 0, currentStreak: 0, longestStreak: 0 };
                        }
                        playerStats[addr].totalWagered += wager;
                        playerStats[addr].games++;
                        if (wager * 2 > playerStats[addr].biggestPot) playerStats[addr].biggestPot = wager * 2;
                    });

                    const hostWins = (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    );

                    if (hostMove === challengerMove) {
                        [game.host, game.challenger].filter(Boolean).forEach(addr => {
                            playerStats[addr].draws++;
                            playerStats[addr].currentStreak = 0;
                        });
                    } else {
                        const winner = hostWins ? game.host : game.challenger;
                        const loser = hostWins ? game.challenger : game.host;
                        if (winner && playerStats[winner]) {
                            playerStats[winner].wins++;
                            playerStats[winner].currentStreak++;
                            if (playerStats[winner].currentStreak > playerStats[winner].longestStreak) {
                                playerStats[winner].longestStreak = playerStats[winner].currentStreak;
                            }
                        }
                        if (loser && playerStats[loser]) {
                            playerStats[loser].losses++;
                            playerStats[loser].currentStreak = 0;
                        }
                    }
                });

                document.getElementById('global-wagered').textContent = totalWagered.toFixed(2);
                document.getElementById('global-burnt').textContent = totalBurnt.toFixed(2);
                document.getElementById('global-treasury').textContent = totalTreasury.toFixed(2);
                document.getElementById('global-games').textContent = games.length;

                const leaderboard = Object.values(playerStats).sort((a, b) => b.totalWagered - a.totalWagered).slice(0, 50);

                document.getElementById('leaderboard-body').innerHTML = leaderboard.map((player, index) => {
                    const winRate = player.games > 0 ? ((player.wins / player.games) * 100).toFixed(1) : 0;
                    return `
                        <tr class="border-b border-gray-900/30 hover:bg-orange-900/10 cursor-pointer transition" onclick="showPlayerProfile('${player.address}')">
                            <td class="p-3 text-orange-500 orbitron">#${index + 1}</td>
                            <td class="p-3">
                                <div class="text-sm text-white">${player.address.slice(0,8)}...${player.address.slice(-6)}</div>
                                <div class="text-[10px] text-gray-600">${player.games} games</div>
                            </td>
                            <td class="p-3 text-right orbitron text-orange-500">${player.totalWagered.toFixed(2)}</td>
                            <td class="p-3 text-right orbitron ${winRate >= 50 ? 'text-green-500' : 'text-red-500'}">${winRate}%</td>
                            <td class="p-3 text-right orbitron text-orange-500">${player.biggestPot.toFixed(2)}</td>
                            <td class="p-3 text-right orbitron text-yellow-500">${player.longestStreak}</td>
                        </tr>`;
                }).join('');
            } catch (err) {
                console.error("Leaderboard error:", err);
            }
        }

        async function showPlayerProfile(address) {
            const modal = document.getElementById('player-modal');
            const content = document.getElementById('player-modal-content');
            modal.classList.add('active');
            content.innerHTML = '<div class="text-center py-8 text-orange-500">Loading...</div>';

            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .or(`host.eq.${address.toLowerCase()},challenger.eq.${address.toLowerCase()}`)
                    .order('game_id', { ascending: false });

                if (error) throw error;

                let wins = 0, losses = 0, draws = 0, totalWagered = 0, biggestPot = 0, longestStreak = 0, currentStreak = 0;
                const recentGames = [];

                games.forEach(game => {
                    const isHost = game.host === address.toLowerCase();
                    const wager = parseFloat(game.wager);
                    totalWagered += wager;
                    if (wager * 2 > biggestPot) biggestPot = wager * 2;
                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    let result = '';

                    if (hostMove === challengerMove) {
                        draws++; result = 'DRAW'; currentStreak = 0;
                    } else {
                        const hostWins = (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        );
                        if ((isHost && hostWins) || (!isHost && !hostWins)) {
                            wins++; result = 'WIN'; currentStreak++;
                            if (currentStreak > longestStreak) longestStreak = currentStreak;
                        } else {
                            losses++; result = 'LOSS'; currentStreak = 0;
                        }
                    }
                    recentGames.push({ ...game, result, isHost });
                });

                const totalGames = games.length;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                const moveIcons = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center pb-4 border-b border-orange-900/30">
                            <div class="text-sm text-gray-500 mb-2">ADDRESS</div>
                            <div class="orbitron text-orange-500 text-sm break-all">${address}</div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-black/40 border border-green-900/30 p-4 text-center">
                                <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                                <div class="orbitron text-2xl text-green-500">${wins}</div>
                            </div>
                            <div class="bg-black/40 border border-red-900/30 p-4 text-center">
                                <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                                <div class="orbitron text-2xl text-red-500">${losses}</div>
                            </div>
                            <div class="bg-black/40 border border-yellow-900/30 p-4 text-center">
                                <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                                <div class="orbitron text-2xl text-yellow-500">${draws}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                                <div class="text-[10px] text-orange-800 uppercase mb-2">Win Rate</div>
                                <div class="orbitron text-2xl text-orange-500">${winRate}%</div>
                            </div>
                            <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                                <div class="text-[10px] text-orange-800 uppercase mb-2">Total Wagered</div>
                                <div class="orbitron text-xl text-orange-500">${totalWagered.toFixed(2)}</div>
                            </div>
                            <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                                <div class="text-[10px] text-orange-800 uppercase mb-2">Biggest Pot</div>
                                <div class="orbitron text-xl text-orange-500">${biggestPot.toFixed(2)}</div>
                            </div>
                            <div class="bg-black/40 border border-yellow-900/30 p-4 text-center">
                                <div class="text-[10px] text-yellow-800 uppercase mb-2">Longest Streak</div>
                                <div class="orbitron text-xl text-yellow-500">${longestStreak}</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="orbitron text-orange-500 mb-3 text-sm">RECENT BATTLES</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${recentGames.slice(0, 10).map(game => `
                                    <div class="bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-3 flex justify-between items-center cursor-pointer hover:bg-black/60" data-gameid="${game.game_id || ''}" onclick="if(this.dataset.gameid && this.dataset.gameid !== 'null'){ closePlayerModal(); openMatchDetail(this.dataset.gameid); }">
                                        <div>
                                            <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500">${game.result}</span>
                                            <div class="text-sm mt-1"><span class="text-orange-500">${game.wager} $EROL</span><span class="text-gray-600 text-[10px] ml-2">Game #${game.game_id}</span></div>
                                        </div>
                                        <div class="text-2xl">${game.isHost ? moveIcons[game.host_move] : moveIcons[game.challenger_move]}</div>
                                    </div>`).join('') || '<div class="text-center text-gray-600 py-4">No battles yet</div>'}
                            </div>
                        </div>
                    </div>`;
            } catch (err) {
                content.innerHTML = '<div class="text-center text-red-500 py-8">Error loading profile</div>';
            }
        }

        function closePlayerModal() {
            document.getElementById('player-modal').classList.remove('active');
        }

        // ===========================
        // PROFILE PAGE
        // ===========================
        async function loadProfile() {
            const profileContent = document.getElementById('profile-content');
            if (!userAddress) {
                profileContent.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-orange-900 text-6xl mb-4">üîí</div>
                        <div class="text-orange-500 orbitron text-lg mb-2">UPLINK REQUIRED</div>
                        <div class="text-gray-500 text-sm">Connect your wallet to view pilot statistics</div>
                    </div>`;
                return;
            }
            
            profileContent.innerHTML = `<div class="text-center py-20"><div class="text-orange-500 animate-pulse">Loading pilot data...</div></div>`;
            
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .or(`host.eq.${userAddress.toLowerCase()},challenger.eq.${userAddress.toLowerCase()}`)
                    .order('game_id', { ascending: false });
                
                if (error) { profileContent.innerHTML = `<div class="text-red-500">Error loading profile</div>`; return; }
                
                let totalGames = 0, wins = 0, losses = 0, draws = 0, totalWagered = 0, totalWon = 0;
                const recentGames = [];
                
                games.forEach(game => {
                    const isHost = game.host === userAddress.toLowerCase();
                    const wager = parseFloat(game.wager);
                    if (game.status === 2 && game.host_move && game.challenger_move) {
                        totalGames++;
                        totalWagered += wager;
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        let result = '';
                        if (hostMove === challengerMove) {
                            draws++; result = 'DRAW'; totalWon += wager * 0.97;
                        } else {
                            const hostWins = (
                                (hostMove === 1 && challengerMove === 2) ||
                                (hostMove === 2 && challengerMove === 3) ||
                                (hostMove === 3 && challengerMove === 1)
                            );
                            if ((isHost && hostWins) || (!isHost && !hostWins)) {
                                wins++; result = 'WIN'; totalWon += wager * 2 * 0.97;
                            } else {
                                losses++; result = 'LOSS';
                            }
                        }
                        recentGames.push({ ...game, result, isHost });
                    }
                });
                
                const netPnL = totalWon - totalWagered;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                const moveIcons = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                
                profileContent.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-black/40 border border-orange-900/30 p-6 text-center">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Games</div>
                            <div class="orbitron text-3xl text-orange-500">${totalGames}</div>
                        </div>
                        <div class="bg-black/40 border border-green-900/30 p-6 text-center">
                            <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                            <div class="orbitron text-3xl text-green-500">${wins}</div>
                        </div>
                        <div class="bg-black/40 border border-red-900/30 p-6 text-center">
                            <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                            <div class="orbitron text-3xl text-red-500">${losses}</div>
                        </div>
                        <div class="bg-black/40 border border-yellow-900/30 p-6 text-center">
                            <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                            <div class="orbitron text-3xl text-yellow-500">${draws}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-black/40 border border-orange-900/30 p-6">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Win Rate</div>
                            <div class="orbitron text-2xl text-orange-500">${winRate}%</div>
                        </div>
                        <div class="bg-black/40 border border-orange-900/30 p-6">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Wagered</div>
                            <div class="orbitron text-2xl text-orange-500">${totalWagered.toFixed(2)}</div>
                        </div>
                        <div class="bg-black/40 border border-${netPnL >= 0 ? 'green' : 'red'}-900/30 p-6">
                            <div class="text-[10px] text-${netPnL >= 0 ? 'green' : 'red'}-800 uppercase mb-2">Net P&L</div>
                            <div class="orbitron text-2xl text-${netPnL >= 0 ? 'green' : 'red'}-500">${netPnL >= 0 ? '+' : ''}${netPnL.toFixed(2)}</div>
                        </div>
                    </div>
                    <h3 class="orbitron text-orange-500 mb-4">RECENT BATTLES</h3>
                    <div class="space-y-3">
                        ${recentGames.slice(0, 10).map(game => `
                            <div class="lobby-row bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-4 flex justify-between cursor-pointer" data-gameid="${game.game_id || ''}" onclick="if(this.dataset.gameid && this.dataset.gameid !== 'null') openMatchDetail(this.dataset.gameid)">
                                <div>
                                    <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500">${game.result}</span>
                                    <div class="text-sm mt-1"><span class="text-orange-500">${game.wager} $EROL</span><span class="text-gray-600 text-[10px] ml-2">Game #${game.game_id}</span></div>
                                </div>
                                <div class="text-2xl">${game.isHost ? moveIcons[game.host_move] : moveIcons[game.challenger_move]}</div>
                            </div>`).join('') || '<div class="text-center text-gray-600 py-8">No battles yet</div>'}
                    </div>`;
            } catch (err) {
                profileContent.innerHTML = `<div class="text-red-500">Error: ${err.message}</div>`;
            }
        }

        // ===========================
        // TAB SWITCHING
        // ===========================
        function getStatusText(s) { 
            return ["Open", "Intercepted", "Resolved", "Refunded", "Forfeited"][s] || "Unknown"; 
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${tab}`);
            if (tabBtn) tabBtn.classList.add('active');
            
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`page-${tab}`).classList.add('active');
            
            if (tab === 'profile') loadProfile();
            if (tab === 'leaderboard') loadLeaderboard();
        }
        
        function debugInfo() {
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            console.log("=== DEBUG INFO ===");
            console.log("Address:", userAddress);
            console.log("Contract:", CONTRACT_ADDR);
            console.log("Secrets:", Object.keys(secrets).length);
            Object.entries(secrets).forEach(([hash, data]) => {
                console.log(`Hash: ${hash}`, data);
            });
            alert(`Debug info in console (F12)\nSecrets stored: ${Object.keys(secrets).length}`);
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 4000);
        }
        
        // ===========================
        // BRIDGE OVERLAY
        // ===========================
        function openBridgeOverlay() {
            const overlay = document.getElementById('bridge-overlay');
            const iframe = document.getElementById('bridge-iframe');
            overlay.style.display = 'block';
            // Load the bridge URL now (lazy load)
            if (iframe.src === 'about:blank' || !iframe.src.includes('martianchain')) {
                iframe.src = 'https://bridge.martianchain.com/swap/';
            }
            document.body.style.overflow = 'hidden';
            initBridgeDrag();
        }

        function closeBridgeOverlay() {
            document.getElementById('bridge-overlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Close on backdrop click
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('bridge-overlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeBridgeOverlay();
                });
            }
        });

        // Drag logic for bridge window
        function initBridgeDrag() {
            const handle = document.getElementById('bridge-drag-handle');
            const win = document.getElementById('bridge-window');
            if (!handle || !win || handle._dragReady) return;
            handle._dragReady = true;

            let isDragging = false, startX, startY, startLeft, startTop;

            handle.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                isDragging = true;
                handle.style.cursor = 'grabbing';
                const rect = win.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                startLeft = rect.left;
                startTop = rect.top;
                // Switch from transform-based to absolute position
                win.style.left = startLeft + 'px';
                win.style.top = startTop + 'px';
                win.style.transform = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newLeft = Math.max(0, Math.min(window.innerWidth - win.offsetWidth, startLeft + dx));
                const newTop = Math.max(0, Math.min(window.innerHeight - 60, startTop + dy));
                win.style.left = newLeft + 'px';
                win.style.top = newTop + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    handle.style.cursor = 'grab';
                }
            });

            // Touch support
            handle.addEventListener('touchstart', (e) => {
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                isDragging = true;
                const rect = win.getBoundingClientRect();
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startLeft = rect.left;
                startTop = rect.top;
                win.style.left = startLeft + 'px';
                win.style.top = startTop + 'px';
                win.style.transform = 'none';
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;
                const newLeft = Math.max(0, Math.min(window.innerWidth - win.offsetWidth, startLeft + dx));
                const newTop = Math.max(0, Math.min(window.innerHeight - 60, startTop + dy));
                win.style.left = newLeft + 'px';
                win.style.top = newTop + 'px';
            }, { passive: true });

            document.addEventListener('touchend', () => { isDragging = false; });
        }

        window.onload = init;
        
        // Live countdown ticker ‚Äî updates every second
        setInterval(() => {
            document.querySelectorAll('[data-deadline]').forEach(el => {
                const deadline = parseInt(el.getAttribute('data-deadline'));
                const now = Math.floor(Date.now() / 1000);
                const remaining = deadline - now;
                if (remaining <= 0) {
                    el.textContent = '‚è± TIMEOUT';
                    el.className = el.className.replace(/text-\S+/g, '') + ' countdown-critical';
                    // Also disable any intercept buttons in the same row
                    const row = el.closest('[data-game-id]');
                    if (row) {
                        const interceptBtn = row.querySelector('[data-intercept-btn]');
                        if (interceptBtn) {
                            interceptBtn.disabled = true;
                            interceptBtn.textContent = 'Timed Out';
                            interceptBtn.className = 'text-[9px] text-red-700 uppercase italic px-4 py-2';
                        }
                    }
                } else if (remaining < 60) {
                    const s = remaining;
                    el.textContent = `‚è± 00:${String(s).padStart(2,'0')}`;
                    el.className = 'text-[10px] countdown-tick countdown-critical ml-2';
                    // Disable intercept buttons when < 60s
                    const row = el.closest('[data-game-id]');
                    if (row) {
                        const interceptBtn = row.querySelector('[data-intercept-btn]');
                        if (interceptBtn && !interceptBtn.disabled) {
                            interceptBtn.disabled = true;
                            interceptBtn.textContent = 'üîí Closing...';
                            interceptBtn.className = 'text-[9px] text-red-500 uppercase italic px-4 py-2 cursor-not-allowed opacity-60';
                        }
                    }
                } else {
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    el.textContent = `‚è± ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    if (remaining < 300) {
                        el.className = 'text-[10px] countdown-tick text-yellow-500 ml-2';
                    } else {
                        el.className = 'text-[10px] countdown-tick text-orange-500 ml-2';
                    }
                }
            });
        }, 1000);
        
        window.onbeforeunload = () => {
            if (lobbyRefreshInterval) clearInterval(lobbyRefreshInterval);
            if (activityRefreshInterval) clearInterval(activityRefreshInterval);
            if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        };
    </script>
</body>
</html>
