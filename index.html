<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit | Mission Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-orange: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --glow: rgba(255, 77, 0, 0.3);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(255, 77, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 77, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .mars-border-glow {
            border: 1px solid var(--mars-orange);
            box-shadow: 0 0 10px var(--glow);
        }

        .btn-mars {
            background: var(--mars-orange);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .btn-mars:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow);
            transform: scale(1.02);
        }

        .move-select {
            border: 1px solid #333;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .move-select.selected {
            border-color: var(--mars-orange);
            filter: grayscale(0);
            background: rgba(255, 77, 0, 0.1);
            box-shadow: inset 0 0 10px var(--glow);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(255, 77, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 100;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--habitat-bg); }
        ::-webkit-scrollbar-thumb { background: var(--mars-orange); }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="scanline"></div>

    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-4 border-b border-orange-900/30">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 mars-border-glow flex items-center justify-center bg-black">
                <span class="text-orange-500 text-2xl font-bold">M</span>
            </div>
            <div>
                <h1 class="orbitron text-2xl font-bold text-orange-500 tracking-widest">MARTIAN GAMBIT</h1>
                <p class="text-[10px] text-orange-800 uppercase tracking-[0.2em]">Sector 2027 // EROL Protocol</p>
            </div>
        </div>

        <div id="connection-interface" class="mt-4 md:mt-0">
            <button id="connect-btn" class="btn-mars px-8 py-2">Initialize Uplink</button>
            <div id="account-info" class="hidden flex items-center gap-4">
                <div class="text-right">
                    <div id="user-address" class="text-[10px] text-orange-400 opacity-70"></div>
                    <div id="user-balance" class="orbitron text-orange-500 font-bold">0.00 $EROL</div>
                </div>
                <div class="h-10 w-1 bg-orange-500"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        <aside class="lg:col-span-4 space-y-6">
            <div class="mars-glass p-6">
                <h2 class="orbitron text-sm text-orange-500 mb-6 flex items-center gap-2">
                    <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                    COMMENCE SIGNAL DEPLOYMENT
                </h2>

                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="selectMove(1)" id="move-1" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                        <span class="text-[9px] uppercase">Solar</span>
                    </button>
                    <button onclick="selectMove(2)" id="move-2" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå¨Ô∏è</span>
                        <span class="text-[9px] uppercase">Oxygen</span>
                    </button>
                    <button onclick="selectMove(3)" id="move-3" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå™Ô∏è</span>
                        <span class="text-[9px] uppercase">Dust</span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-orange-800 uppercase mb-2 block">Energy Stake ($EROL)</label>
                        <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron">
                    </div>
                    <button id="create-btn" onclick="handleCreateGame()" class="btn-mars w-full py-4 text-lg">Deploy Signal</button>
                </div>
            </div>
        </aside>

        <section class="lg:col-span-8">
            <div class="mars-glass p-6 min-h-[500px] relative overflow-hidden">
                <div class="flex justify-between items-center mb-8 border-b border-orange-900/20 pb-4">
                    <h2 class="orbitron text-lg text-white tracking-widest flex items-center gap-3">
                        LOBBY_FREQUENCIES
                        <span class="text-[10px] bg-orange-900/30 px-2 py-1 text-orange-500">FAST INDEX</span>
                    </h2>
                    <button onclick="refreshLobby()" class="text-[10px] text-orange-500 hover:text-white border border-orange-500/30 px-3 py-1 uppercase transition">Sync Data</button>
                </div>
                <div id="lobby-list" class="space-y-4"></div>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 mars-glass border-orange-500 px-8 py-4 text-orange-500 orbitron text-sm transform translate-y-32 transition-all duration-300 z-[200]">
        SYSTEM MESSAGE
    </div>

    <script>
        const CHAIN_ID = "0x7EB"; 
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const CONTRACT_ADDR = "0x0b912a321801B2f6062b4BdC3d9763e643584074";
        
        // Supabase Configuration
        const SB_URL = "https://tvckbtgggsuwxtlgilcl.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2Y2tidGdnZ3N1d3h0bGdpbGNsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDY2NDY0NSwiZXhwIjoyMDg2MjQwNjQ1fQ.DhvGNo3seKoRtDmeRod0gAP48yFZw_0-kAvY3eT_554"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const ABI = [
            "function createGame(bytes32 _hash) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timestamp, uint8 status)",
            "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager, bytes32 commitHash)"
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;

        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                refreshLobby();
                
                _supabase.channel('game_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, () => refreshLobby())
                    .subscribe();

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if ("0x" + network.chainId.toString(16).toUpperCase() !== CHAIN_ID.toUpperCase()) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID }],
                    });
                } catch (switchError) {
                    showToast("SWITCH TO MARTIAN NETWORK");
                    return false;
                }
            }
            return true;
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                
                if (!(await checkNetwork())) return;

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                document.getElementById('user-address').innerText = userAddress.toLowerCase();
                updateBalance();
                refreshLobby();
            } catch (err) { 
                console.error(err);
                showToast("UPLINK FAILED"); 
            }
        }

        async function updateBalance() {
            if (!userAddress || !provider) return;
            try {
                const balance = await provider.getBalance(userAddress);
                document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $EROL`;
            } catch (e) { console.error("Balance fetch error", e); }
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        async function handleCreateGame() {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (selectedMoveIdx === 0) return showToast("SELECT TACTICAL MOVE");
            if (!(await checkNetwork())) return;
            
            const wagerInput = document.getElementById('wager-amount').value;
            const wagerValue = ethers.parseEther(wagerInput);
            const salt = ethers.hexlify(ethers.randomBytes(16));
            const hash = ethers.solidityPackedKeccak256(["uint8", "string", "address"], [selectedMoveIdx, salt, userAddress]);

            try {
                showToast("ENCRYPTING SIGNAL...");
                const tx = await contract.createGame(hash, { value: wagerValue });
                
                showToast("WAITING FOR CONFIRMATION...");
                const receipt = await tx.wait();
                
                // Save secret locally
                const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
                secrets[hash] = { move: selectedMoveIdx, salt: salt };
                localStorage.setItem('martian_gambits', JSON.stringify(secrets));

                let gameId;
                // Method 1: Try parsing logs with proper error handling
                try {
                    for (const log of receipt.logs) {
                        try {
                            // Check if log is from our contract
                            if (log.address.toLowerCase() !== CONTRACT_ADDR.toLowerCase()) continue;
                            
                            const parsed = contract.interface.parseLog({
                                topics: log.topics,
                                data: log.data
                            });
                            
                            if (parsed && parsed.name === 'GameCreated') {
                                gameId = Number(parsed.args.gameId);
                                console.log("Game ID from event:", gameId);
                                break;
                            }
                        } catch(e) { 
                            // Skip logs that aren't GameCreated events
                            continue; 
                        }
                    }
                } catch (e) { 
                    console.warn("Log parsing failed:", e); 
                }

                // Method 2: Fallback to gameCounter
                if (gameId === undefined) {
                    try {
                        const counter = await contract.gameCounter();
                        gameId = Number(counter) - 1;
                        console.log("Game ID from counter:", gameId);
                    } catch (e) {
                        console.error("Counter fetch failed:", e);
                        throw new Error("Unable to determine game ID");
                    }
                }

                // INDEX TO SUPABASE
                const { error: sbError } = await _supabase.from('games').insert([{
                    game_id: gameId,
                    host: userAddress.toLowerCase(),
                    wager: wagerInput,
                    status: 0,
                    commit_hash: hash
                }]);

                if (sbError) console.error("Supabase insert error:", sbError);

                showToast("SIGNAL DEPLOYED");
                setTimeout(refreshLobby, 1000);
            } catch (err) { 
                console.error("Game Creation Error:", err);
                showToast("DEPLOYMENT ABORTED"); 
            }
        }

        async function refreshLobby() {
            const lobby = document.getElementById('lobby-list');
            try {
                const { data: games, error } = await _supabase.from('games')
                    .select('*').order('game_id', { ascending: false }).limit(30);

                if (error) {
                    console.error("Supabase Fetch Error:", error);
                    lobby.innerHTML = `<div class="text-center py-20 text-red-500 uppercase">Indexing Error</div>`;
                    return;
                }

                lobby.innerHTML = games.length ? "" : '<div class="text-center py-20 opacity-30 uppercase italic">No signals detected...</div>';

                games.forEach(game => {
                    const status = Number(game.status);
                    const isHost = userAddress && game.host === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                    
                    if (status > 1 && !isHost && !isChallenger) return;

                    const div = document.createElement('div');
                    div.className = "p-4 bg-black/40 border-l-2 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:bg-black/60 " + (status == 0 ? "border-orange-500" : "border-gray-800");
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] px-2 py-0.5 border ${status == 0 ? 'border-orange-500 text-orange-500' : 'border-gray-700 text-gray-500'} uppercase">${getStatusText(status)}</span>
                                <span class="text-[9px] text-orange-900/40">ID: ${game.game_id}</span>
                            </div>
                            <div class="orbitron text-white text-sm">
                                <span class="text-orange-500">${game.wager} $EROL</span> 
                                <span class="text-gray-600 text-[10px] ml-2">FROM ${game.host.slice(0,6)}...</span>
                            </div>
                        </div>
                        <div class="flex gap-2">${getActionButtons(game, isHost, isChallenger)}</div>`;
                    lobby.appendChild(div);
                });
            } catch (err) { 
                console.error("Lobby Refresh Catch:", err);
            }
        }

        function getActionButtons(game, isHost, isChallenger) {
            if (game.status == 0) {
                return isHost ? `<button onclick="handleRefund(${game.game_id})" class="text-[9px] border border-gray-700 px-4 py-2 hover:bg-white/5 uppercase">Retract</button>` : 
                                `<button onclick="handleChallenge(${game.game_id}, '${game.wager}')" class="btn-mars text-[10px] px-6 py-2">Intercept</button>`;
            }
            if (game.status == 1) {
                return isHost ? `<button onclick="handleResolve(${game.game_id}, '${game.commit_hash}')" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Broadcast Reveal</button>` : 
                                `<span class="text-[9px] text-orange-900 uppercase italic">Combat Active</span>`;
            }
            return `<span class="text-[9px] text-gray-700 uppercase">Inactive</span>`;
        }

        async function handleChallenge(id, wager) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const move = prompt("1-Solar, 2-Oxygen, 3-Dust");
            if (!move || move < 1 || move > 3) return showToast("INVALID MOVE");
            
            try {
                showToast("INTERCEPTING...");
                
                // Fetch actual wager from contract to ensure exact match
                const gameData = await contract.games(id);
                const actualWager = gameData.wager;
                
                const tx = await contract.challengeGame(id, move, { value: actualWager });
                showToast("WAITING FOR CONFIRMATION...");
                await tx.wait();
                
                // Update Supabase with challenger info
                await _supabase.from('games').update({ 
                    status: 1, 
                    challenger: userAddress.toLowerCase(),
                    challenger_move: parseInt(move)
                }).eq('game_id', id);
                
                refreshLobby();
                showToast("SIGNAL INTERCEPTED - AWAITING HOST REVEAL");
            } catch (err) { 
                console.error(err);
                showToast("INTERCEPTION FAILED"); 
            }
        }

        async function handleResolve(id, hash) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const secret = JSON.parse(localStorage.getItem('martian_gambits') || '{}')[hash];
            if (!secret) return showToast("LOCAL SECRET MISSING");
            
            try {
                showToast("BROADCASTING REVEAL...");
                const tx = await contract.resolveGame(id, secret.move, secret.salt);
                showToast("WAITING FOR CONFIRMATION...");
                await tx.wait();
                
                await _supabase.from('games').update({ status: 2 }).eq('game_id', id);
                refreshLobby();
                updateBalance();
                showToast("COMBAT RESOLVED");
            } catch (err) { 
                console.error(err);
                showToast("RESOLVE FAILED"); 
            }
        }

        async function handleRefund(id) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            try {
                showToast("RETRACTING SIGNAL...");
                const tx = await contract.refundUnchallenged(id);
                showToast("WAITING FOR CONFIRMATION...");
                await tx.wait();
                
                await _supabase.from('games').update({ status: 3 }).eq('game_id', id);
                refreshLobby();
                updateBalance();
                showToast("FUNDS RETRACTED");
            } catch (err) { 
                console.error(err);
                showToast("REFUND FAILED"); 
            }
        }

        function getStatusText(s) { return ["Open", "Intercepted", "Resolved", "Refunded", "Forfeited"][s]; }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 4000);
        }
        
        window.onload = init;
    </script>
</body>
</html>
