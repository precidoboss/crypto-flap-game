<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erol's Martian Gambit | Mission Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --mars-orange: #ff4d00;
            --habitat-bg: #060608;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --glow: rgba(255, 77, 0, 0.3);
        }

        body {
            background-color: var(--habitat-bg);
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(255, 77, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 77, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .mars-glass {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 77, 0, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .mars-border-glow {
            border: 1px solid var(--mars-orange);
            box-shadow: 0 0 10px var(--glow);
        }

        .btn-mars {
            background: var(--mars-orange);
            color: black;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .btn-mars:hover:not(:disabled) {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow);
            transform: scale(1.02);
        }

        .btn-mars:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-select {
            border: 1px solid #333;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .move-select.selected {
            border-color: var(--mars-orange);
            filter: grayscale(0);
            background: rgba(255, 77, 0, 0.1);
            box-shadow: inset 0 0 10px var(--glow);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(255, 77, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 100;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--habitat-bg); }
        ::-webkit-scrollbar-thumb { background: var(--mars-orange); }

        .tab-btn {
            color: #666;
            background: transparent;
        }

        .tab-btn:hover {
            color: var(--mars-orange);
        }

        .tab-btn.active {
            color: var(--mars-orange);
            background: rgba(255, 77, 0, 0.1);
            border-bottom: 2px solid var(--mars-orange);
        }

        .lobby-filter {
            color: #666;
            background: transparent;
        }

        .lobby-filter:hover {
            color: var(--mars-orange);
        }

        .lobby-filter.active {
            color: var(--mars-orange);
            background: rgba(255, 77, 0, 0.1);
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .copy-btn {
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            color: var(--mars-orange);
            transform: scale(1.1);
        }

        .header-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 2px solid var(--mars-orange);
        }

        .game-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .activity-feed {
            height: 500px;
            overflow-y: auto;
        }

        .lobby-row {
            cursor: pointer;
            transition: all 0.2s;
        }
        .lobby-row:hover {
            background: rgba(255, 77, 0, 0.05) !important;
            border-left-color: #ff6622 !important;
        }

        /* Match Detail Subpage */
        #page-match {
            display: none;
        }
        #page-match.active {
            display: block;
        }

        .stat-card {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,77,0,0.2);
            padding: 1.5rem;
            text-align: center;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 8px;
            bottom: 0;
            width: 1px;
            background: rgba(255,77,0,0.2);
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 0;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--mars-orange);
            border: 2px solid var(--habitat-bg);
        }
        .timeline-item:last-child::before {
            display: none;
        }

        /* Bridge iframe */
        .bridge-iframe {
            width: 100%;
            height: 750px;
            border: none;
            border-radius: 0 0 4px 4px;
        }

        /* Live countdown ticker */
        .countdown-tick {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
            transition: color 0.3s;
        }
        @keyframes blink-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        /* FAQ accordion */
        details summary::-webkit-details-marker { display: none; }
        details[open] summary span:last-child { transform: rotate(180deg); display: inline-block; }
        details[open] { border-color: rgba(255,77,0,0.3) !important; }

        .countdown-critical {
            animation: blink-red 0.8s ease-in-out infinite;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .header-banner {
                height: 120px;
            }
            .game-logo {
                width: 45px;
                height: 45px;
            }
            .chat-messages {
                height: 300px;
            }
            .bridge-iframe {
                height: 600px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="scanline"></div>

    <!-- Header Banner -->
    <div class="max-w-7xl mx-auto mb-4">
        <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-01_14-21-55.jpg" 
             alt="Martian Gambit Header" 
             class="header-banner"
             onerror="this.style.display='none'">
    </div>

    <nav class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 py-4 border-b border-orange-900/30">
        <div class="flex items-center gap-4">
            <img src="https://raw.githubusercontent.com/precidoboss/my-game-sprites/main/photo_2026-02-01_14-13-33.jpg" 
                 alt="Martian Gambit Logo" 
                 class="game-logo"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-12 h-12 mars-border-glow hidden items-center justify-center bg-black">
                <span class="text-orange-500 text-2xl font-bold">M</span>
            </div>
            <div>
                <h1 class="orbitron text-2xl font-bold text-orange-500 tracking-widest">MARTIAN GAMBIT</h1>
                <p class="text-[10px] text-orange-800 uppercase tracking-[0.2em]">Sector 2027 // EROL Protocol</p>
            </div>
        </div>

        <div class="flex items-center gap-6 mt-4 md:mt-0">
            <div class="flex gap-1 bg-black/40 p-1 border border-orange-900/30 flex-wrap">
                <button onclick="switchTab('lobby')" id="tab-lobby" class="tab-btn active px-4 py-2 text-[10px] uppercase transition">Lobby</button>
                <button onclick="switchTab('leaderboard')" id="tab-leaderboard" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Leaderboard</button>
                <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Profile</button>
                <button onclick="switchTab('bridge')" id="tab-bridge" class="tab-btn px-4 py-2 text-[10px] uppercase transition">Bridge</button>
                <button onclick="switchTab('howto')" id="tab-howto" class="tab-btn px-4 py-2 text-[10px] uppercase transition">How to Play</button>
            </div>

            <div id="connection-interface">
                <button id="connect-btn" class="btn-mars px-8 py-2">Initialize Uplink</button>
                <div id="account-info" class="hidden flex items-center gap-3">
                    <div class="text-right">
                        <div class="flex items-center gap-2">
                            <span id="user-address" class="text-[10px] text-orange-400 opacity-70"></span>
                            <button id="copy-address" class="copy-btn text-orange-400 text-xs" onclick="copyAddress()" title="Copy Address">üìã</button>
                        </div>
                        <div id="user-balance" class="orbitron text-orange-500 font-bold text-sm">0.00 $EROL</div>
                    </div>
                    <div class="h-10 w-1 bg-orange-500"></div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto">

        <!-- LOBBY PAGE -->
        <div id="page-lobby" class="page-section active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <aside class="lg:col-span-4 space-y-6">
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm text-orange-500 mb-6 flex items-center gap-2">
                            <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                            COMMENCE SIGNAL DEPLOYMENT
                        </h2>

                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <button onclick="selectMove(1)" id="move-1" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                                <span class="text-[9px] uppercase">Solar</span>
                            </button>
                            <button onclick="selectMove(2)" id="move-2" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå¨Ô∏è</span>
                                <span class="text-[9px] uppercase">Oxygen</span>
                            </button>
                            <button onclick="selectMove(3)" id="move-3" class="move-select p-4 bg-black flex flex-col items-center">
                                <span class="text-3xl mb-2">üå™Ô∏è</span>
                                <span class="text-[9px] uppercase">Dust</span>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-orange-800 uppercase mb-2 block">Energy Stake ($EROL)</label>
                                <input id="wager-amount" type="number" step="0.1" value="1.0" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron">
                            </div>
                            <div>
                                <label class="text-[10px] text-orange-800 uppercase mb-2 block">Interception Timeout</label>
                                <select id="timeout-select" class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron text-sm">
                                    <option value="300">5 Minutes</option>
                                    <option value="600">10 Minutes</option>
                                    <option value="900" selected>15 Minutes</option>
                                </select>
                            </div>
                            <button id="create-btn" onclick="handleCreateGame()" class="btn-mars w-full py-4 text-lg">Deploy Signal</button>
                            <button onclick="debugInfo()" class="w-full py-2 text-[9px] border border-orange-900/30 text-orange-700 hover:text-orange-500 uppercase">Debug Info</button>
                        </div>
                    </div>

                    <!-- Global Chat -->
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-sm text-orange-500 mb-4 flex items-center gap-2">
                            <span class="w-2 h-2 bg-orange-500 animate-pulse"></span>
                            GLOBAL COMMS
                        </h2>
                        <div id="chat-messages" class="chat-messages mb-4 bg-black/40 border border-orange-900/30 p-3 space-y-2"></div>
                        <div class="flex gap-2">
                            <input id="chat-input" type="text" placeholder="Type message..." maxlength="200" class="flex-1 bg-black border border-orange-900/50 p-2 text-sm text-orange-500 focus:outline-none focus:border-orange-500" onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="btn-mars px-4 py-2 text-xs">Send</button>
                        </div>
                    </div>
                </aside>

                <section class="lg:col-span-8 space-y-6">
                    <div class="mars-glass p-6 min-h-[500px] relative overflow-hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-orange-900/20 pb-4 gap-4">
                            <h2 class="orbitron text-lg text-white tracking-widest flex items-center gap-3">
                                LOBBY_FREQUENCIES
                                <span class="text-[10px] bg-orange-900/30 px-2 py-1 text-orange-500">FAST INDEX</span>
                            </h2>
                            
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="flex gap-1 bg-black/40 p-1 border border-orange-900/30">
                                    <button onclick="setLobbyFilter('all')" id="filter-all" class="lobby-filter active px-3 py-1 text-[9px] uppercase transition">All</button>
                                    <button onclick="setLobbyFilter('open')" id="filter-open" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Open</button>
                                    <button onclick="setLobbyFilter('intercepted')" id="filter-intercepted" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Intercepted</button>
                                    <button onclick="setLobbyFilter('resolved')" id="filter-resolved" class="lobby-filter px-3 py-1 text-[9px] uppercase transition">Resolved</button>
                                </div>
                                <button onclick="refreshLobby()" class="text-[10px] text-orange-500 hover:text-white border border-orange-500/30 px-3 py-1 uppercase transition">Sync Data</button>
                            </div>
                        </div>
                        <div id="lobby-list" class="space-y-4"></div>
                    </div>

                    <!-- Live Activity Feed -->
                    <div class="mars-glass p-6">
                        <h2 class="orbitron text-lg text-white tracking-widest mb-6 flex items-center gap-3">
                            LIVE ACTIVITY FEED
                            <span class="w-2 h-2 bg-green-500 animate-pulse"></span>
                        </h2>
                        <div id="activity-feed" class="activity-feed space-y-2"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- MATCH DETAIL PAGE -->
        <div id="page-match" class="page-section">
            <div class="mb-4">
                <button onclick="goBackToLobby()" class="flex items-center gap-2 text-orange-500 hover:text-white text-sm uppercase transition border border-orange-900/30 px-4 py-2 hover:border-orange-500/50">
                    ‚Üê Back to Lobby
                </button>
            </div>
            <div id="match-detail-content"></div>
        </div>

        <!-- LEADERBOARD PAGE -->
        <div id="page-leaderboard" class="page-section">
            <div class="mars-glass p-8">
                <h2 class="orbitron text-2xl text-orange-500 mb-8 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    PILOT RANKINGS
                </h2>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-2">Total Wagered</div>
                        <div id="global-wagered" class="orbitron text-2xl text-orange-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-red-900/30 p-4 text-center">
                        <div class="text-[10px] text-red-800 uppercase mb-2">Burnt ($EROL)</div>
                        <div id="global-burnt" class="orbitron text-2xl text-red-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-blue-900/30 p-4 text-center">
                        <div class="text-[10px] text-blue-800 uppercase mb-2">Treasury</div>
                        <div id="global-treasury" class="orbitron text-2xl text-blue-500">--</div>
                    </div>
                    <div class="bg-black/40 border border-green-900/30 p-4 text-center">
                        <div class="text-[10px] text-green-800 uppercase mb-2">Games Played</div>
                        <div id="global-games" class="orbitron text-2xl text-green-500">--</div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-orange-900/30">
                                <th class="text-left p-3 text-[10px] text-orange-800 uppercase">Rank</th>
                                <th class="text-left p-3 text-[10px] text-orange-800 uppercase">Pilot</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Wagered</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Win Rate</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Biggest Pot</th>
                                <th class="text-right p-3 text-[10px] text-orange-800 uppercase">Win Streak</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="page-profile" class="page-section">
            <div class="mars-glass p-8 max-w-5xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-8 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    PILOT STATISTICS
                </h2>
                <div id="profile-content" class="space-y-6"></div>
            </div>
        </div>

        <!-- HOW TO PLAY PAGE -->
        <div id="page-howto" class="page-section">
            <div class="max-w-4xl mx-auto space-y-6">

                <!-- Header -->
                <div class="mars-glass p-8">
                    <h2 class="orbitron text-2xl text-orange-500 mb-2">MISSION BRIEFING</h2>
                    <p class="text-gray-500 text-sm">Everything you need to know to survive the Martian arena.</p>

                    <!-- Social Links -->
                    <div class="flex flex-wrap gap-3 mt-5 pt-5 border-t border-orange-900/20">
                        <a href="https://twitter.com/ErolMuskAvax" target="_blank" rel="noopener noreferrer"
                           class="flex items-center gap-2 px-4 py-2 border border-orange-900/40 text-orange-600 hover:text-orange-400 hover:border-orange-500/50 text-[11px] uppercase transition tracking-widest">
                            ùïè @ErolMuskAvax
                        </a>
                        <a href="https://erolmusk.com" target="_blank" rel="noopener noreferrer"
                           class="flex items-center gap-2 px-4 py-2 border border-orange-900/40 text-orange-600 hover:text-orange-400 hover:border-orange-500/50 text-[11px] uppercase transition tracking-widest">
                            üåê erolmusk.com
                        </a>
                        <a href="https://twitter.com/Precidobos" target="_blank" rel="noopener noreferrer"
                           class="flex items-center gap-2 px-4 py-2 border border-orange-900/40 text-orange-600 hover:text-orange-400 hover:border-orange-500/50 text-[11px] uppercase transition tracking-widest">
                            üõ† Dev: @Precidobos
                        </a>
                    </div>
                </div>

                <!-- What is it -->
                <div class="mars-glass p-8">
                    <h3 class="orbitron text-orange-500 text-lg mb-4">üéØ WHAT IS MARTIAN GAMBIT?</h3>
                    <p class="text-gray-300 leading-relaxed mb-4">
                        Martian Gambit is a <span class="text-orange-400">provably fair, on-chain PvP wagering game</span> built on the Martian Chain. 
                        Two pilots face off in a battle of wits using three strategic moves ‚Äî a futuristic take on Rock-Paper-Scissors. 
                        Bet <span class="text-orange-400">$EROL tokens</span>, outthink your opponent, and claim victory.
                    </p>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        Every game is secured by cryptographic commitments on the blockchain ‚Äî the host's move is hashed before the challenger joins, 
                        guaranteeing neither player can cheat. No house edge beyond a small 3% fee split between the treasury and token burn.
                    </p>
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        <div class="bg-black/40 border border-orange-900/20 p-4 text-center">
                            <div class="orbitron text-orange-500 text-xl mb-1">97%</div>
                            <div class="text-[10px] text-gray-500 uppercase">Winner Keeps</div>
                        </div>
                        <div class="bg-black/40 border border-orange-900/20 p-4 text-center">
                            <div class="orbitron text-orange-500 text-xl mb-1">0%</div>
                            <div class="text-[10px] text-gray-500 uppercase">House Edge</div>
                        </div>
                        <div class="bg-black/40 border border-orange-900/20 p-4 text-center">
                            <div class="orbitron text-orange-500 text-xl mb-1">‚àû</div>
                            <div class="text-[10px] text-gray-500 uppercase">On-Chain Proof</div>
                        </div>
                    </div>
                </div>

                <!-- The Three Moves -->
                <div class="mars-glass p-8">
                    <h3 class="orbitron text-orange-500 text-lg mb-4">‚öîÔ∏è THE THREE MOVES</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-black/40 p-5 border border-orange-900/30 text-center">
                            <div class="text-5xl mb-3">‚òÄÔ∏è</div>
                            <div class="orbitron text-orange-500 mb-2">SOLAR FLARE</div>
                            <div class="text-xs text-gray-400 mb-1">‚úÖ Beats Oxygen Siphon</div>
                            <div class="text-xs text-gray-600">‚ùå Loses to Dust Storm</div>
                        </div>
                        <div class="bg-black/40 p-5 border border-orange-900/30 text-center">
                            <div class="text-5xl mb-3">üå¨Ô∏è</div>
                            <div class="orbitron text-orange-500 mb-2">OXYGEN SIPHON</div>
                            <div class="text-xs text-gray-400 mb-1">‚úÖ Beats Dust Storm</div>
                            <div class="text-xs text-gray-600">‚ùå Loses to Solar Flare</div>
                        </div>
                        <div class="bg-black/40 p-5 border border-orange-900/30 text-center">
                            <div class="text-5xl mb-3">üå™Ô∏è</div>
                            <div class="orbitron text-orange-500 mb-2">DUST STORM</div>
                            <div class="text-xs text-gray-400 mb-1">‚úÖ Beats Solar Flare</div>
                            <div class="text-xs text-gray-600">‚ùå Loses to Oxygen Siphon</div>
                        </div>
                    </div>
                    <div class="bg-black/40 border border-orange-900/20 p-3 text-center text-[11px] text-gray-500">
                        ‚òÄÔ∏è Solar ‚Üí beats ‚Üí üå¨Ô∏è Oxygen ‚Üí beats ‚Üí üå™Ô∏è Dust ‚Üí beats ‚Üí ‚òÄÔ∏è Solar
                    </div>
                </div>

                <!-- Step by step -->
                <div class="mars-glass p-8">
                    <h3 class="orbitron text-orange-500 text-lg mb-6">üìã HOW TO PLAY ‚Äî STEP BY STEP</h3>

                    <div class="space-y-6">
                        <!-- Step 1 -->
                        <div class="flex gap-5 items-start">
                            <div class="orbitron text-orange-500 text-3xl font-bold shrink-0 w-10 text-center">1</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-base mb-2">Get $EROL on Martian Chain</div>
                                <p class="text-sm text-gray-400 leading-relaxed mb-2">
                                    You need $EROL tokens on the <span class="text-orange-500">Martian Chain (Chain ID: 2027)</span> to play. 
                                    If you have $EROL on Avalanche C-Chain, use the <strong class="text-orange-400">Bridge tab</strong> to transfer them over at a 1:1 ratio with zero fees (gas only).
                                </p>
                                <div class="bg-black/40 border border-orange-900/20 p-3 text-[11px] text-gray-500">
                                    üí° Add Martian Chain to MetaMask: RPC ‚Üí <span class="text-orange-700">https://martian-rpc1.amichain.org/</span> ¬∑ Chain ID: 2027 ¬∑ Symbol: EROL
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-orange-900/10"></div>

                        <!-- Step 2 -->
                        <div class="flex gap-5 items-start">
                            <div class="orbitron text-orange-500 text-3xl font-bold shrink-0 w-10 text-center">2</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-base mb-2">Connect Your Wallet</div>
                                <p class="text-sm text-gray-400 leading-relaxed">
                                    Click <strong class="text-orange-400">"Initialize Uplink"</strong> in the top right. MetaMask (or compatible wallet) will prompt you. 
                                    The app will automatically switch to Martian Chain ‚Äî if the network isn't in your wallet yet, it will add it for you automatically.
                                </p>
                            </div>
                        </div>

                        <div class="border-t border-orange-900/10"></div>

                        <!-- Step 3 -->
                        <div class="flex gap-5 items-start">
                            <div class="orbitron text-orange-500 text-3xl font-bold shrink-0 w-10 text-center">3</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-base mb-2">Deploy a Signal (Create a Game)</div>
                                <p class="text-sm text-gray-400 leading-relaxed mb-3">
                                    In the left panel, pick your secret move, set your wager amount in $EROL, and choose a timeout window (5, 10, or 15 minutes). 
                                    Hit <strong class="text-orange-400">"Deploy Signal"</strong>.
                                </p>
                                <div class="bg-orange-900/10 border border-orange-900/30 p-3 text-[11px] text-gray-400 space-y-1">
                                    <div class="text-orange-500 font-bold uppercase mb-1">‚ö†Ô∏è Critical ‚Äî Don't lose your reveal key</div>
                                    <div>Your move is encrypted and stored in <strong>this browser only</strong>. If you clear browser data, switch devices, or use incognito mode, you will not be able to reveal your move and will forfeit the game.</div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-orange-900/10"></div>

                        <!-- Step 4 -->
                        <div class="flex gap-5 items-start">
                            <div class="orbitron text-orange-500 text-3xl font-bold shrink-0 w-10 text-center">4</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-base mb-2">Intercept (Join a Game as Challenger)</div>
                                <p class="text-sm text-gray-400 leading-relaxed mb-2">
                                    Browse the <strong class="text-orange-400">Lobby</strong> for open signals. Click a row to view full details, or hit <strong class="text-orange-400">"Intercept"</strong> to join. 
                                    Choose your move in the popup, then confirm. You must match the host's exact wager amount ‚Äî this is deducted from your wallet automatically.
                                </p>
                                <div class="bg-black/40 border border-orange-900/20 p-3 text-[11px] text-gray-500">
                                    üîí You cannot join a game with less than 60 seconds remaining on the timer ‚Äî this prevents last-second sniping.
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-orange-900/10"></div>

                        <!-- Step 5 -->
                        <div class="flex gap-5 items-start">
                            <div class="orbitron text-orange-500 text-3xl font-bold shrink-0 w-10 text-center">5</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-base mb-2">Broadcast Reveal (Host Reveals Move)</div>
                                <p class="text-sm text-gray-400 leading-relaxed mb-2">
                                    Once a challenger joins, the game status changes to <span class="text-yellow-500">Intercepted</span>. As host, you must return to the lobby 
                                    <strong>on the same browser/device</strong> and click <strong class="text-orange-400">"Broadcast Reveal"</strong> before the timer expires.
                                </p>
                                <p class="text-sm text-gray-400 leading-relaxed">
                                    The smart contract then compares both moves on-chain and automatically sends winnings to the winner ‚Äî no manual claim needed.
                                </p>
                            </div>
                        </div>

                        <div class="border-t border-orange-900/10"></div>

                        <!-- Step 6 -->
                        <div class="flex gap-5 items-start">
                            <div class="orbitron text-orange-500 text-3xl font-bold shrink-0 w-10 text-center">6</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-base mb-2">Collect Winnings</div>
                                <p class="text-sm text-gray-400 leading-relaxed">
                                    Winnings are sent directly to your wallet by the smart contract ‚Äî there is nothing to claim. 
                                    Check your Profile tab for your full battle history and P&L tracking.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeout rules -->
                <div class="mars-glass p-8">
                    <h3 class="orbitron text-orange-500 text-lg mb-4">‚è± TIMEOUT RULES</h3>
                    <div class="space-y-4 text-sm text-gray-400">
                        <div class="flex gap-3 items-start">
                            <span class="text-orange-500 shrink-0 mt-0.5">‚Üí</span>
                            <div><strong class="text-white">No Challenger Within Timeout:</strong> If nobody intercepts your signal before the timer hits zero, click <strong class="text-orange-400">"Retract"</strong> on your game to get your full wager back.</div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <span class="text-orange-500 shrink-0 mt-0.5">‚Üí</span>
                            <div><strong class="text-white">Host Fails to Reveal:</strong> If you joined a game and the host doesn't reveal before timeout, you can click <strong class="text-orange-400">"Claim Victory"</strong> to force-forfeit and claim the full pot.</div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <span class="text-orange-500 shrink-0 mt-0.5">‚Üí</span>
                            <div><strong class="text-white">Last 60 Seconds:</strong> Open games are locked for joining in the final 60 seconds of their countdown. This protects against manipulation.</div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <span class="text-orange-500 shrink-0 mt-0.5">‚Üí</span>
                            <div><strong class="text-white">Draw Result:</strong> If both pilots choose the same move, both receive their original wager minus the 3% protocol fee (1.5% treasury + 1.5% burned).</div>
                        </div>
                    </div>
                </div>

                <!-- Fees -->
                <div class="mars-glass p-8">
                    <h3 class="orbitron text-orange-500 text-lg mb-4">üí∞ FEES & PAYOUTS</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-orange-900/30">
                                    <th class="text-left py-2 text-[10px] text-orange-800 uppercase">Scenario</th>
                                    <th class="text-right py-2 text-[10px] text-orange-800 uppercase">Winner Gets</th>
                                    <th class="text-right py-2 text-[10px] text-orange-800 uppercase">Treasury</th>
                                    <th class="text-right py-2 text-[10px] text-orange-800 uppercase">Burned</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-400">
                                <tr class="border-b border-orange-900/10">
                                    <td class="py-3 text-white">Win (e.g. 5 $EROL pot)</td>
                                    <td class="py-3 text-right text-green-500 orbitron">4.85 $EROL</td>
                                    <td class="py-3 text-right text-blue-500">0.075</td>
                                    <td class="py-3 text-right text-red-500">0.075</td>
                                </tr>
                                <tr class="border-b border-orange-900/10">
                                    <td class="py-3 text-white">Draw (each gets back)</td>
                                    <td class="py-3 text-right text-yellow-500 orbitron">97% of wager</td>
                                    <td class="py-3 text-right text-blue-500">1.5%</td>
                                    <td class="py-3 text-right text-red-500">1.5%</td>
                                </tr>
                                <tr>
                                    <td class="py-3 text-white">Forfeit (challenger claims)</td>
                                    <td class="py-3 text-right text-green-500 orbitron">Full pot √ó 97%</td>
                                    <td class="py-3 text-right text-blue-500">1.5%</td>
                                    <td class="py-3 text-right text-red-500">1.5%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FAQ -->
                <div class="mars-glass p-8">
                    <h3 class="orbitron text-orange-500 text-lg mb-6">‚ùì FREQUENTLY ASKED QUESTIONS</h3>
                    <div class="space-y-5" id="faq-list">

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>What wallet do I need?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                MetaMask (browser extension or mobile app) is the most compatible. Any EVM-compatible wallet that supports custom networks should work. 
                                The app will automatically prompt you to add Martian Chain (Chain ID: 2027) when you connect.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>How do I get $EROL tokens?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                Visit <a href="https://erolmusk.com" target="_blank" class="text-orange-500 hover:underline">erolmusk.com</a> for the official token information. 
                                If you already hold $EROL on Avalanche C-Chain, use the <strong class="text-orange-400">Bridge tab</strong> in this app to transfer to Martian Chain at a 1:1 ratio.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>I created a game but can't reveal. What happened?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                Your move secret is stored in your browser's local storage ‚Äî it's tied to the specific browser and device you used to create the game. 
                                If you switched browsers, cleared cookies, or used incognito mode, the secret is gone. 
                                If a challenger joins and you cannot reveal, they can claim victory after the timeout by clicking "Claim Victory".
                                Always play from the same browser you started on.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>Is the game provably fair?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                Yes. When you deploy a signal (create a game), your move is hashed using a cryptographic commitment: 
                                <code class="text-orange-700 text-[10px]">keccak256(move, salt, address, gameId)</code>. 
                                This hash is stored on-chain. The challenger commits their move openly. When the host reveals, 
                                the smart contract verifies the hash matches ‚Äî making it mathematically impossible for the host to change their move after seeing the challenger's choice.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>Can I play on mobile?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                Yes! Open this app in the <strong class="text-white">MetaMask in-app browser</strong> (tap the globe/browser icon inside MetaMask) for the best experience on mobile. 
                                Standard mobile browsers like Chrome or Safari may have trouble connecting to MetaMask ‚Äî the in-app browser bypasses this issue entirely.
                                For the bridge on mobile, tap "Open Bridge in New Tab" for full wallet compatibility.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>What happens if I close the browser after intercepting?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                As a challenger, closing the browser has no effect ‚Äî your move and wager are already locked on-chain. 
                                Simply come back and find your game in the lobby. If the host doesn't reveal in time, you can claim victory from any device.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>What is the Martian Chain?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                Martian Chain is a custom EVM-compatible blockchain built for the Erol Musk ecosystem. 
                                It uses $EROL as its native gas token. Network details: RPC <span class="text-orange-700">https://martian-rpc1.amichain.org/</span> ¬∑ Chain ID: 2027 ¬∑ Symbol: EROL.
                                Visit <a href="https://erolmusk.com" target="_blank" class="text-orange-500 hover:underline">erolmusk.com</a> for more.
                            </div>
                        </details>

                        <details class="border border-orange-900/20 bg-black/20">
                            <summary class="p-4 cursor-pointer text-white font-bold text-sm hover:text-orange-400 transition list-none flex justify-between items-center">
                                <span>Who built this?</span>
                                <span class="text-orange-600 text-xs">‚ñº</span>
                            </summary>
                            <div class="px-4 pb-4 text-sm text-gray-400 leading-relaxed border-t border-orange-900/20 pt-3">
                                Martian Gambit was developed by <a href="https://twitter.com/Precidobos" target="_blank" class="text-orange-500 hover:underline">@Precidobos</a> for the 
                                <a href="https://twitter.com/ErolMuskAvax" target="_blank" class="text-orange-500 hover:underline">@ErolMuskAvax</a> project. 
                                Visit <a href="https://erolmusk.com" target="_blank" class="text-orange-500 hover:underline">erolmusk.com</a> for the official token and community.
                            </div>
                        </details>

                    </div>
                </div>

                <!-- Quick Reference Card -->
                <div class="mars-glass p-6 bg-orange-900/5 border border-orange-500/20">
                    <h3 class="orbitron text-orange-500 text-sm mb-4 uppercase">‚ö° Quick Reference</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-[11px] text-gray-400">
                        <div class="space-y-2">
                            <div class="text-orange-600 uppercase font-bold mb-1">Move Rules</div>
                            <div>‚òÄÔ∏è Solar beats üå¨Ô∏è Oxygen</div>
                            <div>üå¨Ô∏è Oxygen beats üå™Ô∏è Dust</div>
                            <div>üå™Ô∏è Dust beats ‚òÄÔ∏è Solar</div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-orange-600 uppercase font-bold mb-1">Network Info</div>
                            <div>Chain: Martian Chain</div>
                            <div>Chain ID: 2027</div>
                            <div>Token: $EROL</div>
                            <div>RPC: martian-rpc1.amichain.org</div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-orange-600 uppercase font-bold mb-1">Links</div>
                            <div><a href="https://twitter.com/ErolMuskAvax" target="_blank" class="text-orange-700 hover:text-orange-500">ùïè @ErolMuskAvax</a></div>
                            <div><a href="https://erolmusk.com" target="_blank" class="text-orange-700 hover:text-orange-500">üåê erolmusk.com</a></div>
                            <div><a href="https://twitter.com/Precidobos" target="_blank" class="text-orange-700 hover:text-orange-500">üõ† Dev: @Precidobos</a></div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-orange-600 uppercase font-bold mb-1">Fee Structure</div>
                            <div>Winner: 97% of pot</div>
                            <div>Treasury: 1.5%</div>
                            <div>Burned: 1.5%</div>
                            <div>Draw: both get wager √ó 97%</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- BRIDGE PAGE -->
        <div id="page-bridge" class="page-section">
            <div class="mars-glass p-8 max-w-5xl mx-auto">
                <h2 class="orbitron text-2xl text-orange-500 mb-2 flex items-center gap-3">
                    <span class="w-3 h-3 bg-orange-500 animate-pulse"></span>
                    CROSS-CHAIN BRIDGE
                </h2>
                <p class="text-gray-500 text-sm mb-6">Transfer $EROL from Avalanche C-Chain to Martian Chain (1:1 ratio)</p>

                <!-- Info cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-1">Exchange Rate</div>
                        <div class="orbitron text-orange-500">1:1 $EROL</div>
                    </div>
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-1">Bridge Fee</div>
                        <div class="orbitron text-orange-500">Gas Only</div>
                    </div>
                    <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                        <div class="text-[10px] text-orange-800 uppercase mb-1">Min Amount</div>
                        <div class="orbitron text-orange-500">1 $EROL</div>
                    </div>
                </div>

                <!-- Contract addresses -->
                <div class="bg-black/40 border border-orange-900/20 p-4 mb-6 text-[11px] text-gray-600 flex flex-wrap gap-6">
                    <div>Bridge Contract: <span class="text-orange-600">0xF95B...1928</span></div>
                    <div>Token Address (AVAX): <span class="text-orange-600">0xCaC4...D037</span></div>
                    <div>Chain ID (Martian): <span class="text-orange-600">2027</span></div>
                </div>

                <!-- Bridge launch -->
                <div class="space-y-4">
                    <button onclick="openBridgeOverlay()" class="btn-mars w-full py-5 text-lg" style="clip-path:none;border-radius:2px;">
                        üåâ &nbsp; Launch Bridge Interface
                    </button>
                    <a href="https://bridge.martianchain.com/swap/" target="_blank" rel="noopener noreferrer"
                       class="block w-full py-3 text-center text-[11px] border border-orange-900/40 text-orange-700 hover:text-orange-500 hover:border-orange-500/50 uppercase transition tracking-widest">
                        Open Bridge in New Tab ‚Üó
                    </a>
                </div>

                <div class="mt-6 bg-orange-900/10 border border-orange-900/30 p-4 text-[11px] text-gray-500 space-y-1">
                    <div class="text-orange-600 font-bold uppercase mb-2">‚ö†Ô∏è Wallet Connection Guide</div>
                    <div class="font-bold text-gray-300 mt-1 mb-1">On Desktop (PC / Mac):</div>
                    <div>‚Ä¢ Click "Launch Bridge Interface" ‚Äî bridge opens as a draggable full-screen overlay</div>
                    <div>‚Ä¢ Connect MetaMask directly inside that window, then drag to reposition</div>
                    <div class="font-bold text-gray-300 mt-3 mb-1">On Mobile:</div>
                    <div>‚Ä¢ Open <strong class="text-orange-500">MetaMask app</strong> ‚Üí tap the built-in browser (globe icon) ‚Üí navigate here</div>
                    <div>‚Ä¢ Or tap <strong class="text-orange-500">"Open Bridge in New Tab"</strong> for full wallet support in any mobile browser</div>
                    <div class="mt-2 text-gray-600">‚ö†Ô∏è Standard mobile Chrome/Safari cannot inject wallet into iframes. Always use MetaMask's in-app browser or open in a new tab.</div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bridge Full-Screen Overlay ‚Äî draggable floating window -->
    <div id="bridge-overlay" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px);">
        <div id="bridge-window" style="
            position:absolute;top:2%;left:50%;transform:translateX(-50%);
            width:min(960px,96vw);height:94vh;
            background:#0a0a0c;
            border:1px solid rgba(255,77,0,0.5);
            box-shadow:0 0 60px rgba(255,77,0,0.12),0 0 120px rgba(0,0,0,0.8);
            display:flex;flex-direction:column;border-radius:4px;overflow:hidden;
        ">
            <!-- Title bar / drag handle -->
            <div id="bridge-drag-handle" style="
                background:rgba(15,15,18,0.98);
                border-bottom:1px solid rgba(255,77,0,0.3);
                padding:10px 16px;
                display:flex;align-items:center;gap:10px;
                cursor:grab;user-select:none;flex-shrink:0;
            ">
                <span style="width:8px;height:8px;background:#ff4d00;border-radius:50%;display:inline-block;box-shadow:0 0 6px #ff4d00;"></span>
                <span style="font-family:'Orbitron',sans-serif;font-size:11px;color:#ff4d00;text-transform:uppercase;letter-spacing:0.15em;flex:1;">üåâ Martian Chain Bridge</span>
                <span style="font-size:9px;color:#444;text-transform:uppercase;letter-spacing:0.1em;">‚†ø Drag to move</span>
                <a href="https://bridge.martianchain.com/swap/" target="_blank" rel="noopener noreferrer"
                   style="font-size:9px;color:#664400;border:1px solid rgba(255,77,0,0.2);padding:3px 10px;text-transform:uppercase;text-decoration:none;letter-spacing:0.05em;transition:color 0.2s;"
                   onmouseover="this.style.color='#ff4d00';this.style.borderColor='rgba(255,77,0,0.5)'"
                   onmouseout="this.style.color='#664400';this.style.borderColor='rgba(255,77,0,0.2)'">
                    New Tab ‚Üó
                </a>
                <button onclick="closeBridgeOverlay()" style="
                    background:none;border:1px solid rgba(255,77,0,0.2);color:#555;
                    font-size:18px;cursor:pointer;padding:0 8px;line-height:1.4;
                    margin-left:4px;transition:color 0.2s,border-color 0.2s;
                " onmouseover="this.style.color='#ff4d00';this.style.borderColor='rgba(255,77,0,0.5)'"
                   onmouseout="this.style.color='#555';this.style.borderColor='rgba(255,77,0,0.2)'">√ó</button>
            </div>
            <!-- The bridge iframe ‚Äî loads lazily on open -->
            <iframe
                id="bridge-iframe"
                src="about:blank"
                style="flex:1;width:100%;border:none;"
                title="Martian Chain Bridge"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals allow-top-navigation allow-top-navigation-by-user-activation allow-downloads allow-storage-access-by-user-activation allow-pointer-lock"
                allow="ethereum; web3; clipboard-read; clipboard-write; payment"
            ></iframe>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content mars-glass p-8 w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="orbitron text-xl text-orange-500">PILOT PROFILE</h2>
                <button onclick="closePlayerModal()" class="text-2xl text-gray-500 hover:text-orange-500">&times;</button>
            </div>
            <div id="player-modal-content"></div>
        </div>
    </div>

    <!-- Tip Modal -->
    <div id="tip-modal" class="modal">
        <div class="modal-content mars-glass p-8 w-full" style="max-width:400px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="orbitron text-xl text-orange-500">‚ö° SEND TIP</h2>
                <button onclick="closeTipModal()" class="text-2xl text-gray-500 hover:text-orange-500">&times;</button>
            </div>
            <div id="tip-modal-content">
                <div class="bg-black/40 border border-orange-900/20 p-3 mb-5 text-center">
                    <div class="text-[9px] text-gray-500 mb-1 uppercase">Tipping Pilot</div>
                    <div id="tip-recipient-display" class="orbitron text-orange-500 text-sm break-all"></div>
                </div>
                <div class="mb-5">
                    <label class="text-[10px] text-orange-800 uppercase mb-2 block">Amount ($EROL)</label>
                    <div class="flex gap-2 mb-3">
                        <button onclick="setTipAmount(0.1)" class="flex-1 py-2 text-[10px] border border-orange-900/30 text-orange-700 hover:text-orange-500 hover:border-orange-500/50 transition uppercase">0.1</button>
                        <button onclick="setTipAmount(0.5)" class="flex-1 py-2 text-[10px] border border-orange-900/30 text-orange-700 hover:text-orange-500 hover:border-orange-500/50 transition uppercase">0.5</button>
                        <button onclick="setTipAmount(1)" class="flex-1 py-2 text-[10px] border border-orange-900/30 text-orange-700 hover:text-orange-500 hover:border-orange-500/50 transition uppercase">1.0</button>
                        <button onclick="setTipAmount(5)" class="flex-1 py-2 text-[10px] border border-orange-900/30 text-orange-700 hover:text-orange-500 hover:border-orange-500/50 transition uppercase">5.0</button>
                    </div>
                    <input id="tip-amount-input" type="number" step="0.01" min="0.01" placeholder="Custom amount..." 
                        class="w-full bg-black border border-orange-900/50 p-3 text-orange-500 focus:outline-none focus:border-orange-500 orbitron text-sm">
                </div>
                <div class="bg-orange-900/10 border border-orange-900/30 p-3 mb-5 text-[10px] text-gray-500 space-y-1">
                    <div>Tips are sent directly as $EROL on Martian Chain</div>
                    <div>Tip history is recorded on-chain and tracked in profiles</div>
                </div>
                <button onclick="confirmTip()" id="confirm-tip-btn" class="btn-mars w-full py-3 text-sm">Send Tip ‚ö°</button>
            </div>
        </div>
    </div>

    <!-- Challenge Move Modal -->
    <div id="challenge-modal" class="modal">
        <div class="modal-content mars-glass p-8 w-full" style="max-width:400px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="orbitron text-xl text-orange-500">SELECT YOUR MOVE</h2>
                <button onclick="closeChallengeModal()" class="text-2xl text-gray-500 hover:text-orange-500">&times;</button>
            </div>
            <div id="challenge-modal-content">
                <p class="text-gray-400 text-sm mb-6">Choose your interception move carefully, Commander.</p>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="selectChallengeMove(1)" id="cmove-1" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">‚òÄÔ∏è</span>
                        <span class="text-[9px] uppercase">Solar</span>
                    </button>
                    <button onclick="selectChallengeMove(2)" id="cmove-2" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå¨Ô∏è</span>
                        <span class="text-[9px] uppercase">Oxygen</span>
                    </button>
                    <button onclick="selectChallengeMove(3)" id="cmove-3" class="move-select p-4 bg-black flex flex-col items-center">
                        <span class="text-3xl mb-2">üå™Ô∏è</span>
                        <span class="text-[9px] uppercase">Dust</span>
                    </button>
                </div>
                <div id="challenge-wager-info" class="bg-black/40 border border-orange-900/30 p-3 mb-4 text-sm text-center">
                    <span class="text-gray-400">Wager required:</span>
                    <span id="challenge-wager-display" class="orbitron text-orange-500 ml-2">--</span>
                </div>
                <button onclick="confirmChallenge()" id="confirm-challenge-btn" class="btn-mars w-full py-3 text-sm" disabled>Confirm Interception</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 mars-glass border-orange-500 px-8 py-4 text-orange-500 orbitron text-sm transform translate-y-32 transition-all duration-300 z-[200]">
        SYSTEM MESSAGE
    </div>

    <script>
        const CHAIN_ID = "0x7EB"; 
        const RPC_URL = "https://martian-rpc1.amichain.org/";
        const CONTRACT_ADDR = "0x395E368045315062b26AC950690f384c98fDEEe2";
        
        const SB_URL = "https://tvckbtgggsuwxtlgilcl.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2Y2tidGdnZ3N1d3h0bGdpbGNsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDY2NDY0NSwiZXhwIjoyMDg2MjQwNjQ1fQ.DhvGNo3seKoRtDmeRod0gAP48yFZw_0-kAvY3eT_554"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const ABI = [
            "function createGame(bytes32 _hash, uint256 _timeout) external payable",
            "function challengeGame(uint256 _gameId, uint8 _move) external payable",
            "function resolveGame(uint256 _gameId, uint8 _move, string calldata _salt) external",
            "function forceForfeit(uint256 _gameId) external",
            "function refundUnchallenged(uint256 _gameId) external",
            "function gameCounter() public view returns (uint256)",
            "function games(uint256) public view returns (address host, address challenger, bytes32 commitHash, uint8 hostMove, uint8 challengerMove, uint256 wager, uint256 timeout, uint256 timestamp, uint8 status)",
            "function getTimeRemaining(uint256 _gameId) external view returns (uint256)",
            "function canForfeit(uint256 _gameId) external view returns (bool)",
            "function canRefund(uint256 _gameId) external view returns (bool)",
            "event GameCreated(uint256 indexed gameId, address indexed host, uint256 wager, uint256 timeout, bytes32 commitHash)",
            "event GameChallenged(uint256 indexed gameId, address indexed challenger)",
            "event GameResolved(uint256 indexed gameId, address winner, uint256 payout)"
        ];

        let provider, signer, contract, userAddress;
        let selectedMoveIdx = 0;
        let lobbyRefreshInterval, activityRefreshInterval, chatRefreshInterval;
        let currentLobbyFilter = 'all';

        // Challenge modal state
        let pendingChallengeId = null;
        let pendingChallengeWager = null;
        let selectedChallengeMove = 0;

        // ===========================
        // UTILITY: Time helpers
        // ===========================
        function getTimeRemaining(game) {
            const createdAt = new Date(game.created_at).getTime() / 1000;
            const timeout = game.timeout || 900;
            const deadline = createdAt + timeout;
            const now = Math.floor(Date.now() / 1000);
            return deadline - now;
        }

        function isExpired(game) {
            return getTimeRemaining(game) <= 0;
        }

        function isNearExpiry(game) {
            // Less than 60 seconds remaining ‚Äî too late to join
            return getTimeRemaining(game) < 60;
        }

        function formatCountdown(seconds) {
            if (seconds <= 0) return '00:00';
            const m = Math.floor(Math.max(0, seconds) / 60);
            const s = Math.max(0, seconds) % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // ===========================
        // RAW CONTRACT READER
        // Bypasses ethers staticCall entirely ‚Äî uses direct fetch to RPC
        // ===========================

        // Pre-computed: keccak256("games(uint256)") first 4 bytes
        // Verified selector ‚Äî matches standard Solidity mapping/function ABI
        const GAMES_SELECTOR = computeGamesSelector();
        function computeGamesSelector() {
            // We compute this at runtime using ethers keccak256 to be 100% correct
            try {
                return ethers.id("games(uint256)").slice(0, 10); // 0x + 8 hex chars
            } catch(e) {
                return "0x8b5b9ccc"; // fallback pre-computed
            }
        }

        async function fetchWagerRaw(gameId) {
            const gId = parseInt(gameId);
            if (isNaN(gId) || gId <= 0) throw new Error("Invalid gameId: " + gameId);

            // ABI-encode: selector + uint256(gameId) padded to 32 bytes
            const paddedId = gId.toString(16).padStart(64, '0');
            const callData = GAMES_SELECTOR + paddedId;

            // Method 1: Direct fetch to RPC (most reliable, no ethers involved)
            try {
                const payload = {
                    jsonrpc: "2.0",
                    method: "eth_call",
                    params: [{ to: CONTRACT_ADDR, data: callData }, "latest"],
                    id: Date.now()
                };
                const res = await fetch(RPC_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("HTTP " + res.status);
                const json = await res.json();
                if (json.error) throw new Error(json.error.message);
                const hex = json.result;
                if (!hex || hex === "0x" || hex.length < 10) throw new Error("Empty result");

                // Decode result: each slot = 32 bytes (64 hex chars)
                // Slot layout based on ABI:
                // [0]=host [1]=challenger [2]=commitHash [3]=hostMove [4]=challengerMove
                // [5]=wager [6]=timeout [7]=timestamp [8]=status
                const data = hex.startsWith("0x") ? hex.slice(2) : hex;
                if (data.length < 6 * 64) throw new Error("Result too short: " + data.length);
                const wagerHex = data.slice(5 * 64, 6 * 64);
                const wagerWei = BigInt("0x" + wagerHex);
                if (wagerWei === 0n) throw new Error("On-chain wager is zero ‚Äî game may not exist");
                console.log("[fetchWagerRaw] gameId=" + gId + " wager=" + ethers.formatEther(wagerWei) + " EROL");
                return wagerWei;

            } catch(e) {
                console.error("[fetchWagerRaw] Direct fetch failed:", e.message);

                // Method 2: provider.send eth_call (MetaMask relay)
                try {
                    const result = await provider.send("eth_call", [
                        { to: CONTRACT_ADDR, data: callData },
                        "latest"
                    ]);
                    if (!result || result === "0x" || result.length < 10) throw new Error("Empty via provider");
                    const data2 = result.startsWith("0x") ? result.slice(2) : result;
                    const wagerHex2 = data2.slice(5 * 64, 6 * 64);
                    const wagerWei2 = BigInt("0x" + wagerHex2);
                    if (wagerWei2 === 0n) throw new Error("Zero via provider");
                    console.log("[fetchWagerRaw] method2 wager=" + ethers.formatEther(wagerWei2) + " EROL");
                    return wagerWei2;
                } catch(e2) {
                    console.error("[fetchWagerRaw] provider.send failed:", e2.message);
                    throw new Error("All RPC methods failed: " + e.message + " | " + e2.message);
                }
            }
        }

        // ===========================
        // INIT
        // ===========================
        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connect-btn').addEventListener('click', connectWallet);
                
                await refreshLobby();
                await refreshActivityFeed();
                await refreshChat();
                
                lobbyRefreshInterval = setInterval(refreshLobby, 10000);
                activityRefreshInterval = setInterval(refreshActivityFeed, 5000);
                chatRefreshInterval = setInterval(refreshChat, 3000);
                
                _supabase.channel('game_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, () => {
                        refreshLobby();
                        refreshActivityFeed();
                    })
                    .subscribe();

                _supabase.channel('chat_updates')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, () => {
                        refreshChat();
                    })
                    .subscribe();

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        }

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if ("0x" + network.chainId.toString(16).toUpperCase() !== CHAIN_ID.toUpperCase()) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: CHAIN_ID,
                                    chainName: 'Martian Chain',
                                    nativeCurrency: { name: 'EROL', symbol: 'EROL', decimals: 18 },
                                    rpcUrls: [RPC_URL],
                                    blockExplorerUrls: ['https://explorer.martian.com']
                                }]
                            });
                        } catch (addError) {
                            showToast("FAILED TO ADD MARTIAN NETWORK");
                            return false;
                        }
                    } else {
                        showToast("SWITCH TO MARTIAN NETWORK");
                        return false;
                    }
                }
            }
            return true;
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = await provider.getSigner();
                
                if (!(await checkNetwork())) return;

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('account-info').classList.remove('hidden');
                
                const shortened = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('user-address').innerText = shortened;
                
                updateBalance();
                refreshLobby();
            } catch (err) { 
                console.error(err);
                showToast("UPLINK FAILED"); 
            }
        }

        function copyAddress() {
            if (userAddress) {
                navigator.clipboard.writeText(userAddress).then(() => {
                    showToast("ADDRESS COPIED");
                }).catch(() => showToast("COPY FAILED"));
            }
        }

        async function updateBalance() {
            if (!userAddress || !provider) return;
            try {
                const balance = await provider.getBalance(userAddress);
                document.getElementById('user-balance').innerText = `${parseFloat(ethers.formatEther(balance)).toFixed(2)} $EROL`;
            } catch (e) { console.error("Balance fetch error", e); }
        }

        function selectMove(idx) {
            selectedMoveIdx = idx;
            document.querySelectorAll('.move-select').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`move-${idx}`).classList.add('selected');
        }

        // ===========================
        // CREATE GAME
        // ===========================
        async function handleCreateGame() {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (selectedMoveIdx === 0) return showToast("SELECT TACTICAL MOVE");
            if (!(await checkNetwork())) return;
            
            const createBtn = document.getElementById('create-btn');
            createBtn.disabled = true;
            
            const wagerInput = document.getElementById('wager-amount').value;
            const wagerValue = ethers.parseEther(wagerInput);
            const timeoutValue = document.getElementById('timeout-select').value;
            const salt = ethers.hexlify(ethers.randomBytes(32));
            
            try {
                const nextGameId = (await contract.gameCounter()) + BigInt(1);
                
                const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                    ["uint8", "string", "address", "uint256"],
                    [selectedMoveIdx, salt, userAddress, nextGameId]
                );
                const hash = ethers.keccak256(encoded);

                showToast("ENCRYPTING SIGNAL...");
                const tx = await contract.createGame(hash, timeoutValue, { value: wagerValue });
                
                showToast("WAITING FOR CONFIRMATION...");
                const receipt = await tx.wait();
                
                const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
                secrets[hash] = { 
                    move: selectedMoveIdx, 
                    salt: salt,
                    gameId: nextGameId.toString(),
                    address: userAddress.toLowerCase()
                };
                localStorage.setItem('martian_gambits', JSON.stringify(secrets));

                let gameId = Number(nextGameId);

                try {
                    for (const log of receipt.logs) {
                        try {
                            if (log.address.toLowerCase() !== CONTRACT_ADDR.toLowerCase()) continue;
                            const parsed = contract.interface.parseLog({ topics: log.topics, data: log.data });
                            if (parsed && parsed.name === 'GameCreated') {
                                gameId = Number(parsed.args.gameId);
                                break;
                            }
                        } catch(e) { continue; }
                    }
                } catch (e) { console.warn("Log parsing failed:", e); }

                const { error: sbError } = await _supabase.from('games')
                    .upsert([{
                        game_id: gameId,
                        host: userAddress.toLowerCase(),
                        wager: wagerInput,
                        timeout: parseInt(timeoutValue),
                        status: 0,
                        commit_hash: hash
                    }], { onConflict: 'game_id' })
                    .select();

                if (sbError) {
                    console.error("Supabase upsert error:", sbError);
                    showToast("‚ö†Ô∏è GAME CREATED BUT INDEX FAILED");
                } else {
                    showToast("‚úì SIGNAL DEPLOYED");
                }

                setTimeout(async () => {
                    await refreshLobby();
                    createBtn.disabled = false;
                }, 2000);
                
            } catch (err) { 
                console.error("Game Creation Error:", err);
                showToast("DEPLOYMENT ABORTED");
                createBtn.disabled = false;
            }
        }

        // ===========================
        // LOBBY
        // ===========================
        async function refreshLobby() {
            const lobby = document.getElementById('lobby-list');
            try {
                const { data: games, error } = await _supabase.from('games')
                    .select('*')
                    .order('game_id', { ascending: false })
                    .limit(100);

                if (error) {
                    lobby.innerHTML = `<div class="text-center py-20 text-red-500 uppercase">Indexing Error: ${error.message}</div>`;
                    return;
                }

                lobby.innerHTML = '';
                let displayedCount = 0;

                games.forEach(game => {
                    const status = Number(game.status);
                    const isHost = userAddress && game.host === userAddress.toLowerCase();
                    const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                    
                    if (currentLobbyFilter === 'open' && status !== 0) return;
                    if (currentLobbyFilter === 'intercepted' && status !== 1) return;
                    if (currentLobbyFilter === 'resolved' && status !== 2) return;
                    
                    // In "all" filter, hide resolved/refunded/forfeited games unless you participated
                    if (status > 1 && !isHost && !isChallenger && currentLobbyFilter === 'all') return;

                    displayedCount++;

                    const remaining = getTimeRemaining(game);
                    const expired = remaining <= 0;
                    const nearExpiry = remaining > 0 && remaining < 60;

                    let countdownHTML = '';
                    if (status === 0 || status === 1) {
                        const createdAt = new Date(game.created_at).getTime() / 1000;
                        const timeout = game.timeout || 900;
                        const deadline = Math.floor(createdAt + timeout);

                        if (!expired) {
                            const initColor = nearExpiry ? 'countdown-critical' : (remaining < 300 ? 'text-yellow-500' : 'text-orange-500');
                            const initText = `‚è± ${formatCountdown(remaining)}`;
                            countdownHTML = `<span class="text-[10px] countdown-tick ${initColor} ml-2" data-deadline="${deadline}">${initText}</span>`;
                        } else {
                            countdownHTML = `<span class="text-[10px] countdown-critical ml-2" data-deadline="${deadline}">‚è± TIMEOUT</span>`;
                        }
                    }

                    if (status === 0 && nearExpiry && !isHost) {
                        countdownHTML += `<span class="text-[10px] text-red-500 ml-2">üîí CLOSING SOON</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = "lobby-row p-4 bg-black/40 border-l-2 flex flex-col md:flex-row justify-between items-center gap-4 " + 
                        (status == 0 ? "border-orange-500" : 
                         status == 1 ? "border-yellow-500" : 
                         status == 2 ? "border-green-700" : 
                         "border-gray-800");
                    
                    // Click handler to open detail page - guard against null game_id
                    const safeGameId = game.game_id != null ? String(game.game_id) : '';
                    div.setAttribute('data-game-id', safeGameId);
                    div.onclick = (e) => {
                        if (e.target.closest('button')) return;
                        if (safeGameId && safeGameId !== 'null') openMatchDetail(safeGameId);
                    };
                    
                    let gameInfo = `
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-[9px] px-2 py-0.5 border ${
                                    status == 0 ? 'border-orange-500 text-orange-500' : 
                                    status == 1 ? 'border-yellow-500 text-yellow-500' : 
                                    status == 2 ? 'border-green-500 text-green-500' : 
                                    'border-gray-700 text-gray-500'
                                } uppercase">${getStatusText(status)}</span>
                                <span class="text-[9px] text-orange-900/40">ID: ${game.game_id}</span>
                                ${countdownHTML}
                            </div>
                            <div class="orbitron text-white text-sm">
                                <span class="text-orange-500">${game.wager} $EROL</span> 
                                <span class="text-gray-600 text-[10px] ml-2">FROM ${game.host.slice(0,6)}...</span>`;
                    
                    if (status == 2 && game.host_move && game.challenger_move) {
                        const moves = ['', '‚òÄÔ∏è Solar', 'üå¨Ô∏è Oxygen', 'üå™Ô∏è Dust'];
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        let winner = '';
                        if (hostMove === challengerMove) {
                            winner = '‚öñÔ∏è DRAW';
                        } else if (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        ) {
                            winner = `üèÜ ${game.host.slice(0,6)}... WINS`;
                        } else {
                            winner = `üèÜ ${(game.challenger || 'Unknown').slice(0,6)}... WINS`;
                        }
                        gameInfo += `
                            <div class="text-[10px] mt-1 text-gray-400">
                                Host: ${moves[hostMove]} vs Challenger: ${moves[challengerMove]}
                            </div>
                            <div class="text-[11px] mt-1 font-bold ${hostMove === challengerMove ? 'text-yellow-500' : 'text-green-500'}">
                                ${winner}
                            </div>`;
                    }
                    
                    gameInfo += `
                            </div>
                            <div class="text-[9px] text-gray-700 mt-1">Click row for details</div>
                        </div>
                        <div class="flex gap-2 shrink-0" onclick="event.stopPropagation()">${getActionButtons(game, isHost, isChallenger)}</div>`;
                    
                    div.innerHTML = gameInfo;
                    lobby.appendChild(div);
                });
                
                if (displayedCount === 0) {
                    lobby.innerHTML = '<div class="text-center py-20 opacity-30 uppercase italic">No signals detected...</div>';
                }
            } catch (err) { 
                console.error("Lobby Refresh Error:", err);
                lobby.innerHTML = `<div class="text-center py-20 text-red-500">Error loading lobby: ${err.message}</div>`;
            }
        }

        function setLobbyFilter(filter) {
            currentLobbyFilter = filter;
            document.querySelectorAll('.lobby-filter').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            refreshLobby();
        }

        function getActionButtons(game, isHost, isChallenger) {
            const status = Number(game.status);
            const expired = isExpired(game);
            const nearExpiry = isNearExpiry(game);

            if (status === 0) {
                if (isHost) {
                    // HOST: only show Retract button
                    return `<button onclick="handleRefund(${game.game_id})" class="text-[9px] border border-gray-700 px-4 py-2 hover:bg-white/5 uppercase transition">Retract</button>`;
                }
                // Non-host: show Intercept only if not expired and not near expiry
                if (expired) {
                    return `<span class="text-[9px] text-red-700 uppercase italic">Timed Out</span>`;
                }
                if (nearExpiry) {
                    return `<span class="text-[9px] text-red-500 uppercase italic">üîí Closing...</span>`;
                }
                const safeId = game.game_id != null ? String(game.game_id) : '';
                const dbWager = (game.wager != null && game.wager !== 'null' && game.wager !== '') ? String(game.wager) : 'null';
                // Always show Intercept ‚Äî wager will be fetched from contract if null
                return `<button data-intercept-btn onclick="openChallengeModal('${safeId}', '${dbWager}')" class="btn-mars text-[10px] px-6 py-2">Intercept</button>`;
            }

            if (status === 1) {
                if (isHost) {
                    return `<button onclick="handleResolve(${game.game_id}, '${game.commit_hash}')" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Broadcast Reveal</button>`;
                }
                if (isChallenger) {
                    if (expired) {
                        return `<button onclick="handleForceForfeit(${game.game_id})" class="btn-mars text-[10px] px-6 py-2 animate-pulse">Claim Victory</button>`;
                    }
                    return `<span class="text-[9px] text-orange-500 uppercase italic">‚öîÔ∏è Awaiting Reveal...</span>`;
                }
                return `<span class="text-[9px] text-orange-900 uppercase italic">Combat Active</span>`;
            }

            if (status === 2) return `<span class="text-[9px] text-green-500 uppercase">‚úì Resolved</span>`;
            if (status === 3) return `<span class="text-[9px] text-gray-600 uppercase">Refunded</span>`;
            if (status === 4) return `<span class="text-[9px] text-red-600 uppercase">‚ö° Forfeited</span>`;
            return `<span class="text-[9px] text-gray-700 uppercase">Inactive</span>`;
        }

        // ===========================
        // MATCH DETAIL PAGE
        // ===========================
        async function openMatchDetail(gameId) {
            if (!gameId || gameId === 'null' || gameId === 'undefined') {
                showToast("‚ö†Ô∏è INVALID MATCH ID");
                return;
            }
            gameId = parseInt(gameId);
            if (isNaN(gameId)) { showToast("‚ö†Ô∏è INVALID MATCH ID"); return; }
            // Switch to match detail tab
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-match').classList.add('active');

            const content = document.getElementById('match-detail-content');
            content.innerHTML = `<div class="text-center py-20 text-orange-500 animate-pulse orbitron">Loading match data...</div>`;

            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('game_id', gameId)
                    .single();

                if (error || !games) throw new Error("Game not found");

                const game = games;
                const status = Number(game.status);
                const isHost = userAddress && game.host === userAddress.toLowerCase();
                const isChallenger = userAddress && game.challenger === userAddress.toLowerCase();
                const moves = ['', '‚òÄÔ∏è Solar Flare', 'üå¨Ô∏è Oxygen Siphon', 'üå™Ô∏è Dust Storm'];
                const moveIcons = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                const remaining = getTimeRemaining(game);
                const expired = remaining <= 0;
                const nearExpiry = remaining > 0 && remaining < 60;

                const pot = parseFloat(game.wager) * 2;
                const winnerPayout = (pot * 0.97).toFixed(4);
                const treasury = (pot * 0.015).toFixed(4);
                const burnt = (pot * 0.015).toFixed(4);

                // Determine result
                let resultSection = '';
                let hostMove = Number(game.host_move);
                let challengerMove = Number(game.challenger_move);

                if (status === 2 && game.host_move && game.challenger_move) {
                    let winnerAddr = '';
                    let resultLabel = '';
                    let resultColor = '';

                    if (hostMove === challengerMove) {
                        resultLabel = '‚öñÔ∏è DRAW ‚Äî Both pilots return to base';
                        resultColor = 'text-yellow-500';
                        winnerAddr = 'Draw';
                    } else if (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    ) {
                        resultLabel = `üèÜ HOST WINS`;
                        winnerAddr = game.host;
                        resultColor = 'text-green-500';
                    } else {
                        resultLabel = `üèÜ CHALLENGER WINS`;
                        winnerAddr = game.challenger;
                        resultColor = 'text-green-500';
                    }

                    const isDraw = hostMove === challengerMove;
                    const hostWins = !isDraw && resultLabel.includes('HOST');
                    const challengerWins = !isDraw && resultLabel.includes('CHALLENGER');

                    resultSection = `
                        <div class="mars-glass mb-6 border border-orange-500/30 overflow-hidden">
                            <div class="px-6 pt-5 pb-2 flex justify-between items-center">
                                <h3 class="orbitron text-sm text-orange-500 uppercase">‚öîÔ∏è Battle Outcome</h3>
                                <button onclick="replayBattle()" class="text-[9px] border border-orange-900/40 text-orange-700 hover:text-orange-500 px-3 py-1 uppercase tracking-widest transition">‚Ü∫ Replay</button>
                            </div>
                            <!-- Canvas battle arena -->
                            <div style="position:relative;background:#000;overflow:hidden;" id="battle-arena-wrap">
                                <canvas id="battle-canvas" width="800" height="340" style="width:100%;height:auto;display:block;"></canvas>
                                <!-- Scanline overlay -->
                                <div style="position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px);pointer-events:none;"></div>
                            </div>
                            <!-- Result footer -->
                            <div class="p-4 flex justify-between items-center border-t border-orange-900/20">
                                <div class="flex items-center gap-3">
                                    <div class="text-center px-3">
                                        <div class="text-[9px] text-gray-600 uppercase mb-1">HOST</div>
                                        <div class="text-2xl">${moveIcons[hostMove]}</div>
                                        <div class="text-[9px] text-orange-700 orbitron mt-1">${moves[hostMove]}</div>
                                    </div>
                                    <div class="orbitron text-orange-800 text-lg">VS</div>
                                    <div class="text-center px-3">
                                        <div class="text-[9px] text-gray-600 uppercase mb-1">CHALLENGER</div>
                                        <div class="text-2xl">${moveIcons[challengerMove]}</div>
                                        <div class="text-[9px] text-orange-700 orbitron mt-1">${moves[challengerMove]}</div>
                                    </div>
                                </div>
                                <div class="${resultColor} orbitron text-xl font-bold text-right">${resultLabel}</div>
                            </div>
                        </div>
                    `;
                    // Queue canvas animation after DOM renders
                    setTimeout(() => initBattleAnimation(${hostMove}, ${challengerMove}, "${isDraw ? 'draw' : hostWins ? 'host' : 'challenger'}"), 120);
                }

                // Timer section
                let timerSection = '';
                if (status === 0 || status === 1) {
                    const createdAt = new Date(game.created_at).getTime() / 1000;
                    const timeout = game.timeout || 900;
                    const deadline = Math.floor(createdAt + timeout);
                    const timeColor = expired ? 'countdown-critical' : (nearExpiry ? 'countdown-critical' : 'text-orange-500');
                    const timeDisplay = expired ? '‚è± TIMEOUT' : `‚è± ${formatCountdown(remaining)}`;
                    timerSection = `
                        <div class="stat-card mb-4">
                            <div class="text-[10px] text-gray-500 uppercase mb-2">Time Remaining</div>
                            <div class="orbitron text-3xl countdown-tick ${timeColor}" data-deadline="${deadline}">${timeDisplay}</div>
                            ${nearExpiry && !expired ? `<div class="text-[10px] text-red-500 mt-2 animate-pulse">üîí Cannot be joined in final 60 seconds</div>` : ''}
                        </div>
                    `;
                }

                // Action buttons for this player
                const actionButtons = getActionButtons(game, isHost, isChallenger);

                // Timeline / History
                const createdTime = new Date(game.created_at);
                let timelineHTML = `
                    <div class="timeline-item">
                        <div class="text-sm text-white font-bold">Game Created</div>
                        <div class="text-[10px] text-gray-500">${createdTime.toLocaleString()}</div>
                        <div class="text-[10px] text-gray-600 mt-1">Host: ${game.host.slice(0,10)}...${game.host.slice(-6)}</div>
                    </div>
                `;

                if (status >= 1 && game.challenger) {
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="text-sm text-yellow-400 font-bold">Signal Intercepted</div>
                            <div class="text-[10px] text-gray-600 mt-1">Challenger: ${game.challenger.slice(0,10)}...${game.challenger.slice(-6)}</div>
                        </div>
                    `;
                }

                if (status === 2) {
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="text-sm text-green-400 font-bold">Battle Resolved</div>
                            <div class="text-[10px] text-gray-500">${game.updated_at ? new Date(game.updated_at).toLocaleString() : 'Unknown time'}</div>
                        </div>
                    `;
                }

                if (status === 3) {
                    timelineHTML += `<div class="timeline-item"><div class="text-sm text-gray-400 font-bold">Wager Refunded</div></div>`;
                }

                if (status === 4) {
                    timelineHTML += `<div class="timeline-item"><div class="text-sm text-red-400 font-bold">Game Forfeited</div></div>`;
                }

                content.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Info -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Header -->
                            <div class="mars-glass p-6">
                                <div class="flex items-start justify-between flex-wrap gap-4 mb-6">
                                    <div>
                                        <div class="text-[10px] text-gray-600 mb-1">MATCH ID</div>
                                        <div class="orbitron text-3xl text-orange-500">#${game.game_id}</div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-[9px] px-3 py-1 border ${
                                            status == 0 ? 'border-orange-500 text-orange-500' : 
                                            status == 1 ? 'border-yellow-500 text-yellow-500' : 
                                            status == 2 ? 'border-green-500 text-green-500' : 
                                            'border-gray-700 text-gray-500'
                                        } uppercase">${getStatusText(status)}</span>
                                    </div>
                                </div>

                                <!-- Stats row -->
                                <div class="grid grid-cols-3 gap-3 mb-6">
                                    <div class="stat-card">
                                        <div class="text-[10px] text-gray-500 uppercase mb-1">Wager</div>
                                        <div class="orbitron text-orange-500 text-lg">${game.wager}</div>
                                        <div class="text-[9px] text-gray-600">$EROL each</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-[10px] text-gray-500 uppercase mb-1">Total Pot</div>
                                        <div class="orbitron text-orange-500 text-lg">${pot.toFixed(4)}</div>
                                        <div class="text-[9px] text-gray-600">$EROL</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-[10px] text-gray-500 uppercase mb-1">Timeout</div>
                                        <div class="orbitron text-orange-500 text-lg">${Math.floor(game.timeout / 60)}m</div>
                                        <div class="text-[9px] text-gray-600">window</div>
                                    </div>
                                </div>

                                ${timerSection}
                            </div>

                            ${resultSection}

                            <!-- Players -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Combatants</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between bg-black/40 p-4 border border-orange-900/20">
                                        <div>
                                            <div class="text-[9px] text-orange-700 uppercase mb-1">Host ${isHost ? '(You)' : ''}</div>
                                            <div class="text-sm text-white font-mono">${game.host}</div>
                                        </div>
                                        <div class="text-right">
                                            ${status === 2 && game.host_move ? `<div class="text-2xl">${moveIcons[Number(game.host_move)]}</div>` : `<div class="text-[10px] text-gray-600">Move Hidden</div>`}
                                        </div>
                                    </div>
                                    ${game.challenger ? `
                                    <div class="flex items-center justify-between bg-black/40 p-4 border border-yellow-900/20">
                                        <div>
                                            <div class="text-[9px] text-yellow-700 uppercase mb-1">Challenger ${isChallenger ? '(You)' : ''}</div>
                                            <div class="text-sm text-white font-mono">${game.challenger}</div>
                                        </div>
                                        <div class="text-right">
                                            ${status === 2 && game.challenger_move ? `<div class="text-2xl">${moveIcons[Number(game.challenger_move)]}</div>` : `<div class="text-[10px] text-gray-600">${status === 1 ? 'Move Locked In' : 'No Challenger Yet'}</div>`}
                                        </div>
                                    </div>` : `
                                    <div class="bg-black/40 p-4 border border-gray-900/20 text-center text-gray-600 text-sm italic">
                                        Awaiting challenger...
                                    </div>`}
                                </div>
                            </div>

                            <!-- Payout Breakdown -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Payout Structure</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center py-2 border-b border-orange-900/10">
                                        <span class="text-gray-400">Total Pot</span>
                                        <span class="orbitron text-white">${pot.toFixed(4)} $EROL</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-orange-900/10">
                                        <span class="text-gray-400">Winner Receives (97%)</span>
                                        <span class="orbitron text-green-500">${winnerPayout} $EROL</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-orange-900/10">
                                        <span class="text-gray-400">Treasury (1.5%)</span>
                                        <span class="orbitron text-blue-500">${treasury} $EROL</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-gray-400">Burned (1.5%)</span>
                                        <span class="orbitron text-red-500">${burnt} $EROL</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="space-y-6">
                            <!-- Action Panel -->
                            ${(isHost || isChallenger) || (status === 0 && !expired && !nearExpiry) ? `
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Your Actions</h3>
                                <div class="space-y-2">
                                    ${getActionButtons(game, isHost, isChallenger)}
                                </div>
                            </div>` : ''}

                            <!-- Match Timeline -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">Mission Log</h3>
                                <div class="text-sm">
                                    ${timelineHTML}
                                </div>
                            </div>

                            <!-- Commit Hash -->
                            <div class="mars-glass p-6">
                                <h3 class="orbitron text-sm text-orange-500 mb-4 uppercase">On-Chain Proof</h3>
                                <div class="space-y-3 text-[10px]">
                                    <div>
                                        <div class="text-gray-600 mb-1">Commit Hash</div>
                                        <div class="text-orange-800 break-all font-mono text-[9px]">${game.commit_hash || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600 mb-1">Contract</div>
                                        <div class="text-orange-800 break-all font-mono text-[9px]">${CONTRACT_ADDR}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- How to win reminder -->
                            <div class="mars-glass p-6 bg-orange-900/5">
                                <h3 class="orbitron text-sm text-orange-500 mb-3 uppercase">Move Rules</h3>
                                <div class="space-y-2 text-[10px] text-gray-500">
                                    <div>‚òÄÔ∏è Solar <span class="text-orange-800">beats</span> üå¨Ô∏è Oxygen</div>
                                    <div>üå¨Ô∏è Oxygen <span class="text-orange-800">beats</span> üå™Ô∏è Dust</div>
                                    <div>üå™Ô∏è Dust <span class="text-orange-800">beats</span> ‚òÄÔ∏è Solar</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (err) {
                console.error("Match detail error:", err);
                content.innerHTML = `<div class="text-center py-20 text-red-500">Error loading match: ${err.message}</div>`;
            }
        }

        function goBackToLobby() {
            switchTab('lobby');
        }

        // ===========================
        // CHALLENGE MODAL
        // ===========================
        async function openChallengeModal(gameId, wager) {
            if (!userAddress) { showToast("CONNECT UPLINK FIRST"); return; }
            if (!gameId || gameId === 'null' || gameId === '') { showToast("‚ö†Ô∏è INVALID GAME ID"); return; }
            if (!(await checkNetwork())) return;

            pendingChallengeId = gameId;
            selectedChallengeMove = 0;

            // Try to resolve wager: use passed value, else fetch from contract
            let resolvedWager = wager;
            const isValidWager = resolvedWager && resolvedWager !== 'null' && resolvedWager !== '0' && !isNaN(parseFloat(resolvedWager)) && parseFloat(resolvedWager) > 0;

            document.getElementById('challenge-wager-display').textContent = isValidWager ? `${resolvedWager} $EROL` : 'Fetching...';
            document.querySelectorAll('[id^="cmove-"]').forEach(b => b.classList.remove('selected'));
            document.getElementById('confirm-challenge-btn').disabled = true;
            document.getElementById('challenge-modal').classList.add('active');

            if (!isValidWager) {
                // Fetch real wager from the smart contract
                try {
                    showToast("LOADING WAGER...");
                    const wagerWei = await fetchWagerRaw(gameId);
                    resolvedWager = ethers.formatEther(wagerWei);
                    document.getElementById('challenge-wager-display').textContent = `${parseFloat(resolvedWager).toFixed(4)} $EROL`;
                    showToast("WAGER LOADED");
                } catch(e) {
                    console.error("Could not fetch wager:", e);
                    document.getElementById('challenge-wager-display').textContent = 'Could not load ‚Äî try again';
                    showToast("‚ö†Ô∏è COULD NOT LOAD WAGER ‚Äî CHECK RPC");
                }
            }
            pendingChallengeWager = resolvedWager;
        }

        function closeChallengeModal() {
            document.getElementById('challenge-modal').classList.remove('active');
            pendingChallengeId = null;
            pendingChallengeWager = null;
            selectedChallengeMove = 0;
        }

        function selectChallengeMove(idx) {
            selectedChallengeMove = idx;
            document.querySelectorAll('[id^="cmove-"]').forEach(b => b.classList.remove('selected'));
            document.getElementById(`cmove-${idx}`).classList.add('selected');
            document.getElementById('confirm-challenge-btn').disabled = false;
        }

        async function confirmChallenge() {
            if (!pendingChallengeId || pendingChallengeId === 'null' || selectedChallengeMove === 0) {
                showToast("‚ö†Ô∏è SELECT A MOVE FIRST");
                return;
            }
            const idToUse = pendingChallengeId;
            const wagerToUse = pendingChallengeWager;
            const moveToUse = selectedChallengeMove;
            closeChallengeModal();
            await handleChallenge(idToUse, wagerToUse, moveToUse);
        }

        // ===========================
        // CHALLENGE GAME
        // ===========================
        async function handleChallenge(id, wager, move) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;

            // Hard guard ‚Äî never call Supabase with null id
            const gameId = parseInt(id);
            if (!id || id === 'null' || id === null || isNaN(gameId) || gameId <= 0) {
                showToast("‚ö†Ô∏è INVALID GAME ID ‚Äî REFRESH LOBBY");
                console.error("handleChallenge called with invalid id:", id);
                return;
            }
            
            try {
                // Re-check timer on-chain before submitting
                const { data: gameRow } = await _supabase.from('games').select('*').eq('game_id', gameId).single();
                if (gameRow) {
                    if (isExpired(gameRow)) return showToast("‚õî MATCH HAS TIMED OUT");
                    if (isNearExpiry(gameRow)) return showToast("‚õî TOO CLOSE TO TIMEOUT ‚Äî CANNOT JOIN");
                }

                showToast("FETCHING GAME DATA...");

                // Fetch wager via raw eth_call ‚Äî avoids ethers staticCall bug with MetaMask provider
                let actualWager;
                try {
                    actualWager = await fetchWagerRaw(gameId); // returns BigInt in wei
                    console.log("On-chain wager (wei):", actualWager.toString(), "=", ethers.formatEther(actualWager), "EROL");
                    showToast("INTERCEPTING...");
                } catch(e) {
                    console.error("fetchWagerRaw failed:", e);
                    // Fallback: try the pending wager stored from modal
                    const fallback = pendingChallengeWager;
                    if (fallback && fallback !== 'null' && !isNaN(parseFloat(fallback)) && parseFloat(fallback) > 0) {
                        console.log("Using modal wager fallback:", fallback);
                        actualWager = ethers.parseEther(parseFloat(fallback).toString());
                        showToast("INTERCEPTING...");
                    } else {
                        showToast("‚ö†Ô∏è CANNOT READ WAGER ‚Äî RPC ISSUE");
                        return;
                    }
                }
                
                const tx = await contract.challengeGame(id, move, { value: actualWager });
                showToast("CONFIRMING TRANSACTION...");
                const receipt = await tx.wait();
                
                const { error: updateError } = await _supabase
                    .from('games')
                    .update({ 
                        status: 1, 
                        challenger: userAddress.toLowerCase(),
                        challenger_move: parseInt(move)
                    })
                    .eq('game_id', gameId);
                
                if (updateError) {
                    showToast("‚ö†Ô∏è INTERCEPTED BUT DB UPDATE FAILED");
                } else {
                    showToast("‚úì SIGNAL INTERCEPTED");
                }
                
                setTimeout(refreshLobby, 1500);
            } catch (err) { 
                console.error("Challenge error:", err);
                showToast("INTERCEPTION FAILED"); 
            }
        }

        // ===========================
        // RESOLVE GAME
        // ===========================
        async function handleResolve(id, hash) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            let secret = secrets[hash];
            
            if (!secret) {
                const manualReveal = confirm("Secret not found in this browser. Enter manually?");
                if (manualReveal) {
                    const move = prompt("Enter your move (1-3):");
                    const salt = prompt("Enter your salt (hex string):");
                    if (!move || !salt) return showToast("CANCELLED");
                    
                    const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                        ["uint8", "string", "address", "uint256"],
                        [parseInt(move), salt, userAddress, BigInt(id)]
                    );
                    const testHash = ethers.keccak256(encoded);
                    if (testHash.toLowerCase() !== hash.toLowerCase()) return showToast("‚ö†Ô∏è HASH MISMATCH");
                    
                    secret = { move: parseInt(move), salt: salt, gameId: id.toString() };
                } else {
                    return showToast("‚ö†Ô∏è SECRET NOT FOUND");
                }
            }
            
            const encoded = ethers.AbiCoder.defaultAbiCoder().encode(
                ["uint8", "string", "address", "uint256"],
                [secret.move, secret.salt, userAddress, BigInt(secret.gameId || id)]
            );
            const verifyHash = ethers.keccak256(encoded);
            
            if (verifyHash.toLowerCase() !== hash.toLowerCase()) return showToast("‚ö†Ô∏è HASH VERIFICATION FAILED");
            
            try {
                showToast("BROADCASTING REVEAL...");
                const tx = await contract.resolveGame(id, secret.move, secret.salt);
                showToast("CONFIRMING...");
                await tx.wait();
                
                // Fetch resolved move data from supabase instead of contract call
                let hostMove = secret.move;
                let challengerMove = 0;
                try {
                    const { data: resolvedGame } = await _supabase.from('games').select('*').eq('game_id', id).single();
                    if (resolvedGame && resolvedGame.challenger_move) {
                        challengerMove = Number(resolvedGame.challenger_move);
                    }
                } catch(e) { console.warn('Could not fetch resolved moves from DB'); }
                
                let resultMsg = "COMBAT RESOLVED";
                if (hostMove === challengerMove) {
                    resultMsg = "‚öñÔ∏è DRAW";
                } else if (
                    (hostMove === 1 && challengerMove === 2) ||
                    (hostMove === 2 && challengerMove === 3) ||
                    (hostMove === 3 && challengerMove === 1)
                ) {
                    resultMsg = "üèÜ VICTORY!";
                } else {
                    resultMsg = "üí• DEFEAT";
                }
                
                await _supabase.from('games').update({ 
                    status: 2,
                    host_move: hostMove,
                    challenger_move: challengerMove
                }).eq('game_id', id);
                
                setTimeout(refreshLobby, 1000);
                updateBalance();
                showToast(resultMsg);
            } catch (err) { 
                console.error("Resolve error:", err);
                showToast("RESOLVE FAILED"); 
            }
        }

        async function handleRefund(id) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            try {
                showToast("RETRACTING...");
                const tx = await contract.refundUnchallenged(id);
                await tx.wait();
                await _supabase.from('games').update({ status: 3 }).eq('game_id', id);
                refreshLobby();
                updateBalance();
                showToast("FUNDS RETRACTED");
            } catch (err) { 
                console.error(err);
                showToast("REFUND FAILED"); 
            }
        }

        async function handleForceForfeit(gameId) {
            if (!signer) return showToast("CONNECT UPLINK FIRST");
            if (!(await checkNetwork())) return;
            try {
                showToast("CLAIMING VICTORY...");
                const tx = await contract.forceForfeit(gameId);
                await tx.wait();
                await _supabase.from('games').update({ status: 4 }).eq('game_id', gameId);
                refreshLobby();
                updateBalance();
                showToast("üèÜ VICTORY BY FORFEIT!");
            } catch (err) {
                console.error("Forfeit error:", err);
                showToast("FORFEIT FAILED");
            }
        }

        // ===========================
        // ACTIVITY FEED
        // ===========================
        async function refreshActivityFeed() {
            const feed = document.getElementById('activity-feed');
            // Add event delegation once
            if (!feed._delegated) {
                feed._delegated = true;
                feed.addEventListener('click', (e) => {
                    const row = e.target.closest('[data-gameid]');
                    if (row) {
                        const gid = row.getAttribute('data-gameid');
                        if (gid && gid !== 'null' && gid !== '') openMatchDetail(gid);
                    }
                });
            }
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .order('updated_at', { ascending: false })
                    .limit(50);

                if (error) return;

                feed.innerHTML = games.map(game => {
                    const moves = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];
                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    
                    let result = '', resultColor = '';
                    if (hostMove === challengerMove) {
                        result = 'DRAW'; resultColor = 'text-yellow-500';
                    } else if (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    ) {
                        result = `${game.host.slice(0,6)}... WINS`; resultColor = 'text-green-500';
                    } else {
                        result = `${(game.challenger || 'Unknown').slice(0,6)}... WINS`; resultColor = 'text-green-500';
                    }
                    
                    const timeAgo = getTimeAgo(new Date(game.updated_at || game.created_at));
                    
                    return `
                        <div class="lobby-row bg-black/40 border-l-2 border-green-700 p-3 flex justify-between items-center transition" data-gameid="${game.game_id || ''}" style="cursor:pointer">
                            <div class="flex-1">
                                <div class="text-sm ${resultColor} font-bold">${result}</div>
                                <div class="text-[10px] text-gray-500 mt-1">
                                    ${moves[hostMove]} vs ${moves[challengerMove]} ‚Ä¢ ${game.wager} $EROL ‚Ä¢ ${timeAgo}
                                </div>
                            </div>
                            <div class="text-2xl">${result.includes('DRAW') ? '‚öñÔ∏è' : 'üèÜ'}</div>
                        </div>`;
                }).join('') || '<div class="text-center text-gray-600 py-8">No recent activity</div>';
            } catch (err) {
                console.error("Activity feed error:", err);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        // ===========================
        // CHAT
        // ===========================
        async function refreshChat() {
            const chatMessages = document.getElementById('chat-messages');
            try {
                const { data: messages, error } = await _supabase
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) return;

                const shouldScroll = chatMessages.scrollHeight - chatMessages.scrollTop === chatMessages.clientHeight;

                chatMessages.innerHTML = messages.reverse().map(msg => {
                    const isOwn = userAddress && msg.sender.toLowerCase() === userAddress.toLowerCase();
                    const addrDisplay = `${msg.sender.slice(0,6)}...${msg.sender.slice(-4)}`;
                    const addrEl = isOwn
                        ? `<span class="text-[9px] text-orange-700">${addrDisplay} (you)</span>`
                        : `<button onclick="openTipModal('${msg.sender}')" title="Tip this pilot ‚ö°" class="text-[9px] text-orange-700 hover:text-orange-400 transition flex items-center gap-1"><span>${addrDisplay}</span><span class="text-orange-900 hover:text-orange-500">‚ö°</span></button>`;
                    return `
                        <div class="${isOwn ? 'text-right' : 'text-left'}">
                            <div class="inline-block max-w-[80%] ${isOwn ? 'bg-orange-900/30' : 'bg-gray-900/50'} px-3 py-2 rounded">
                                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-1">${addrEl}</div>
                                <div class="text-sm text-gray-200 text-left">${escapeHtml(msg.message)}</div>
                            </div>
                        </div>`;
                }).join('');

                if (shouldScroll) chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (err) {
                console.error("Chat refresh error:", err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !userAddress) return;
            try {
                const { error } = await _supabase
                    .from('chat_messages')
                    .insert([{ sender: userAddress.toLowerCase(), message: message }]);
                if (!error) { input.value = ''; refreshChat(); }
            } catch (err) { showToast("MESSAGE FAILED"); }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===========================
        // LEADERBOARD
        // ===========================
        async function loadLeaderboard() {
            try {
                const { data: games, error } = await _supabase.from('games').select('*').eq('status', 2);
                if (error) return;

                const playerStats = {};
                let totalWagered = 0, totalBurnt = 0, totalTreasury = 0;

                games.forEach(game => {
                    const wager = parseFloat(game.wager);
                    totalWagered += wager * 2;
                    const pot = wager * 2;
                    totalBurnt += pot * 0.015;
                    totalTreasury += pot * 0.015;

                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    
                    [game.host, game.challenger].filter(Boolean).forEach((addr, idx) => {
                        if (!playerStats[addr]) {
                            playerStats[addr] = { address: addr, totalWagered: 0, wins: 0, losses: 0, draws: 0, games: 0, biggestPot: 0, currentStreak: 0, longestStreak: 0 };
                        }
                        playerStats[addr].totalWagered += wager;
                        playerStats[addr].games++;
                        if (wager * 2 > playerStats[addr].biggestPot) playerStats[addr].biggestPot = wager * 2;
                    });

                    const hostWins = (
                        (hostMove === 1 && challengerMove === 2) ||
                        (hostMove === 2 && challengerMove === 3) ||
                        (hostMove === 3 && challengerMove === 1)
                    );

                    if (hostMove === challengerMove) {
                        [game.host, game.challenger].filter(Boolean).forEach(addr => {
                            playerStats[addr].draws++;
                            playerStats[addr].currentStreak = 0;
                        });
                    } else {
                        const winner = hostWins ? game.host : game.challenger;
                        const loser = hostWins ? game.challenger : game.host;
                        if (winner && playerStats[winner]) {
                            playerStats[winner].wins++;
                            playerStats[winner].currentStreak++;
                            if (playerStats[winner].currentStreak > playerStats[winner].longestStreak) {
                                playerStats[winner].longestStreak = playerStats[winner].currentStreak;
                            }
                        }
                        if (loser && playerStats[loser]) {
                            playerStats[loser].losses++;
                            playerStats[loser].currentStreak = 0;
                        }
                    }
                });

                document.getElementById('global-wagered').textContent = totalWagered.toFixed(2);
                document.getElementById('global-burnt').textContent = totalBurnt.toFixed(2);
                document.getElementById('global-treasury').textContent = totalTreasury.toFixed(2);
                document.getElementById('global-games').textContent = games.length;

                const leaderboard = Object.values(playerStats).sort((a, b) => b.totalWagered - a.totalWagered).slice(0, 50);

                document.getElementById('leaderboard-body').innerHTML = leaderboard.map((player, index) => {
                    const winRate = player.games > 0 ? ((player.wins / player.games) * 100).toFixed(1) : 0;
                    return `
                        <tr class="border-b border-gray-900/30 hover:bg-orange-900/10 cursor-pointer transition" onclick="showPlayerProfile('${player.address}')">
                            <td class="p-3 text-orange-500 orbitron">#${index + 1}</td>
                            <td class="p-3">
                                <div class="text-sm text-white">${player.address.slice(0,8)}...${player.address.slice(-6)}</div>
                                <div class="text-[10px] text-gray-600">${player.games} games</div>
                            </td>
                            <td class="p-3 text-right orbitron text-orange-500">${player.totalWagered.toFixed(2)}</td>
                            <td class="p-3 text-right orbitron ${winRate >= 50 ? 'text-green-500' : 'text-red-500'}">${winRate}%</td>
                            <td class="p-3 text-right orbitron text-orange-500">${player.biggestPot.toFixed(2)}</td>
                            <td class="p-3 text-right orbitron text-yellow-500">${player.longestStreak}</td>
                        </tr>`;
                }).join('');
            } catch (err) {
                console.error("Leaderboard error:", err);
            }
        }

        async function showPlayerProfile(address) {
            const modal = document.getElementById('player-modal');
            const content = document.getElementById('player-modal-content');
            modal.classList.add('active');
            content.innerHTML = '<div class="text-center py-8 text-orange-500">Loading...</div>';

            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .eq('status', 2)
                    .or(`host.eq.${address.toLowerCase()},challenger.eq.${address.toLowerCase()}`)
                    .order('game_id', { ascending: false });

                if (error) throw error;

                let wins = 0, losses = 0, draws = 0, totalWagered = 0, biggestPot = 0, longestStreak = 0, currentStreak = 0;
                const recentGames = [];

                games.forEach(game => {
                    const isHost = game.host === address.toLowerCase();
                    const wager = parseFloat(game.wager);
                    totalWagered += wager;
                    if (wager * 2 > biggestPot) biggestPot = wager * 2;
                    const hostMove = Number(game.host_move);
                    const challengerMove = Number(game.challenger_move);
                    let result = '';

                    if (hostMove === challengerMove) {
                        draws++; result = 'DRAW'; currentStreak = 0;
                    } else {
                        const hostWins = (
                            (hostMove === 1 && challengerMove === 2) ||
                            (hostMove === 2 && challengerMove === 3) ||
                            (hostMove === 3 && challengerMove === 1)
                        );
                        if ((isHost && hostWins) || (!isHost && !hostWins)) {
                            wins++; result = 'WIN'; currentStreak++;
                            if (currentStreak > longestStreak) longestStreak = currentStreak;
                        } else {
                            losses++; result = 'LOSS'; currentStreak = 0;
                        }
                    }
                    recentGames.push({ ...game, result, isHost });
                });

                const totalGames = games.length;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                const moveIcons = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center pb-4 border-b border-orange-900/30">
                            <div class="text-sm text-gray-500 mb-2">ADDRESS</div>
                            <div class="orbitron text-orange-500 text-sm break-all">${address}</div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-black/40 border border-green-900/30 p-4 text-center">
                                <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                                <div class="orbitron text-2xl text-green-500">${wins}</div>
                            </div>
                            <div class="bg-black/40 border border-red-900/30 p-4 text-center">
                                <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                                <div class="orbitron text-2xl text-red-500">${losses}</div>
                            </div>
                            <div class="bg-black/40 border border-yellow-900/30 p-4 text-center">
                                <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                                <div class="orbitron text-2xl text-yellow-500">${draws}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                                <div class="text-[10px] text-orange-800 uppercase mb-2">Win Rate</div>
                                <div class="orbitron text-2xl text-orange-500">${winRate}%</div>
                            </div>
                            <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                                <div class="text-[10px] text-orange-800 uppercase mb-2">Total Wagered</div>
                                <div class="orbitron text-xl text-orange-500">${totalWagered.toFixed(2)}</div>
                            </div>
                            <div class="bg-black/40 border border-orange-900/30 p-4 text-center">
                                <div class="text-[10px] text-orange-800 uppercase mb-2">Biggest Pot</div>
                                <div class="orbitron text-xl text-orange-500">${biggestPot.toFixed(2)}</div>
                            </div>
                            <div class="bg-black/40 border border-yellow-900/30 p-4 text-center">
                                <div class="text-[10px] text-yellow-800 uppercase mb-2">Longest Streak</div>
                                <div class="orbitron text-xl text-yellow-500">${longestStreak}</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="orbitron text-orange-500 mb-3 text-sm">RECENT BATTLES</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${recentGames.slice(0, 10).map(game => `
                                    <div class="bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-3 flex justify-between items-center cursor-pointer hover:bg-black/60" data-gameid="${game.game_id || ''}" onclick="if(this.dataset.gameid && this.dataset.gameid !== 'null'){ closePlayerModal(); openMatchDetail(this.dataset.gameid); }">
                                        <div>
                                            <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500">${game.result}</span>
                                            <div class="text-sm mt-1"><span class="text-orange-500">${game.wager} $EROL</span><span class="text-gray-600 text-[10px] ml-2">Game #${game.game_id}</span></div>
                                        </div>
                                        <div class="text-2xl">${game.isHost ? moveIcons[game.host_move] : moveIcons[game.challenger_move]}</div>
                                    </div>`).join('') || '<div class="text-center text-gray-600 py-4">No battles yet</div>'}
                            </div>
                        </div>
                    </div>`;
            } catch (err) {
                content.innerHTML = '<div class="text-center text-red-500 py-8">Error loading profile</div>';
            }
        }

        function closePlayerModal() {
            document.getElementById('player-modal').classList.remove('active');
        }

        // ===========================
        // PROFILE PAGE
        // ===========================
        async function loadProfile() {
            const profileContent = document.getElementById('profile-content');
            if (!userAddress) {
                profileContent.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-orange-900 text-6xl mb-4">üîí</div>
                        <div class="text-orange-500 orbitron text-lg mb-2">UPLINK REQUIRED</div>
                        <div class="text-gray-500 text-sm">Connect your wallet to view pilot statistics</div>
                    </div>`;
                return;
            }
            
            profileContent.innerHTML = `<div class="text-center py-20"><div class="text-orange-500 animate-pulse">Loading pilot data...</div></div>`;
            
            try {
                const { data: games, error } = await _supabase
                    .from('games')
                    .select('*')
                    .or(`host.eq.${userAddress.toLowerCase()},challenger.eq.${userAddress.toLowerCase()}`)
                    .order('game_id', { ascending: false });
                
                if (error) { profileContent.innerHTML = `<div class="text-red-500">Error loading profile</div>`; return; }
                
                let totalGames = 0, wins = 0, losses = 0, draws = 0, totalWagered = 0, totalWon = 0;
                const recentGames = [];
                
                games.forEach(game => {
                    const isHost = game.host === userAddress.toLowerCase();
                    const wager = parseFloat(game.wager);
                    if (game.status === 2 && game.host_move && game.challenger_move) {
                        totalGames++;
                        totalWagered += wager;
                        const hostMove = Number(game.host_move);
                        const challengerMove = Number(game.challenger_move);
                        let result = '';
                        if (hostMove === challengerMove) {
                            draws++; result = 'DRAW'; totalWon += wager * 0.97;
                        } else {
                            const hostWins = (
                                (hostMove === 1 && challengerMove === 2) ||
                                (hostMove === 2 && challengerMove === 3) ||
                                (hostMove === 3 && challengerMove === 1)
                            );
                            if ((isHost && hostWins) || (!isHost && !hostWins)) {
                                wins++; result = 'WIN'; totalWon += wager * 2 * 0.97;
                            } else {
                                losses++; result = 'LOSS';
                            }
                        }
                        recentGames.push({ ...game, result, isHost });
                    }
                });
                
                const netPnL = totalWon - totalWagered;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                const moveIcons = ['', '‚òÄÔ∏è', 'üå¨Ô∏è', 'üå™Ô∏è'];

                // Load tip stats in parallel
                const tipStats = await loadTipStats(userAddress);
                const recentTipsHTML = tipStats.recentTips.length > 0
                    ? tipStats.recentTips.map(t => `
                        <div class="flex justify-between items-center py-2 border-b border-orange-900/10 text-sm">
                            <div class="text-gray-400">
                                <span class="text-[9px] text-gray-600">FROM </span>
                                <span class="text-orange-700 text-[10px]">${t.sender.slice(0,8)}...${t.sender.slice(-4)}</span>
                            </div>
                            <div class="orbitron text-orange-500">+${parseFloat(t.amount).toFixed(4)} $EROL</div>
                        </div>`).join('')
                    : '<div class="text-center text-gray-600 py-3 text-sm">No tips received yet</div>';
                
                profileContent.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-black/40 border border-orange-900/30 p-6 text-center">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Games</div>
                            <div class="orbitron text-3xl text-orange-500">${totalGames}</div>
                        </div>
                        <div class="bg-black/40 border border-green-900/30 p-6 text-center">
                            <div class="text-[10px] text-green-800 uppercase mb-2">Wins</div>
                            <div class="orbitron text-3xl text-green-500">${wins}</div>
                        </div>
                        <div class="bg-black/40 border border-red-900/30 p-6 text-center">
                            <div class="text-[10px] text-red-800 uppercase mb-2">Losses</div>
                            <div class="orbitron text-3xl text-red-500">${losses}</div>
                        </div>
                        <div class="bg-black/40 border border-yellow-900/30 p-6 text-center">
                            <div class="text-[10px] text-yellow-800 uppercase mb-2">Draws</div>
                            <div class="orbitron text-3xl text-yellow-500">${draws}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-black/40 border border-orange-900/30 p-6">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Win Rate</div>
                            <div class="orbitron text-2xl text-orange-500">${winRate}%</div>
                        </div>
                        <div class="bg-black/40 border border-orange-900/30 p-6">
                            <div class="text-[10px] text-orange-800 uppercase mb-2">Wagered</div>
                            <div class="orbitron text-2xl text-orange-500">${totalWagered.toFixed(2)}</div>
                        </div>
                        <div class="bg-black/40 border border-${netPnL >= 0 ? 'green' : 'red'}-900/30 p-6">
                            <div class="text-[10px] text-${netPnL >= 0 ? 'green' : 'red'}-800 uppercase mb-2">Net P&L</div>
                            <div class="orbitron text-2xl text-${netPnL >= 0 ? 'green' : 'red'}-500">${netPnL >= 0 ? '+' : ''}${netPnL.toFixed(2)}</div>
                        </div>
                        <div class="bg-black/40 border border-yellow-900/30 p-6">
                            <div class="text-[10px] text-yellow-800 uppercase mb-2">Tips Received</div>
                            <div class="orbitron text-2xl text-yellow-500">+${tipStats.totalReceived.toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Tips Section -->
                    <div class="bg-black/40 border border-yellow-900/20 p-6 mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="orbitron text-yellow-500 text-sm uppercase flex items-center gap-2">
                                <span>‚ö° TIP HISTORY</span>
                            </h3>
                            <div class="flex gap-6 text-[10px]">
                                <span class="text-gray-500">Received: <span class="text-yellow-500 orbitron">${tipStats.totalReceived.toFixed(4)} $EROL</span></span>
                                <span class="text-gray-500">Sent: <span class="text-orange-700 orbitron">${tipStats.totalSent.toFixed(4)} $EROL</span></span>
                            </div>
                        </div>
                        <div>${recentTipsHTML}</div>
                    </div>

                    <h3 class="orbitron text-orange-500 mb-4">RECENT BATTLES</h3>
                    <div class="space-y-3">
                        ${recentGames.slice(0, 10).map(game => `
                            <div class="lobby-row bg-black/40 border-l-2 border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-700 p-4 flex justify-between cursor-pointer" data-gameid="${game.game_id || ''}" onclick="if(this.dataset.gameid && this.dataset.gameid !== 'null') openMatchDetail(this.dataset.gameid)">
                                <div>
                                    <span class="text-[10px] px-2 py-0.5 border border-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500 text-${game.result === 'WIN' ? 'green' : game.result === 'LOSS' ? 'red' : 'yellow'}-500">${game.result}</span>
                                    <div class="text-sm mt-1"><span class="text-orange-500">${game.wager || '?'} $EROL</span><span class="text-gray-600 text-[10px] ml-2">Game #${game.game_id}</span></div>
                                </div>
                                <div class="text-2xl">${game.isHost ? moveIcons[game.host_move] : moveIcons[game.challenger_move]}</div>
                            </div>`).join('') || '<div class="text-center text-gray-600 py-8">No battles yet</div>'}
                    </div>`;
            } catch (err) {
                profileContent.innerHTML = `<div class="text-red-500">Error: ${err.message}</div>`;
            }
        }

        // ===========================
        // TAB SWITCHING
        // ===========================
        function getStatusText(s) { 
            return ["Open", "Intercepted", "Resolved", "Refunded", "Forfeited"][s] || "Unknown"; 
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${tab}`);
            if (tabBtn) tabBtn.classList.add('active');
            
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`page-${tab}`).classList.add('active');
            
            if (tab === 'profile') loadProfile();
            if (tab === 'leaderboard') loadLeaderboard();
        }
        
        function debugInfo() {
            const secrets = JSON.parse(localStorage.getItem('martian_gambits') || '{}');
            console.log("=== DEBUG INFO ===");
            console.log("Address:", userAddress);
            console.log("Contract:", CONTRACT_ADDR);
            console.log("Secrets:", Object.keys(secrets).length);
            Object.entries(secrets).forEach(([hash, data]) => {
                console.log(`Hash: ${hash}`, data);
            });
            alert(`Debug info in console (F12)\nSecrets stored: ${Object.keys(secrets).length}`);
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 4000);
        }
        

        // ===================================================
        // EPIC BATTLE ANIMATION ENGINE
        // Canvas-based cinematic fight sequence
        // ===================================================
        let battleAnimFrame = null;
        let battleState = null;

        function replayBattle() {
            if (battleState) {
                initBattleAnimation(battleState.hMove, battleState.cMove, battleState.winner);
            }
        }

        function initBattleAnimation(hostMove, challengerMove, winner) {
            const canvas = document.getElementById('battle-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;

            // Cancel any running animation
            if (battleAnimFrame) cancelAnimationFrame(battleAnimFrame);

            battleState = { hMove: hostMove, cMove: challengerMove, winner };

            // Move definitions
            const MOVES = {
                1: { name: 'SOLAR FLARE',    color: '#ffaa00', glow: '#ff6600', emoji: '‚òÄÔ∏è',  secondary: '#ff8800' },
                2: { name: 'OXYGEN SIPHON',  color: '#44aaff', glow: '#0088ff', emoji: 'üå¨Ô∏è', secondary: '#0044aa' },
                3: { name: 'DUST STORM',      color: '#cc6600', glow: '#884400', emoji: 'üå™Ô∏è', secondary: '#ff8844' },
            };

            const hDef = MOVES[hostMove]   || MOVES[1];
            const cDef = MOVES[challengerMove] || MOVES[1];

            // Animation timeline phases
            // 0-60:   Intro ‚Äî arena materializes, fighters slide in
            // 60-120: Charge ‚Äî fighters power up with particles
            // 120-160: Clash ‚Äî fighters rush to center
            // 160-200: Impact ‚Äî massive collision flash + shockwave
            // 200-280: Resolution ‚Äî winner pushes loser back (or draw spin)
            // 280-360: Outro ‚Äî winner celebration, result text

            const TOTAL = 360;
            let frame = 0;

            // Particle systems
            let particles = [];
            let shockwaves = [];
            let stars = [];
            let debris = [];

            // Pre-populate background stars
            for (let i = 0; i < 80; i++) {
                stars.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    r: Math.random() * 1.5 + 0.3,
                    a: Math.random(),
                    speed: Math.random() * 0.5 + 0.1
                });
            }

            function easeOut(t) { return 1 - Math.pow(1 - t, 3); }
            function easeIn(t) { return t * t * t; }
            function lerp(a, b, t) { return a + (b - a) * t; }
            function clamp(v, mn, mx) { return Math.max(mn, Math.min(mx, v)); }

            function spawnParticles(x, y, color, count, speed, life) {
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const s = (Math.random() * 0.5 + 0.5) * speed;
                    particles.push({
                        x, y,
                        vx: Math.cos(angle) * s,
                        vy: Math.sin(angle) * s,
                        life: life || 40,
                        maxLife: life || 40,
                        color,
                        r: Math.random() * 3 + 1,
                        trail: []
                    });
                }
            }

            function spawnDebris(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const s = Math.random() * 8 + 2;
                    debris.push({
                        x, y,
                        vx: Math.cos(angle) * s,
                        vy: Math.sin(angle) * s - 3,
                        life: 60,
                        maxLife: 60,
                        color,
                        w: Math.random() * 8 + 2,
                        h: Math.random() * 3 + 1,
                        rot: Math.random() * Math.PI * 2,
                        rotV: (Math.random() - 0.5) * 0.3
                    });
                }
            }

            function addShockwave(x, y, color) {
                shockwaves.push({ x, y, r: 0, maxR: 200, life: 40, maxLife: 40, color });
            }

            function drawBackground(t) {
                // Martian landscape gradient
                const grad = ctx.createLinearGradient(0, 0, 0, H);
                grad.addColorStop(0, '#0a0008');
                grad.addColorStop(0.5, '#150510');
                grad.addColorStop(1, '#200808');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, W, H);

                // Ground line
                const groundY = H * 0.78;
                ctx.strokeStyle = 'rgba(255,77,0,0.15)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, groundY);
                ctx.lineTo(W, groundY);
                ctx.stroke();

                // Terrain bumps
                ctx.fillStyle = 'rgba(180,60,0,0.12)';
                ctx.beginPath();
                ctx.moveTo(0, groundY);
                for (let x = 0; x <= W; x += 20) {
                    ctx.lineTo(x, groundY + Math.sin(x * 0.05) * 8);
                }
                ctx.lineTo(W, H); ctx.lineTo(0, H);
                ctx.fill();

                // Stars twinkle
                stars.forEach(s => {
                    s.a += s.speed * 0.02;
                    const alpha = (Math.sin(s.a) * 0.5 + 0.5) * 0.6 + 0.1;
                    ctx.fillStyle = `rgba(255,220,180,${alpha})`;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y * 0.7, s.r, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Red planet in background
                const planetX = W * 0.5, planetY = H * 0.22;
                const pGrad = ctx.createRadialGradient(planetX - 15, planetY - 15, 5, planetX, planetY, 45);
                pGrad.addColorStop(0, 'rgba(255,100,30,0.15)');
                pGrad.addColorStop(1, 'rgba(100,20,0,0.04)');
                ctx.fillStyle = pGrad;
                ctx.beginPath();
                ctx.arc(planetX, planetY, 45, 0, Math.PI * 2);
                ctx.fill();

                // Grid floor lines
                for (let i = 0; i < 6; i++) {
                    const py = groundY + i * 12;
                    const alpha = (1 - i / 6) * 0.08;
                    ctx.strokeStyle = `rgba(255,77,0,${alpha})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(0, py); ctx.lineTo(W, py);
                    ctx.stroke();
                }
            }

            function drawFighter(x, y, def, scale, glowIntensity, label, flip, frameNum) {
                ctx.save();
                ctx.translate(x, y);
                if (flip) ctx.scale(-1, 1);

                // Glow aura
                if (glowIntensity > 0) {
                    const aura = ctx.createRadialGradient(0, 0, 10, 0, 0, 80 * scale);
                    aura.addColorStop(0, def.glow + Math.round(glowIntensity * 0.6 * 255).toString(16).padStart(2,'0'));
                    aura.addColorStop(1, 'transparent');
                    ctx.fillStyle = aura;
                    ctx.beginPath();
                    ctx.arc(0, 0, 80 * scale, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Fighter body ‚Äî stylized mech suit
                const bodyScale = scale;

                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(0, 55 * bodyScale, 30 * bodyScale, 8 * bodyScale, 0, 0, Math.PI * 2);
                ctx.fill();

                // Legs
                ctx.fillStyle = def.secondary;
                ctx.fillRect(-18 * bodyScale, 28 * bodyScale, 12 * bodyScale, 28 * bodyScale);
                ctx.fillRect(6 * bodyScale, 28 * bodyScale, 12 * bodyScale, 28 * bodyScale);
                // Boot
                ctx.fillStyle = '#1a1a2a';
                ctx.fillRect(-20 * bodyScale, 52 * bodyScale, 14 * bodyScale, 8 * bodyScale);
                ctx.fillRect(6 * bodyScale, 52 * bodyScale, 14 * bodyScale, 8 * bodyScale);

                // Torso
                const torsoGrad = ctx.createLinearGradient(-22 * bodyScale, -20 * bodyScale, 22 * bodyScale, 30 * bodyScale);
                torsoGrad.addColorStop(0, def.color);
                torsoGrad.addColorStop(0.5, def.secondary);
                torsoGrad.addColorStop(1, '#111');
                ctx.fillStyle = torsoGrad;
                ctx.beginPath();
                ctx.roundRect(-22 * bodyScale, -20 * bodyScale, 44 * bodyScale, 50 * bodyScale, 4 * bodyScale);
                ctx.fill();

                // Chest emblem glow
                if (glowIntensity > 0.3) {
                    const chest = ctx.createRadialGradient(0, 5 * bodyScale, 2, 0, 5 * bodyScale, 14 * bodyScale);
                    chest.addColorStop(0, def.color + 'cc');
                    chest.addColorStop(1, 'transparent');
                    ctx.fillStyle = chest;
                    ctx.beginPath();
                    ctx.arc(0, 5 * bodyScale, 14 * bodyScale, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Arms
                // Back arm
                ctx.fillStyle = def.secondary;
                ctx.save();
                ctx.rotate(flip ? 0.3 : -0.3);
                ctx.fillRect(flip ? -36 * bodyScale : 22 * bodyScale, -15 * bodyScale, 14 * bodyScale, 36 * bodyScale);
                ctx.restore();
                // Front arm (weapon arm)
                ctx.save();
                const armAngle = glowIntensity > 0.5 ? (flip ? -0.5 : 0.5) : 0.1;
                ctx.rotate(armAngle);
                ctx.fillStyle = def.color;
                const armX = flip ? 22 * bodyScale : -36 * bodyScale;
                ctx.fillRect(armX, -15 * bodyScale, 14 * bodyScale, 38 * bodyScale);

                // Weapon / ability glow on hand
                if (glowIntensity > 0.4) {
                    const handY = 23 * bodyScale;
                    const handX = armX + 7 * bodyScale;
                    const weaponGrad = ctx.createRadialGradient(handX, handY, 2, handX, handY, 20 * glowIntensity * bodyScale);
                    weaponGrad.addColorStop(0, def.color + 'ff');
                    weaponGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = weaponGrad;
                    ctx.beginPath();
                    ctx.arc(handX, handY, 20 * glowIntensity * bodyScale, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();

                // Shoulders
                ctx.fillStyle = def.color;
                ctx.beginPath();
                ctx.roundRect(-30 * bodyScale, -22 * bodyScale, 18 * bodyScale, 14 * bodyScale, 3 * bodyScale);
                ctx.fill();
                ctx.beginPath();
                ctx.roundRect(12 * bodyScale, -22 * bodyScale, 18 * bodyScale, 14 * bodyScale, 3 * bodyScale);
                ctx.fill();

                // Helmet
                const helmGrad = ctx.createLinearGradient(-16 * bodyScale, -52 * bodyScale, 16 * bodyScale, -20 * bodyScale);
                helmGrad.addColorStop(0, '#2a2a3a');
                helmGrad.addColorStop(0.5, '#1a1a28');
                helmGrad.addColorStop(1, '#111');
                ctx.fillStyle = helmGrad;
                ctx.beginPath();
                ctx.roundRect(-16 * bodyScale, -52 * bodyScale, 32 * bodyScale, 34 * bodyScale, 8 * bodyScale);
                ctx.fill();

                // Visor
                ctx.fillStyle = def.color + '99';
                ctx.shadowColor = def.glow;
                ctx.shadowBlur = 10 * glowIntensity;
                ctx.beginPath();
                ctx.roundRect(-11 * bodyScale, -45 * bodyScale, 22 * bodyScale, 12 * bodyScale, 3 * bodyScale);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Visor reflection
                ctx.fillStyle = 'rgba(255,255,255,0.15)';
                ctx.beginPath();
                ctx.roundRect(-9 * bodyScale, -43 * bodyScale, 10 * bodyScale, 4 * bodyScale, 2);
                ctx.fill();

                // Helmet antenna/crest
                ctx.fillStyle = def.color;
                ctx.fillRect(-3 * bodyScale, -62 * bodyScale, 6 * bodyScale, 12 * bodyScale);
                if (glowIntensity > 0.2) {
                    ctx.fillStyle = def.glow;
                    ctx.shadowColor = def.glow;
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.arc(0, -63 * bodyScale, 4 * bodyScale, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }

                // Name label
                ctx.restore();
                ctx.save();
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(x - 40, y + 68 * scale, 80, 16);
                ctx.fillStyle = def.color;
                ctx.font = `bold ${8 * scale}px 'Orbitron', monospace`;
                ctx.textAlign = 'center';
                ctx.fillText(label.toUpperCase(), x, y + 80 * scale);
                ctx.restore();
            }

            function drawMoveEffect(x, y, def, intensity, frameNum, move) {
                if (intensity <= 0) return;
                ctx.save();

                if (move === 1) {
                    // Solar Flare ‚Äî rotating sun corona
                    const rays = 12;
                    for (let i = 0; i < rays; i++) {
                        const angle = (i / rays) * Math.PI * 2 + frameNum * 0.05;
                        const len = (50 + Math.sin(frameNum * 0.15 + i) * 15) * intensity;
                        ctx.strokeStyle = def.color + Math.round(intensity * 180).toString(16).padStart(2,'0');
                        ctx.lineWidth = 2 + Math.sin(i) * 1;
                        ctx.shadowColor = def.glow;
                        ctx.shadowBlur = 15 * intensity;
                        ctx.beginPath();
                        ctx.moveTo(x + Math.cos(angle) * 20 * intensity, y + Math.sin(angle) * 20 * intensity);
                        ctx.lineTo(x + Math.cos(angle) * len, y + Math.sin(angle) * len);
                        ctx.stroke();
                    }
                    // Core fireball
                    const fireGrad = ctx.createRadialGradient(x, y, 0, x, y, 35 * intensity);
                    fireGrad.addColorStop(0, '#ffffff');
                    fireGrad.addColorStop(0.2, '#ffee44');
                    fireGrad.addColorStop(0.6, def.color);
                    fireGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = fireGrad;
                    ctx.beginPath();
                    ctx.arc(x, y, 35 * intensity, 0, Math.PI * 2);
                    ctx.fill();

                } else if (move === 2) {
                    // Oxygen Siphon ‚Äî swirling wind vortex
                    for (let ring = 0; ring < 4; ring++) {
                        const offset = (ring / 4) * Math.PI * 2;
                        const radius = (20 + ring * 18) * intensity;
                        ctx.strokeStyle = def.color + Math.round((1 - ring * 0.2) * intensity * 200).toString(16).padStart(2,'0');
                        ctx.lineWidth = 3 - ring * 0.5;
                        ctx.shadowColor = def.glow;
                        ctx.shadowBlur = 10;
                        ctx.beginPath();
                        for (let a = 0; a < Math.PI * 2; a += 0.05) {
                            const spin = a + frameNum * 0.08 + offset;
                            const r = radius + Math.sin(a * 4 + frameNum * 0.1) * 8 * intensity;
                            const px = x + Math.cos(spin) * r;
                            const py = y + Math.sin(spin) * r * 0.5; // elliptical
                            if (a === 0) ctx.moveTo(px, py);
                            else ctx.lineTo(px, py);
                        }
                        ctx.closePath();
                        ctx.stroke();
                    }
                    // Center orb
                    const windGrad = ctx.createRadialGradient(x, y, 0, x, y, 22 * intensity);
                    windGrad.addColorStop(0, '#ffffff');
                    windGrad.addColorStop(0.3, def.color);
                    windGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = windGrad;
                    ctx.beginPath();
                    ctx.arc(x, y, 22 * intensity, 0, Math.PI * 2);
                    ctx.fill();

                } else if (move === 3) {
                    // Dust Storm ‚Äî expanding spiral particles
                    const spiralCount = 6;
                    for (let s = 0; s < spiralCount; s++) {
                        const baseAngle = (s / spiralCount) * Math.PI * 2 + frameNum * -0.06;
                        for (let t = 0; t < 8; t++) {
                            const angle = baseAngle + t * 0.4;
                            const r = (t * 10 + 5) * intensity;
                            const px = x + Math.cos(angle) * r;
                            const py = y + Math.sin(angle) * r * 0.6;
                            const dotAlpha = (1 - t / 8) * intensity;
                            ctx.fillStyle = def.color + Math.round(dotAlpha * 200).toString(16).padStart(2,'0');
                            ctx.shadowColor = def.glow;
                            ctx.shadowBlur = 5;
                            ctx.beginPath();
                            ctx.arc(px, py, (4 - t * 0.3) * intensity, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    // Vortex core
                    const dustGrad = ctx.createRadialGradient(x, y, 0, x, y, 28 * intensity);
                    dustGrad.addColorStop(0, '#ffffff99');
                    dustGrad.addColorStop(0.4, def.color + 'aa');
                    dustGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = dustGrad;
                    ctx.beginPath();
                    ctx.arc(x, y, 28 * intensity, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.shadowBlur = 0;
                ctx.restore();
            }

            function drawImpactFlash(intensity) {
                if (intensity <= 0) return;
                // Screen-wide white flash
                ctx.fillStyle = `rgba(255,255,255,${intensity * 0.7})`;
                ctx.fillRect(0, 0, W, H);
                // Color tint
                const midColor = winner === 'draw' ? '#ffaa00' :
                                 winner === 'host' ? hDef.color : cDef.color;
                ctx.fillStyle = midColor + Math.round(intensity * 80).toString(16).padStart(2,'0');
                ctx.fillRect(0, 0, W, H);
            }

            function drawShockwaves() {
                shockwaves = shockwaves.filter(sw => sw.life > 0);
                shockwaves.forEach(sw => {
                    const t = 1 - sw.life / sw.maxLife;
                    const r = sw.maxR * easeOut(t);
                    const alpha = (1 - t) * 0.7;
                    ctx.strokeStyle = sw.color + Math.round(alpha * 255).toString(16).padStart(2,'0');
                    ctx.lineWidth = (1 - t) * 6 + 1;
                    ctx.shadowColor = sw.color;
                    ctx.shadowBlur = 20 * (1 - t);
                    ctx.beginPath();
                    ctx.arc(sw.x, sw.y, r, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    // Inner ring
                    if (t < 0.7) {
                        ctx.strokeStyle = '#ffffff' + Math.round(alpha * 0.5 * 255).toString(16).padStart(2,'0');
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.arc(sw.x, sw.y, r * 0.6, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    sw.r = r;
                    sw.life--;
                });
            }

            function drawParticles() {
                particles = particles.filter(p => p.life > 0);
                particles.forEach(p => {
                    const t = p.life / p.maxLife;
                    p.trail.push({ x: p.x, y: p.y });
                    if (p.trail.length > 6) p.trail.shift();
                    // Trail
                    if (p.trail.length > 1) {
                        ctx.strokeStyle = p.color + Math.round(t * 0.4 * 255).toString(16).padStart(2,'0');
                        ctx.lineWidth = p.r * t;
                        ctx.beginPath();
                        ctx.moveTo(p.trail[0].x, p.trail[0].y);
                        p.trail.forEach(pt => ctx.lineTo(pt.x, pt.y));
                        ctx.stroke();
                    }
                    // Dot
                    ctx.fillStyle = p.color + Math.round(t * 220).toString(16).padStart(2,'0');
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 6 * t;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r * t, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    p.x += p.vx; p.y += p.vy;
                    p.vy += 0.15; // gravity
                    p.vx *= 0.97;
                    p.life--;
                });
            }

            function drawDebris() {
                debris = debris.filter(d => d.life > 0);
                debris.forEach(d => {
                    const t = d.life / d.maxLife;
                    ctx.save();
                    ctx.translate(d.x, d.y);
                    ctx.rotate(d.rot);
                    ctx.globalAlpha = t;
                    ctx.fillStyle = d.color;
                    ctx.fillRect(-d.w / 2, -d.h / 2, d.w, d.h);
                    ctx.restore();
                    d.x += d.vx; d.y += d.vy;
                    d.vy += 0.3;
                    d.vx *= 0.95;
                    d.rot += d.rotV;
                    d.life--;
                });
            }

            function drawHUD(frame) {
                // Phase label
                const phases = [
                    [0, 60, 'ARENA INITIALIZED'],
                    [60, 120, 'PILOTS CHARGING'],
                    [120, 160, 'COLLISION IMMINENT'],
                    [160, 200, 'IMPACT'],
                    [200, 280, winner === 'draw' ? 'DRAW ‚Äî EQUAL POWER' : 'EXECUTING VICTORY'],
                    [280, TOTAL, winner === 'draw' ? '‚öñÔ∏è DRAW' : 'üèÜ VICTORY']
                ];
                let phase = phases.find(([s, e]) => frame >= s && frame < e);
                if (!phase) phase = phases[phases.length - 1];

                const phaseAlpha = Math.min(1, (frame - phase[0]) / 10) * Math.min(1, (phase[1] - frame) / 10);
                if (phaseAlpha > 0 && frame < 280) {
                    ctx.save();
                    ctx.globalAlpha = phaseAlpha * 0.8;
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.fillRect(W/2 - 100, 8, 200, 18);
                    ctx.fillStyle = '#ff4d00';
                    ctx.font = '8px Orbitron, monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(phase[2], W/2, 20);
                    ctx.restore();
                }

                // Versus divider line during charge phase
                if (frame >= 40 && frame < 120) {
                    const t = clamp((frame - 40) / 30, 0, 1);
                    const alpha = Math.sin(frame * 0.1) * 0.3 + 0.4;
                    ctx.strokeStyle = `rgba(255,77,0,${t * alpha})`;
                    ctx.lineWidth = 1;
                    ctx.setLineDash([4, 4]);
                    ctx.beginPath();
                    ctx.moveTo(W / 2, H * 0.1);
                    ctx.lineTo(W / 2, H * 0.85);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // VS text
                    ctx.fillStyle = `rgba(255,77,0,${t})`;
                    ctx.font = 'bold 18px Orbitron, monospace';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#ff4d00';
                    ctx.shadowBlur = 15;
                    ctx.fillText('VS', W / 2, H / 2 + 6);
                    ctx.shadowBlur = 0;
                }
            }

            function drawVictoryText(frame) {
                if (frame < 285) return;
                const t = clamp((frame - 285) / 30, 0, 1);
                const winDef = winner === 'host' ? hDef : winner === 'challenger' ? cDef : null;
                const label = winner === 'draw' ? 'DRAW' : winner === 'host' ? 'HOST WINS' : 'CHALLENGER WINS';
                const col = winner === 'draw' ? '#ffaa00' : winDef.color;

                // Backdrop
                ctx.fillStyle = `rgba(0,0,0,${t * 0.5})`;
                ctx.fillRect(0, H * 0.3, W, H * 0.4);

                // Glow
                ctx.shadowColor = col;
                ctx.shadowBlur = 40 * t;

                // Main text
                const scale2 = 0.5 + easeOut(t) * 0.5;
                ctx.save();
                ctx.translate(W / 2, H * 0.5);
                ctx.scale(scale2, scale2);
                ctx.fillStyle = col;
                ctx.font = `bold ${38}px Orbitron, monospace`;
                ctx.textAlign = 'center';
                ctx.globalAlpha = t;
                ctx.fillText(label, 0, 0);

                // Sub text
                ctx.fillStyle = '#ffffff88';
                ctx.font = `${13}px Orbitron, monospace`;
                ctx.fillText(winner === 'draw' ? 'Both pilots return to base' : '97% of pot awarded', 0, 28);
                ctx.restore();
                ctx.shadowBlur = 0;
            }

            // ---- Main animation loop ----
            const centerX = W / 2;
            const groundY = H * 0.72;

            function tick() {
                ctx.clearRect(0, 0, W, H);

                // ---- Calculate positions and states based on frame ----
                let hX, cX, hGlow, cGlow, chargeH, chargeC, flashIntensity = 0;
                const attackX = centerX;

                if (frame < 60) {
                    // Phase 1: Slide in
                    const t = easeOut(frame / 60);
                    hX = lerp(-100, W * 0.22, t);
                    cX = lerp(W + 100, W * 0.78, t);
                    hGlow = 0.1;
                    cGlow = 0.1;
                    chargeH = 0; chargeC = 0;
                } else if (frame < 120) {
                    // Phase 2: Charge up
                    const t = (frame - 60) / 60;
                    hX = W * 0.22;
                    cX = W * 0.78;
                    hGlow = easeIn(t) * 0.9;
                    cGlow = easeIn(t) * 0.9;
                    chargeH = t; chargeC = t;
                    // Spawn charge particles
                    if (frame % 3 === 0) {
                        spawnParticles(hX, groundY - 30, hDef.color, 3, 3, 25);
                        spawnParticles(cX, groundY - 30, cDef.color, 3, 3, 25);
                    }
                } else if (frame < 160) {
                    // Phase 3: Rush to center
                    const t = easeIn((frame - 120) / 40);
                    hX = lerp(W * 0.22, centerX - 55, t);
                    cX = lerp(W * 0.78, centerX + 55, t);
                    hGlow = 1;
                    cGlow = 1;
                    chargeH = 1; chargeC = 1;
                    // Rush particles
                    if (frame % 2 === 0) {
                        spawnParticles(hX - 20, groundY - 30, hDef.color, 2, 5, 15);
                        spawnParticles(cX + 20, groundY - 30, cDef.color, 2, 5, 15);
                    }
                } else if (frame < 200) {
                    // Phase 4: IMPACT
                    const t = (frame - 160) / 40;
                    hX = centerX - 55 + (winner === 'challenger' ? t * 20 : -t * 5);
                    cX = centerX + 55 + (winner === 'host' ? -t * 20 : t * 5);
                    hGlow = 1;
                    cGlow = 1;
                    chargeH = 1; chargeC = 1;
                    flashIntensity = frame === 160 ? 1 : Math.max(0, 1 - (frame - 160) / 20);

                    if (frame === 160) {
                        // Big bang
                        addShockwave(centerX, groundY - 30, '#ffffff');
                        addShockwave(centerX, groundY - 30, hDef.color);
                        addShockwave(centerX, groundY - 30, cDef.color);
                        spawnParticles(centerX, groundY - 30, '#ffffff', 30, 12, 50);
                        spawnParticles(centerX, groundY - 30, hDef.color, 20, 9, 45);
                        spawnParticles(centerX, groundY - 30, cDef.color, 20, 9, 45);
                        spawnDebris(centerX, groundY - 30, hDef.secondary, 8);
                        spawnDebris(centerX, groundY - 30, cDef.secondary, 8);
                    }
                    if (frame > 163 && frame % 4 === 0) {
                        addShockwave(
                            centerX + (Math.random() - 0.5) * 60,
                            groundY - 30 + (Math.random() - 0.5) * 40,
                            frame % 8 === 0 ? hDef.color : cDef.color
                        );
                    }
                } else if (frame < 280) {
                    // Phase 5: Resolution
                    const t = easeOut((frame - 200) / 80);
                    if (winner === 'draw') {
                        // Push apart
                        hX = lerp(centerX - 55, W * 0.28, t);
                        cX = lerp(centerX + 55, W * 0.72, t);
                    } else if (winner === 'host') {
                        hX = lerp(centerX - 55, W * 0.35, t);
                        cX = lerp(centerX + 55, W * 0.78, t);
                        // Loser staggers
                        cX += Math.sin(frame * 0.8) * (1 - t) * 10;
                    } else {
                        cX = lerp(centerX + 55, W * 0.65, t);
                        hX = lerp(centerX - 55, W * 0.22, t);
                        hX += Math.sin(frame * 0.8) * (1 - t) * 10;
                    }
                    hGlow = winner === 'host' ? 0.8 : 0.2 * (1 - t);
                    cGlow = winner === 'challenger' ? 0.8 : 0.2 * (1 - t);
                    chargeH = winner === 'host' ? 1 : 0;
                    chargeC = winner === 'challenger' ? 1 : 0;

                    // Victory particles for winner
                    if (frame % 4 === 0) {
                        if (winner === 'host') spawnParticles(hX, groundY - 80, hDef.color, 3, 4, 35);
                        if (winner === 'challenger') spawnParticles(cX, groundY - 80, cDef.color, 3, 4, 35);
                        if (winner === 'draw') {
                            spawnParticles(hX, groundY - 80, '#ffaa00', 2, 3, 30);
                            spawnParticles(cX, groundY - 80, '#ffaa00', 2, 3, 30);
                        }
                    }
                } else {
                    // Phase 6: Hold final pose
                    hX = winner === 'host' ? W * 0.35 : W * 0.22;
                    cX = winner === 'challenger' ? W * 0.65 : W * 0.78;
                    hGlow = winner === 'host' ? 0.7 + Math.sin(frame * 0.05) * 0.2 : 0.05;
                    cGlow = winner === 'challenger' ? 0.7 + Math.sin(frame * 0.05) * 0.2 : 0.05;
                    chargeH = winner === 'host' ? 1 : 0;
                    chargeC = winner === 'challenger' ? 1 : 0;
                    if (winner === 'draw') { hGlow = 0.3; cGlow = 0.3; }
                    if (frame % 6 === 0 && winner !== 'draw') {
                        const wx = winner === 'host' ? hX : cX;
                        const wDef = winner === 'host' ? hDef : cDef;
                        spawnParticles(wx, groundY - 90, wDef.color, 2, 3, 40);
                    }
                }

                // ---- Draw everything ----
                drawBackground(frame);

                // Move effects (charge auras)
                if (chargeH > 0) drawMoveEffect(hX, groundY - 30, hDef, chargeH * hGlow, frame, hostMove);
                if (chargeC > 0) drawMoveEffect(cX, groundY - 30, cDef, chargeC * cGlow, frame, challengerMove);

                // Shockwaves
                drawShockwaves();

                // Fighters
                const hWinner = (winner === 'host' && frame >= 200);
                const cWinner = (winner === 'challenger' && frame >= 200);
                drawFighter(hX, groundY, hDef, 1, hGlow, 'HOST', false, frame);
                drawFighter(cX, groundY, cDef, 1, cGlow, 'CHALLENGER', true, frame);

                // Particles and debris on top
                drawParticles();
                drawDebris();

                // Flash
                drawImpactFlash(flashIntensity);

                // HUD
                drawHUD(frame);

                // Victory text
                drawVictoryText(frame);

                frame++;
                if (frame < TOTAL) {
                    battleAnimFrame = requestAnimationFrame(tick);
                } else {
                    // Hold last frame
                    battleAnimFrame = null;
                }
            }

            battleAnimFrame = requestAnimationFrame(tick);
        }

        // ===========================
        // TIPPING SYSTEM
        // ===========================
        let pendingTipRecipient = null;

        function openTipModal(recipientAddress) {
            if (!userAddress) { showToast("CONNECT UPLINK FIRST"); return; }
            if (recipientAddress.toLowerCase() === userAddress.toLowerCase()) {
                showToast("CANNOT TIP YOURSELF"); return;
            }
            pendingTipRecipient = recipientAddress;
            document.getElementById('tip-recipient-display').textContent =
                `${recipientAddress.slice(0,10)}...${recipientAddress.slice(-8)}`;
            document.getElementById('tip-amount-input').value = '';
            document.getElementById('tip-modal').classList.add('active');
        }

        function closeTipModal() {
            document.getElementById('tip-modal').classList.remove('active');
            pendingTipRecipient = null;
        }

        function setTipAmount(amount) {
            document.getElementById('tip-amount-input').value = amount;
        }

        async function confirmTip() {
            if (!signer || !pendingTipRecipient) return;
            if (!(await checkNetwork())) return;

            const amountInput = document.getElementById('tip-amount-input').value;
            const amount = parseFloat(amountInput);
            if (!amountInput || isNaN(amount) || amount <= 0) {
                showToast("‚ö†Ô∏è ENTER A VALID AMOUNT");
                return;
            }

            const btn = document.getElementById('confirm-tip-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                showToast("SENDING TIP...");
                const tipWei = ethers.parseEther(amount.toString());

                // Send native EROL directly to recipient
                const tx = await signer.sendTransaction({
                    to: pendingTipRecipient,
                    value: tipWei
                });

                showToast("CONFIRMING TIP...");
                await tx.wait();

                // Record in Supabase tips table
                try {
                    await _supabase.from('tips').insert([{
                        sender: userAddress.toLowerCase(),
                        recipient: pendingTipRecipient.toLowerCase(),
                        amount: amount.toString(),
                        tx_hash: tx.hash
                    }]);
                } catch(dbErr) {
                    console.warn("Tip recorded on-chain but DB insert failed:", dbErr);
                }

                showToast(`‚ö° ${amount} $EROL TIPPED!`);
                closeTipModal();
                updateBalance();
            } catch(err) {
                console.error("Tip error:", err);
                if (err.message && err.message.includes('user rejected')) {
                    showToast("TIP CANCELLED");
                } else {
                    showToast("TIP FAILED ‚Äî CHECK BALANCE");
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Tip ‚ö°';
            }
        }

        async function loadTipStats(address) {
            try {
                const [sentRes, receivedRes] = await Promise.all([
                    _supabase.from('tips').select('amount').eq('sender', address.toLowerCase()),
                    _supabase.from('tips').select('amount, sender, created_at').eq('recipient', address.toLowerCase()).order('created_at', { ascending: false })
                ]);

                const totalSent = (sentRes.data || []).reduce((s, r) => s + parseFloat(r.amount || 0), 0);
                const totalReceived = (receivedRes.data || []).reduce((s, r) => s + parseFloat(r.amount || 0), 0);
                const recentTips = (receivedRes.data || []).slice(0, 5);

                return { totalSent, totalReceived, recentTips };
            } catch(e) {
                console.error("loadTipStats error:", e);
                return { totalSent: 0, totalReceived: 0, recentTips: [] };
            }
        }

        // ===========================
        // BRIDGE OVERLAY
        // ===========================
        function openBridgeOverlay() {
            const overlay = document.getElementById('bridge-overlay');
            const iframe = document.getElementById('bridge-iframe');
            overlay.style.display = 'block';
            // Load the bridge URL now (lazy load)
            if (iframe.src === 'about:blank' || !iframe.src.includes('martianchain')) {
                iframe.src = 'https://bridge.martianchain.com/swap/';
            }
            document.body.style.overflow = 'hidden';
            initBridgeDrag();
        }

        function closeBridgeOverlay() {
            document.getElementById('bridge-overlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Close on backdrop click
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('bridge-overlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeBridgeOverlay();
                });
            }
        });

        // Drag logic for bridge window
        function initBridgeDrag() {
            const handle = document.getElementById('bridge-drag-handle');
            const win = document.getElementById('bridge-window');
            if (!handle || !win || handle._dragReady) return;
            handle._dragReady = true;

            let isDragging = false, startX, startY, startLeft, startTop;

            handle.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                isDragging = true;
                handle.style.cursor = 'grabbing';
                const rect = win.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                startLeft = rect.left;
                startTop = rect.top;
                // Switch from transform-based to absolute position
                win.style.left = startLeft + 'px';
                win.style.top = startTop + 'px';
                win.style.transform = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newLeft = Math.max(0, Math.min(window.innerWidth - win.offsetWidth, startLeft + dx));
                const newTop = Math.max(0, Math.min(window.innerHeight - 60, startTop + dy));
                win.style.left = newLeft + 'px';
                win.style.top = newTop + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    handle.style.cursor = 'grab';
                }
            });

            // Touch support
            handle.addEventListener('touchstart', (e) => {
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                isDragging = true;
                const rect = win.getBoundingClientRect();
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startLeft = rect.left;
                startTop = rect.top;
                win.style.left = startLeft + 'px';
                win.style.top = startTop + 'px';
                win.style.transform = 'none';
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;
                const newLeft = Math.max(0, Math.min(window.innerWidth - win.offsetWidth, startLeft + dx));
                const newTop = Math.max(0, Math.min(window.innerHeight - 60, startTop + dy));
                win.style.left = newLeft + 'px';
                win.style.top = newTop + 'px';
            }, { passive: true });

            document.addEventListener('touchend', () => { isDragging = false; });
        }

        window.onload = init;
        
        // Live countdown ticker ‚Äî updates every second
        setInterval(() => {
            document.querySelectorAll('[data-deadline]').forEach(el => {
                const deadline = parseInt(el.getAttribute('data-deadline'));
                const now = Math.floor(Date.now() / 1000);
                const remaining = deadline - now;
                if (remaining <= 0) {
                    el.textContent = '‚è± TIMEOUT';
                    el.className = el.className.replace(/text-\S+/g, '') + ' countdown-critical';
                    // Also disable any intercept buttons in the same row
                    const row = el.closest('[data-game-id]');
                    if (row) {
                        const interceptBtn = row.querySelector('[data-intercept-btn]');
                        if (interceptBtn) {
                            interceptBtn.disabled = true;
                            interceptBtn.textContent = 'Timed Out';
                            interceptBtn.className = 'text-[9px] text-red-700 uppercase italic px-4 py-2';
                        }
                    }
                } else if (remaining < 60) {
                    const s = remaining;
                    el.textContent = `‚è± 00:${String(s).padStart(2,'0')}`;
                    el.className = 'text-[10px] countdown-tick countdown-critical ml-2';
                    // Disable intercept buttons when < 60s
                    const row = el.closest('[data-game-id]');
                    if (row) {
                        const interceptBtn = row.querySelector('[data-intercept-btn]');
                        if (interceptBtn && !interceptBtn.disabled) {
                            interceptBtn.disabled = true;
                            interceptBtn.textContent = 'üîí Closing...';
                            interceptBtn.className = 'text-[9px] text-red-500 uppercase italic px-4 py-2 cursor-not-allowed opacity-60';
                        }
                    }
                } else {
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    el.textContent = `‚è± ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    if (remaining < 300) {
                        el.className = 'text-[10px] countdown-tick text-yellow-500 ml-2';
                    } else {
                        el.className = 'text-[10px] countdown-tick text-orange-500 ml-2';
                    }
                }
            });
        }, 1000);
        
        window.onbeforeunload = () => {
            if (lobbyRefreshInterval) clearInterval(lobbyRefreshInterval);
            if (activityRefreshInterval) clearInterval(activityRefreshInterval);
            if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        };
    </script>
</body>
</html>
