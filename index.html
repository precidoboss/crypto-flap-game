<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AVAX Chronicles ‚Äî The Eternal Dungeon Ledger</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&family=Bebas+Neue&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --black:#000000; --dungeon:#080808; --stone:#0f0f0f; --stone-mid:#141414; --stone-light:#1c1c1c;
    --ash:#2a2a2a; --ash-light:#383838;
    --red:#cc0000; --red-bright:#ff1a1a; --red-deep:#880000; --red-ember:#ff4400; --red-glow:#ff6633;
    --white:#ffffff; --white-dim:#e0e0e0; --white-fade:#999999; --white-ghost:#555555;
    --fire-1:#ff0000; --fire-2:#ff4400; --fire-3:#ff8800; --fire-4:#ffcc00;
    --border:rgba(204,0,0,0.35); --border-bright:rgba(255,26,26,0.65);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    background:var(--dungeon);
    background-image:
      repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,0.01) 2px,rgba(255,255,255,0.01) 3px),
      repeating-linear-gradient(90deg,transparent,transparent 50px,rgba(255,255,255,0.005) 50px,rgba(255,255,255,0.005) 51px),
      radial-gradient(ellipse at 50% 0%,rgba(180,0,0,0.12) 0%,transparent 55%);
    min-height:100vh;
    font-family:'IM Fell English',serif;
    color:var(--white-dim);
    overflow-x:hidden;
  }

  /* FIRE PARTICLES */
  .fire-bg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
  .fp{position:absolute;border-radius:50% 50% 25% 25%;animation:fpRise linear infinite;opacity:0;}
  @keyframes fpRise{
    0%{transform:translateY(0) scale(1);opacity:0;}
    8%{opacity:0.85;}
    50%{transform:translateY(-45vh) translateX(12px) scale(0.6);opacity:0.4;}
    100%{transform:translateY(-105vh) translateX(-8px) scale(0.1);opacity:0;}
  }

  /* HEADER */
  .site-header{
    position:relative;z-index:10;text-align:center;
    padding:48px 20px 20px;
    background:linear-gradient(180deg,rgba(0,0,0,0.97) 0%,rgba(0,0,0,0.7) 70%,transparent 100%);
    border-bottom:1px solid rgba(204,0,0,0.25);
  }

  .avax-emblem{display:inline-block;margin-bottom:18px;position:relative;}
  .avax-emblem svg{width:64px;height:64px;
    filter:drop-shadow(0 0 10px rgba(204,0,0,0.9)) drop-shadow(0 0 25px rgba(204,0,0,0.5));
    animation:emblemPulse 2.8s ease-in-out infinite alternate;}
  @keyframes emblemPulse{
    from{filter:drop-shadow(0 0 8px rgba(204,0,0,0.8)) drop-shadow(0 0 18px rgba(204,0,0,0.4));}
    to  {filter:drop-shadow(0 0 18px rgba(255,50,0,1)) drop-shadow(0 0 45px rgba(255,30,0,0.7)) drop-shadow(0 0 90px rgba(200,0,0,0.35));}
  }

  .site-title{
    font-family:'Cinzel Decorative',cursive;
    font-size:clamp(1.8rem,5vw,3.8rem);
    font-weight:900;
    color:var(--white);
    text-shadow:0 0 12px rgba(255,20,20,0.95),0 0 35px rgba(204,0,0,0.75),0 0 70px rgba(204,0,0,0.4),2px 2px 0 rgba(120,0,0,0.8),4px 4px 0 rgba(0,0,0,0.7);
    letter-spacing:4px;
    animation:titleFlicker 3.5s ease-in-out infinite alternate;
    line-height:1.1;
  }
  @keyframes titleFlicker{
    from{text-shadow:0 0 12px rgba(255,20,20,0.95),0 0 35px rgba(204,0,0,0.75),3px 3px 0 rgba(120,0,0,0.8),5px 5px 0 rgba(0,0,0,0.7);}
    to  {text-shadow:0 0 22px rgba(255,80,0,1),0 0 55px rgba(255,30,0,0.85),0 0 110px rgba(200,0,0,0.45),3px 3px 0 rgba(120,0,0,0.8),5px 5px 0 rgba(0,0,0,0.7);}
  }

  .site-sub{font-family:'Cinzel',serif;color:var(--white-ghost);font-size:0.68rem;letter-spacing:7px;text-transform:uppercase;margin-top:9px;text-shadow:0 0 8px rgba(200,0,0,0.3);}

  .fire-divider{display:flex;align-items:center;justify-content:center;gap:14px;margin:14px 0 0;color:var(--red);font-size:1rem;}
  .fire-divider::before,.fire-divider::after{content:'';height:1px;width:90px;background:linear-gradient(90deg,transparent,var(--red),transparent);box-shadow:0 0 8px rgba(204,0,0,0.4);}

  /* WALLET BAR */
  .wallet-bar{position:relative;z-index:10;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;padding:14px 20px;background:rgba(0,0,0,0.6);border-bottom:1px solid rgba(204,0,0,0.15);}
  .wc{background:rgba(204,0,0,0.07);border:1px solid var(--border);padding:7px 15px;font-family:'Cinzel',serif;font-size:0.65rem;color:var(--white-fade);letter-spacing:1.5px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:7px;text-transform:uppercase;}
  .wc:hover{background:rgba(204,0,0,0.16);border-color:var(--red);box-shadow:0 0 14px rgba(204,0,0,0.35);color:var(--white);}
  .live-dot{width:6px;height:6px;border-radius:50%;background:var(--red-bright);box-shadow:0 0 7px var(--red-bright);animation:ldot 1.5s ease-in-out infinite;}
  @keyframes ldot{0%,100%{opacity:1}50%{opacity:0.15}}
  .bal-chip{font-family:'Cinzel',serif;font-size:0.7rem;color:var(--white);background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.1);padding:7px 15px;letter-spacing:1px;}

  /* NAV */
  .nav-tabs{position:relative;z-index:10;display:flex;justify-content:center;gap:2px;padding:14px 20px;flex-wrap:wrap;background:rgba(0,0,0,0.4);}
  .tab-btn{font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:2px;text-transform:uppercase;padding:9px 15px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.6);color:var(--white-ghost);cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
  .tab-btn::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--red);transform:scaleX(0);transition:transform 0.2s;}
  .tab-btn:hover{color:var(--white-fade);border-color:rgba(204,0,0,0.25);background:rgba(204,0,0,0.05);}
  .tab-btn.active{color:var(--white);border-color:var(--border-bright);background:rgba(204,0,0,0.1);box-shadow:inset 0 0 20px rgba(204,0,0,0.07);}
  .tab-btn.active::after{transform:scaleX(1);box-shadow:0 0 8px var(--red);}

  /* MAIN */
  .main{position:relative;z-index:5;max-width:870px;margin:0 auto;padding:26px 18px 80px;}
  .tab-content{display:none;}
  .tab-content.active{display:block;}

  /* DUNGEON PANEL */
  .dp{position:relative;background:linear-gradient(150deg,var(--stone) 0%,var(--stone-mid) 60%,#0a0a0a 100%);border:1px solid rgba(204,0,0,0.22);margin-bottom:22px;overflow:hidden;box-shadow:0 4px 0 rgba(0,0,0,0.8),0 0 40px rgba(0,0,0,0.7),inset 0 1px 0 rgba(255,255,255,0.025);}
  .dp::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--red-deep),var(--red),var(--red-bright),var(--red),var(--red-deep),transparent);box-shadow:0 0 12px rgba(204,0,0,0.55);}
  .dp::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(255,255,255,0.006) 3px,rgba(255,255,255,0.006) 4px);pointer-events:none;}
  .dp-inner{padding:26px 30px;position:relative;z-index:1;}

  .sec-title{font-family:'Cinzel Decorative',cursive;font-size:0.98rem;letter-spacing:3px;color:var(--white);text-align:center;margin-bottom:4px;text-shadow:0 0 16px rgba(204,0,0,0.65),0 0 32px rgba(204,0,0,0.3);}
  .sec-sub{font-family:'IM Fell English',serif;font-style:italic;font-size:0.8rem;color:var(--white-ghost);text-align:center;margin-bottom:22px;}

  /* FORM */
  .fl{font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--white-fade);display:block;margin-bottom:6px;}
  .di,.dt,.ds{width:100%;background:rgba(0,0,0,0.65);border:1px solid rgba(255,255,255,0.07);border-bottom:2px solid rgba(204,0,0,0.38);padding:9px 11px;font-family:'IM Fell English',serif;font-size:0.93rem;color:var(--white-dim);outline:none;transition:all 0.2s;margin-bottom:16px;}
  .di:focus,.dt:focus,.ds:focus{border-color:rgba(204,0,0,0.5);border-bottom-color:var(--red-bright);background:rgba(204,0,0,0.05);box-shadow:0 0 0 1px rgba(204,0,0,0.18),0 0 18px rgba(204,0,0,0.08);color:var(--white);}
  .di::placeholder,.dt::placeholder{color:var(--white-ghost);font-style:italic;}
  .dt{resize:vertical;min-height:130px;border:1px solid rgba(204,0,0,0.22);padding:11px;line-height:1.75;}
  .ds{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7'%3E%3Cpath d='M0 0l5 7 5-7z' fill='%23cc0000'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;}
  .ds option{background:#111;color:var(--white-dim);}

  .cc{font-family:'Cinzel',serif;font-size:0.58rem;color:var(--white-ghost);text-align:right;margin-top:-12px;margin-bottom:12px;}
  .cc.warn{color:var(--red-bright);}

  /* TIER */
  .tier-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
  .to{border:1px solid rgba(255,255,255,0.07);background:rgba(0,0,0,0.45);padding:13px;cursor:pointer;transition:all 0.2s;position:relative;}
  .to:hover{border-color:rgba(204,0,0,0.38);background:rgba(204,0,0,0.06);}
  .to.sel{border-color:var(--red);background:rgba(204,0,0,0.09);box-shadow:inset 0 0 20px rgba(204,0,0,0.07);}
  .to.sel::after{content:'‚ñ∏';position:absolute;top:8px;right:10px;color:var(--red);font-size:0.7rem;}
  .tn{font-family:'Cinzel',serif;font-size:0.72rem;letter-spacing:1px;color:var(--white);margin-bottom:3px;}
  .tc{font-family:'IM Fell English',serif;font-size:0.82rem;color:var(--red-bright);font-style:italic;}
  .td{font-size:0.65rem;color:var(--white-ghost);margin-top:2px;}

  /* BUTTONS */
  .btn-fire{font-family:'Cinzel',serif;font-size:0.75rem;letter-spacing:3px;text-transform:uppercase;padding:12px 28px;border:none;cursor:pointer;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--red-deep),var(--red),var(--red-deep));color:var(--white);box-shadow:0 4px 0 rgba(0,0,0,0.7),0 0 20px rgba(204,0,0,0.35);transition:all 0.2s;}
  .btn-fire::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity 0.2s;}
  .btn-fire:hover{transform:translateY(-2px);box-shadow:0 6px 0 rgba(0,0,0,0.7),0 0 25px rgba(204,0,0,0.55);}
  .btn-fire:hover::before{opacity:1;}
  .btn-fire:active{transform:translateY(1px);box-shadow:0 2px 0 rgba(0,0,0,0.7);}
  .btn-ghost{font-family:'Cinzel',serif;font-size:0.7rem;letter-spacing:2px;text-transform:uppercase;padding:10px 20px;background:transparent;color:var(--white-ghost);border:1px solid rgba(255,255,255,0.12);cursor:pointer;transition:all 0.2s;}
  .btn-ghost:hover{border-color:rgba(255,255,255,0.3);color:var(--white-fade);background:rgba(255,255,255,0.04);}
  .btn-rg{font-family:'Cinzel',serif;font-size:0.67rem;letter-spacing:2px;text-transform:uppercase;padding:8px 16px;background:transparent;color:var(--red);border:1px solid rgba(204,0,0,0.38);cursor:pointer;transition:all 0.2s;}
  .btn-rg:hover{background:rgba(204,0,0,0.1);border-color:var(--red);box-shadow:0 0 12px rgba(204,0,0,0.28);color:var(--red-bright);}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

  /* CHRONICLE CARD */
  .ci{position:relative;background:linear-gradient(155deg,#0d0d0d,#111,#090909);border:1px solid rgba(204,0,0,0.18);margin-bottom:14px;overflow:hidden;animation:ciIn 0.32s ease-out;box-shadow:0 3px 0 rgba(0,0,0,0.8),0 8px 28px rgba(0,0,0,0.55);transition:border-color 0.2s;}
  .ci:hover{border-color:rgba(204,0,0,0.4);}
  @keyframes ciIn{from{opacity:0;transform:translateY(-7px)}to{opacity:1;transform:translateY(0)}}
  .ci::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--red-deep),var(--red),var(--red-deep),transparent);}
  .ci.grand{border-color:rgba(204,0,0,0.42);}
  .ci.grand::before{height:3px;background:linear-gradient(90deg,transparent,var(--red-deep),var(--red-bright),var(--fire-3),var(--red-bright),var(--red-deep),transparent);box-shadow:0 0 16px rgba(255,68,0,0.55);}
  .ci-inn{padding:17px 20px 13px;position:relative;}
  .grand-tag{display:inline-block;font-family:'Cinzel',serif;font-size:0.52rem;letter-spacing:2px;text-transform:uppercase;border:1px solid rgba(255,100,0,0.45);color:var(--fire-3);padding:2px 8px;margin-bottom:7px;text-shadow:0 0 8px rgba(255,100,0,0.45);}
  .ci-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:9px;flex-wrap:wrap;gap:7px;}
  .ci-author{font-family:'Cinzel',serif;font-size:0.7rem;color:var(--white-fade);letter-spacing:1px;}
  .ci-target{display:inline-block;background:rgba(204,0,0,0.12);border:1px solid rgba(204,0,0,0.38);color:var(--red-bright);font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:1px;padding:2px 9px;margin-left:7px;}
  .ci-heat{display:flex;align-items:center;gap:5px;font-family:'Cinzel',serif;font-size:0.58rem;color:var(--white-ghost);}
  .hbars{display:flex;gap:2px;align-items:flex-end;}
  .hb{width:4px;background:var(--ash);border-radius:1px;transition:background 0.3s;}
  .hb.h1{height:5px}.hb.h2{height:8px}.hb.h3{height:11px}.hb.h4{height:14px}.hb.h5{height:17px}
  .hb.lit{background:var(--red);box-shadow:0 0 4px var(--red);}
  .hb.blaze{background:var(--fire-3);box-shadow:0 0 6px var(--fire-3);}
  .ci-text{font-family:'IM Fell English',serif;font-size:0.95rem;line-height:1.75;color:var(--white-dim);margin-bottom:13px;white-space:pre-wrap;word-break:break-word;}
  .ci-text .men{color:var(--red-bright);font-style:italic;font-weight:bold;}
  .ci-ftr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:7px;padding-top:9px;border-top:1px solid rgba(255,255,255,0.04);}
  .ci-meta{font-family:'Cinzel',serif;font-size:0.57rem;color:var(--white-ghost);letter-spacing:1px;}
  .ci-tl{font-family:'Cinzel',serif;font-size:0.57rem;color:var(--white-ghost);}
  .ci-tl.urg{color:var(--red-bright);animation:blink 1s step-end infinite;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
  .vote-a{display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
  .vb{font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:1.5px;padding:5px 11px;cursor:pointer;border:1px solid;transition:all 0.2s;background:transparent;}
  .vb.up{border-color:rgba(255,255,255,0.18);color:var(--white-fade);}
  .vb.up:hover{border-color:rgba(255,255,255,0.45);color:var(--white);background:rgba(255,255,255,0.05);}
  .vb.dn{border-color:rgba(204,0,0,0.32);color:rgba(204,0,0,0.65);}
  .vb.dn:hover{border-color:var(--red);color:var(--red-bright);background:rgba(204,0,0,0.07);}
  .rx-a{display:flex;gap:3px;}
  .rxb{border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.35);padding:4px 8px;font-size:0.76rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:2px;color:var(--white-dim);}
  .rxb:hover{background:rgba(204,0,0,0.1);border-color:rgba(204,0,0,0.38);}
  .rxc{font-family:'Cinzel',serif;font-size:0.56rem;color:var(--white-ghost);}
  .ctb{font-family:'Cinzel',serif;font-size:0.56rem;letter-spacing:1px;padding:4px 9px;cursor:pointer;border:1px solid rgba(255,255,255,0.09);color:var(--white-ghost);background:transparent;transition:all 0.2s;text-transform:uppercase;}
  .ctb:hover{border-color:rgba(255,255,255,0.22);color:var(--white-fade);}

  /* FEED FILTERS */
  .feed-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:18px;}
  .fp-btn{font-family:'Cinzel',serif;font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;padding:6px 13px;border:1px solid rgba(255,255,255,0.07);background:transparent;color:var(--white-ghost);cursor:pointer;transition:all 0.2s;}
  .fp-btn.active,.fp-btn:hover{border-color:rgba(204,0,0,0.45);color:var(--red-bright);background:rgba(204,0,0,0.07);}

  /* LEADERBOARD */
  .lb-row{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid rgba(255,255,255,0.035);transition:background 0.2s;}
  .lb-row:hover{background:rgba(204,0,0,0.03);}
  .lb-rank{font-family:'Cinzel Decorative',cursive;min-width:28px;text-align:center;}
  .lb-rank.r1{color:var(--red-bright);font-size:1.05rem;text-shadow:0 0 10px rgba(255,26,26,0.8);}
  .lb-rank.r2{color:var(--white-dim);font-size:0.9rem;}
  .lb-rank.r3{color:var(--white-ghost);font-size:0.82rem;}
  .lb-rank.rN{color:var(--ash-light);font-size:0.75rem;}
  .lb-ico{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--red-deep),#2a0000);border:1px solid rgba(204,0,0,0.38);display:flex;align-items:center;justify-content:center;font-size:0.95rem;flex-shrink:0;}
  .lb-info{flex:1;min-width:0;}
  .lb-name{font-family:'Cinzel',serif;font-size:0.72rem;color:var(--white-dim);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .lb-target{font-family:'IM Fell English',serif;font-size:0.7rem;color:var(--red);font-style:italic;}
  .lb-excerpt{font-family:'IM Fell English',serif;font-size:0.75rem;color:var(--white-ghost);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .lb-stats{text-align:right;min-width:52px;}
  .lb-up{font-family:'Cinzel',serif;font-size:0.65rem;color:var(--white-dim);}
  .lb-dn{font-family:'Cinzel',serif;font-size:0.65rem;color:var(--red);}

  /* MOST WANTED */
  .wr{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;margin-bottom:5px;background:rgba(0,0,0,0.35);border:1px solid rgba(204,0,0,0.1);transition:all 0.2s;flex-wrap:wrap;gap:7px;}
  .wr:hover{border-color:rgba(204,0,0,0.32);background:rgba(204,0,0,0.05);}
  .w-handle{font-family:'Cinzel',serif;font-size:0.82rem;color:var(--white-dim);}
  .w-crown{color:var(--red-bright);font-size:0.6rem;font-family:'Cinzel',serif;letter-spacing:1px;}
  .w-count{font-family:'IM Fell English',serif;font-style:italic;font-size:0.75rem;color:var(--red);}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.93);backdrop-filter:blur(7px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
  .modal-overlay.open{display:flex;}
  .modal-d{position:relative;background:linear-gradient(145deg,#0d0d0d,#111,#090909);border:1px solid rgba(204,0,0,0.38);max-width:490px;width:100%;padding:34px 30px;box-shadow:0 0 0 1px rgba(255,255,255,0.02),0 0 55px rgba(204,0,0,0.22),0 30px 80px rgba(0,0,0,0.95);animation:mIn 0.26s cubic-bezier(0.34,1.56,0.64,1);max-height:90vh;overflow-y:auto;}
  .modal-d::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--red-deep),var(--red-bright),var(--red),var(--red-deep),transparent);}
  @keyframes mIn{from{transform:scale(0.84);opacity:0}to{transform:scale(1);opacity:1}}
  .modal-close{position:absolute;top:13px;right:15px;font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:1px;background:none;border:none;cursor:pointer;color:var(--white-ghost);text-transform:uppercase;transition:color 0.2s;}
  .modal-close:hover{color:var(--red-bright);}
  .m-title{font-family:'Cinzel Decorative',cursive;font-size:0.92rem;color:var(--white);text-align:center;margin-bottom:4px;letter-spacing:2px;text-shadow:0 0 18px rgba(204,0,0,0.55);}
  .m-sub{font-family:'IM Fell English',serif;font-style:italic;font-size:0.78rem;color:var(--white-ghost);text-align:center;margin-bottom:20px;}
  .kd{background:rgba(0,0,0,0.75);border:1px solid rgba(255,255,255,0.05);border-left:3px solid var(--red-deep);padding:11px 13px;margin-bottom:11px;cursor:pointer;transition:all 0.2s;}
  .kd:hover{border-left-color:var(--red);background:rgba(204,0,0,0.04);}
  .k-lbl{font-family:'Cinzel',serif;font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--white-ghost);display:block;margin-bottom:4px;}
  .k-val{font-family:'Courier New',monospace;font-size:0.68rem;color:var(--white-fade);word-break:break-all;}
  .warn-bx{background:rgba(204,0,0,0.05);border:1px solid rgba(204,0,0,0.28);padding:9px 13px;margin-bottom:14px;font-family:'IM Fell English',serif;font-style:italic;font-size:0.78rem;color:var(--red);text-align:center;}
  .m-div{height:1px;background:rgba(255,255,255,0.05);margin:16px 0;}
  .m-sec{font-family:'Cinzel',serif;font-size:0.68rem;letter-spacing:2px;text-transform:uppercase;color:var(--white-fade);margin-bottom:10px;}
  .amt-row{display:flex;gap:8px;align-items:flex-end;margin-bottom:12px;}
  .amt-row .di{margin-bottom:0;flex:1;}

  /* TX STATUS */
  .txs{display:none;text-align:center;padding:9px 13px;font-family:'Cinzel',serif;font-size:0.65rem;letter-spacing:1px;border:1px solid;margin-top:10px;}
  .txs.pending{display:block;border-color:rgba(255,200,0,0.38);color:#f0c040;background:rgba(240,192,64,0.04);}
  .txs.success{display:block;border-color:rgba(0,180,0,0.35);color:#00cc44;background:rgba(0,180,0,0.04);}
  .txs.error{display:block;border-color:rgba(204,0,0,0.38);color:var(--red);background:rgba(204,0,0,0.04);}

  /* TOAST */
  .toast-wrap{position:fixed;bottom:22px;right:22px;z-index:300;display:flex;flex-direction:column;gap:5px;}
  .toast{background:var(--stone);border:1px solid rgba(204,0,0,0.38);border-left:3px solid var(--red);padding:9px 14px;font-family:'Cinzel',serif;font-size:0.65rem;letter-spacing:1px;color:var(--white-dim);box-shadow:0 4px 20px rgba(0,0,0,0.8);max-width:270px;animation:tIn 0.22s ease-out,tOut 0.3s ease-in 2.7s forwards;}
  .toast.success{border-left-color:#00cc44;border-color:rgba(0,180,0,0.28);}
  .toast.error{border-left-color:var(--red-bright);}
  @keyframes tIn{from{transform:translateX(28px);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes tOut{from{opacity:1}to{opacity:0;pointer-events:none}}

  /* MISC */
  .loading-state{text-align:center;padding:48px 20px;font-family:'IM Fell English',serif;font-style:italic;color:var(--white-ghost);font-size:0.95rem;}
  .avax-note{font-family:'IM Fell English',serif;font-style:italic;font-size:0.76rem;color:var(--white-ghost);text-align:center;margin-top:8px;}
  .wn-row{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:9px 13px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.03);}
  .wn-lbl{font-family:'Cinzel',serif;font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--white-ghost);}
  .wn-name{font-family:'IM Fell English',serif;font-style:italic;font-size:0.92rem;color:var(--red-bright);}
  .prev-lbl{font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:4px;text-transform:uppercase;color:var(--white-ghost);text-align:center;margin-bottom:10px;opacity:0.55;}
  .sr-row{display:flex;gap:8px;margin-bottom:16px;}
  .sr-row .di{margin-bottom:0;flex:1;}
  ::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:#000;}::-webkit-scrollbar-thumb{background:var(--red-deep);}::-webkit-scrollbar-thumb:hover{background:var(--red);}
  @media(max-width:580px){.dp-inner,.ci-inn{padding:14px;}.tier-grid{grid-template-columns:1fr;}.modal-d{padding:22px 16px;}.site-title{font-size:1.6rem;}}

  /* STATS BAR */
  .stats-bar{position:relative;z-index:10;display:flex;align-items:center;justify-content:center;gap:0;flex-wrap:wrap;background:rgba(0,0,0,0.85);border-bottom:1px solid rgba(204,0,0,0.2);}
  .stat-block{display:flex;flex-direction:column;align-items:center;padding:10px 24px;border-right:1px solid rgba(255,255,255,0.04);gap:2px;}
  .stat-block:last-child{border-right:none;}
  .stat-val{font-family:'Cinzel',serif;font-size:0.95rem;color:var(--red-bright);letter-spacing:1px;text-shadow:0 0 10px rgba(255,26,26,0.5);font-weight:600;}
  .stat-lbl{font-family:'Cinzel',serif;font-size:0.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--white-ghost);}

  /* TWEET MODAL */
  .tweet-preview-box{background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.08);padding:14px;font-family:'IM Fell English',serif;font-size:0.88rem;line-height:1.7;color:var(--white-dim);white-space:pre-wrap;word-break:break-word;margin-bottom:14px;border-left:3px solid var(--red);}
  .tweet-char-count{font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:1px;color:var(--white-ghost);text-align:right;margin-bottom:12px;}
  .tweet-char-count.over{color:var(--red-bright);}

  /* CHRONICLE DEEP LINK highlight */
  .chronicle-direct{border-color:rgba(255,200,0,0.5)!important;box-shadow:0 0 30px rgba(255,200,0,0.15)!important;}
  .chronicle-direct::before{background:linear-gradient(90deg,transparent,#aa8800,#ffcc00,#aa8800,transparent)!important;}

  /* HOW IT WORKS */
  .hiw-block{display:flex;gap:18px;align-items:flex-start;padding:18px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
  .hiw-block:last-child{border-bottom:none;padding-bottom:0;}
  .hiw-num{font-family:'Cinzel Decorative',cursive;font-size:1.3rem;color:var(--red);min-width:36px;text-align:center;line-height:1;text-shadow:0 0 10px rgba(204,0,0,0.6);flex-shrink:0;padding-top:2px;}
  .hiw-content{flex:1;}
  .hiw-title{font-family:'Cinzel',serif;font-size:0.82rem;letter-spacing:1.5px;color:var(--white);margin-bottom:8px;text-transform:uppercase;}
  .hiw-text{font-family:'IM Fell English',serif;font-size:0.92rem;line-height:1.75;color:var(--white-fade);}
  .hiw-text strong{color:var(--white-dim);font-style:normal;}
  .hiw-text em{color:var(--red-bright);}
</style>
</head>
<body>

<div class="fire-bg" id="fireBg"></div>
<div class="toast-wrap" id="toastWrap"></div>

<!-- HEADER -->
<header class="site-header">
  <div class="avax-emblem">
    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <polygon points="50,6 94,81 6,81" fill="none" stroke="#cc0000" stroke-width="3.5"/>
      <polygon points="50,22 80,76 20,76" fill="rgba(204,0,0,0.13)" stroke="#ff2200" stroke-width="1.8"/>
      <polygon points="31,76 50,40 69,76" fill="rgba(0,0,0,0.9)" stroke="#cc0000" stroke-width="2.2"/>
      <line x1="50" y1="6" x2="50" y2="81" stroke="rgba(255,80,0,0.25)" stroke-width="1.2"/>
    </svg>
  </div>
  <div class="site-title">AVAX Chronicles</div>
  <div class="site-sub">The Eternal Dungeon Ledger of Degen Grievances</div>
  <div class="fire-divider">üî•</div>
</header>

<!-- WALLET BAR -->
<div class="wallet-bar">
  <div class="wc" onclick="openModal('walletModal')">
    <div class="live-dot"></div>
    <span id="walletAddr">Conjuring Vault...</span>
  </div>
  <div class="bal-chip" id="balChip">‚ö° 0.0000 AVAX</div>
  <div class="wc" onclick="openModal('walletModal')">‚öô MANAGE VAULT</div>
</div>

<!-- STATS BAR -->
<div class="stats-bar">
  <div class="stat-block">
    <div class="stat-val" id="statTotalBurned">‚Äî AVAX</div>
    <div class="stat-lbl">üî• Total Burned</div>
  </div>
  <div class="stat-block">
    <div class="stat-val" id="statChronicles">‚Äî</div>
    <div class="stat-lbl">üìú Chronicles</div>
  </div>
  <div class="stat-block">
    <div class="stat-val" id="statVotes">‚Äî</div>
    <div class="stat-lbl">‚öî Votes Cast</div>
  </div>
  <div class="stat-block">
    <div class="stat-val" id="statTargets">‚Äî</div>
    <div class="stat-lbl">üíÄ Targets Named</div>
  </div>
</div>

<!-- TWEET MODAL -->
<div class="modal-overlay" id="tweetModal">
  <div class="modal-d">
    <button class="modal-close" onclick="closeModal('tweetModal')">‚úï CLOSE</button>
    <div class="m-title">üìã Post to X</div>
    <div class="m-sub">Two versions ready ‚Äî one for the project account, one for users to self-post</div>

    <div class="m-sec" style="margin-bottom:8px">üè¥ PROJECT ACCOUNT POST <span style="color:var(--white-ghost);font-size:0.58rem">(post from @avaxchronicles_)</span></div>
    <div class="tweet-preview-box" id="tweetProjectText"></div>
    <div class="tweet-char-count" id="tweetProjectCount"></div>
    <button class="btn-fire" style="width:100%;margin-bottom:16px" onclick="copyTweetVariant('project')">üìã COPY PROJECT TWEET</button>

    <div class="m-sec" style="margin-bottom:8px">üî• USER SELF-POST <span style="color:var(--white-ghost);font-size:0.58rem">(tags @avaxchronicles_ ‚Äî for the anon to post)</span></div>
    <div class="tweet-preview-box" id="tweetUserText"></div>
    <div class="tweet-char-count" id="tweetUserCount"></div>
    <button class="btn-ghost" style="width:100%" onclick="copyTweetVariant('user')">üìã COPY USER TWEET</button>
  </div>
</div>

<!-- NAV -->
<nav class="nav-tabs">
  <button class="tab-btn active" onclick="sw('write')">‚úç Write Chronicle</button>
  <button class="tab-btn" onclick="sw('feed')">üìú The Feed</button>
  <button class="tab-btn" onclick="sw('wall')">‚ò† Wall of Shame</button>
  <button class="tab-btn" onclick="sw('fame')">‚öú Wall of Fame</button>
  <button class="tab-btn" onclick="sw('wanted')">üíÄ Most Wanted</button>
  <button class="tab-btn" onclick="sw('archives')">üóÑ Archives</button>
  <button class="tab-btn" onclick="sw('howto')">üìñ How It Works</button>
</nav>

<!-- MAIN -->
<main class="main">

  <!-- WRITE -->
  <div id="tab-write" class="tab-content active">
    <div class="dp">
      <div class="dp-inner">
        <div class="sec-title">Commission Thy Chronicle</div>
        <div class="sec-sub">Ink thy grievances into the eternal dungeon ‚Äî once burned, forever inscribed</div>
        <div class="wn-row">
          <span class="wn-lbl">Chronicle Name</span>
          <span class="wn-name" id="chronicleName">‚Äî conjuring ‚Äî</span>
        </div>
        <label class="fl">‚öî Target on X (optional)</label>
        <input class="di" id="targetHandle" placeholder="@their_handle" maxlength="50" oninput="fmtHandle(this)">
        <label class="fl">üî• Crash-Out Mode</label>
        <select class="ds" id="crashMode" style="margin-bottom:18px">
          <option value="rage">‚ö° The Great Rage</option>
          <option value="betrayal">üó° The Betrayal Chronicles</option>
          <option value="rug">üíÄ The Rug Pull Lament</option>
          <option value="fud">üëÅ Thy FUD Dispelled</option>
          <option value="alpha">üîÆ The Alpha Revelation</option>
          <option value="degen">üé∞ Pure Degen Energy</option>
        </select>
        <label class="fl">üìú Thy Chronicle</label>
        <textarea class="dt" id="crashText" maxlength="1000" oninput="updateCC()" placeholder="Pour thy soul into the dungeon. Name names. Speak truths. Burn bridges. The AVAX chain remembers everything.&#10;&#10;The dungeon does not forget."></textarea>
        <div class="cc" id="charCountEl">0 / 1000</div>
        <label class="fl">üíé Chronicle Tier</label>
        <div class="tier-grid">
          <div class="to sel" onclick="selTier(this,'standard',0.001)">
            <div class="tn">Standard Chronicle</div>
            <div class="tc">0.001 AVAX burned</div>
            <div class="td">Eternal. Humble. Real.</div>
          </div>
          <div class="to" onclick="selTier(this,'grand',0.01)">
            <div class="tn">üî• Grand Chronicle</div>
            <div class="tc">0.01 AVAX burned</div>
            <div class="td">Pinned 24hrs. Legendary.</div>
          </div>
        </div>
        <label class="fl">‚öî Duel Link (optional ‚Äî reply to an existing Chronicle ID)</label>
        <input class="di" id="duelTarget" placeholder="Paste Chronicle UUID for a duel">
        <div class="btn-row">
          <button class="btn-fire" onclick="submitCrashOut()">üî• SEAL INTO ETERNITY</button>
          <button class="btn-ghost" onclick="previewCO()">üëÅ Preview</button>
        </div>
        <div class="avax-note">Sealing burns AVAX to the dead address on Avalanche C-Chain. No refunds. Anon forever.</div>
        <div class="txs" id="writeTx"></div>
      </div>
    </div>
    <div id="prevWrap" style="display:none"><div class="prev-lbl">‚Äî preview ‚Äî</div><div id="prevContent"></div></div>
  </div>

  <!-- FEED -->
  <div id="tab-feed" class="tab-content">
    <div class="feed-filters">
      <button class="fp-btn active" onclick="filterFeed('hot',this)">üî• Hottest</button>
      <button class="fp-btn" onclick="filterFeed('new',this)">üïØ Freshest</button>
      <button class="fp-btn" onclick="filterFeed('grand',this)">üíé Grand Only</button>
      <button class="fp-btn" onclick="filterFeed('duels',this)">‚öî Duels</button>
      <button class="fp-btn" onclick="filterFeed('rage',this)">üò§ Rage</button>
      <button class="fp-btn" onclick="filterFeed('rug',this)">üíÄ Rug Pulls</button>
      <button class="fp-btn" onclick="filterFeed('degen',this)">üé∞ Degen</button>
    </div>
    <div id="feedContainer"><div class="loading-state">The dungeon scribes are working...</div></div>
  </div>

  <!-- WALL OF SHAME -->
  <div id="tab-wall" class="tab-content">
    <div class="dp"><div class="dp-inner">
      <div class="sec-title">‚ò† The Wall of Shame</div>
      <div class="sec-sub">Chronicles most scorned by the dungeon ‚Äî the downvoted condemned</div>
      <div id="shameContainer"><div class="loading-state">Consulting the dark ledger...</div></div>
    </div></div>
  </div>

  <!-- WALL OF FAME -->
  <div id="tab-fame" class="tab-content">
    <div class="dp"><div class="dp-inner">
      <div class="sec-title">‚öú The Wall of Fame</div>
      <div class="sec-sub">Chronicles most celebrated ‚Äî legends burned into the dungeon forever</div>
      <div id="fameContainer"><div class="loading-state">Consulting the golden ledger...</div></div>
    </div></div>
  </div>

  <!-- MOST WANTED -->
  <div id="tab-wanted" class="tab-content">
    <div class="dp"><div class="dp-inner">
      <div class="sec-title">üíÄ Most Wanted Scrolls</div>
      <div class="sec-sub">Handles most frequently dragged across the dungeon parchment</div>
      <div id="wantedContainer" style="margin-top:16px"></div>
    </div></div>
  </div>

  <!-- ARCHIVES -->
  <div id="tab-archives" class="tab-content">
    <div class="dp"><div class="dp-inner">
      <div class="sec-title">üóÑ The Archives</div>
      <div class="sec-sub">All chronicles inscribed ‚Äî the eternal record of the dungeon</div>
      <div class="sr-row">
        <input class="di" id="archSearch" placeholder="Search by handle, name or keyword..." onkeydown="if(event.key==='Enter')searchArch()">
        <button class="btn-rg" onclick="searchArch()">SEARCH</button>
      </div>
      <div id="archivesContainer"><div class="loading-state">Unrolling the archives...</div></div>
    </div></div>
  </div>

  <!-- HOW IT WORKS -->
  <div id="tab-howto" class="tab-content">
    <div class="dp"><div class="dp-inner">
      <div class="sec-title">üìñ How It Works</div>
      <div class="sec-sub">Everything thou needest to know about the Dungeon Ledger</div>

      <div class="hiw-block">
        <div class="hiw-num">I</div>
        <div class="hiw-content">
          <div class="hiw-title">Thy Anonymous Vault is Auto-Generated</div>
          <div class="hiw-text">The moment you open AVAX Chronicles, a fresh wallet is conjured for you automatically and stored in your browser's local storage. No sign-up. No email. No identity. It survives page reloads and return visits. Your wallet address becomes your anonymous identity on the ledger ‚Äî and from it, your unique <strong>Chronicle Name</strong> is derived (e.g. <em>Scorned Degen of the Flame</em>).</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">II</div>
        <div class="hiw-content">
          <div class="hiw-title">Deposit AVAX to Your Vault</div>
          <div class="hiw-text">Open the <strong>Manage Vault</strong> panel (top of screen) and copy your wallet address. Send AVAX to it from any exchange or wallet ‚Äî Coinbase, MetaMask, Binance, wherever. Your balance refreshes automatically every 15 seconds. You need at least <strong>0.002 AVAX</strong> to start sealing chronicles, voting, and reacting.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">III</div>
        <div class="hiw-content">
          <div class="hiw-title">Write Thy Chronicle ‚Äî Crash Out Freely</div>
          <div class="hiw-text">Go to <strong>Write Chronicle</strong>. Drop the @handle of whoever you're calling out (optional), pick a Crash-Out Mode (Rage, Betrayal, Rug Pull, FUD, Alpha, or Pure Degen), and write your truth ‚Äî up to 1000 characters. You can also link to an existing Chronicle UUID to create a <strong>Duel</strong> ‚Äî a side-by-side confrontation on the ledger.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">IV</div>
        <div class="hiw-content">
          <div class="hiw-title">Choose Thy Tier ‚Äî Then Seal & Burn Forever</div>
          <div class="hiw-text">Two tiers available: <strong>Standard Chronicle</strong> burns 0.001 AVAX to the dead address on Avalanche C-Chain ‚Äî eternal and humble. <strong>Grand Chronicle</strong> burns 0.01 AVAX and gets a pinned golden treatment at the top of the feed for 24 hours. Once sealed, the burn transaction is irreversible and your chronicle is inscribed into both the blockchain and the dungeon ledger forever. No edits. No deletions.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">V</div>
        <div class="hiw-content">
          <div class="hiw-title">The Community Votes ‚Äî With Real AVAX</div>
          <div class="hiw-text">Every upvote (‚ñ≤) and downvote (‚ñº) costs <strong>0.001 AVAX</strong> burned to the dead address. This means community sentiment has real financial weight ‚Äî no spam, no bots, no fake engagement. You can only vote once per chronicle. Reactions ‚Äî the üî¥ Wax Seal, ü¶Ö Raven, and üî• Torch ‚Äî also cost 0.001 AVAX each and can only be sent once per chronicle per wallet.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">VI</div>
        <div class="hiw-content">
          <div class="hiw-title">Heat Score ‚Äî What Makes Chronicles Rise</div>
          <div class="hiw-text">Each chronicle has a <strong>Heat Score</strong> calculated from: (upvotes √ó 2) minus downvotes plus all reactions. Hot chronicles rise to the top of the feed. Heat decays over time so fresh chronicles can always challenge for dominance. Chronicles live on the hot feed for <strong>48 hours</strong> before moving to the Archives ‚Äî but they remain searchable and readable forever.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">VII</div>
        <div class="hiw-content">
          <div class="hiw-title">Wall of Shame, Wall of Fame & Most Wanted</div>
          <div class="hiw-text"><strong>Wall of Shame</strong> shows the most downvoted chronicles ‚Äî the community's condemned. <strong>Wall of Fame</strong> shows the most upvoted legends. <strong>Most Wanted</strong> tracks which X handles have been called out the most times across all chronicles ‚Äî the dungeon's permanent hit list.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">VIII</div>
        <div class="hiw-content">
          <div class="hiw-title">Export & Protect Thy Vault</div>
          <div class="hiw-text">Your private key lives in your browser's local storage. Go to <strong>Manage Vault</strong> to export a JSON key file or copy the private key ‚Äî store it somewhere safe offline. If you clear your browser data without backing up your key, thy vault is lost forever. You can import this key into MetaMask or any EVM wallet to send AVAX back out if needed. Each device generates its own vault ‚Äî your key does not sync across devices automatically.</div>
        </div>
      </div>

      <div class="hiw-block">
        <div class="hiw-num">IX</div>
        <div class="hiw-content">
          <div class="hiw-title">Copy Tweet ‚Äî The Project Posts For You</div>
          <div class="hiw-text">Every chronicle has a <strong>Copy Tweet</strong> button that formats a ready-to-post message: who challenged who, the first 140 characters of the crash-out, and the link. The AVAX Chronicles project account reviews these in Supabase and posts the spiciest ones manually ‚Äî so the community sees thy wrath on X without any auto-posting or bots.</div>
        </div>
      </div>

    </div></div>
  </div>

</main>

<!-- WALLET MODAL -->
<div class="modal-overlay" id="walletModal">
  <div class="modal-d">
    <button class="modal-close" onclick="closeModal('walletModal')">‚úï CLOSE</button>
    <div class="m-title">Thy Secret Vault</div>
    <div class="m-sub">Handle with the gravity of a thousand burned scrolls</div>
    <div class="warn-bx">‚ö† Never share thy private key. Not with anyone. Ever.</div>
    <div class="kd" onclick="copyText(document.getElementById('addrVal').textContent,'Address copied!')">
      <span class="k-lbl">Wallet Address ‚Äî click to copy</span>
      <span class="k-val" id="addrVal">loading...</span>
    </div>
    <div class="kd" onclick="revealKey()">
      <span class="k-lbl">Private Key ‚Äî click to reveal (once)</span>
      <span class="k-val" id="privKeyVal">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
    </div>
    <div class="btn-row" style="margin-bottom:4px">
      <button class="btn-rg" onclick="exportVault()">üì• Export Key File</button>
      <button class="btn-ghost" onclick="copyPrivKey()">üìã Copy Key</button>
    </div>
    <div class="m-div"></div>
    <div class="m-sec">‚¨á Deposit AVAX</div>
    <div class="kd" onclick="copyText(document.getElementById('depVal').textContent,'Deposit address copied!')">
      <span class="k-lbl">Send AVAX to this address</span>
      <span class="k-val" id="depVal">loading...</span>
    </div>
    <div class="avax-note">Balance refreshes every 15s automatically</div>
    <div class="m-div"></div>
    <div class="m-sec">‚¨Ü Withdraw AVAX</div>
    <input class="di" id="withdrawAddr" placeholder="Destination address 0x...">
    <div class="amt-row">
      <input class="di" id="withdrawAmt" type="number" step="0.001" min="0.001" placeholder="Amount in AVAX" style="max-width:160px;margin-bottom:0">
      <button class="btn-fire" onclick="withdrawAVAX()">WITHDRAW</button>
    </div>
    <div class="txs" id="walletTx"></div>
  </div>
</div>

<script>
const SUPABASE_URL  = 'https://vfyrbfwugryzfvlmxyvc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmeXJiZnd1Z3J5emZ2bG14eXZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODc2ODgsImV4cCI6MjA4NzI2MzY4OH0.sC_s8XK8CQfJBzzL4BbZSB9AdrtP9yetSere269A5s4';
const BURN_ADDR     = '0x000000000000000000000000000000000000dEaD';
const AVAX_RPC      = 'https://api.avax.network/ext/bc/C/rpc';
const AVAX_CHAIN    = 43114;
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let wallet, provider, signer, curBal = '0';
let selTierData = { name:'standard', cost:0.001 };

const ADJ   = ['Scorned','Forsaken','Betrayed','Wrathful','Eternal','Exiled','Vengeful','Burning','Shadowed','Cursed','Iron','Raging','Silent','Hollow','Damned'];
const NOUN  = ['Merchant','Degen','Scribe','Warlord','Alchemist','Pilgrim','Heretic','Phantom','Oracle','Knight','Ronin','Spectre','Jester','Wanderer','Rogue'];
const PLACE = ['of Avalanche','of the Abyss','of the Burn','of Eternity','of the Void','of the Chain','of the Dungeon','of the Flame','of the Ledger','of the Summit'];
function makeName(addr){const s=parseInt(addr.slice(2,10),16);return `${ADJ[s%ADJ.length]} ${NOUN[Math.floor(s/ADJ.length)%NOUN.length]} ${PLACE[Math.floor(s/300)%PLACE.length]}`;}

// ‚îÄ‚îÄ WALLET ‚îÄ‚îÄ
function initWallet(){
  const pk = localStorage.getItem('avax_chron_pk');
  if(pk){loadWallet(pk);}else{const w=ethers.Wallet.createRandom();localStorage.setItem('avax_chron_pk',w.privateKey);loadWallet(w.privateKey);}
}
function loadWallet(pk){
  provider = new ethers.providers.JsonRpcProvider(AVAX_RPC);
  wallet = new ethers.Wallet(pk, provider); signer = wallet;
  const a = wallet.address;
  document.getElementById('walletAddr').textContent = a.slice(0,6)+'...'+a.slice(-4);
  document.getElementById('addrVal').textContent = a;
  document.getElementById('depVal').textContent = a;
  document.getElementById('privKeyVal').textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  document.getElementById('chronicleName').textContent = makeName(a);
  refreshBal(); setInterval(refreshBal,15000); subscribeRT();
}
async function refreshBal(){
  if(!provider||!wallet)return;
  try{const b=await provider.getBalance(wallet.address);curBal=ethers.utils.formatEther(b);document.getElementById('balChip').textContent=`‚ö° ${parseFloat(curBal).toFixed(4)} AVAX`;}catch(e){}
}
function revealKey(){const el=document.getElementById('privKeyVal');if(el.textContent.startsWith('‚Ä¢')){if(!confirm('Reveal private key? Make sure no one is watching.'))return;el.textContent=localStorage.getItem('avax_chron_pk')||'';}else{el.textContent='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';}}
function copyPrivKey(){const pk=localStorage.getItem('avax_chron_pk');if(pk){navigator.clipboard.writeText(pk);toast('Private key copied ‚Äî guard it','');}}
function exportVault(){
  const pk=localStorage.getItem('avax_chron_pk'),addr=wallet?.address||'unknown';
  const d=JSON.stringify({address:addr,privateKey:pk,chronicleName:makeName(addr),network:'Avalanche C-Chain (43114)',rpc:AVAX_RPC,warning:'NEVER share. Import via MetaMask using privateKey field.'},null,2);
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([d],{type:'application/json'}));a.download=`avax-chronicles-vault-${addr.slice(0,10)}.json`;a.click();
  toast('Vault exported üîê','success');
}
async function withdrawAVAX(){
  const to=document.getElementById('withdrawAddr').value.trim(),amt=document.getElementById('withdrawAmt').value;
  if(!to||!amt){toast('Fill destination and amount','error');return;}
  setTxS('walletTx','pending','‚è≥ Signing withdrawal...');
  try{const tx=await signer.sendTransaction({to,value:ethers.utils.parseEther(amt),chainId:AVAX_CHAIN});setTxS('walletTx','pending','üì° Broadcasting...');await tx.wait(1);setTxS('walletTx','success',`‚úÖ ${amt} AVAX withdrawn`);toast(`${amt} AVAX withdrawn`,'success');refreshBal();}
  catch(e){setTxS('walletTx','error',`‚ùå ${(e.message||'Failed').slice(0,80)}`);}
}

// ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
async function submitCrashOut(){
  const text=document.getElementById('crashText').value.trim();
  if(!text||text.length<20){toast('The dungeon demands more words, anon','error');return;}
  const target=document.getElementById('targetHandle').value.trim();
  const mode=document.getElementById('crashMode').value;
  const duelId=document.getElementById('duelTarget').value.trim()||null;
  const burnAmt=selTierData.cost;
  if(parseFloat(curBal)<burnAmt+0.001){toast(`Need at least ${burnAmt+0.001} AVAX to seal`,'error');return;}
  setTxS('writeTx','pending','‚è≥ Preparing the eternal seal...');
  try{
    const tx=await signer.sendTransaction({to:BURN_ADDR,value:ethers.utils.parseEther(burnAmt.toString()),chainId:AVAX_CHAIN});
    setTxS('writeTx','pending','üî• Burning into Avalanche...');
    const rc=await tx.wait(1);
    const row={author_address:wallet.address,chronicle_name:makeName(wallet.address),target_handle:target||null,crash_mode:mode,crash_text:text,tier:selTierData.name,burn_amount:burnAmt,tx_hash:rc.transactionHash,duel_with:duelId,upvotes:0,downvotes:0,heat_score:0,reactions:{seal:0,raven:0,torch:0},is_active:true,is_pinned:selTierData.name==='grand',expires_at:new Date(Date.now()+48*3600*1000).toISOString()};
    const{error}=await db.from('chronicles').insert([row]);
    if(error)throw error;
    setTxS('writeTx','success',`‚úÖ Sealed ¬∑ TX: ${rc.transactionHash.slice(0,20)}...`);
    toast('Thy chronicle burns eternally! üî• Open the tweet modal to share it.','success');
    document.getElementById('crashText').value='';document.getElementById('targetHandle').value='';document.getElementById('duelTarget').value='';updateCC();refreshBal();loadStats();
    // auto-open tweet modal for the new chronicle
    setTimeout(()=>{
      db.from('chronicles').select('*').eq('tx_hash',rc.transactionHash).single().then(({data:nc})=>{
        if(nc){tweetCache.current=nc;buildTweetPreviews(nc);openModal('tweetModal');}
      });
    },1200);
    setTimeout(()=>{sw('feed');loadFeed();},3000);
  }catch(e){setTxS('writeTx','error',`‚ùå ${(e.message||'Failed').slice(0,90)}`);}
}

// ‚îÄ‚îÄ FEED ‚îÄ‚îÄ
let curFilter='hot';
async function loadFeed(){
  document.getElementById('feedContainer').innerHTML='<div class="loading-state">The dungeon scribes are working...</div>';
  let q=db.from('chronicles').select('*').eq('is_active',true);
  if(curFilter==='hot')q=q.order('heat_score',{ascending:false});
  else if(curFilter==='new')q=q.order('created_at',{ascending:false});
  else if(curFilter==='grand')q=q.eq('tier','grand').order('heat_score',{ascending:false});
  else if(curFilter==='duels')q=q.not('duel_with','is',null).order('created_at',{ascending:false});
  else q=q.eq('crash_mode',curFilter).order('created_at',{ascending:false});
  const{data,error}=await q.limit(30);
  if(error){document.getElementById('feedContainer').innerHTML=`<div class="loading-state" style="color:var(--red)">Failed: ${error.message}</div>`;return;}
  const rows=data||[];
  document.getElementById('feedContainer').innerHTML=rows.length?rows.map(c=>mkCard(c)).join(''):'<div class="loading-state">The dungeon is silent. Be the first to crash out, anon.</div>';
}

function mkCard(c,prev=false){
  const heat=Math.max(0,(c.upvotes||0)*2-(c.downvotes||0)+Object.values(c.reactions||{}).reduce((a,b)=>a+(b||0),0));
  const rx=c.reactions||{seal:0,raven:0,torch:0};
  const tl=getTimeLeft(c.expires_at);
  const grand=c.tier==='grand';
  const mi={rage:'‚ö°',betrayal:'üó°',rug:'üíÄ',fud:'üëÅ',alpha:'üîÆ',degen:'üé∞'}[c.crash_mode]||'üìú';
  // encode chronicle id safely for inline onclick
  const safeId = encodeURIComponent(c.id||'');
  return `<div class="ci ${grand?'grand':''}">
    <div class="ci-inn">
      ${grand?'<div class="grand-tag">üî• Grand Chronicle</div>':''}
      <div class="ci-hdr">
        <div><span class="ci-author">${mi} ${esc(c.chronicle_name||'Anonymous')}</span>${c.target_handle?`<span class="ci-target">‚öî ${esc(c.target_handle)}</span>`:''}</div>
        <div class="ci-heat">${mkHeat(heat)}<span>${heat}¬∞ heat</span></div>
      </div>
      <div class="ci-text">${hiMen(esc(c.crash_text))}</div>
      <div class="ci-ftr">
        <div>
          <div class="ci-meta">üî• ${c.burn_amount||0.001} AVAX burned ¬∑ ${relT(c.created_at)}</div>
          ${!prev?`<div class="ci-tl ${tl.urgent?'urg':''}">‚è≥ ${tl.text}</div>`:''}
        </div>
        ${!prev?`<div>
          <div class="rx-a" style="margin-bottom:5px">
            <button class="rxb" onclick="doReact('${c.id}','seal')">üî¥ <span class="rxc">${rx.seal||0}</span></button>
            <button class="rxb" onclick="doReact('${c.id}','raven')">ü¶Ö <span class="rxc">${rx.raven||0}</span></button>
            <button class="rxb" onclick="doReact('${c.id}','torch')">üî• <span class="rxc">${rx.torch||0}</span></button>
          </div>
          <div class="vote-a">
            <button class="vb up" onclick="doVote('${c.id}','up')">‚ñ≤ ${c.upvotes||0}</button>
            <button class="vb dn" onclick="doVote('${c.id}','down')">‚ñº ${c.downvotes||0}</button>
            <button class="ctb" onclick="openTweetModal('${safeId}')">üê¶ POST TO X</button>
          </div>
        </div>`:''}
      </div>
    </div>
  </div>`;
}

function mkHeat(h){const lit=Math.min(5,Math.floor(h/8)),blaze=h>24?Math.min(lit,Math.floor((h-24)/12)):0;const hs=['h1','h2','h3','h4','h5'];return `<div class="hbars">${hs.map((cl,i)=>`<div class="hb ${cl} ${i<lit?(i<blaze?'blaze':'lit'):''}"></div>`).join('')}</div>`;}
function hiMen(t){return t.replace(/(@\S+)/g,'<span class="men">$1</span>');}

async function doVote(id,dir){
  if(parseFloat(curBal)<0.0015){toast('Need 0.001 AVAX to vote','error');return;}
  toast(`Casting ${dir==='up'?'‚ñ≤ upvote':'‚ñº downvote'} ¬∑ 0.001 AVAX burn...`);
  try{
    const tx=await signer.sendTransaction({to:BURN_ADDR,value:ethers.utils.parseEther('0.001'),chainId:AVAX_CHAIN});
    await tx.wait(1);
    const{error}=await db.rpc('increment_vote',{p_chronicle_id:id,p_direction:dir,p_voter_address:wallet.address,p_tx_hash:tx.hash});
    if(error)throw error;
    toast(dir==='up'?'‚ñ≤ Upvote cast!':'‚ñº Downvote cast ‚Äî shame upon them','success');refreshBal();loadFeed();loadStats();
  }catch(e){toast(e.message?.includes('unique')||e.code==='23505'?'Already voted on this chronicle':'Vote failed ‚Äî try again','error');}
}

async function doReact(id,type){
  if(parseFloat(curBal)<0.0015){toast('Need 0.001 AVAX to react','error');return;}
  const em={seal:'üî¥',raven:'ü¶Ö',torch:'üî•'}[type];
  toast(`Sending ${em} reaction ¬∑ 0.001 AVAX...`);
  try{
    const tx=await signer.sendTransaction({to:BURN_ADDR,value:ethers.utils.parseEther('0.001'),chainId:AVAX_CHAIN});
    await tx.wait(1);
    const{error}=await db.rpc('increment_reaction',{p_chronicle_id:id,p_reaction_type:type,p_voter_address:wallet.address,p_tx_hash:tx.hash});
    if(error)throw error;
    toast(`${em} Reaction sealed!`,'success');refreshBal();loadFeed();
  }catch(e){toast(e.message?.includes('unique')||e.code==='23505'?'Already sent this reaction':'Reaction failed','error');}
}

function filterFeed(f,el){curFilter=f;document.querySelectorAll('.fp-btn').forEach(p=>p.classList.remove('active'));el.classList.add('active');loadFeed();}

// ‚îÄ‚îÄ TWEET MODAL ‚îÄ‚îÄ
let tweetCache = {};
function openTweetModal(safeId){
  const id = decodeURIComponent(safeId);
  // find chronicle from current feed data in DOM ‚Äî re-query supabase
  db.from('chronicles').select('*').eq('id',id).single().then(({data:c,error})=>{
    if(error||!c){toast('Could not load chronicle','error');return;}
    tweetCache.current = c;
    buildTweetPreviews(c);
    openModal('tweetModal');
  });
}

function buildTweetPreviews(c){
  const target = c.target_handle || null;
  const name   = c.chronicle_name || 'An Anonymous Degen';
  const modeLabel = {rage:'Great Rage',betrayal:'Betrayal',rug:'Rug Pull',fud:'FUD Dispelled',alpha:'Alpha Drop',degen:'Degen Energy'}[c.crash_mode]||'Chronicle';
  // deep link to the specific chronicle ‚Äî avaxchronicles.xyz/?c=ID
  const deepLink = `avaxchronicles.xyz/?c=${c.id}`;
  // truncate text to fit within 280 after link and handles
  const shortText   = c.crash_text.length > 160 ? c.crash_text.slice(0,157)+'...' : c.crash_text;
  const shortTextXS = c.crash_text.length > 120 ? c.crash_text.slice(0,117)+'...' : c.crash_text;

  // PROJECT account post ‚Äî from @avaxchronicles_, tags the target
  const projectTweet = target
    ? `üî• NEW CHRONICLE SEALED ON-CHAIN\n\n${target} just got called out in a ${modeLabel} Chronicle üëá\n\n"${shortText}"\n\n${(c.burn_amount||0.001)} AVAX burned to the dead address forever üî•\n\nüëâ ${deepLink}\n\n#AVAX #AVAXChronicles #Avalanche`
    : `üî• NEW CHRONICLE SEALED ON-CHAIN\n\n${name} just dropped a ${modeLabel} Chronicle on the dungeon ledger üëá\n\n"${shortText}"\n\n${(c.burn_amount||0.001)} AVAX burned forever üî•\n\nüëâ ${deepLink}\n\n#AVAX #AVAXChronicles #Avalanche`;

  // USER self-post ‚Äî tags @avaxchronicles_ and the target, deep link
  const userTweet = target
    ? `I just crashed out on ${target} and burned it on Avalanche forever üî•\n\n"${shortTextXS}"\n\nSealed on @avaxchronicles_ ‚Äî the eternal dungeon ledger.\n\nRead it: ${deepLink}\n\n#AVAX #CrashOut #Avalanche`
    : `I just sealed a Chronicle on-chain and it burns forever üî•\n\n"${shortTextXS}"\n\nDrop yours on @avaxchronicles_ ‚Äî the eternal dungeon ledger.\n\nüëâ ${deepLink}\n\n#AVAX #CrashOut #Avalanche`;

  document.getElementById('tweetProjectText').textContent = projectTweet;
  document.getElementById('tweetUserText').textContent    = userTweet;

  const pc = projectTweet.length, uc = userTweet.length;
  document.getElementById('tweetProjectCount').textContent = `${pc} chars ${pc>280?'‚ö† OVER 280 ‚Äî shorten the quote':pc>260?'‚ö† close to limit':'‚úì good to post'}`;
  document.getElementById('tweetProjectCount').className = 'tweet-char-count' + (pc>280?' over':'');
  document.getElementById('tweetUserCount').textContent = `${uc} chars ${uc>280?'‚ö† OVER 280 ‚Äî shorten the quote':uc>260?'‚ö† close to limit':'‚úì good to post'}`;
  document.getElementById('tweetUserCount').className = 'tweet-char-count' + (uc>280?' over':'');
}

function copyTweetVariant(which){
  const el = document.getElementById(which==='project'?'tweetProjectText':'tweetUserText');
  navigator.clipboard.writeText(el.textContent).then(()=>{
    toast(which==='project'?'Project tweet copied ‚Äî post it from @AVAXChronicles! üî•':'User tweet copied ‚Äî share thy chronicle! üî•','success');
  });
}

// ‚îÄ‚îÄ PLATFORM STATS ‚îÄ‚îÄ
async function loadStats(){
  try{
    const[burnRes,countRes,voteRes,targetRes]=await Promise.all([
      db.from('chronicles').select('burn_amount'),
      db.from('chronicles').select('id',{count:'exact',head:true}),
      db.from('votes').select('id',{count:'exact',head:true}),
      db.from('chronicles').select('target_handle').not('target_handle','is',null)
    ]);
    // total burned: sum all burn_amount + votes*0.001 + reactions
    const chronicleBurn = (burnRes.data||[]).reduce((s,r)=>s+(parseFloat(r.burn_amount)||0),0);
    const voteBurn      = (voteRes.count||0)*0.001;
    const totalBurn     = chronicleBurn + voteBurn;
    document.getElementById('statTotalBurned').textContent = totalBurn.toFixed(4)+' AVAX';
    document.getElementById('statChronicles').textContent  = countRes.count||0;
    document.getElementById('statVotes').textContent       = voteRes.count||0;
    // unique targets
    const handles = new Set((targetRes.data||[]).map(r=>r.target_handle).filter(Boolean));
    document.getElementById('statTargets').textContent = handles.size;
  }catch(e){}
}

// ‚îÄ‚îÄ WALLS ‚îÄ‚îÄ
async function loadWalls(){
  const[shameR,fameR,wantedR]=await Promise.all([
    db.from('chronicles').select('*').eq('is_active',true).order('downvotes',{ascending:false}).limit(8),
    db.from('chronicles').select('*').eq('is_active',true).order('upvotes',{ascending:false}).limit(8),
    db.from('most_wanted').select('*').limit(15)
  ]);
  const mkLB=(rows,cid)=>{
    if(!rows?.length){document.getElementById(cid).innerHTML='<div class="loading-state">No entries yet</div>';return;}
    const roman=['I','II','III','IV','V','VI','VII','VIII'];
    document.getElementById(cid).innerHTML=rows.map((c,i)=>{
      const rc=i===0?'r1':i===1?'r2':i===2?'r3':'rN';
      const ico={rage:'‚ö°',betrayal:'üó°',rug:'üíÄ',fud:'üëÅ',alpha:'üîÆ',degen:'üé∞'}[c.crash_mode]||'üìú';
      return `<div class="lb-row"><div class="lb-rank ${rc}">${roman[i]||i+1}</div><div class="lb-ico">${ico}</div><div class="lb-info"><div class="lb-name">${esc(c.chronicle_name||'Anonymous')}</div>${c.target_handle?`<div class="lb-target">‚öî ${esc(c.target_handle)}</div>`:''}<div class="lb-excerpt">${esc(c.crash_text.slice(0,70))}...</div></div><div class="lb-stats"><div class="lb-up">‚ñ≤ ${c.upvotes||0}</div><div class="lb-dn">‚ñº ${c.downvotes||0}</div></div></div>`;
    }).join('');
  };
  mkLB(shameR.data,'shameContainer');mkLB(fameR.data,'fameContainer');
  const wd=wantedR.data||[];
  document.getElementById('wantedContainer').innerHTML=wd.length?wd.map((r,i)=>`<div class="wr"><div><div class="w-handle">${esc(r.target_handle)}</div>${i===0?'<div class="w-crown">üëë MOST CHRONICLED</div>':''}</div><div style="text-align:right"><div class="w-count">${r.chronicle_count} chronicle${r.chronicle_count>1?'s':''}</div><div style="font-family:\'Cinzel\',serif;font-size:0.58rem;color:var(--white-ghost)">${parseFloat(r.total_burned||0).toFixed(3)} AVAX burned</div></div></div>`).join(''):'<div class="loading-state">No targets named yet</div>';
}

// ‚îÄ‚îÄ ARCHIVES ‚îÄ‚îÄ
async function loadArch(q=''){
  let query=db.from('chronicles').select('*').order('created_at',{ascending:false}).limit(50);
  if(q)query=query.or(`crash_text.ilike.%${q}%,target_handle.ilike.%${q}%,chronicle_name.ilike.%${q}%`);
  const{data,error}=await query;
  document.getElementById('archivesContainer').innerHTML=(data&&data.length)?data.map(c=>mkCard(c)).join(''):'<div class="loading-state">No chronicles found</div>';
}
function searchArch(){loadArch(document.getElementById('archSearch').value.trim());}

// ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ
function previewCO(){
  const text=document.getElementById('crashText').value.trim();
  if(!text){toast('Nothing to preview','error');return;}
  const mock={id:'prev',chronicle_name:makeName(wallet?.address||'0x000'),target_handle:document.getElementById('targetHandle').value.trim(),crash_mode:document.getElementById('crashMode').value,crash_text:text,tier:selTierData.name,burn_amount:selTierData.cost,upvotes:0,downvotes:0,reactions:{seal:0,raven:0,torch:0},created_at:new Date().toISOString(),expires_at:new Date(Date.now()+48*3600*1000).toISOString()};
  document.getElementById('prevContent').innerHTML=mkCard(mock,true);
  document.getElementById('prevWrap').style.display='block';
  document.getElementById('prevWrap').scrollIntoView({behavior:'smooth'});
}

// ‚îÄ‚îÄ REALTIME ‚îÄ‚îÄ
function subscribeRT(){
  db.channel('chronicles-rt').on('postgres_changes',{event:'INSERT',schema:'public',table:'chronicles'},p=>{
    if(document.getElementById('tab-feed').classList.contains('active')){
      const fc=document.getElementById('feedContainer');
      if(!fc.querySelector('.loading-state'))fc.insertAdjacentHTML('afterbegin',mkCard(p.new));
    }
    toast(`New chronicle sealed ‚Äî ${(p.new.chronicle_name||'Anon').split(' ').slice(0,3).join(' ')}`);
  }).subscribe();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function getTimeLeft(exp){if(!exp)return{text:'Eternal',urgent:false};const d=new Date(exp)-Date.now();if(d<=0)return{text:'In Archives',urgent:false};const h=Math.floor(d/3600000),m=Math.floor((d%3600000)/60000);return{text:h<1?`${m}m left`:`${h}h ${m}m left`,urgent:h<2};}
function relT(iso){if(!iso)return'';const d=Date.now()-new Date(iso);if(d<60000)return'just now';if(d<3600000)return`${Math.floor(d/60000)}m ago`;if(d<86400000)return`${Math.floor(d/3600000)}h ago`;return`${Math.floor(d/86400000)}d ago`;}
function esc(s=''){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function updateCC(){const n=document.getElementById('crashText').value.length;const el=document.getElementById('charCountEl');el.textContent=`${n} / 1000`;el.className='cc'+(n>900?' warn':'');}
function selTier(el,name,cost){document.querySelectorAll('.to').forEach(o=>o.classList.remove('sel'));el.classList.add('sel');selTierData={name,cost};}
function setTxS(id,type,msg){const el=document.getElementById(id);el.className=`txs ${type}`;el.textContent=msg;}
function toast(msg,type=''){const w=document.getElementById('toastWrap');const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;w.appendChild(t);setTimeout(()=>t.remove(),3200);}
function cp(text,msg='Copied!'){navigator.clipboard.writeText(text).then(()=>toast(msg,'success'));}
function copyText(text,msg){navigator.clipboard.writeText(text).then(()=>toast(msg,'success'));}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay'))closeModal(e.target.id);});

const TABS=['write','feed','wall','fame','wanted','archives','howto'];
function sw(name){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',TABS[i]===name));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='feed')loadFeed();
  if(['wall','fame','wanted'].includes(name))loadWalls();
  if(name==='archives')loadArch();
}

// ‚îÄ‚îÄ FIRE PARTICLES ‚îÄ‚îÄ
function spawnFire(){
  const bg=document.getElementById('fireBg');
  const cols=['#ff0000','#ff2200','#ff4400','#ff6600','#ff8800','#ffaa00','#ffcc00'];
  for(let i=0;i<40;i++){
    const p=document.createElement('div');p.className='fp';
    const s=2+Math.random()*7;
    p.style.cssText=`left:${Math.random()*100}vw;bottom:${-15+Math.random()*5}px;width:${s}px;height:${s*1.5}px;background:radial-gradient(circle at 40% 30%,${cols[Math.floor(Math.random()*3)]},${cols[3+Math.floor(Math.random()*3)]});animation-duration:${4+Math.random()*10}s;animation-delay:${Math.random()*10}s;opacity:0;filter:blur(${Math.random()*1.5}px);box-shadow:0 0 ${3+Math.random()*8}px ${cols[Math.floor(Math.random()*cols.length)]};`;
    bg.appendChild(p);
  }
}

// ‚îÄ‚îÄ TARGET HANDLE AUTO-FORMAT ‚îÄ‚îÄ
// Automatically prepends @ so users just type the username
function fmtHandle(el){ let v=el.value.replace(/\s/g,''); if(v&&!v.startsWith('@'))v='@'+v; el.value=v; }

// ‚îÄ‚îÄ DEEP LINK ROUTER ‚îÄ‚îÄ
// Handles avaxchronicles.xyz/?c=CHRONICLE_ID
// Opens the feed tab and scrolls/highlights the specific chronicle
async function handleDeepLink(){
  const params = new URLSearchParams(window.location.search);
  const chronicleId = params.get('c');
  if(!chronicleId) return;

  // Switch to feed
  sw('feed');

  // Load the specific chronicle and jump to it
  try{
    const{data:c, error} = await db.from('chronicles').select('*').eq('id', chronicleId).single();
    if(error || !c){ toast('Chronicle not found in the dungeon','error'); return; }

    // Render it highlighted at the top
    const card = mkCard(c);
    const container = document.getElementById('feedContainer');
    container.innerHTML = `
      <div style="font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:2px;color:var(--white-ghost);text-align:center;margin-bottom:12px;text-transform:uppercase;">
        üìå Direct Chronicle Link
        <button onclick="loadFeed()" style="margin-left:10px;background:none;border:1px solid rgba(255,255,255,0.15);color:var(--white-ghost);font-family:'Cinzel',serif;font-size:0.58rem;letter-spacing:1px;padding:3px 10px;cursor:pointer;text-transform:uppercase;">View Full Feed</button>
      </div>
      ${card}
    `;
    // Highlight the card
    setTimeout(()=>{
      const el = container.querySelector('.ci');
      if(el){ el.classList.add('chronicle-direct'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
    }, 200);

    // Clean URL without reloading
    window.history.replaceState({}, '', window.location.pathname);
  }catch(e){ toast('Failed to load direct chronicle','error'); }
}

spawnFire();
initWallet();
loadStats();
// Run deep link check after wallet loads
setTimeout(handleDeepLink, 800);
</script>
</body>
</html>
