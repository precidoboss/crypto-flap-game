import React, { useState, useEffect, createContext, useContext, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from 'firebase/firestore';
import {
  Home, DollarSign, Package, MessageCircle, BarChart2, ShoppingCart, User, Clock, AlertCircle, TrendingUp, TrendingDown, Truck, CheckCircle, XCircle, ChevronLeft, ChevronRight, Plus, Minus, Edit, Trash2, Tag, Percent, Play, Pause
} from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

// Ensure Tailwind CSS is loaded
// This script tag will be automatically added by the Canvas environment when rendering React code.
// <script src="https://cdn.tailwindcss.com"></script>

// Font: Inter (Google Fonts)
// This link tag will be automatically added by the Canvas environment.
// <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

// --- Global Contexts ---
const AuthContext = createContext(null);
const GameContext = createContext(null);

// --- Utility Functions ---
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(amount);
};

const formatTime = (seconds) => {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
};

const generateRandomId = () => Math.random().toString(36).substring(2, 11);

const getRandomNigerianAddress = () => {
  const streets = ['Obafemi Awolowo Way', 'Ademola Adetokunbo St', 'Ozumba Mbadiwe Ave', 'Herbert Macaulay Way', 'Ahmadu Bello Way', 'Shehu Shagari Way', 'Kingsway Rd', 'Adeola Odeku St', 'Ligali Ayorinde St'];
  const cities = ['Lagos', 'Abuja', 'Port Harcourt', 'Ibadan', 'Kano', 'Enugu', 'Benin City', 'Calabar'];
  const states = ['Lagos', 'FCT', 'Rivers', 'Oyo', 'Kano', 'Enugu', 'Edo', 'Cross River'];
  const postcodes = ['100001', '900001', '500001', '200001', '700001', '400001', '300001', '540001'];
  const houseNumber = Math.floor(Math.random() * 200) + 1;
  const street = streets[Math.floor(Math.random() * streets.length)];
  const city = cities[Math.floor(Math.random() * cities.length)];
  const state = states[Math.floor(Math.random() * states.length)];
  const postcode = postcodes[Math.floor(Math.random() * postcodes.length)];
  const phoneNumber = `0${Math.floor(Math.random() * 9000000000) + 7000000000}`; // Random Nigerian mobile number prefix
  return {
    address: `No. ${houseNumber} ${street}, ${city}, ${state}, ${postcode}`,
    contact: phoneNumber
  };
};

const clothingImages = [
  { url: 'https://i.imgur.com/mVSQLbr.gif', name: 'Crimson Glide Jacket' },
  { url: 'https://i.imgur.com/hUR7VVS.gif', name: 'Azure Dream Dress' },
  { url: 'https://i.imgur.com/yP04Pr3.gif', name: 'Emerald Haze Hoodie' },
  { url: 'https://i.imgur.com/cZSMpws.gif', name: 'Obsidian Shadow Sneakers' },
  { url: 'https://i.imgur.com/UmOtrjY.gif', name: 'Golden Whisper Scarf' },
  { url: 'https://i.imgur.com/HDo8xYo.gif', name: 'Violet Velocity Tracksuit' },
  { url: 'https://i.imgur.com/LzNiPLR.gif', name: 'Silver Stream Jeans' },
];

const genericBlackMarketItems = [
  { name: 'Basic T-Shirt', basePrice: 2500, tags: ['Casual'] },
  { name: 'Denim Jeans', basePrice: 4000, tags: ['Casual'] },
  { name: 'Summer Dress', basePrice: 3500, tags: ['Casual', 'Formal'] },
  { name: 'Winter Coat', basePrice: 7000, tags: ['Outerwear'] },
  { name: 'Generic Sneakers', basePrice: 3000, tags: ['Footwear', 'Sportswear'] },
  { name: 'Formal Shirt', basePrice: 4500, tags: ['Formal'] },
  { name: 'Chinos', basePrice: 3800, tags: ['Casual', 'Formal'] },
  { name: 'Polo Shirt', basePrice: 2800, tags: ['Casual'] },
  { name: 'Sweater', basePrice: 5000, tags: ['Outerwear'] },
  { name: 'High Heels', basePrice: 6000, tags: ['Footwear', 'Formal'] },
];

const botNames = ['AishaBot', 'KunleAI', 'AdaTech', 'TundeTrendz', 'ZainabStyles', 'ChidiChic', 'NgoziVogue', 'ObiOutfit', 'FemiFashion', 'KemiKloset'];

// --- Firebase Initialization and Auth Context Provider ---
const FirebaseProvider = ({ children }) => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const initializeFirebase = async () => {
      try {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        if (!Object.keys(firebaseConfig).length) {
          throw new Error("Firebase config not found. Please ensure __firebase_config is set.");
        }

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const authInstance = getAuth(app);

        setDb(firestore);
        setAuth(authInstance);

        // Sign in with custom token if available, otherwise anonymously
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (initialAuthToken) {
          await signInWithCustomToken(authInstance, initialAuthToken);
        } else {
          await signInAnonymously(authInstance);
        }

        // Listen for auth state changes
        onAuthStateChanged(authInstance, (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            // Handle signed out state if necessary
            setUserId(null);
          }
          setLoading(false);
        });

      } catch (err) {
        console.error("Firebase initialization error:", err);
        setError(err.message);
        setLoading(false);
      }
    };

    initializeFirebase();
  }, []);

  if (loading) {
    return <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 to-indigo-800 text-white text-2xl">Loading Firebase...</div>;
  }

  if (error) {
    return <div className="min-h-screen flex items-center justify-center bg-red-800 text-white text-2xl">Error: {error}</div>;
  }

  return (
    <AuthContext.Provider value={{ db, auth, userId }}>
      {children}
    </AuthContext.Provider>
  );
};

// --- Game Context Provider ---
const GameProvider = ({ children }) => {
  const { db, userId } = useContext(AuthContext);
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  const [bankBalance, setBankBalance] = useState(500000); // NGN 500,000 initial capital
  const [availableCredit, setAvailableCredit] = useState(500000);
  const [inventory, setInventory] = useState([]);
  const [dms, setDMs] = useState([]); // { id, botName, reputation, chatHistory: [{ sender: 'bot'/'user', message: '...' }], status, orderItems: [], deliveryAddress: null, negotiating: false, botProposedPrice: null, lastCounterPrice: null }
  const [deliveries, setDeliveries] = useState([]); // { id, orderId, customerName, items, address, contact, status, eta, startTime, incidents: [] }
  const [reputation, setReputation] = useState(5); // Overall reputation 1-5 stars
  const [gameTime, setGameTime] = useState(0); // Seconds into the game day (0-1800 for 30 mins real time)
  const [activityFeed, setActivityFeed] = useState([]);
  const [dailyDealItem, setDailyDealItem] = useState(null); // { itemId, originalPrice, discountedPrice, endTime }
  const [marketPrices, setMarketPrices] = useState({}); // { itemName: price } for black market
  const [showModal, setShowModal] = useState(false);
  const [modalContent, setModalContent] = useState({ title: '', message: '', onConfirm: null, confirmText: 'OK' });
  const [autoDMEnabled, setAutoDMEnabled] = useState(true); // New state for auto DM control

  const gameLoopIntervalRef = useRef(null);
  const gameSaveIntervalRef = useRef(null);

  // Firestore path for user data
  const getUserDocRef = useCallback(() => {
    if (db && userId) {
      return doc(db, `artifacts/${appId}/users/${userId}/game_state/current`);
    }
    return null;
  }, [db, userId, appId]);

  // Save game state to Firestore
  const saveGameState = useCallback(async () => {
    const docRef = getUserDocRef();
    if (docRef) {
      try {
        await setDoc(docRef, {
          bankBalance,
          availableCredit,
          inventory: JSON.parse(JSON.stringify(inventory)), // Deep copy to avoid Firestore issues with non-plain objects
          dms: JSON.parse(JSON.stringify(dms)),
          deliveries: JSON.parse(JSON.stringify(deliveries)),
          reputation,
          gameTime,
          activityFeed: JSON.parse(JSON.stringify(activityFeed)),
          dailyDealItem: JSON.parse(JSON.stringify(dailyDealItem)),
          marketPrices: JSON.parse(JSON.stringify(marketPrices)),
          autoDMEnabled, // Save auto DM state
          lastSaved: new Date(),
        }, { merge: true });
        console.log("Game state saved successfully.");
      } catch (e) {
        console.error("Error saving game state:", e);
      }
    }
  }, [bankBalance, availableCredit, inventory, dms, deliveries, reputation, gameTime, activityFeed, dailyDealItem, marketPrices, autoDMEnabled, getUserDocRef]);

  // Load game state from Firestore
  useEffect(() => {
    const loadGameState = async () => {
      const docRef = getUserDocRef();
      if (docRef) {
        try {
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            setBankBalance(data.bankBalance || 500000);
            setAvailableCredit(data.availableCredit || 500000);
            setInventory(data.inventory || []);
            setDMs(data.dms || []);
            setDeliveries(data.deliveries || []);
            setReputation(data.reputation || 5);
            setGameTime(data.gameTime || 0);
            setActivityFeed(data.activityFeed || []);
            setDailyDealItem(data.dailyDealItem || null);
            setMarketPrices(data.marketPrices || {});
            setAutoDMEnabled(data.autoDMEnabled !== undefined ? data.autoDMEnabled : true); // Load auto DM state
            console.log("Game state loaded successfully.");
          } else {
            console.log("No existing game state found. Starting new game.");
            // Initialize market prices for a new game
            const initialMarketPrices = {};
            genericBlackMarketItems.forEach(item => {
              initialMarketPrices[item.name] = item.basePrice;
            });
            setMarketPrices(initialMarketPrices);
          }
        } catch (e) {
          console.error("Error loading game state:", e);
        }
      }
    };

    if (db && userId) {
      loadGameState();
      // Set up real-time listener for game state
      const docRef = getUserDocRef();
      if (docRef) {
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            // Only update if the change came from another source or if it's a critical update
            // Avoid infinite loops if `saveGameState` triggers this.
            // For simplicity in this demo, we'll just update all. In a real app, use more granular state management.
            // A more robust solution would involve checking `lastSaved` timestamp or using a dedicated
            // "syncing" mechanism to prevent local changes from being overwritten immediately.
            setBankBalance(data.bankBalance || 500000);
            setAvailableCredit(data.availableCredit || 500000);
            setInventory(data.inventory || []);
            setDMs(data.dms || []);
            setDeliveries(data.deliveries || []);
            setReputation(data.reputation || 5);
            setGameTime(data.gameTime || 0);
            setActivityFeed(data.activityFeed || []);
            setDailyDealItem(data.dailyDealItem || null);
            setMarketPrices(data.marketPrices || {});
            setAutoDMEnabled(data.autoDMEnabled !== undefined ? data.autoDMEnabled : true);
          }
        }, (error) => {
          console.error("Error listening to game state:", error);
        });
        return () => unsubscribe(); // Cleanup listener
      }
    }
  }, [db, userId, getUserDocRef]);

  // Game Loop (Time Progression, Events)
  useEffect(() => {
    if (!db || !userId) return;

    // 30 minutes real-time = 1 game day (1800 seconds real time)
    // 1 game day = 24 game hours
    // So, 1 game hour = 1800 / 24 = 75 real seconds
    // 1 game minute = 75 / 60 = 1.25 real seconds
    const GAME_DAY_LENGTH_REAL_SECONDS = 30 * 60; // 30 minutes
    const GAME_HOUR_REAL_SECONDS = GAME_DAY_LENGTH_REAL_SECONDS / 24; // 75 seconds
    // const GAME_MINUTE_REAL_SECONDS = GAME_HOUR_REAL_SECONDS / 60; // 1.25 seconds

    gameLoopIntervalRef.current = setInterval(() => {
      setGameTime(prevTime => {
        let newTime = prevTime + 1; // Advance 1 real second
        if (newTime >= GAME_DAY_LENGTH_REAL_SECONDS) {
          newTime = 0; // Reset to start of new day
          // Trigger end-of-day events if any
        }

        // Check for daily deal expiration
        if (dailyDealItem && newTime >= dailyDealItem.endTime) {
          setDailyDealItem(null);
          addActivity('Daily Deal Expired', `The daily deal for ${dailyDealItem.name} has ended.`);
        }

        // Update delivery timers
        setDeliveries(prevDeliveries => prevDeliveries.map(delivery => {
          if (delivery.status === 'in-transit') {
            const timeElapsed = newTime - delivery.startTime;
            const remainingTime = delivery.eta - timeElapsed;

            if (remainingTime <= 0) {
              // Delivery completed
              addActivity('Delivery Successful', `Order #${delivery.orderId} for ${delivery.customerName} delivered!`);
              // Trigger positive review (simulated)
              sendBotReview(delivery.customerName, delivery.orderId, 5); // 5-star review
              return { ...delivery, status: 'completed', eta: 0 };
            } else {
              return { ...delivery, eta: remainingTime };
            }
          }
          return delivery;
        }));

        // Randomly trigger new DMs if autoDMEnabled is true (e.g., every 5-10 game hours)
        // Trigger a new DM roughly every 5 game hours (375 real seconds)
        if (autoDMEnabled && newTime > 0 && newTime % 375 === 0 && Math.random() < 0.3) { // 30% chance every 5 game hours
            startNewDM();
        }

        // Fluctuate Black Market prices every 6 game hours (450 real seconds)
        if (newTime > 0 && newTime % 450 === 0) {
            updateBlackMarketPrices();
        }

        return newTime;
      });
    }, 1000); // Every 1 real second

    // Auto-save game state every 30 real seconds
    gameSaveIntervalRef.current = setInterval(saveGameState, 30000);

    return () => {
      clearInterval(gameLoopIntervalRef.current);
      clearInterval(gameSaveIntervalRef.current);
    };
  }, [db, userId, dailyDealItem, deliveries, saveGameState, autoDMEnabled]); // Dependencies for useEffect

  // Add activity to feed
  const addActivity = useCallback((type, message) => {
    setActivityFeed(prev => [{ id: generateRandomId(), type, message, timestamp: new Date() }, ...prev].slice(0, 50)); // Keep last 50 activities
  }, []);

  // Show custom modal
  const showCustomModal = useCallback((title, message, onConfirm = null, confirmText = 'OK') => {
    setModalContent({ title, message, onConfirm, confirmText });
    setShowModal(true);
  }, []);

  // Hide custom modal
  const hideCustomModal = useCallback(() => {
    setShowModal(false);
    setModalContent({ title: '', message: '', onConfirm: null, confirmText: 'OK' });
  }, []);

  // Start a new DM with a random bot
  const startNewDM = useCallback(() => {
    const newBotName = botNames[Math.floor(Math.random() * botNames.length)];
    const newDM = {
      id: generateRandomId(),
      botName: newBotName,
      reputation: 5, // Start with good reputation
      chatHistory: [{ sender: 'bot', message: `Hello! I'm ${newBotName}. I'm looking for some new clothes.` }],
      status: 'open', // 'open', 'negotiating', 'pending_payment', 'awaiting_delivery', 'completed', 'cancelled'
      orderItems: [],
      deliveryAddress: null,
      contactNumber: null,
      negotiating: false,
      botProposedPrice: null,
      lastCounterPrice: null,
      negotiationAttempts: 0, // Track negotiation attempts
      lastMessageTime: Date.now(),
    };
    setDMs(prev => [newDM, ...prev]);
    addActivity('New DM', `${newBotName} wants to chat!`);
  }, [addActivity]);

  // Send bot review (simulated)
  const sendBotReview = useCallback((botName, orderId, stars) => {
    const message = stars === 5 ?
      `The clothes for order #${orderId} arrived perfectly! 5/5 stars, great service!` :
      `Order #${orderId} had some issues. Only ${stars}/5 stars.`;
    setDMs(prevDMs => prevDMs.map(dm =>
      dm.botName === botName && dm.status === 'completed' // Find relevant DM
        ? { ...dm, chatHistory: [...dm.chatHistory, { sender: 'bot', message: message, type: 'review' }] }
        : dm
    ));
    // Adjust overall reputation
    setReputation(prevRep => {
      const newRep = Math.max(1, Math.min(5, prevRep + (stars - 3) * 0.5)); // Adjust by difference from 3 stars
      return Math.round(newRep * 10) / 10; // Round to one decimal place
    });
    addActivity('Customer Review', `${botName} left a ${stars}-star review for Order #${orderId}. Overall reputation: ${Math.round(reputation * 10) / 10}`);
  }, [addActivity, reputation]);

  // Update Black Market prices
  const updateBlackMarketPrices = useCallback(() => {
    setMarketPrices(prevPrices => {
      const newPrices = { ...prevPrices };
      genericBlackMarketItems.forEach(item => {
        const currentPrice = newPrices[item.name];
        const fluctuation = Math.floor(Math.random() * 500) - 250; // Fluctuate by +/- NGN 250
        newPrices[item.name] = Math.max(item.basePrice * 0.8, Math.round((currentPrice + fluctuation) / 100) * 100); // Ensure price doesn't go too low, round to nearest 100
      });
      addActivity('Market Fluctuation', 'Black Market prices have adjusted.');
      return newPrices;
    });
  }, [addActivity]);

  // Initial Black Market price setup on first load
  useEffect(() => {
    if (Object.keys(marketPrices).length === 0) {
      const initialMarketPrices = {};
      genericBlackMarketItems.forEach(item => {
        initialMarketPrices[item.name] = item.basePrice;
      });
      setMarketPrices(initialMarketPrices);
    }
  }, [marketPrices]);

  const value = {
    bankBalance, setBankBalance,
    availableCredit, setAvailableCredit,
    inventory, setInventory,
    dms, setDMs,
    deliveries, setDeliveries,
    reputation, setReputation,
    gameTime, setGameTime,
    activityFeed, addActivity,
    dailyDealItem, setDailyDealItem,
    marketPrices,
    showCustomModal, hideCustomModal,
    showModal, modalContent,
    getUserDocRef, saveGameState, // Expose for direct use if needed
    startNewDM, sendBotReview,
    autoDMEnabled, setAutoDMEnabled // Expose auto DM control
  };

  return (
    <GameContext.Provider value={value}>
      {children}
    </GameContext.Provider>
  );
};

// --- Custom Modal Component ---
const Modal = ({ show, title, message, onConfirm, confirmText, onClose, children }) => {
  if (!show) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-800 rounded-xl shadow-lg shadow-purple-500/50 p-6 w-full max-w-md border border-purple-700 animate-fade-in">
        <h3 className="text-2xl font-bold text-yellow-400 mb-4 border-b border-purple-600 pb-2">{title}</h3>
        {message && <p className="text-gray-200 mb-6 text-lg">{message}</p>}
        {children} /* Render children if provided */
        <div className="flex justify-end space-x-4 mt-6">
          {onConfirm && (
            <button
              onClick={() => { onConfirm(); onClose(); }}
              className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
            >
              {confirmText}
            </button>
          )}
          <button
            onClick={onClose}
            className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};


// --- Navigation Component ---
const Navbar = ({ currentPage, setCurrentPage }) => {
  const navItems = [
    { name: 'Dashboard', icon: Home, page: 'dashboard' },
    { name: 'DMs', icon: MessageCircle, page: 'dms' },
    { name: 'Inventory', icon: Package, page: 'inventory' },
    { name: 'Black Market', icon: ShoppingCart, page: 'blackMarket' },
    { name: 'Deliveries', icon: Truck, page: 'deliveries' },
    { name: 'Analytics', icon: BarChart2, page: 'analytics' },
  ];

  return (
    <nav className="bg-gray-900 bg-opacity-80 backdrop-blur-sm p-4 shadow-xl border-b border-purple-800 fixed bottom-0 left-0 right-0 z-40 md:static md:w-64 md:h-screen md:flex md:flex-col md:rounded-r-xl">
      <div className="hidden md:block text-center mb-8 pt-4">
        <h1 className="text-3xl font-extrabold text-yellow-400 tracking-wider animate-pulse">Precido Sales</h1>
      </div>
      <ul className="flex justify-around md:flex-col md:space-y-4 md:justify-start">
        {navItems.map((item) => (
          <li key={item.name} className="md:w-full">
            <button
              onClick={() => setCurrentPage(item.page)}
              className={`flex flex-col md:flex-row items-center md:items-center md:justify-start p-2 md:p-4 w-full text-sm md:text-lg font-medium rounded-lg transition-all duration-300 transform hover:scale-105 hover:bg-purple-700 ${
                currentPage === item.page ? 'bg-purple-700 text-white shadow-lg shadow-purple-500/30 ring-2 ring-purple-400' : 'text-gray-300 hover:text-white'
              }`}
            >
              <item.icon className="w-6 h-6 mb-1 md:mb-0 md:mr-3" />
              <span className="hidden md:block">{item.name}</span>
            </button>
          </li>
        ))}
      </ul>
    </nav>
  );
};

// --- Dashboard Page ---
const Dashboard = () => {
  const { bankBalance, availableCredit, reputation, gameTime, activityFeed, dailyDealItem, showCustomModal, setBankBalance, setAvailableCredit, addActivity, startNewDM, autoDMEnabled, setAutoDMEnabled } = useContext(GameContext);

  const getGameTimeDisplay = () => {
    const totalMinutes = Math.floor(gameTime / 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 === 0 ? 12 : hours % 12;
    return `${displayHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${ampm} (Day ${Math.floor(gameTime / (30 * 60)) + 1})`;
  };

  const handleTopUpCredit = () => {
    if (availableCredit <= 0) {
      showCustomModal('No Credit Available', 'You have no available credit to top up.');
      return;
    }
    showCustomModal(
      'Top Up Credit',
      `Are you sure you want to top up ${formatCurrency(availableCredit)} from your credit line? A small fee will be applied later.`,
      () => {
        setBankBalance(prev => prev + availableCredit);
        addActivity('Credit Top Up', `${formatCurrency(availableCredit)} added from credit line.`);
        setAvailableCredit(0);
      },
      'Confirm Top Up'
    );
  };

  const handleInitiateDM = () => {
    startNewDM();
    addActivity('Manual DM', 'Manually initiated a new DM conversation.');
  };

  const handleToggleAutoDM = () => {
    setAutoDMEnabled(prev => !prev);
    addActivity('DM Control', `Auto DM initiation ${autoDMEnabled ? 'paused' : 'resumed'}.`);
    showCustomModal('DM Control', `Automatic DM initiation has been ${autoDMEnabled ? 'paused' : 'resumed'}.`);
  };

  return (
    <div className="p-6 md:p-8 bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-gray-100 font-inter rounded-xl shadow-2xl overflow-y-auto pb-24 md:pb-8">
      <h2 className="text-4xl font-extrabold text-yellow-400 mb-8 flex items-center gap-4 animate-fade-in">
        <Home className="w-10 h-10" /> Dashboard
      </h2>

      {/* Game Time & Reputation & DM Control */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 animate-slide-up">
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 flex items-center justify-between">
          <div>
            <p className="text-purple-300 text-sm font-semibold">Game Day Time</p>
            <p className="text-3xl font-bold text-white">{getGameTimeDisplay()}</p>
          </div>
          <Clock className="w-10 h-10 text-purple-400" />
        </div>
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 flex items-center justify-between">
          <div>
            <p className="text-purple-300 text-sm font-semibold">Overall Reputation</p>
            <p className="text-3xl font-bold text-white">{reputation} / 5 Stars</p>
          </div>
          <User className="w-10 h-10 text-yellow-400" />
        </div>
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 flex flex-col justify-center">
          <p className="text-purple-300 text-sm font-semibold mb-2">DM Control</p>
          <div className="flex space-x-2">
            <button
              onClick={handleInitiateDM}
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md flex items-center justify-center"
            >
              <Plus className="w-4 h-4 mr-1" /> New DM
            </button>
            <button
              onClick={handleToggleAutoDM}
              className={`flex-1 px-4 py-2 rounded-lg text-sm transition-all duration-300 transform hover:scale-105 shadow-md flex items-center justify-center ${
                autoDMEnabled ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'
              } text-white`}
            >
              {autoDMEnabled ? <Pause className="w-4 h-4 mr-1" /> : <Play className="w-4 h-4 mr-1" />}
              {autoDMEnabled ? 'Pause Auto DMs' : 'Resume Auto DMs'}
            </button>
          </div>
        </div>
        {dailyDealItem && (
          <div className="bg-gradient-to-r from-yellow-600 to-yellow-800 p-6 rounded-xl shadow-lg border border-yellow-700 flex items-center justify-between col-span-1 md:col-span-2 lg:col-span-1 animate-pulse-light">
            <div>
              <p className="text-white text-sm font-semibold">Daily Deal Active!</p>
              <p className="text-xl font-bold text-white">{dailyDealItem.name}</p>
              <p className="text-white text-lg">
                <span className="line-through opacity-70">{formatCurrency(dailyDealItem.originalPrice)}</span>{' '}
                <span className="font-extrabold">{formatCurrency(dailyDealItem.discountedPrice)}</span>
              </p>
              <p className="text-xs text-yellow-200">Ends in {formatTime(dailyDealItem.endTime - gameTime)}</p>
            </div>
            <Tag className="w-10 h-10 text-white" />
          </div>
        )}
      </div>

      {/* Financial Overview */}
      <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 mb-8 animate-fade-in-delay-1">
        <h3 className="text-2xl font-bold text-purple-300 mb-4 flex items-center gap-2">
          <DollarSign className="w-7 h-7" /> Financial Overview
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
            <p className="text-gray-300 text-sm">Current Precido Balance</p>
            <p className="text-4xl font-extrabold text-green-400 mt-1">{formatCurrency(bankBalance)}</p>
          </div>
          <div className="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
            <p className="text-gray-300 text-sm">Available Credit Line</p>
            <p className="text-4xl font-extrabold text-blue-400 mt-1">{formatCurrency(availableCredit)}</p>
            {availableCredit > 0 && (
              <button
                onClick={handleTopUpCredit}
                className="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md"
              >
                Top Up from Credit
              </button>
            )}
          </div>
        </div>
        <div className="mt-6 bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
          <p className="text-gray-300 text-sm mb-2">Precido Debit Card</p>
          <div className="flex items-center justify-between text-lg">
            <p className="font-mono text-gray-200">**** **** **** 1234</p>
            <p className="text-gray-400">12/26</p>
            <p className="text-gray-400">***</p>
          </div>
        </div>
      </div>

      {/* Recent Activity Feed */}
      <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 animate-fade-in-delay-2">
        <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Recent Activity Feed</h3>
        <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
          {activityFeed.length === 0 ? (
            <p className="text-gray-400 italic">No recent activity. Start selling!</p>
          ) : (
            activityFeed.map((activity) => (
              <div key={activity.id} className="flex items-start bg-gray-700 p-3 rounded-lg shadow-sm border border-gray-600">
                {activity.type === 'Sale Confirmation' && <DollarSign className="w-5 h-5 text-green-400 mr-3 mt-1" />}
                {activity.type === 'Delivery Successful' && <CheckCircle className="w-5 h-5 text-blue-400 mr-3 mt-1" />}
                {activity.type === 'Critical: Delivery Issue!' && <XCircle className="w-5 h-5 text-red-400 mr-3 mt-1 animate-pulse" />}
                {activity.type === 'Delivery Alert' && <AlertCircle className="w-5 h-5 text-yellow-400 mr-3 mt-1" />}
                {activity.type === 'Stock Purchase' && <ShoppingCart className="w-5 h-5 text-purple-400 mr-3 mt-1" />}
                {activity.type === 'New DM' && <MessageCircle className="w-5 h-5 text-cyan-400 mr-3 mt-1" />}
                {activity.type === 'Manual DM' && <MessageCircle className="w-5 h-5 text-blue-400 mr-3 mt-1" />}
                {activity.type === 'DM Control' && <Play className="w-5 h-5 text-orange-400 mr-3 mt-1" />}
                {activity.type === 'Customer Review' && <User className="w-5 h-5 text-yellow-400 mr-3 mt-1" />}
                {activity.type === 'Market Fluctuation' && <TrendingUp className="w-5 h-5 text-orange-400 mr-3 mt-1" />}
                {activity.type === 'Credit Top Up' && <Plus className="w-5 h-5 text-blue-400 mr-3 mt-1" />}
                {activity.type === 'Daily Deal Expired' && <Percent className="w-5 h-5 text-gray-400 mr-3 mt-1" />}
                <p className="text-gray-200 text-sm">
                  <span className="font-semibold text-purple-300">[{new Date(activity.timestamp).toLocaleTimeString()}]</span> {activity.message}
                </p>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

// --- DM Interface Page ---
const DMInterface = () => {
  const { dms, setDMs, inventory, setInventory, setBankBalance, addActivity, showCustomModal, reputation, setReputation, deliveries, setDeliveries, gameTime } = useContext(GameContext);
  const [selectedDMId, setSelectedDMId] = useState(null);
  const chatInputRef = useRef(null);
  const chatWindowRef = useRef(null);
  const [showCounterModal, setShowCounterModal] = useState(false);
  const [counterPrice, setCounterPrice] = useState('');

  const selectedDM = selectedDMId ? dms.find(dm => dm.id === selectedDMId) : null;

  // Scroll to bottom of chat
  useEffect(() => {
    if (chatWindowRef.current) {
      chatWindowRef.current.scrollTop = chatWindowRef.current.scrollHeight;
    }
  }, [selectedDM?.chatHistory]);

  const sendUserMessage = async (message) => {
    if (!selectedDM || !message.trim()) return;

    const userMessage = { sender: 'user', message: message.trim() };
    const updatedDMs = dms.map(dm =>
      dm.id === selectedDMId
        ? { ...dm, chatHistory: [...dm.chatHistory, userMessage], lastMessageTime: Date.now() }
        : dm
    );
    setDMs(updatedDMs);
    chatInputRef.current.value = '';

    // Simulate bot response after a short delay
    setTimeout(() => {
      handleBotResponse(selectedDMId, userMessage.message);
    }, 1000);
  };

  const handleBotResponse = async (dmId, userMessage) => {
    const dmIndex = dms.findIndex(dm => dm.id === dmId);
    if (dmIndex === -1) return;

    const currentDM = dms[dmIndex];
    let botResponseText = '';
    let newStatus = currentDM.status;
    let newOrderItems = [...currentDM.orderItems];
    let newDeliveryAddress = currentDM.deliveryAddress;
    let newContactNumber = currentDM.contactNumber;
    let newNegotiating = currentDM.negotiating;
    let newBotProposedPrice = currentDM.botProposedPrice;
    let newLastCounterPrice = currentDM.lastCounterPrice;
    let newNegotiationAttempts = currentDM.negotiationAttempts;

    // --- LLM Integration: Get natural language response ---
    const chatHistoryForLLM = currentDM.chatHistory.map(msg => ({
      role: msg.sender === 'user' ? 'user' : 'model',
      parts: [{ text: msg.message }]
    }));

    // Add current user message to history for LLM context
    chatHistoryForLLM.push({ role: 'user', parts: [{ text: userMessage }] });

    // Provide inventory context to LLM for recommendations/negotiation
    const inventoryContext = inventory.map(item => ({
        name: item.name,
        sellingPrice: item.sellingPrice,
        purchasePrice: item.purchasePrice,
        quantity: item.quantity,
        tags: item.tags || [],
    }));

    // Simplified and focused system instruction for better reliability
    const systemInstruction = `You are a savvy AI customer from Nigeria, fluent in local slang.
    Your main goal is to buy clothes, and you enjoy negotiating for fair prices.
    You respond naturally and conversationally.
    You understand what items the seller has: ${JSON.stringify(inventoryContext)}.
    Initiate purchases by stating what you want. Negotiate when you feel the price is high.
    If negotiation fails repeatedly (2-3 attempts), you may decide to cancel.
    Once a price is agreed, you'll ask for their Precido tag and then give a delivery address after 'paying'.`;

    const apiKey = "AIzaSyD30_p6cLYmMMDRzrdJ77PCBEDQ1ITefYU"; // User provided API Key

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 20000); // Increased to 20 seconds timeout

    try {
      if (!apiKey || apiKey.length < 20) { // Basic check for a valid-looking key length
          console.warn("Gemini API Key is missing or invalid. Please ensure it's correctly provided.");
          botResponseText = "Apologies, I'm facing an internal authentication issue. My API key seems missing or invalid. Please check your setup.";
          newStatus = 'open';
          clearTimeout(timeoutId);
      } else {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: chatHistoryForLLM }), // Send system instruction as part of contents
            signal: controller.signal // Apply the abort signal
          });

          clearTimeout(timeoutId); // Clear timeout if response received

          if (!response.ok) {
            const errorBody = await response.text();
            console.error(`API Error: ${response.status} - ${response.statusText}`, errorBody);
            if (response.status === 401) {
                botResponseText = "Apologies, I'm experiencing an authentication issue (401 Unauthorized). Please ensure your API key is correct and has access.";
            } else {
                botResponseText = `Apologies, it seems I'm having a network issue (${response.status} - ${response.statusText}). Can we try that again?`;
            }
            newStatus = 'open';
          } else {
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
              botResponseText = result.candidates[0].content.parts[0].text;
              console.log("AI Raw Response:", botResponseText); // Log raw response for debugging

              // --- Client-side Parsing and Logic based on AI's natural language ---

              const lowerCaseResponse = botResponseText.toLowerCase();

              // 1. Bot proposes a price / wants to negotiate
              const priceOfferMatch = lowerCaseResponse.match(/(can you do|my offer is|i can do|how about|what about) (ngn|â‚¦)\s*([\d,\.]+)/);
              if (priceOfferMatch && currentDM.orderItems.length > 0 && !currentDM.negotiating) { // Start negotiation
                  newNegotiating = true;
                  newBotProposedPrice = parseFloat(priceOfferMatch[3].replace(/,/g, ''));
                  newStatus = 'negotiating';
                  newNegotiationAttempts++;
              } else if (priceOfferMatch && currentDM.negotiating) { // Bot re-proposing in ongoing negotiation
                  newBotProposedPrice = parseFloat(priceOfferMatch[3].replace(/,/g, ''));
                  // Status remains negotiating
                  newNegotiationAttempts++;
              }
              // 2. User sends total, bot verifies
              else if (userMessage.toLowerCase().includes('total is') || userMessage.toLowerCase().includes('total price')) {
                  const userProvidedTotal = parseFloat(userMessage.replace(/[^0-9.]/g, ''));
                  // Use botProposedPrice if negotiation is active and accepted, otherwise original selling price
                  const expectedTotal = currentDM.negotiating && currentDM.botProposedPrice
                                       ? currentDM.botProposedPrice
                                       : currentDM.orderItems.reduce((sum, item) => sum + item.sellingPrice, 0);

                  if (userProvidedTotal === expectedTotal && expectedTotal > 0) {
                      botResponseText = `Perfect! That's correct. What's your Precido tag?`;
                      newStatus = 'pending_payment';
                      newNegotiating = false; // End negotiation
                      newBotProposedPrice = null;
                      newLastCounterPrice = null;
                  } else {
                      botResponseText = `Abeg, check your figures well. My calculation is showing ${formatCurrency(expectedTotal)}, not ${formatCurrency(userProvidedTotal)}. Please rectify!`;
                      newStatus = 'open'; // Revert to open for correction
                  }
              }
              // 3. User sends Precido tag, simulate payment
              else if (userMessage.toLowerCase().includes('precido')) {
                  if (currentDM.status === 'pending_payment' && currentDM.orderItems.length > 0) {
                      const totalAmount = currentDM.orderItems.reduce((sum, item) => sum + item.sellingPrice, 0); // Use the final agreed price
                      setBankBalance(prev => prev + totalAmount);
                      addActivity('Sale Confirmation', `${currentDM.botName} bought ${currentDM.orderItems.map(i => i.name).join(', ')} for ${formatCurrency(totalAmount)}. Precido Balance Updated.`);

                      const updatedInventory = [...inventory];
                      currentDM.orderItems.forEach(orderedItem => {
                        const invItemIndex = updatedInventory.findIndex(item => item.id === orderedItem.id);
                        if (invItemIndex !== -1) {
                          updatedInventory[invItemIndex].quantity -= 1;
                          if (updatedInventory[invItemIndex].quantity <= 0) {
                            updatedInventory.splice(invItemIndex, 1);
                          }
                        }
                      });
                      setInventory(updatedInventory);

                      const { address, contact } = getRandomNigerianAddress();
                      newDeliveryAddress = address;
                      newContactNumber = contact;
                      botResponseText = `Payment sent! Transaction ID: PRECIDOX${generateRandomId().toUpperCase()}. Money don enter! Please deliver to: ${address}, Contact: ${contact}.`;
                      newStatus = 'awaiting_delivery';
                      newNegotiating = false;
                      newBotProposedPrice = null;
                  } else {
                      botResponseText = "I'm not sure what you mean by 'Precido' right now. Are you ready to confirm an order?";
                      newStatus = 'open';
                  }
              }
              // 4. User accepts bot's offer (handled by button, but AI might acknowledge)
              else if (userMessage.toLowerCase().includes('accept offer') && currentDM.negotiating) {
                  // The action is already handled by the button, AI just confirms
                  botResponseText = botResponseText || `Fantastic! Glad we could agree. Please confirm the total: ${formatCurrency(currentDM.botProposedPrice)} and send your Precido tag.`;
                  newStatus = 'pending_payment';
                  newNegotiating = false;
                  newBotProposedPrice = null;
                  newLastCounterPrice = null;
                  newNegotiationAttempts = 0;
              }
              // 5. User rejects bot's offer (handled by button, AI might acknowledge)
              else if (userMessage.toLowerCase().includes('reject offer') && currentDM.negotiating) {
                  // The action is already handled by the button, AI just confirms or re-negotiates
                  // For simplicity, we just keep the status as negotiating, expecting a new AI offer or cancellation
                  botResponseText = botResponseText || `Ah, okay. That's a shame. What's your final word then?`;
                  // Status remains negotiating if AI wants to continue, or changes to open if it implicitly gives up
                  if (lowerCaseResponse.includes('cancel') || lowerCaseResponse.includes('not proceed') || lowerCaseResponse.includes('no longer interested')) {
                       newStatus = 'cancelled';
                       newNegotiating = false;
                       addActivity('Order Cancelled', `Order with ${currentDM.botName} cancelled by bot.`);
                  } else {
                       newStatus = 'negotiating'; // Still negotiating
                  }
                  newBotProposedPrice = null; // Clear old proposed price, expecting new
                  newLastCounterPrice = null;
                  newNegotiationAttempts++;
              }
              // 6. User sends counter offer (handled by button, AI responds)
              else if (userMessage.toLowerCase().includes('counter offer')) {
                  // Logic for bot's response to counter is already in handleBotResponse (priceOfferMatch)
                  // The AI's response after parsing will dictate the next status
              }
              // 7. Bot cancels order (explicitly via LLM response)
              else if (lowerCaseResponse.includes('cancel') || lowerCaseResponse.includes('no longer interested') || lowerCaseResponse.includes('cannot proceed with this order')) {
                  botResponseText = botResponseText; // Use AI's full cancellation message
                  newStatus = 'cancelled';
                  newNegotiating = false;
                  newBotProposedPrice = null;
                  newLastCounterPrice = null;
                  addActivity('Order Cancelled', `Order with ${currentDM.botName} cancelled.`);
              }
              // 8. Bot states items it wants (initial order confirmation)
              else if (currentDM.orderItems.length === 0 && (lowerCaseResponse.includes('i will take') || lowerCaseResponse.includes('i\'ll take') || lowerCaseResponse.includes('i want to buy') || lowerCaseResponse.includes('i want'))) {
                  const itemNamesInResponse = inventory.filter(item => lowerCaseResponse.includes(item.name.toLowerCase()));
                  
                  if (itemNamesInResponse.length > 0) {
                      newOrderItems = itemNamesInResponse.map(item => ({ id: item.id, name: item.name, sellingPrice: item.sellingPrice, purchasePrice: item.purchasePrice }));
                      const totalSellingPrice = newOrderItems.reduce((sum, item) => sum + item.sellingPrice, 0);
                      const averageMarkup = newOrderItems.reduce((sum, item) => sum + (item.sellingPrice - item.purchasePrice) / item.purchasePrice, 0) / itemNamesInResponse.length;

                      // Decision to negotiate or accept based on markup and randomness
                      if (averageMarkup > 0.65 && Math.random() < 0.6) { // High markup and 60% chance to negotiate
                          newNegotiating = true;
                          const negotiationFactor = Math.random() * (0.18 - 0.08) + 0.08; // Offer 8-18% less
                          newBotProposedPrice = Math.round((totalSellingPrice * (1 - negotiationFactor)) / 100) * 100;
                          // Ensure bot's offer is not below seller's 10% profit margin
                          newBotProposedPrice = Math.max(newBotProposedPrice, newOrderItems.reduce((sum, item) => sum + item.purchasePrice * 1.1, 0));
                          botResponseText = `I'm interested in the ${newOrderItems.map(item => item.name).join(' and ')}. Your price is ${formatCurrency(totalSellingPrice)}. Can you do ${formatCurrency(newBotProposedPrice)}?`;
                          newStatus = 'negotiating';
                      } else {
                          botResponseText = `Okay, I'll take the ${newOrderItems.map(item => item.name).join(' and ')}. The total should be ${formatCurrency(totalSellingPrice)}. Please confirm the total and send your Precido tag.`;
                          newStatus = 'pending_payment';
                      }
                  } else {
                      botResponseText = "I'm not sure which items you're referring to. Can you be more specific? Or tell me what you have.";
                      newStatus = 'open';
                  }
              }
              // 9. General chat / Recommendation requests
              else {
                  // Use the AI's generated response directly, status remains unchanged unless explicitly changed above
                  // If bot previously proposed price but user didn't respond with negotiation action
                  if(currentDM.negotiating && currentDM.botProposedPrice && !priceOfferMatch){
                      botResponseText = botResponseText || `So, about my offer of ${formatCurrency(currentDM.botProposedPrice)}? What do you say?`;
                  }
                  newStatus = currentDM.status;
              }

            } else {
              console.error("LLM response structure unexpected or empty candidates:", result);
              botResponseText = "Apologies, it seems I'm having a slight internal processing issue right now. Can we try that again?";
              newStatus = 'open';
            }
          }
      }
    } catch (llmError) {
      clearTimeout(timeoutId); // Ensure timeout is cleared even if another error occurs
      if (llmError.name === 'AbortError') {
        console.error("Gemini API request timed out:", llmError);
        botResponseText = "Apologies, my connection timed out. Can you try again?";
      } else if (llmError.name === 'TypeError' && llmError.message.includes('Failed to fetch')) {
        console.error("Network error during Gemini API request:", llmError);
        botResponseText = "Apologies, I'm experiencing a network connection issue. Can you try again?";
      } else {
        console.error("An unexpected error occurred with Gemini API:", llmError);
        botResponseText = "Apologies, it seems I'm having a slight internal processing issue right now. Can we try that again?";
      }
      newStatus = 'open';
    }

    setDMs(prevDMs => prevDMs.map(dm =>
      dm.id === dmId
        ? {
            ...dm,
            chatHistory: [...dm.chatHistory, { sender: 'bot', message: botResponseText }],
            status: newStatus,
            orderItems: newOrderItems,
            deliveryAddress: newDeliveryAddress,
            contactNumber: newContactNumber,
            negotiating: newNegotiating,
            botProposedPrice: newBotProposedPrice,
            lastCounterPrice: newLastCounterPrice,
            negotiationAttempts: newNegotiationAttempts,
            lastMessageTime: Date.now(),
          }
        : dm
    ));
  };


  const handleOrderCompletion = (dmId) => {
    const dm = dms.find(d => d.id === dmId);
    if (!dm || dm.status !== 'awaiting_delivery' || !dm.deliveryAddress) {
      showCustomModal('Error', 'This DM is not ready for delivery setup.');
      return;
    }

    const newDelivery = {
      id: generateRandomId(),
      orderId: `ORD-${generateRandomId().toUpperCase()}`,
      customerName: dm.botName,
      items: dm.orderItems,
      address: dm.deliveryAddress,
      contact: dm.contactNumber,
      status: 'pending', // 'pending', 'in-transit', 'completed', 'stolen'
      eta: 5 * 60, // 5 minutes game time (300 seconds)
      startTime: gameTime, // Record game time when rider is hired
      incidents: [], // 'traffic_jam', 'theft'
    };

    setDeliveries(prev => [...prev, newDelivery]);
    setDMs(prevDMs => prevDMs.map(d =>
      d.id === dmId ? { ...d, status: 'completed' } : d // Mark DM as completed/closed
    ));
    addActivity('Delivery Initiated', `Order #${newDelivery.orderId} for ${dm.botName} is ready for dispatch.`);
    showCustomModal('Delivery Initiated', `Order #${newDelivery.orderId} for ${dm.botName} added to deliveries. Hire a rider from the Deliveries page!`);
  };

  const handleNegotiationAction = (actionType, price = null) => {
    if (!selectedDM) return;

    let userResponse = '';
    if (actionType === 'accept') {
      userResponse = `I accept your offer of ${formatCurrency(selectedDM.botProposedPrice)}.`;
      // Update orderItems with the negotiated price for payment stage
      const updatedOrderItems = selectedDM.orderItems.map(item => ({
          ...item,
          sellingPrice: selectedDM.botProposedPrice / selectedDM.orderItems.length // Distribute total negotiated price
      }));
      setDMs(prevDMs => prevDMs.map(dm =>
          dm.id === selectedDMId ? { ...dm, orderItems: updatedOrderItems } : dm
      ));
    } else if (actionType === 'counter') {
      userResponse = `My counter offer is ${formatCurrency(price)}.`;
    } else if (actionType === 'reject') {
      userResponse = `I cannot accept that offer. I'm sticking to my original price.`;
    }

    sendUserMessage(userResponse);
    setShowCounterModal(false);
    setCounterPrice('');
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'open': return 'text-green-400';
      case 'negotiating': return 'text-orange-400';
      case 'pending_payment': return 'text-yellow-400';
      case 'awaiting_delivery': return 'text-blue-400';
      case 'completed': return 'text-gray-400';
      case 'cancelled': return 'text-red-400';
      default: return 'text-gray-300';
    }
  };

  return (
    <div className="p-6 md:p-8 bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-gray-100 font-inter rounded-xl shadow-2xl overflow-y-auto pb-24 md:pb-8">
      <h2 className="text-4xl font-extrabold text-yellow-400 mb-8 flex items-center gap-4 animate-fade-in">
        <MessageCircle className="w-10 h-10" /> Direct Messages
      </h2>

      <div className="flex flex-col md:flex-row gap-6 h-[calc(100vh-200px)] md:h-[calc(100vh-150px)]">
        {/* DM List */}
        <div className="w-full md:w-1/3 bg-gray-800 bg-opacity-70 rounded-xl shadow-lg border border-purple-700 p-4 overflow-y-auto custom-scrollbar flex-shrink-0 animate-slide-left">
          <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Conversations</h3>
          {dms.length === 0 ? (
            <p className="text-gray-400 italic">No active DMs. New DMs will appear automatically or you can initiate one from the Dashboard.</p>
          ) : (
            dms.map(dm => (
              <button
                key={dm.id}
                onClick={() => setSelectedDMId(dm.id)}
                className={`flex items-center w-full p-3 mb-2 rounded-lg transition-all duration-300 transform hover:scale-[1.02] ${
                  selectedDMId === dm.id ? 'bg-purple-700 shadow-md ring-2 ring-purple-400' : 'bg-gray-700 hover:bg-gray-600'
                }`}
              >
                <User className="w-8 h-8 text-cyan-400 mr-3" />
                <div className="flex-1 text-left">
                  <p className="font-semibold text-lg text-white">{dm.botName}</p>
                  <p className={`text-sm ${getStatusColor(dm.status)} capitalize`}>{dm.status.replace('_', ' ')}</p>
                </div>
                {dm.chatHistory.length > 0 && (
                  <p className="text-xs text-gray-400">
                    {new Date(dm.lastMessageTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </p>
                )}
              </button>
            ))
          )}
        </div>

        {/* Chat Window */}
        <div className="w-full md:w-2/3 bg-gray-800 bg-opacity-70 rounded-xl shadow-lg border border-purple-700 flex flex-col animate-slide-right">
          {selectedDM ? (
            <>
              <div className="p-4 border-b border-purple-600 flex items-center">
                <User className="w-10 h-10 text-yellow-400 mr-3" />
                <h3 className="text-2xl font-bold text-white flex-1">{selectedDM.botName}</h3>
                <span className={`text-lg font-semibold ${getStatusColor(selectedDM.status)} capitalize`}>
                  {selectedDM.status.replace('_', ' ')}
                </span>
              </div>
              <div ref={chatWindowRef} className="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-4">
                {selectedDM.chatHistory.map((msg, index) => (
                  <div
                    key={index}
                    className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-[70%] p-3 rounded-lg shadow-md ${
                        msg.sender === 'user'
                          ? 'bg-blue-600 text-white rounded-br-none'
                          : 'bg-gray-700 text-gray-100 rounded-bl-none'
                      }`}
                    >
                      <p className="text-sm">{msg.message}</p>
                    </div>
                  </div>
                ))}
              </div>
              <div className="p-4 border-t border-purple-600 flex flex-col space-y-3">
                {selectedDM.negotiating && selectedDM.botProposedPrice && (
                    <div className="flex justify-center space-x-2 mb-3">
                        <button
                            onClick={() => handleNegotiationAction('accept')}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                        >
                            Accept {formatCurrency(selectedDM.botProposedPrice)}
                        </button>
                        <button
                            onClick={() => setShowCounterModal(true)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                        >
                            Counter Offer
                        </button>
                        <button
                            onClick={() => handleNegotiationAction('reject')}
                            className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                        >
                            Reject Offer
                        </button>
                    </div>
                )}
                <div className="flex items-center space-x-3">
                    <input
                        type="text"
                        ref={chatInputRef}
                        placeholder="Type your message..."
                        className="flex-1 p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-200"
                        onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                                sendUserMessage(e.target.value);
                            }
                        }}
                        disabled={selectedDM.status === 'completed' || selectedDM.status === 'cancelled' || (selectedDM.negotiating && !selectedDM.botProposedPrice)}
                    />
                    <button
                        onClick={() => sendUserMessage(chatInputRef.current.value)}
                        className="px-5 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                        disabled={selectedDM.status === 'completed' || selectedDM.status === 'cancelled' || (selectedDM.negotiating && !selectedDM.botProposedPrice)}
                    >
                        Send
                    </button>
                    {selectedDM.status === 'awaiting_delivery' && selectedDM.deliveryAddress && (
                    <button
                        onClick={() => handleOrderCompletion(selectedDM.id)}
                        className="px-5 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                    >
                        Confirm Delivery
                    </button>
                    )}
                </div>
              </div>
            </>
          ) : (
            <div className="flex-1 flex items-center justify-center text-gray-400 text-xl italic">
              Select a DM to start chatting.
            </div>
          )}
        </div>
      </div>

      {/* Counter Offer Modal */}
      <Modal
        show={showCounterModal}
        title="Make a Counter Offer"
        onClose={() => setShowCounterModal(false)}
        onConfirm={() => handleNegotiationAction('counter', parseFloat(counterPrice))}
        confirmText="Send Counter"
      >
        <div className="flex flex-col space-y-4">
            <p className="text-gray-200">Bot's last offer: <span className="font-bold text-yellow-400">{formatCurrency(selectedDM?.botProposedPrice || 0)}</span></p>
            <label className="text-gray-200 text-left">Your Counter Price:</label>
            <input
                type="number"
                value={counterPrice}
                onChange={(e) => setCounterPrice(e.target.value)}
                className="p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"
                placeholder="Enter your counter price"
            />
            <p className="text-xs text-gray-400">
                Be strategic! Too high and the bot might cancel.
            </p>
        </div>
      </Modal>
    </div>
  );
};

// --- Inventory Page ---
const InventoryPage = () => {
  const { inventory, setInventory, dailyDealItem, setDailyDealItem, gameTime, addActivity, showCustomModal } = useContext(GameContext);
  const [editingItem, setEditingItem] = useState(null);
  const [newPrice, setNewPrice] = useState('');
  const [newImageUrl, setNewImageUrl] = useState('');

  const handleAdjustPrice = (item) => {
    setEditingItem(item);
    setNewPrice(item.sellingPrice);
    setNewImageUrl(item.imageUrl || '');
  };

  const saveItemDetails = () => {
    if (!editingItem || isNaN(newPrice) || newPrice <= 0) {
      showCustomModal('Invalid Price', 'Please enter a valid positive number for the price.');
      return;
    }
    const updatedPrice = parseFloat(newPrice);
    const updatedInventory = inventory.map(item =>
      item.id === editingItem.id ? { ...item, sellingPrice: updatedPrice, imageUrl: newImageUrl.trim() || null } : item
    );
    setInventory(updatedInventory);
    addActivity('Item Update', `Details for ${editingItem.name} updated (Price: ${formatCurrency(updatedPrice)}, Image: ${newImageUrl ? 'Set' : 'Removed'}).`);
    setEditingItem(null);
    setNewPrice('');
    setNewImageUrl('');
  };

  const handleSetDailyDeal = (item) => {
    if (dailyDealItem && dailyDealItem.itemId === item.id) {
      showCustomModal('Daily Deal Active', `${item.name} is already the daily deal.`);
      return;
    }
    showCustomModal(
      'Set Daily Deal',
      `Set ${item.name} as the daily deal? It will be discounted by 15-20% for 1 game hour.`,
      () => {
        const discountFactor = Math.random() * (0.20 - 0.15) + 0.15; // 15-20% discount
        const discountedPrice = Math.round((item.sellingPrice * (1 - discountFactor)) / 100) * 100; // Round to nearest 100
        const endTime = gameTime + (75 * 60); // 1 game hour = 75 real seconds * 60 minutes = 4500 real seconds
        setDailyDealItem({
          itemId: item.id,
          name: item.name,
          originalPrice: item.sellingPrice,
          discountedPrice: discountedPrice,
          endTime: endTime
        });
        addActivity('Daily Deal Set', `${item.name} is now the daily deal at ${formatCurrency(discountedPrice)}.`);
      },
      'Confirm'
    );
  };

  const handleRemoveItem = (item) => {
    showCustomModal(
      'Remove Item',
      `Are you sure you want to remove ${item.name} (Quantity: ${item.quantity}) from your inventory? This cannot be undone.`,
      () => {
        const updatedInventory = inventory.filter(invItem => invItem.id !== item.id);
        setInventory(updatedInventory);
        addActivity('Inventory Update', `Removed ${item.name} from inventory.`);
      },
      'Confirm Remove'
    );
  };

  return (
    <div className="p-6 md:p-8 bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-gray-100 font-inter rounded-xl shadow-2xl overflow-y-auto pb-24 md:pb-8">
      <h2 className="text-4xl font-extrabold text-yellow-400 mb-8 flex items-center gap-4 animate-fade-in">
        <Package className="w-10 h-10" /> Inventory
      </h2>

      {inventory.length === 0 ? (
        <div className="text-center text-gray-400 text-xl italic mt-16 animate-fade-in-delay-1">
          <p>Your inventory is empty! Head to the Black Market to stock up.</p>
          <ShoppingCart className="w-24 h-24 mx-auto mt-8 text-purple-600 opacity-50" />
        </div>
      ) : (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-slide-up">
          {inventory.map(item => (
            <div key={item.id} className="bg-gray-800 bg-opacity-70 rounded-xl shadow-lg border border-purple-700 p-5 flex flex-col items-center text-center relative">
              {dailyDealItem && dailyDealItem.itemId === item.id && (
                <div className="absolute top-0 right-0 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-bl-lg rounded-tr-xl animate-pulse">
                  DAILY DEAL!
                </div>
              )}
              <img
                src={item.imageUrl || `https://placehold.co/150x150/8a2be2/ffffff?text=${item.name.split(' ').map(n => n[0]).join('')}`}
                alt={item.name}
                className="w-32 h-32 object-cover rounded-lg mb-4 border-2 border-purple-500 shadow-md"
                onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/150x150/8a2be2/ffffff?text=Image+Error`; }}
              />
              <h3 className="text-xl font-bold text-white mb-2">{item.name}</h3>
              <p className="text-purple-300 text-sm mb-1">Quantity: <span className="font-semibold">{item.quantity}</span></p>
              <p className="text-purple-300 text-sm mb-1">Purchase Price: <span className="font-semibold">{formatCurrency(item.purchasePrice)}</span></p>
              <p className="text-green-400 text-lg font-bold mb-4">Selling Price: {formatCurrency(item.sellingPrice)}</p>

              <div className="flex flex-wrap justify-center gap-2 mt-auto w-full">
                <button
                  onClick={() => handleAdjustPrice(item)}
                  className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                >
                  <Edit className="w-4 h-4 mr-2" /> Adjust Price
                </button>
                <button
                  onClick={() => handleSetDailyDeal(item)}
                  className="flex items-center px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm hover:bg-yellow-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                >
                  <Tag className="w-4 h-4 mr-2" /> Set Daily Deal
                </button>
                <button
                  onClick={() => handleRemoveItem(item)}
                  className="flex items-center px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                >
                  <Trash2 className="w-4 h-4 mr-2" /> Remove
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      {editingItem && (
        <Modal
          show={true}
          title={`Edit Item: ${editingItem.name}`}
          onClose={() => setEditingItem(null)}
          onConfirm={saveItemDetails}
          confirmText="Save Changes"
        >
          <div className="flex flex-col space-y-4">
            <p className="text-gray-200">Purchase Price: <span className="font-bold">{formatCurrency(editingItem.purchasePrice)}</span></p>

            <div>
              <label htmlFor="priceSlider" className="text-gray-200 text-left block mb-2">
                Selling Price: <span className="font-bold text-green-400">{formatCurrency(newPrice)}</span>
              </label>
              <input
                id="priceSlider"
                type="range"
                min={editingItem.purchasePrice}
                max={editingItem.purchasePrice * 1.5} // 50% markup limit
                step={100} // Adjust step for smoother sliding
                value={newPrice}
                onChange={(e) => setNewPrice(parseFloat(e.target.value))}
                className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-purple-500"
              />
              <p className="text-xs text-gray-400 mt-1">
                Slider range: {formatCurrency(editingItem.purchasePrice)} to {formatCurrency(editingItem.purchasePrice * 1.5)}.
                Bots are sensitive to high markups.
              </p>
            </div>

            <div>
              <label htmlFor="imageUrlInput" className="text-gray-200 text-left block mb-2">Image URL (Imgur link or direct URL):</label>
              <input
                id="imageUrlInput"
                type="text"
                value={newImageUrl}
                onChange={(e) => setNewImageUrl(e.target.value)}
                className="p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 w-full focus:outline-none focus:ring-2 focus:ring-purple-500"
                placeholder="e.g., https://i.imgur.com/yourimage.gif"
              />
              {newImageUrl && (
                <img
                  src={newImageUrl}
                  alt="Preview"
                  className="w-24 h-24 object-cover rounded-lg mt-3 border border-gray-500 mx-auto"
                  onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/150x150/8a2be2/ffffff?text=Invalid+URL`; }}
                />
              )}
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};

// --- Black Market Page ---
const BlackMarket = () => {
  const { bankBalance, setBankBalance, inventory, setInventory, marketPrices, addActivity, showCustomModal } = useContext(GameContext);
  const [quantities, setQuantities] = useState({});
  const [totalCost, setTotalCost] = useState(0);

  useEffect(() => {
    const newTotalCost = Object.entries(quantities).reduce((sum, [itemName, qty]) => {
      return sum + (marketPrices[itemName] || 0) * qty;
    }, 0);
    setTotalCost(newTotalCost);
  }, [quantities, marketPrices]);

  const handleQuantityChange = (itemName, change) => {
    setQuantities(prev => {
      const currentQty = prev[itemName] || 0;
      const newQty = Math.max(0, currentQty + change);
      return { ...prev, [itemName]: newQty };
    });
  };

  const handlePurchaseStock = () => {
    if (totalCost === 0) {
      showCustomModal('No Items Selected', 'Please select items to purchase.');
      return;
    }
    if (bankBalance < totalCost) {
      showCustomModal('Insufficient Funds', 'You do not have enough money to make this purchase.');
      return;
    }

    showCustomModal(
      'Confirm Purchase',
      `Are you sure you want to purchase these items for a total of ${formatCurrency(totalCost)}?`,
      () => {
        setBankBalance(prev => prev - totalCost);
        const updatedInventory = [...inventory];
        Object.entries(quantities).forEach(([itemName, qty]) => {
          if (qty > 0) {
            const existingItemIndex = updatedInventory.findIndex(item => item.name === itemName);
            const purchasePrice = marketPrices[itemName];
            const isGeneric = genericBlackMarketItems.some(gbi => gbi.name === itemName);

            if (existingItemIndex !== -1) {
              updatedInventory[existingItemIndex].quantity += qty;
              // For simplicity, we average the purchase price if adding to existing stock
              updatedInventory[existingItemIndex].purchasePrice =
                (updatedInventory[existingItemIndex].purchasePrice * (updatedInventory[existingItemIndex].quantity - qty) + purchasePrice * qty) / updatedInventory[existingItemIndex].quantity;
            } else {
              const itemImage = isGeneric ? null : clothingImages.find(img => img.name === itemName)?.url;
              const tags = genericBlackMarketItems.find(gbi => gbi.name === itemName)?.tags || [];
              updatedInventory.push({
                id: generateRandomId(),
                name: itemName,
                imageUrl: itemImage,
                purchasePrice: purchasePrice,
                sellingPrice: Math.round(purchasePrice * 1.5 / 100) * 100, // Default 50% markup, rounded
                quantity: qty,
                isDailyDeal: false,
                tags: tags,
              });
            }
            addActivity('Stock Purchase', `Purchased ${qty} x ${itemName} for ${formatCurrency(purchasePrice * qty)}.`);
          }
        });
        setInventory(updatedInventory);
        setQuantities({}); // Reset quantities after purchase
        showCustomModal('Purchase Successful', `${formatCurrency(totalCost)} deducted. Inventory updated!`);
      },
      'Confirm Purchase'
    );
  };

  return (
    <div className="p-6 md:p-8 bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-gray-100 font-inter rounded-xl shadow-2xl overflow-y-auto pb-24 md:pb-8">
      <h2 className="text-4xl font-extrabold text-yellow-400 mb-8 flex items-center gap-4 animate-fade-in">
        <ShoppingCart className="w-10 h-10" /> Black Market
      </h2>

      <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 mb-8 animate-slide-up">
        <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Available Stock</h3>
        <p className="text-gray-400 text-sm mb-4">Prices fluctuate daily. Stock up wisely!</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {genericBlackMarketItems.map(item => (
            <div key={item.name} className="flex items-center justify-between bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
              <div>
                <p className="text-lg font-semibold text-white">{item.name}</p>
                <p className="text-green-400 text-xl font-bold">{formatCurrency(marketPrices[item.name] || item.basePrice)}</p>
              </div>
              <div className="flex items-center space-x-2">
                <button
                  onClick={() => handleQuantityChange(item.name, -1)}
                  className="p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition-all duration-300 transform hover:scale-110 shadow-md"
                >
                  <Minus className="w-5 h-5" />
                </button>
                <span className="text-xl font-bold text-white w-8 text-center">{quantities[item.name] || 0}</span>
                <button
                  onClick={() => handleQuantityChange(item.name, 1)}
                  className="p-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition-all duration-300 transform hover:scale-110 shadow-md"
                >
                  <Plus className="w-5 h-5" />
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 animate-slide-up-delay-1">
        <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Order Summary</h3>
        <div className="space-y-2 mb-4">
          {Object.entries(quantities).map(([itemName, qty]) => qty > 0 && (
            <p key={itemName} className="text-gray-200 flex justify-between">
              <span>{qty} x {itemName}</span>
              <span>{formatCurrency((marketPrices[itemName] || 0) * qty)}</span>
            </p>
          ))}
          {totalCost === 0 && <p className="text-gray-400 italic">No items selected.</p>}
        </div>
        <div className="flex justify-between items-center border-t border-purple-600 pt-4 mt-4">
          <p className="text-xl font-bold text-white">Total Cost:</p>
          <p className="text-3xl font-extrabold text-green-400">{formatCurrency(totalCost)}</p>
        </div>
        <button
          onClick={handlePurchaseStock}
          className="mt-6 w-full px-6 py-3 bg-purple-600 text-white rounded-lg text-lg font-semibold hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
        >
          Purchase Stock
        </button>
        <p className="text-xs text-gray-400 mt-4 text-center">
          **AI bots are price-sensitive!** Your selling price should ideally be no more than **50-75% above** the Black Market cost for common items.
        </p>
      </div>
    </div>
  );
};

// --- Deliveries Page ---
const DeliveryPage = () => {
  const { deliveries, setDeliveries, gameTime, addActivity, showCustomModal, setReputation, dms, setDMs } = useContext(GameContext);

  const hireRider = (deliveryId) => {
    const deliveryIndex = deliveries.findIndex(d => d.id === deliveryId);
    if (deliveryIndex === -1) return;

    const delivery = deliveries[deliveryIndex];
    if (delivery.status !== 'pending') {
      showCustomModal('Error', 'This delivery is not pending dispatch.');
      return;
    }

    showCustomModal(
      'Confirm Rider Hire',
      `Hire a rider for Order #${delivery.orderId}? The bot will pay the rider fee.`,
      () => {
        let newETA = delivery.eta;
        let incidents = [];

        // Random Traffic Jam (5-10% chance)
        if (Math.random() < 0.1) {
          const delay = Math.floor(Math.random() * 3 * 60) + 1 * 60; // 1 to 3 game minutes delay (60-180 real seconds)
          newETA += delay;
          incidents.push('traffic_jam');
          addActivity('Delivery Alert', `Order #${delivery.orderId} for ${delivery.customerName} delayed by traffic!`);
          showCustomModal('Traffic Jam!', `Order #${delivery.orderId} for ${delivery.customerName} is delayed due to traffic. ETA extended.`);
        }

        // Random Theft (1-2% chance)
        if (Math.random() < 0.02) {
          incidents.push('theft');
          addActivity('Critical: Delivery Issue!', `Order #${delivery.orderId} for ${delivery.customerName} - PRODUCT STOLEN!`);
          showCustomModal('Product Stolen!', `Oh no! The package for Order #${delivery.orderId} was stolen. The customer will be furious!`);

          // Trigger abusive DM
          setDMs(prevDMs => prevDMs.map(dm =>
            dm.botName === delivery.customerName
              ? { ...dm, chatHistory: [...dm.chatHistory, { sender: 'bot', message: `Wetin dey occur? My clothes no show! Na so una dey do business? This is unacceptable! I need my money back or my clothes ASAP! My reputation score for you don zero!`, type: 'abuse' }], status: 'cancelled' }
              : dm
          ));
          // Significant reputation hit
          setReputation(prevRep => Math.max(1, prevRep - 1)); // -1 star
          setDeliveries(prev => prev.map(d => d.id === deliveryId ? { ...d, status: 'stolen', incidents: incidents } : d));
          return; // Stop further processing for this delivery if stolen
        }

        // Update delivery status to in-transit
        setDeliveries(prev => prev.map(d =>
          d.id === deliveryId
            ? { ...d, status: 'in-transit', startTime: gameTime, eta: newETA, incidents: incidents }
            : d
        ));
        addActivity('Rider Dispatched', `Rider dispatched for Order #${delivery.orderId}.`);
      },
      'Confirm Hire'
    );
  };

  const getDeliveryStatusColor = (status) => {
    switch (status) {
      case 'pending': return 'text-yellow-400';
      case 'in-transit': return 'text-blue-400';
      case 'completed': return 'text-green-400';
      case 'stolen': return 'text-red-400';
      default: return 'text-gray-300';
    }
  };

  return (
    <div className="p-6 md:p-8 bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-gray-100 font-inter rounded-xl shadow-2xl overflow-y-auto pb-24 md:pb-8">
      <h2 className="text-4xl font-extrabold text-yellow-400 mb-8 flex items-center gap-4 animate-fade-in">
        <Truck className="w-10 h-10" /> Deliveries
      </h2>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Pending Deliveries */}
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 animate-slide-left">
          <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Pending Dispatch</h3>
          {deliveries.filter(d => d.status === 'pending').length === 0 ? (
            <p className="text-gray-400 italic">No deliveries awaiting dispatch.</p>
          ) : (
            deliveries.filter(d => d.status === 'pending').map(delivery => (
              <div key={delivery.id} className="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600 mb-3">
                <p className="text-lg font-semibold text-white">Order #{delivery.orderId}</p>
                <p className="text-gray-300">Customer: {delivery.customerName}</p>
                <p className="text-gray-300">Items: {delivery.items.map(item => item.name).join(', ')}</p>
                <p className="text-gray-300">Address: {delivery.address}</p>
                <button
                  onClick={() => hireRider(delivery.id)}
                  className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                >
                  Hire Rider
                </button>
              </div>
            ))
          )}
        </div>

        {/* In Transit Deliveries */}
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 animate-slide-right">
          <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">In Transit</h3>
          {deliveries.filter(d => d.status === 'in-transit').length === 0 ? (
            <p className="text-gray-400 italic">No deliveries currently in transit.</p>
          ) : (
            deliveries.filter(d => d.status === 'in-transit').map(delivery => (
              <div key={delivery.id} className="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600 mb-3">
                <p className="text-lg font-semibold text-white">Order #{delivery.orderId}</p>
                <p className="text-gray-300">Customer: {delivery.customerName}</p>
                <p className="text-gray-300">Items: {delivery.items.map(item => item.name).join(', ')}</p>
                <p className="text-gray-300">Address: {delivery.address}</p>
                <p className="text-blue-400 font-bold mt-2">
                  ETA: {formatTime(Math.max(0, delivery.eta - (gameTime - delivery.startTime)))}
                </p>
                {delivery.incidents.includes('traffic_jam') && (
                  <p className="text-yellow-400 text-sm flex items-center mt-1">
                    <AlertCircle className="w-4 h-4 mr-1" /> Traffic Jam Delay!
                  </p>
                )}
              </div>
            ))
          )}
        </div>
      </div>

      {/* Completed/Stolen Deliveries */}
      <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 mt-6 animate-fade-in-delay-1">
        <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Delivery History</h3>
        {deliveries.filter(d => d.status === 'completed' || d.status === 'stolen').length === 0 ? (
          <p className="text-gray-400 italic">No completed or stolen deliveries yet.</p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {deliveries.filter(d => d.status === 'completed' || d.status === 'stolen').map(delivery => (
              <div key={delivery.id} className={`bg-gray-700 p-4 rounded-lg shadow-md border ${delivery.status === 'stolen' ? 'border-red-600' : 'border-gray-600'}`}>
                <p className="text-lg font-semibold text-white">Order #{delivery.orderId}</p>
                <p className="text-gray-300">Customer: {delivery.customerName}</p>
                <p className="text-gray-300">Items: {delivery.items.map(item => item.name).join(', ')}</p>
                <p className="text-gray-300">Address: {delivery.address}</p>
                <p className={`font-bold mt-2 ${getDeliveryStatusColor(delivery.status)}`}>
                  Status: {delivery.status === 'stolen' ? 'Stolen' : 'Completed'}
                </p>
                {delivery.status === 'stolen' && (
                  <p className="text-red-400 text-sm flex items-center mt-1">
                    <XCircle className="w-4 h-4 mr-1" /> Product Stolen!
                  </p>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// --- Analytics Page ---
const AnalyticsPage = () => {
  const { activityFeed, inventory, dms, deliveries } = useContext(GameContext);

  // Prepare data for sales trends (simplified for demo)
  const salesData = activityFeed
    .filter(a => a.type === 'Sale Confirmation')
    .map(a => ({
      date: new Date(a.timestamp).toLocaleDateString(),
      amount: parseFloat(a.message.match(/NGN ([\d,.]+)/)[1].replace(/,/g, '')),
    }))
    .reduce((acc, curr) => {
      const existing = acc.find(item => item.date === curr.date);
      if (existing) {
        existing.sales += curr.amount;
      } else {
        acc.push({ date: curr.date, sales: curr.amount });
      }
      return acc;
    }, [])
    .sort((a, b) => new Date(a.date) - new Date(b.date));

  // Top/Least Selling Products
  const productSales = inventory.reduce((acc, item) => {
    const salesCount = activityFeed.filter(a => a.type === 'Sale Confirmation' && a.message.includes(item.name)).length;
    acc.push({ name: item.name, sales: salesCount, profit: (item.sellingPrice - item.purchasePrice) * salesCount });
    return acc;
  }, []);

  const topSellingProducts = [...productSales].sort((a, b) => b.sales - a.sales).slice(0, 5);
  const leastSellingProducts = [...productSales].sort((a, b) => a.sales - b.sales).slice(0, 5);
  const highestProfitItems = [...productSales].sort((a, b) => b.profit - a.profit).slice(0, 5);

  // Customer Insights
  const uniqueBots = new Set(dms.map(dm => dm.botName));
  const repeatCustomers = new Set();
  dms.forEach(dm => {
    const salesCount = activityFeed.filter(a => a.type === 'Sale Confirmation' && a.message.includes(dm.botName)).length;
    if (salesCount > 1) {
      repeatCustomers.add(dm.botName);
    }
  });
  const repeatCustomerRate = uniqueBots.size > 0 ? (repeatCustomers.size / uniqueBots.size * 100).toFixed(2) : 0;

  // Delivery Performance
  const completedDeliveries = deliveries.filter(d => d.status === 'completed').length;
  const stolenDeliveries = deliveries.filter(d => d.status === 'stolen').length;
  const totalDeliveries = completedDeliveries + stolenDeliveries;
  const deliverySuccessRate = totalDeliveries > 0 ? (completedDeliveries / totalDeliveries * 100).toFixed(2) : 0;

  return (
    <div className="p-6 md:p-8 bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-gray-100 font-inter rounded-xl shadow-2xl overflow-y-auto pb-24 md:pb-8">
      <h2 className="text-4xl font-extrabold text-yellow-400 mb-8 flex items-center gap-4 animate-fade-in">
        <BarChart2 className="w-10 h-10" /> Analytics
      </h2>

      {/* Sales Trends */}
      <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 mb-8 animate-slide-up">
        <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Sales Trends (Daily)</h3>
        {salesData.length === 0 ? (
          <p className="text-gray-400 italic">No sales data yet.</p>
        ) : (
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={salesData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" stroke="#4a4a4a" />
              <XAxis dataKey="date" stroke="#9ca3af" />
              <YAxis stroke="#9ca3af" tickFormatter={(value) => formatCurrency(value)} />
              <Tooltip formatter={(value) => formatCurrency(value)} contentStyle={{ backgroundColor: '#374151', border: 'none', borderRadius: '8px' }} itemStyle={{ color: '#fff' }} labelStyle={{ color: '#fff' }} />
              <Line type="monotone" dataKey="sales" stroke="#8884d8" activeDot={{ r: 8 }} strokeWidth={2} />
            </LineChart>
          </ResponsiveContainer>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        {/* Product Performance */}
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 animate-slide-left">
          <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Product Performance</h3>
          <div className="mb-6">
            <h4 className="text-xl font-semibold text-yellow-400 mb-2 flex items-center"><TrendingUp className="w-5 h-5 mr-2" /> Top 5 Selling Products</h4>
            {topSellingProducts.length === 0 ? (<p className="text-gray-400 italic">No sales yet.</p>) : (
              <ul className="list-disc list-inside text-gray-200">
                {topSellingProducts.map(item => <li key={item.name}>{item.name} ({item.sales} sales)</li>)}
              </ul>
            )}
          </div>
          <div className="mb-6">
            <h4 className="text-xl font-semibold text-red-400 mb-2 flex items-center"><TrendingDown className="w-5 h-5 mr-2" /> Least 5 Selling Products</h4>
            {leastSellingProducts.length === 0 ? (<p className="text-gray-400 italic">No sales yet.</p>) : (
              <ul className="list-disc list-inside text-gray-200">
                {leastSellingProducts.map(item => <li key={item.name}>{item.name} ({item.sales} sales)</li>)}
              </ul>
            )}
          </div>
          <div>
            <h4 className="text-xl font-semibold text-green-400 mb-2 flex items-center"><DollarSign className="w-5 h-5 mr-2" /> Highest Profit Items</h4>
            {highestProfitItems.length === 0 ? (<p className="text-gray-400 italic">No profit data yet.</p>) : (
              <ul className="list-disc list-inside text-gray-200">
                {highestProfitItems.map(item => <li key={item.name}>{item.name} ({formatCurrency(item.profit)} total profit)</li>)}
              </ul>
            )}
          </div>
        </div>

        {/* Customer & Delivery Insights */}
        <div className="bg-gray-800 bg-opacity-70 p-6 rounded-xl shadow-lg border border-purple-700 animate-slide-right">
          <h3 className="text-2xl font-bold text-purple-300 mb-4 border-b border-purple-600 pb-2">Customer & Delivery Insights</h3>
          <div className="mb-6">
            <h4 className="text-xl font-semibold text-cyan-400 mb-2 flex items-center"><User className="w-5 h-5 mr-2" /> Customer Insights</h4>
            <p className="text-gray-200">Total Unique AI Customers: <span className="font-bold">{uniqueBots.size}</span></p>
            <p className="text-gray-200">Repeat Customer Rate: <span className="font-bold">{repeatCustomerRate}%</span></p>
          </div>
          <div>
            <h4 className="text-xl font-semibold text-blue-400 mb-2 flex items-center"><Truck className="w-5 h-5 mr-2" /> Delivery Performance</h4>
            <p className="text-gray-200">Total Deliveries: <span className="font-bold">{totalDeliveries}</span></p>
            <p className="text-gray-200">Delivery Success Rate: <span className="font-bold">{deliverySuccessRate}%</span></p>
            <p className="text-gray-200">Stolen Deliveries: <span className="font-bold text-red-400">{stolenDeliveries}</span></p>
          </div>
        </div>
      </div>
    </div>
  );
};


// --- Main App Component ---
const App = () => {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const { showModal, modalContent, hideCustomModal } = useContext(GameContext);

  return (
    <div className="relative min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-gray-900 font-inter text-gray-100 flex flex-col md:flex-row">
      {/* Navbar for larger screens */}
      <div className="hidden md:block">
        <Navbar currentPage={currentPage} setCurrentPage={setCurrentPage} />
      </div>

      {/* Main Content Area */}
      <main className="flex-1 overflow-hidden md:ml-64 relative">
        {currentPage === 'dashboard' && <Dashboard />}
        {currentPage === 'dms' && <DMInterface />}
        {currentPage === 'inventory' && <InventoryPage />}
        {currentPage === 'blackMarket' && <BlackMarket />}
        {currentPage === 'deliveries' && <DeliveryPage />}
        {currentPage === 'analytics' && <AnalyticsPage />}
      </main>

      {/* Navbar for mobile screens (fixed bottom) */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 z-40">
        <Navbar currentPage={currentPage} setCurrentPage={setCurrentPage} />
      </div>

      {/* Global Modal */}
      <Modal
        show={showModal}
        title={modalContent.title}
        message={modalContent.message}
        onConfirm={modalContent.onConfirm}
        confirmText={modalContent.confirmText}
        onClose={hideCustomModal}
      >
        {modalContent.children} /* Render children if provided by modalContent */
      </Modal>
    </div>
  );
};

// --- Root Component with Providers ---
export default function Root() {
  return (
    <FirebaseProvider>
      <GameProvider>
        <App />
      </GameProvider>
    </FirebaseProvider>
  );
}

